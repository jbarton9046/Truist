{% extends "layout.html" %}
{% block content %}

<style>
  /* ‚Äî‚Äî‚Äî Page-specific polish, built on top of layout.html theme ‚Äî‚Äî‚Äî */

  .budget-title { letter-spacing:.2px; }

  /* Cards (match Goals) */
  .card, .stat-card, .panel{
    background: var(--card-bg) !important;
    border: 1px solid var(--card-border) !important;
    color: var(--text);
    border-radius: 16px;
    box-shadow: 0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter: saturate(120%) blur(4px);
  }

  /* Section headers / card headers */
  .section-header,
  .card-header{
    background: var(--thead-bg) !important;
    color: var(--text) !important;
    border-bottom: 1px solid var(--hair) !important;
    font-weight: 600;
    padding: .75rem 1rem !important;
  }

  .summary-label,
  #recent-activity h5,
  .section-header .fw-bold {
    color: var(--text) !important; /* accent ink */
  }

  /* ======= Tables ‚Äì shared with Goals ======= */
  .table-responsive{
    border:1px solid var(--card-border);
    border-radius:14px;
    background:var(--card-bg);
    box-shadow:0 8px 24px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.04);
    overflow:auto;
    position: relative;
    scrollbar-gutter: stable both-edges;
  }

  .table-floating,
  .table-modern{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    color:var(--text);
    background:transparent;
  }

  /* Frosted sticky headers (navbar-like blur) */
  .frost thead{
    position: sticky;
    top: 0;
    z-index: 4;
  }
  .frost thead th{
    backdrop-filter: saturate(130%) blur(6px);
    -webkit-backdrop-filter: saturate(130%) blur(6px);
    background: color-mix(in oklab, var(--thead-bg) 78%, transparent) !important;
    color: var(--table-head-fg, var(--text)) !important;
    border-bottom:1px solid var(--hair) !important;
    font-weight:700; letter-spacing:.2px;
    box-shadow:
      0 1px 0 rgba(255,255,255,.05),
      0 10px 18px rgba(2, 6, 23, .25);
  }

  .table-floating tbody td,
  .table-modern   tbody td{
    border-top:1px solid var(--hair);
    vertical-align:middle;
  }
  .table-floating tbody tr:nth-child(odd),
  .table-modern   tbody tr:nth-child(odd){ background:rgba(255,255,255,.015); }
  .table-floating tbody tr:hover,
  .table-modern   tbody tr:hover{ background:rgba(255,255,255,.05); }

  /* ======= Latest Month Totals ‚Äî compact ‚Äúbubble‚Äù tiles ======= */
  .totals-row{
    --gap: 18px;
    display:grid;
    grid-template-columns: repeat(3, minmax(0,1fr));
    gap: var(--gap);
  }
  @media (max-width: 992px){
    .totals-row{ grid-template-columns: 1fr; }
  }
  .total-bubble{
    border:1px solid var(--card-border);
    background: color-mix(in oklab, var(--card-bg) 92%, transparent);
    border-radius: 14px;
    padding: 14px 16px;
    box-shadow:
      0 10px 22px rgba(0,0,0,.25),
      inset 0 1px 0 rgba(255,255,255,.05);
  }
  .total-bubble .label{ color: var(--text); opacity:.95; }
  .total-bubble .primary{ font-weight:700; font-size:1.25rem; }
  .total-bubble .delta{ color:#22c55e; font-weight:600; }

  /* Give the ‚ÄúLatest Month Totals‚Äù card comfortable inner paddings */
  .totals-card .card-body{ padding: 16px 18px 10px 18px; }

  /* ======= Category Movers ‚Äî bubble-rows like the totals ======= */
  .cm-card .table-wrap{
    /* inner inset so rows don‚Äôt hug the card edges */
    padding: 10px 12px 12px 12px;
  }
  .cm-card .table-floating{
    /* vertical gaps between rows via row border-spacing */
    border-collapse: separate;
    border-spacing: 0 10px;              /* <-- creates row ‚Äúpill‚Äù gaps */
  }
  /* remove default zebra + borders for this table; we‚Äôll paint the row pills */
  .cm-card .table-floating tbody tr{ background: transparent !important; }
  .cm-card .table-floating tbody td{
    border-top: none !important;
    background: color-mix(in oklab, var(--card-bg) 94%, transparent);
    border: 1px solid var(--card-border);
    box-shadow:
      0 8px 18px rgba(0,0,0,.20),
      inset 0 1px 0 rgba(255,255,255,.04);
    padding: .6rem .8rem !important;
  }
  .cm-card .table-floating tbody td:first-child{
    border-top-left-radius: 12px; border-bottom-left-radius: 12px;
  }
  .cm-card .table-floating tbody td:last-child{
    border-top-right-radius: 12px; border-bottom-right-radius: 12px;
  }

  /* Keep the header tidy and not slammed to the edge */
  .tight-head th{ padding: .55rem .8rem !important; }

  /* ======= Recent Transactions table also gets frosted header ======= */
  .rt-card .table-wrap{ padding: 10px 12px; }

  /* ======= Utilities ======= */
  .mono { font-variant-numeric: tabular-nums; }
  .muted { color: var(--muted) !important; }
  .tx-neg { color:#c0392b; font-weight:600; }
  .tx-pos { color:#1e7e34; font-weight:600; }

  /* Collapsible month summary header chip */
  .clickable-card-header{
    display:flex; align-items:center; gap:.6rem; cursor:pointer; user-select:none;
    padding:.575rem .875rem; margin:.75rem; border-radius:12px;
    background: linear-gradient(180deg, color-mix(in oklab, var(--thead-bg) 85%, transparent), color-mix(in oklab, var(--thead-bg) 65%, transparent));
    color: var(--text);
    border:1px solid var(--hair);
    transition: background .15s ease, color .15s ease;
  }
  .clickable-card-header .chev{ font-weight:700; opacity:.9; transition: transform .2s ease; }
  .card.open .clickable-card-header .chev{ transform: rotate(90deg); }

  /* Category tree */
  details > summary { list-style: none; cursor: pointer; user-select: none; }
  details > summary::-webkit-details-marker { display: none; }
  .caret { display:inline-block; width:.9rem; text-align:center; transform:rotate(0deg); transition:transform .15s; opacity:.8; color: var(--muted); }
  details[open] .caret { transform:rotate(90deg); color: var(--text); }

  .node-line { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.35rem .45rem; border-radius:10px; transition: background .15s; }
  .node-line:hover { background: rgba(255,255,255,.04); }
  .node-main { display:flex; align-items:center; gap:.55rem; }
  .node-total { opacity:.92; font-variant-numeric: tabular-nums; color: var(--text); }

  .link-manage{
    color: var(--text); text-decoration:none; border:1px solid transparent;
    padding:.12rem .5rem; border-radius:10px; cursor:pointer;
  }
  .link-manage:hover{
    background: rgba(255,255,255,.06);
    border-color: var(--hair);
    text-decoration:none;
  }

  /* Depth padding */
  .depth-1 { padding-left: 0px; }
  .depth-2 { padding-left: 16px; }
  .depth-3 { padding-left: 32px; }
  .depth-4 { padding-left: 48px; }
</style>

<!-- Header -->
<div class="container mt-3 mb-2">
  <div class="d-flex align-items-center justify-content-center">
    <h1 class="m-0 budget-title">üìä <span style="background:linear-gradient(90deg,#8ab6ff,#00d1ff); -webkit-background-clip:text; background-clip:text; color:transparent;">Barton Budget Tracker</span></h1>
  </div>
</div>

<!-- Recent Activity -->
<div class="container my-4" id="recent-activity">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h5 class="m-0">Recent Activity</h5>
    <small class="muted" id="ra-asof"></small>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <!-- Category Movers -->
      <div class="stat-card cm-card" id="catMoversCard">
        <div class="card-header section-header">
          <div class="fw-bold">üìà Category Movers <span class="muted small" id="cmSubtitle"></span></div>
        </div>
        <div class="card-body p-0 table-wrap">
          <div class="table-responsive frost">
            <table class="table table-sm table-floating align-middle mb-0 tight-head">
              <thead class="small">
                <tr>
                  <th>Category</th>
                  <th class="text-end">Prev</th>
                  <th class="text-end">Latest</th>
                  <th class="text-end">Œî</th>
                  <th class="text-end">Œî%</th>
                </tr>
              </thead>
              <tbody id="cmBody">
                <tr><td colspan="5" class="text-center py-4 muted">Loading‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Latest Month Totals -->
      <div class="stat-card totals-card mt-3">
        <div class="card-header section-header">Latest Month Totals</div>
        <div class="card-body">
          <div class="totals-row">
            <div class="total-bubble">
              <div class="label small">Income</div>
              <div class="primary mono" id="ra-inc"></div>
              <div class="delta small" id="ra-inc-delta"></div>
            </div>
            <div class="total-bubble">
              <div class="label small">Expense</div>
              <div class="primary mono" id="ra-exp"></div>
              <div class="delta small" id="ra-exp-delta"></div>
            </div>
            <div class="total-bubble">
              <div class="label small">Net</div>
              <div class="primary mono" id="ra-net"></div>
              <div class="delta small" id="ra-net-delta"></div>
            </div>
          </div>
          <div class="muted small mt-2" id="ra-months"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <!-- Most Recent Transactions -->
      <div class="stat-card rt-card">
        <div class="card-header section-header d-flex justify-content-between align-items-center">
          <h6 class="m-0">Most Recent Transactions</h6>
          <button id="refresh-btn" type="button" class="btn btn-sm btn-outline-light">üîÑ Refresh</button>
        </div>
        <div class="card-body p-0 table-wrap">
          <div class="table-responsive frost">
            <table class="table table-sm table-floating align-middle mb-0 tight-head" id="ra-recent">
              <thead>
                <tr>
                  <th style="width:110px;">Date</th>
                  <th>Description</th>
                  <th style="width:130px;" class="text-end">Amount</th>
                  <th style="width:120px;">Category</th>
                </tr>
              </thead>
              <tbody id="ra-recent-body"></tbody>
            </table>
          </div>
          <div class="muted small mt-2 px-3 pb-2" id="ra-windows"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loader for Movers & Recent -->
<script>
(function(){
  const $ = id => document.getElementById(id);
  const fmtMoney = (n) => { const v = Number(n||0); const sign = v < 0 ? '-' : ''; return sign + '$' + Math.abs(v).toFixed(2); };
  const fmtExpense = (n) => fmtMoney(-Math.abs(Number(n||0)));
  const fmtPct = (p) => (p == null || !isFinite(p)) ? '‚Äî' : (p*100).toFixed(0) + '%';
  const safe = (s) => String(s||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');

  const pctCellText = (row) => {
    if (typeof row.delta_pct === 'string') {
      const trimmed = row.delta_pct.replace(/\s*\(0(?:\.0+)?%\)\s*$/,'').trim();
      return trimmed || '‚Äî';
    }
    const main = Number(row.delta_pct);
    const aux  = Number(row.delta_pct2 ?? row.share_pct ?? row.pct2);
    const base = fmtPct(main);
    if (isFinite(aux) && Math.abs(aux) >= 0.005) { return `${base} (${fmtPct(aux)})`; }
    return base;
  };

  // Category Movers
  const cmBody = $('cmBody'), cmSub = $('cmSubtitle');
  async function loadCategoryMovers(){
    if (!cmBody) return;
    cmBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 muted">Loading‚Ä¶</td></tr>';
    try{
      const r = await fetch('/api/category_movers');
      if (!r.ok) throw new Error(await r.text());
      const j = await r.json();
      if (cmSub) cmSub.textContent = (j.prev_month && j.latest_month) ? `(${j.prev_month} ‚Üí ${j.latest_month})` : '';
      const rows = j.rows || [];
      if (!rows.length){
        cmBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 muted">No category movement yet.</td></tr>';
        return;
      }
      cmBody.innerHTML = rows.map(row => {
        const d = Number(row.delta || 0);
        const cls = d > 0 ? 'tx-neg' : d < 0 ? 'tx-pos' : 'muted';
        const arrow = d > 0 ? '‚ñ≤' : d < 0 ? '‚ñº' : '‚Äî';
        const deltaHtml = '<span class="'+cls+'">'+arrow+' '+fmtMoney(Math.abs(d))+'</span>';
        return (
          '<tr>' +
            '<td>' + (safe(row.category) || '‚Äî') + '</td>' +
            '<td class="text-end mono">' + fmtMoney(row.prev) + '</td>' +
            '<td class="text-end mono">' + fmtMoney(row.latest) + '</td>' +
            '<td class="text-end">' + deltaHtml + '</td>' +
            '<td class="text-end">' + pctCellText(row) + '</td>' +
          '</tr>'
        );
      }).join('');
    }catch(err){
      cmBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-danger">Failed to load: ' + safe(err.message||err) + '</td></tr>';
    }
  }
  window.loadCategoryMovers = loadCategoryMovers;

  // Recent Activity
  const raAsOf=$('ra-asof'), raInc=$('ra-inc'), raExp=$('ra-exp'), raNet=$('ra-net');
  const raIncD=$('ra-inc-delta'), raExpD=$('ra-exp-delta'), raNetD=$('ra-net-delta'), raMonths=$('ra-months');
  const raWin=$('ra-windows'), raBody=$('ra-recent-body');

  async function loadRecentActivity(){
    if (!raBody) return;
    try{
      const r = await fetch('/api/recent-activity');
      if (!r.ok) throw new Error(await r.text());
      const j = await r.json();
      const d = j.data || j;

      if (raAsOf)   raAsOf.textContent   = d.as_of ? `as of ${d.as_of}` : '';
      if (raMonths) raMonths.textContent = (d.prev_month && d.latest_month) ? `${d.prev_month} ‚Üí ${d.latest_month}` : '';

      const lt = d.latest_totals || {};
      if (raInc) { raInc.textContent = fmtMoney(lt.income); raInc.classList.add('mono'); }
      if (raExp) { raExp.textContent = fmtExpense(lt.expense); raExp.classList.add('mono'); }
      if (raNet) {
        const netVal = Number(lt.net || 0);
        raNet.textContent = fmtMoney(netVal);
        raNet.classList.add('mono');
        raNet.classList.toggle('tx-pos', netVal >= 0);
        raNet.classList.toggle('tx-neg', netVal < 0);
      }

      const mkDelta = (val, posGood=true) => {
        const d = Number(val||0);
        const cls = (posGood ? (d>0) : (d<0)) ? 'tx-pos' : d===0 ? 'muted' : 'tx-neg';
        const arrow = d>0 ? '‚ñ≤' : d<0 ? '‚ñº' : '‚Äî';
        return '<span class="'+cls+'">'+arrow+' '+fmtMoney(Math.abs(d))+'</span>';
      };
      if (raIncD) raIncD.innerHTML = mkDelta(lt.delta_income, true);
      if (raExpD) raExpD.innerHTML = mkDelta(lt.delta_expense, false);
      if (raNetD) raNetD.innerHTML = mkDelta(lt.delta_net, true);

      if (raWin){
        const w = d.recent_windows || {};
        raWin.textContent = '7d: +' + fmtMoney(w.last_7_income) + ' / -' + fmtMoney(w.last_7_expense) +
                            ' ‚Ä¢ 30d: +' + fmtMoney(w.last_30_income) + ' / -' + fmtMoney(w.last_30_expense);
      }

      const rows = d.recent_txs || [];
      raBody.innerHTML = rows.length ? rows.map(t => (
        '<tr>' +
          '<td class="mono">' + safe(String(t.date||'').slice(0,10)) + '</td>' +
          '<td>' + safe(t.desc) + '</td>' +
          '<td class="text-end mono">' + fmtMoney(t.amount) + '</td>' +
          '<td>' + safe(t.category) + (t.subcategory ? ' ‚Ä∫ ' + safe(t.subcategory) : '') + '</td>' +
        '</tr>'
      )).join('') : '<tr><td colspan="4" class="text-center muted py-3">No recent transactions.</td></tr>';
    }catch(err){
      console.error('Recent activity error:', err);
      raBody.innerHTML = '<tr><td colspan="4" class="text-danger text-center py-3">Couldn‚Äôt load recent activity: ' + safe(err?.message||err) + '</td></tr>';
    }
  }
  window.loadRecentActivity = loadRecentActivity;

  // Global refresh
  const raRefreshBtn = document.getElementById('refresh-btn');
  if (raRefreshBtn){
    raRefreshBtn.addEventListener('click', async () => {
      const original = raRefreshBtn.textContent;
      raRefreshBtn.disabled = true;
      raRefreshBtn.textContent = '‚è≥ Refreshing‚Ä¶';
      try {
        await fetch('/refresh_data', { method:'POST' }).catch(()=>{});
        window.location.reload();
      } finally {
        raRefreshBtn.disabled = false;
        raRefreshBtn.textContent = original;
      }
    });
  }

  loadCategoryMovers();
  loadRecentActivity();
})();
</script>

<!-- Per-month summary + category tree -->
<div class="container mt-2">
  {% macro usd(val) -%}
    {%- set n = (val or 0)|float -%}
    {{ '-' if n < 0 else '' }}${{ '%.2f'|format(n|abs) }}
  {%- endmacro %}

  {% macro render_node(node, ancestors=[], depth=1, month_key='') %}
    {% set cat  = (ancestors[0] if ancestors|length > 0 else (node.name if depth == 1 else '')) %}
    {% set sub  = (ancestors[1] if ancestors|length > 1 else (node.name if depth == 2 else '')) %}
    {% set ssub = (ancestors[2] if ancestors|length > 2 else (node.name if depth == 3 else '')) %}
    {% set sss  = (node.name if depth == 4 else '') %}

    {% if depth == 1 %}{% set level = 'category' %}
    {% elif depth == 2 %}{% set level = 'subcategory' %}
    {% elif depth == 3 %}{% set level = 'subsubcategory' %}
    {% else %}{% set level = 'subsubsubcategory' %}{% endif %}

    <details>
      <summary>
        <div class="node-line">
          <div class="node-main depth-{{ depth }}">
            <span class="caret">‚ñ∏</span>

            <a
              class="link-manage"
              title="Manage {{ node.name }}"
              data-level="{{ level }}"
              data-cat="{{ cat }}"
              data-sub="{{ sub }}"
              data-ssub="{{ ssub }}"
              data-sss="{{ sss }}"
              data-month="{{ month_key }}"
              href="#"
              onclick="return dashManage(event, this);">
              {{ node.name }}
            </a>

            <span class="node-total mono">{{ usd(node.total) }}</span>
          </div>
        </div>
      </summary>

      {% if node.children and node.children|length > 0 %}
        <ul class="list-unstyled ms-3 mt-1">
          {% for child in node.children %}
            <li>{{ render_node(child, ancestors + [node.name], depth + 1, month_key) }}</li>
          {% endfor %}
        </ul>
      {% else %}
        {% if node.transactions %}
          <ul class="list-unstyled ms-3 mt-1">
            {% for tx in node.transactions %}
              <li class="transaction-entry">
                <span class="muted mono">{{ tx.date }}</span>:
                {{ tx.description }}
                <span class="fw-bold {% if tx.amount>=0 %}tx-pos{% else %}tx-neg{% endif %} mono">
                  {{ usd(tx.amount) }}
                </span>
              </li>
            {% endfor %}
          </ul>
        {% endif %}
      {% endif %}
    </details>
  {% endmacro %}

  {% for month_key, summary in summary_data.items()|sort(reverse=True) %}
    {% set norm = month_key|replace('_','-') %}
    {% set parts = norm.split('-') %}
    {% set formatted_month_key = parts[1] ~ '-' ~ parts[0][-2:] %}
    {% set net_class = 'tx-pos' if summary.net_cash_flow >= 0 else 'tx-neg' %}

    <div class="card mb-4" id="card-{{ month_key }}">
      <div class="clickable-card-header" onclick="toggleSection('{{ month_key }}')" id="header-{{ month_key }}">
        <span class="chev" aria-hidden="true">‚ñ∏</span>
        <span class="summary-label">{{ formatted_month_key }} Summary</span>
      </div>

      <div id="section-{{ month_key }}" class="card-body" style="display: none;">
        <p><strong>Total Income:</strong>
          <span class="tx-pos mono">{{ usd(summary.income_total) }}</span>
        </p>
        <p><strong>Total Expenses:</strong>
          <span class="tx-neg mono">{{ usd(summary.expense_total) }}</span>
        </p>
        <p><strong>Net Cash Flow:</strong>
          <span class="fw-bold {{ net_class }} mono">{{ usd(summary.net_cash_flow) }}</span>
        </p>

        <h5 class="mt-3 toggle-link" id="cats-toggle-{{ month_key }}" onclick="toggleCategoryList('{{ month_key }}')" aria-expanded="false"
            style="display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .7rem; border-radius:10px; border:1px solid var(--hair); color:var(--text); background:rgba(255,255,255,.04);">
          <span class="chev" aria-hidden="true">‚ñ∏</span>
          Categories
        </h5>
        <div id="category-list-{{ month_key }}" style="display:none;">
          {% if summary.tree and summary.tree|length > 0 %}
            <div class="ms-1">
              {% for top in summary.tree %}
                {{ render_node(top, [], 1, norm[:7]) }}
              {% endfor %}
            </div>
          {% else %}
            <div class="muted">No category data for this month.</div>
          {% endif %}
        </div>
      </div>
    </div>
  {% endfor %}
</div>

<script>
window.toggleSection = function(key){
  const el = document.getElementById('section-' + key);
  if (!el) return false;
  const v = el.style.display;
  const willOpen = (v === 'none' || !v);
  el.style.display = willOpen ? 'block' : 'none';

  const card = document.getElementById('card-' + key);
  if (card) card.classList.toggle('open', willOpen);

  return false;
};
window.toggleCategoryList = function(key){
  const el = document.getElementById('category-list-' + key);
  if (!el) return false;
  const v = el.style.display;
  const willOpen = (v === 'none' || !v);
  el.style.display = willOpen ? 'block' : 'none';

  const hdr = document.getElementById('cats-toggle-' + key);
  if (hdr) hdr.setAttribute('aria-expanded', willOpen ? 'true' : 'false');

  return false;
};
</script>

{% endblock %}

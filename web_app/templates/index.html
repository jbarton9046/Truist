{% extends "layout.html" %}
{% block content %}

<style>
  /* --- Page-specific polish (uses global dark tokens from layout.html) --- */

  /* Title row */
  .budget-title { letter-spacing:.2px; }

  /* Cards (same skin as goals) */
  .card, .stat-card, .panel{
    background: var(--card-bg) !important;
    border: 1px solid var(--card-border) !important;
    color: var(--text);
    border-radius: 16px;
    box-shadow: 0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter: saturate(120%) blur(4px);
  }
  .card-header{
    background: var(--thead-bg) !important;
    color: var(--text) !important;
    border-bottom: 1px solid var(--hair) !important;
    font-weight: 600;
  }
  /* Header alignment like goals */
  .card-header, .section-title{
    padding: .75rem 1rem;
    display:flex; align-items:center; gap:.5rem;
  }
  .section-title .muted { margin-left:.25rem; }

  /* --- Table wrapper look --- */
  .table-wrap{
    border:1px solid var(--card-border);
    border-radius:14px;
    background:var(--card-bg);
    box-shadow:0 8px 24px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.04);
    overflow:hidden;
  }
  .table-floating,
  .table-modern{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    color:var(--text);
    background:transparent;
  }

  /* ===== Scrollers for sticky headers (backdrop context) ===== */
  .cm-scroll,
  .tx-scroll{
    max-height: 42vh; /* tx-scroll overrides below */
    overflow: auto;
    border-radius:12px;
    position: relative;
    isolation: isolate;
    background: transparent;
  }

  /* Body rows (visual only; sticky/blur is global) */
  .table-modern tbody td,
  .table-floating tbody td{
    border-top:1px solid var(--hair);
    vertical-align:middle;
  }
  .table-modern tbody tr:nth-child(odd),
  .table-floating tbody tr:nth-child(odd){ background:rgba(255,255,255,.015); }
  .table-modern tbody tr:hover,
  .table-floating tbody tr:hover{ background:rgba(255,255,255,.05); }

  .mono { font-variant-numeric: tabular-nums; }
  .muted { color: var(--muted) !important; }
  .tx-neg { color:#c0392b; font-weight:600; }
  .tx-pos { color:#1e7e34; font-weight:600; }

  /* --- Metric ‚Äúbubbles‚Äù --- */
  .metric-bubble{
    background:rgba(255,255,255,.04);
    border:1px solid var(--hair);
    border-radius:14px;
    padding:16px 18px;
    box-shadow: 0 6px 18px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .metric-title{ font-weight:600; margin-bottom:.25rem; color:var(--text); }
  .metric-value{ font-weight:700; font-size:1.25rem; }
  .metric-sub{ color:#31d4a1; font-weight:600; }

  .metrics-row{ padding:12px 12px 6px; }
  .metrics-row .col-12, .metrics-row .col-md-4{ padding:8px; }

  /* ---- Category Movers shell ---- */
  .cm-shell{
    margin:12px;
    border-radius:14px;
    border:1px solid var(--hair);
    background:rgba(255,255,255,.035);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
  }
  .cm-scroll table{ margin: 6px; }

  /* ---- Transactions panel ---- */
  .tx-shell{
    margin:12px;
    border-radius:14px;
    border:1px solid var(--hair);
    background:rgba(255,255,255,.035);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04);
  }
  .tx-scroll{
    max-height: 540px;
    overflow-y: auto;
    overflow-x: hidden;
  }
  .tx-scroll table{ margin: 6px; }

  .tx-table{ table-layout: fixed; }
  .tx-table th, .tx-table td{ padding:.65rem .85rem; }
  .tx-table .col-date{ width:110px; white-space:nowrap; }
  .tx-table .col-amount{ width:130px; white-space:nowrap; text-align:right; }
  .tx-table .col-desc, .tx-table .col-cat{ width:auto; word-break:break-word; }

  .clickable-card-header{
    display:flex; align-items:center; gap:.6rem; user-select:none;
    padding:.575rem .875rem; margin:.5rem; border-radius:12px;
    background: color-mix(in oklab, var(--thead-bg) 78%, transparent);
    border:1px solid var(--hair);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
  }
  .clickable-card-header .chev{ font-weight:700; opacity:.9; }

  /* Category tree */
  details > summary { list-style: none; cursor: pointer; user-select: none; }
  details > summary::-webkit-details-marker { display: none; }
  .caret { display:inline-block; width:.9rem; text-align:center; transform:rotate(0deg); transition:transform .15s ease-in-out; opacity:.8; color: var(--muted); }
  details[open] .caret { transform:rotate(90deg); color: var(--text); }

  .node-line { display:flex; align-items:center; justify-content:space-between; gap:.75rem; padding:.35rem .45rem; border-radius:10px; transition: background .15s ease; }
  .node-line:hover { background: rgba(255,255,255,.04); }
  .node-main { display:flex; align-items:center; gap:.55rem; }
  .node-total { opacity:.92; font-variant-numeric: tabular-nums; }

  .link-manage{
    color: var(--text); text-decoration:none; border:1px solid transparent;
    padding:.12rem .5rem; border-radius:10px; cursor:pointer;
  }
  .link-manage:hover{
    background: rgba(255,255,255,.06);
    border-color: var(--hair);
    text-decoration:none;
  }

  /* Dashboard-only: hide ‚ÄúRecent Activity‚Äù and date */
  #recent-activity .section-heading,
  #recent-activity #ra-asof { display: none !important; }

  /* Transactions header refresh button alignment */
  #refresh-btn{ margin-left:auto; }

  /* ==== STRONG FROSTED HEADER FIX ==== */
  .cm-scroll, .tx-scroll {
    transform: translateZ(0);
  }
  .cm-scroll .table thead th,
  .tx-scroll .table thead th {
    position: sticky;
    top: 0;
    z-index: 6;
    backdrop-filter: saturate(130%) blur(14px) !important;
    -webkit-backdrop-filter: saturate(130%) blur(14px) !important;
    background: rgba(10,14,24,.68) !important;
    border-bottom: 1px solid var(--hair) !important;
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.06),
      0 10px 18px rgba(2, 6, 23, .25);
    will-change: backdrop-filter;
  }

  /* Hide month range + 7d/30d windows */
  #ra-months,
  #ra-windows {
    display: none !important;
  }
</style>

<!-- Header -->
<div class="container mt-3 mb-2">
  <div class="d-flex align-items-center justify-content-center">
    <h1 class="m-0 budget-title">üìä Barton Budget Tracker</h1>
  </div>
</div>

<!-- Recent Activity -->
<div class="container my-4" id="recent-activity">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h5 class="m-0 section-heading">Recent Activity</h5>
    <small class="muted" id="ra-asof"></small>
  </div>

  <div class="row g-3">
    <div class="col-lg-6">
      <!-- Category Movers -->
      <div class="stat-card" id="catMoversCard">
        <div class="section-title">
          <div class="fw-bold">üìà Category Movers <span class="muted small" id="cmSubtitle"></span></div>
        </div>
        <div class="card-body p-0">
          <div class="cm-shell">
            <div class="cm-scroll">
              <table class="table table-sm table-modern align-middle mb-0">
                <thead class="small">
                  <tr>
                    <th>Category</th>
                    <th class="text-end">Prev</th>
                    <th class="text-end">Latest</th>
                    <th class="text-end">Œî</th>
                    <th class="text-end">Œî%</th>
                  </tr>
                </thead>
                <tbody id="cmBody">
                  <tr><td colspan="5" class="text-center py-4 muted">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Latest Month Totals -->
      <div class="stat-card mt-3">
        <div class="section-title"><div class="fw-bold">Latest Month Totals</div></div>
        <div class="card-body pt-0">
          <div class="row metrics-row">
            <div class="col-12 col-md-4">
              <div class="metric-bubble">
                <div class="metric-title">Income</div>
                <div class="metric-value mono" id="ra-inc"></div>
                <div class="metric-sub mono" id="ra-inc-delta"></div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="metric-bubble">
                <div class="metric-title">Expense</div>
                <div class="metric-value mono" id="ra-exp"></div>
                <div class="metric-sub mono" id="ra-exp-delta"></div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="metric-bubble">
                <div class="metric-title">Net</div>
                <div class="metric-value mono" id="ra-net"></div>
                <div class="metric-sub mono" id="ra-net-delta"></div>
              </div>
            </div>
          </div>
          <div class="muted small mt-1 px-3" id="ra-months"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <!-- Most Recent Transactions -->
      <div class="stat-card">
        <div class="card-header d-flex align-items-center">
          <h6 class="m-0">Most Recent Transactions</h6>
          <button id="refresh-btn" type="button" class="btn btn-sm btn-outline-light ms-auto">üîÑ Refresh</button>
        </div>
        <div class="card-body p-0">
          <div class="tx-shell">
            <div class="tx-scroll">
              <table class="table table-sm table-modern align-middle mb-0 tx-table" id="ra-recent">
                <thead>
                  <tr>
                    <th class="col-date">Date</th>
                    <th class="col-desc">Description</th>
                    <th class="col-amount text-end">Amount</th>
                    <th class="col-cat">Category</th>
                  </tr>
                </thead>
                <tbody id="ra-recent-body"></tbody>
              </table>
            </div>
          </div>
          <div class="muted small mt-2 px-3" id="ra-windows"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- scripts unchanged ... -->
{% endblock %}

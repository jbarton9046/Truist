{% extends "layout.html" %}
{% block content %}
<style>
  /* ============== Base ============== */
  .muted { color:#6c757d; }
  .mono { font-variant-numeric: tabular-nums; }
  .chip { display:inline-block; padding:.2rem .5rem; border:1px solid #dee2e6; border-radius:999px; margin:.1rem .25rem; font-size:.85rem; }
  .stat-card { border:1px solid #e9ecef; border-radius:.75rem; padding:.75rem; }

  /* one-bar chooser */
  .onebar { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
  .onebar .onebar-new { display:flex; align-items:center; gap:.5rem; }
  .onebar .onebar-new.d-none { display:none !important; }
  .onebar .onebar-select.d-none { display:none !important; }

  /* modal table tweaks */
  .manage-table input.form-control-sm { min-width: 260px; }

  /* misc panel */
  .misc-card { border:1px solid #e9ecef; border-radius:.75rem; }
  .misc-table tbody tr td { vertical-align: middle; }
  .misc-controls .form-control, .misc-controls .form-select { height: 36px; }
  .misc-scroll { max-height: 60vh; overflow:auto; }
  .pointer { cursor:pointer; }

  /* --- Keyword Finder (left column) --- */
  .kb-card { border-radius:1rem; border:1px solid #e9ecef; background:#fff; }
  .kb-card .kb-head { padding:.6rem .9rem; border-bottom:1px solid #edf2f7; }
  .kb-card .kb-body { padding:.75rem; }
  .kb-muted { color:#6c757d; }
  .kb-path { max-width:480px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .kb-table thead th { position:sticky; top:0; background:#fff; z-index:1; }

  /* Dark / glass overrides (tokens from layout.html) */
  .kb-card{
    border-radius:16px;
    border:1px solid var(--card-border) !important;
    background: var(--card-bg) !important;
    color: var(--text);
    box-shadow: 0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter: saturate(120%) blur(4px);
  }
  .kb-card .kb-head{
    background: var(--thead-bg) !important;
    color: var(--text) !important;
    border-bottom:1px solid var(--hair) !important;
    font-weight:700; letter-spacing:.2px;
    border-top-left-radius:16px; border-top-right-radius:16px;
    -webkit-backdrop-filter:saturate(120%) blur(6px);
    backdrop-filter:saturate(120%) blur(6px);
  }

  #kwMiniList{ max-height:35vh; overflow:auto; background:transparent; isolation:isolate; }
  .kb-card .list-group{ border:1px solid var(--hair); border-radius:12px; background:transparent; }
  .kb-card .list-group-item{ background:transparent; color:var(--text); border-color:var(--hair); }
  .kb-card .list-group-item:hover{ background:rgba(255,255,255,.05); }

  .misc-card .table thead th,
  .kb-table thead th{
    position: sticky;
    top: 0;
    z-index: 7;
    background: rgba(8,12,20,.78) !important;
    color: var(--text) !important;
    border-bottom:1px solid var(--hair) !important;
    font-weight:700; letter-spacing:.2px;
    padding:.65rem .9rem;
    -webkit-backdrop-filter: saturate(130%) blur(16px);
    backdrop-filter: saturate(130%) blur(16px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.05),
      0 10px 18px rgba(2, 6, 23, .25);
  }

  #kwMiniList .list-group-item{ position: relative; padding-right: 40px; font-family: inherit; }
  #kwMiniList .list-group-item .badge{
    position: absolute; top: 50%; right: 12px; transform: translateY(-50%);
    background: transparent !important; border: 0 !important; box-shadow: none !important;
    color: var(--link, #9ec5ff) !important; font-weight: 700; font-size: .95rem; line-height: 1;
    padding: 0; min-width: 0; width: auto; height: auto; pointer-events: none;
    text-shadow: 0 0 10px rgba(158,197,255,.35);
  }
  #kwMiniList .list-group-item .badge.rounded-pill{ border-radius: 0 !important; }

  .form-text, #submitHint { color: var(--muted) !important; }

  /* ======= Keywords for current path (right column) ======= */
  .kwp-card { border:1px solid var(--card-border); border-radius:.75rem; background:var(--card-bg); }
  .kwp-chip { display:inline-flex; align-items:center; gap:.35rem; padding:.2rem .55rem; border-radius:999px; background:#f1f3f5; color:#212529; border:1px solid #e9ecef; margin:.15rem .25rem .15rem 0; }
  .kwp-chip button { border:0; background:transparent; padding:0 .2rem; cursor:pointer; }
</style>

<div class="container-fluid my-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">🧩 Category Builder</h2>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else ('warning' if category=='warning' else ('danger' if category=='danger' else 'info')) }} mb-2">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ========================= -->
  <!-- Row 1: Keywords | Build   -->
  <!-- ========================= -->
  <div class="row g-3">

    <!-- 1) Keywords Used (left) -->
    <div class="col-12 col-xl-6">
      <div class="kb-card">
        <div class="kb-head d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Keywords Used</div>
          <div class="small kb-muted"><span id="kwMiniTotal">0</span> total</div>
        </div>
        <div class="kb-body">
          <input id="kwMiniFilter" class="form-control form-control-sm mb-2" placeholder="Filter keywords…">
          <div class="list-group small" id="kwMiniList" style="max-height:35vh; overflow:auto;"></div>

          <div class="mt-2" id="kwMiniDetails" style="max-height:20vh; overflow:auto;">
            <div class="small kb-muted kb-placeholder">Select a keyword to see its categories.</div>
          </div>
        </div>
      </div>
      <div class="small kb-muted mt-2" id="kbTip">
        Tip: Click a <strong>path</strong> to load it into the builder on the right.
      </div>

      <!-- CFG JSON + parse (one source of truth) -->
      <script id="cfg-json" type="application/json">
        {{ cfg | default({}) | tojson | safe }}
      </script>
      <script>
        window.CFG = window.CFG || JSON.parse(document.getElementById('cfg-json').textContent || '{}');
      </script>

      <!-- Compact keywords logic (unchanged) -->
      <script>
        (function(){
          const CFG = window.CFG || {};
          const elFilter  = document.getElementById('kwMiniFilter');
          const elList    = document.getElementById('kwMiniList');
          const elTotal   = document.getElementById('kwMiniTotal');
          const elDetails = document.getElementById('kwMiniDetails');

          const MAX_PATHS_SHOWN = 5;
          const norm = s => String(s||'').trim().toLowerCase();

          function collectAllKeywordsAndPaths(cfg){
            const kwSet = new Map();     // normalized -> display
            const pathsByKw = new Map(); // normalized -> Set(paths)

            function add(kw, pathArr){
              const n = norm(kw);
              if (!n) return;
              if (!kwSet.has(n)) kwSet.set(n, String(kw).trim());
              const path = pathArr.filter(Boolean).join(' > ');
              if (!pathsByKw.has(n)) pathsByKw.set(n, new Set());
              pathsByKw.get(n).add(path);
            }

            Object.entries(cfg.CATEGORY_KEYWORDS || {}).forEach(([cat, kws])=>{
              (kws||[]).forEach(kw=> add(kw, [cat]));
            });
            Object.entries(cfg.SUBCATEGORY_MAPS || {}).forEach(([cat, subs])=>{
              Object.entries(subs||{}).forEach(([sub, kws])=>{
                (kws||[]).forEach(kw=> add(kw, [cat, sub]));
              });
            });
            Object.entries(cfg.SUBSUBCATEGORY_MAPS || {}).forEach(([cat, subs])=>{
              Object.entries(subs||{}).forEach(([sub, ssubs])=>{
                Object.entries(ssubs||{}).forEach(([ssub, kws])=>{
                  (kws||[]).forEach(kw=> add(kw, [cat, sub, ssub]));
                });
              });
            });
            Object.entries(cfg.SUBSUBSUBCATEGORY_MAPS || {}).forEach(([cat, subs])=>{
              Object.entries(subs||{}).forEach(([sub, ssubs])=>{
                Object.entries(ssubs||{}).forEach(([ssub, ssss])=>{
                  Object.entries(ssss||{}).forEach(([sss, kws])=>{
                    (kws||[]).forEach(kw=> add(kw, [cat, sub, ssub, sss]));
                  });
                });
              });
            });

            const stats = cfg.KEYWORD_STATS || {};
            const countFor = (display)=>{
              const s = stats[display] || stats[display?.toUpperCase?.()] || stats[display?.toLowerCase?.()];
              return s && typeof s.count === 'number' ? s.count : undefined;
            };

            return Array.from(kwSet.entries()).map(([n, display])=>{
              const paths = Array.from(pathsByKw.get(n) || []);
              return { n, display, paths, pathsCount: paths.length, usage: countFor(display) };
            });
          }

          const ALL = collectAllKeywordsAndPaths(CFG).sort((a,b)=> a.display.localeCompare(b.display));
          elTotal.textContent = ALL.length;

          function renderList(q=''){
            const query = norm(q);
            elList.innerHTML = '';
            let shown = 0;
            ALL.forEach(item=>{
              if (query && !item.display.toLowerCase().includes(query)) return;
              shown++;
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
              btn.dataset.kw = item.display;

              const left = document.createElement('span');
              left.textContent = item.display;

              const right = document.createElement('span');
              right.className = 'badge rounded-pill text-bg-light';
              right.textContent = item.pathsCount;

              btn.appendChild(left);
              btn.appendChild(right);
              elList.appendChild(btn);
            });
            if (!shown) {
              const li = document.createElement('div');
              li.className = 'list-group-item text-muted';
              li.textContent = 'No keywords match your filter.';
              elList.appendChild(li);
            }
          }

          function renderDetailsFor(keyword, showAll=false){
            const n = norm(keyword);
            const item = ALL.find(i => i.n === n);
            if (!item){
              elDetails.innerHTML = '<div class="small kb-muted">Select a keyword to see its categories.</div>';
              return;
            }

            const total = item.paths.length;
            const visible = showAll ? item.paths : item.paths.slice(0, MAX_PATHS_SHOWN);

            const lines = visible.map(p => {
              const esc = p.replace(/"/g,'&quot;');
              return `<li class="mb-1">
                <span class="badge bg-secondary-subtle text-secondary-emphasis">${p || '—'}</span>
                <a href="#" class="ms-2 small kw-path" data-path="${esc}">Use path</a>
              </li>`;
            }).join('');

            const usage = (typeof item.usage === 'number') ? `<span class="ms-2 small kb-muted">• ${item.usage} seen</span>` : '';
            const more = (!showAll && total > MAX_PATHS_SHOWN)
              ? `<div class="mt-1"><a href="#" class="small kw-show-all" data-kw="${item.display}">Show all (${total - MAX_PATHS_SHOWN} more)</a></div>`
              : '';

            elDetails.innerHTML = `
              <div class="small">
                <div class="mb-1"><strong>${item.display}</strong> used in ${item.pathsCount} path(s) ${usage}</div>
                <ul class="ps-3 mb-2" style="max-height:20vh; overflow:auto;">${lines || '<li class="kb-muted">No paths found.</li>'}</ul>
                ${more}
              </div>
            `;
          }

          elFilter.addEventListener('input', (e)=> renderList(e.target.value));
          elList.addEventListener('click', (e)=>{
            const btn = e.target.closest('.list-group-item');
            if (!btn) return;
            renderDetailsFor(btn.dataset.kw);
          });
          elDetails.addEventListener('click', (e)=>{
            const aPath = e.target.closest('.kw-path');
            if (aPath){
              e.preventDefault();
              const path = aPath.dataset.path || '';
              if (typeof window.applyPathToLeft === 'function') {
                window.applyPathToLeft(path);
              }
              return;
            }
            const aAll = e.target.closest('.kw-show-all');
            if (aAll){
              e.preventDefault();
              renderDetailsFor(aAll.dataset.kw, true);
            }
          });

          renderList('');
        })();
      </script>
    </div>

    <!-- 2) Build Path & Keyword (right) -->
    <div class="col-12 col-xl-6">
      <form id="formUpsert" method="POST" action="{{ url_for('admin_categories.upsert_path_and_keyword') }}">
        <div class="card shadow-sm">
          <div class="card-header fw-bold">Build Path &amp; Add Keyword</div>
          <div class="card-body">
            <div class="row g-3">

              <!-- Category -->
              <div class="col-12" id="wrap-cat">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Category</span>
                  <button type="button" class="btn btn-link p-0 align-baseline manage-link" data-level="category">Manage</button>
                </label>
                <div class="onebar" data-level="cat">
                  <select id="selCategory" class="form-select onebar-select"></select>
                  <div class="onebar-new d-none" id="newCategoryWrap">
                    <input id="inpCategory" class="form-control" placeholder="New category name">
                    <button type="button" class="btn btn-outline-secondary btn-sm onebar-cancel" data-target="cat">Select existing</button>
                  </div>
                </div>
              </div>

              <!-- Subcategory -->
              <div class="col-12 d-none" id="wrap-sub">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Subcategory</span>
                  <button type="button" class="btn btn-link p-0 align-baseline manage-link" data-level="subcategory">Manage</button>
                </label>
                <div class="onebar" data-level="sub">
                  <select id="selSub" class="form-select onebar-select"></select>
                  <div class="onebar-new d-none" id="newSubWrap">
                    <input id="inpSub" class="form-control" placeholder="New subcategory name">
                    <button type="button" class="btn btn-outline-secondary btn-sm onebar-cancel" data-target="sub">Select existing</button>
                  </div>
                </div>
              </div>

              <!-- Sub-subcategory -->
              <div class="col-12 d-none" id="wrap-ssub">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Sub-subcategory</span>
                  <button type="button" class="btn btn-link p-0 align-baseline manage-link" data-level="subsubcategory">Manage</button>
                </label>
                <div class="onebar" data-level="ssub">
                  <select id="selSubSub" class="form-select onebar-select"></select>
                  <div class="onebar-new d-none" id="newSubSubWrap">
                    <input id="inpSubSub" class="form-control" placeholder="New sub-subcategory name">
                    <button type="button" class="btn btn-outline-secondary btn-sm onebar-cancel" data-target="ssub">Select existing</button>
                  </div>
                </div>
              </div>

              <!-- Sub-sub-subcategory -->
              <div class="col-12 d-none" id="wrap-sssb">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Sub-sub-subcategory</span>
                  <button type="button" class="btn btn-link p-0 align-baseline manage-link" data-level="subsubsubcategory">Manage</button>
                </label>
                <div class="onebar" data-level="sss">
                  <select id="selSubSubSub" class="form-select onebar-select"></select>
                  <div class="onebar-new d-none" id="newSubSubSubWrap">
                    <input id="inpSubSubSub" class="form-control" placeholder="New sub-sub-subcategory name">
                    <button type="button" class="btn btn-outline-secondary btn-sm onebar-cancel" data-target="sss">Select existing</button>
                  </div>
                </div>
              </div>

              <hr class="mt-2 mb-1">

              <!-- Optional Keyword (form post) -->
              <div class="col-12">
                <label class="form-label">Keyword (optional)</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="kw_input" placeholder="e.g., COSTCO">
                  <button type="button" id="kw_clear" class="btn btn-outline-secondary">Clear</button>
                </div>
                <div class="form-text">Tip: click “Use path” in the Keywords panel to auto-fill selections here.</div>
              </div>

              <div class="col-12">
                <div class="muted small mb-1">Current path</div>
                <div id="currentPathBadge" class="badge bg-secondary">—</div>
              </div>

              <div class="col-12">
                <button type="submit" id="btnSaveAll" class="btn btn-primary" disabled>Save Path</button>
                <small class="form-text text-muted" id="submitHint">Pick or enter a Category to enable.</small>
              </div>

              <!-- ====== Keywords for current path (live via API, no drawer) ====== -->
              <div class="col-12">
                <div class="kwp-card p-3 mt-2">
                  <div class="d-flex align-items-center justify-content-between">
                    <div class="fw-semibold">Keywords for this path</div>
                    <div class="small muted" id="kwp-count">—</div>
                  </div>
                  <div class="mt-2">
                    <div id="kwp-list" class="small"></div>
                  </div>
                  <div class="input-group input-group-sm mt-2">
                    <input id="kwp-new" class="form-control" placeholder="Add keyword…">
                    <button id="kwp-add" type="button" class="btn btn-outline-primary">Add</button>
                  </div>
                  <div class="form-text mt-1" id="kwp-status"></div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Hidden posts for UPSERT -->
        <input type="hidden" name="cat" id="post_cat">
        <input type="hidden" name="sub" id="post_sub">
        <input type="hidden" name="ssub" id="post_ssub">
        <input type="hidden" name="sss" id="post_sss">
        <input type="hidden" name="keyword" id="post_keyword">
        <input type="hidden" name="target_level" id="post_target_level">
        <input type="hidden" name="target_label" id="post_target_label">
      </form>
    </div>
  </div>

  <!-- Row 2: Misc (unchanged) -->
  <div class="row g-3 mt-1">
    <div class="col-12">
      <div class="card misc-card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-bold">🧭 Misc Transactions</div>
          <div class="d-flex align-items-center gap-2">
            <div class="small muted me-2" id="miscMeta">—</div>
            <button id="miscRefresh" class="btn btn-outline-primary btn-sm" type="button">Refresh</button>
          </div>
        </div>

        <div class="card-body">
          <div class="d-none">
            <input type="text" id="miscSearch" value="">
            <input type="number" step="0.01" id="miscMinAbs" value="">
            <select id="miscLimit">
              <option>50</option>
              <option selected>100</option>
              <option>200</option>
              <option>300</option>
              <option>500</option>
            </select>
            <input class="form-check-input" type="checkbox" id="lblMisc" checked>
            <input class="form-check-input" type="checkbox" id="lblUncat" checked>
            <input class="form-check-input" type="checkbox" id="lblUnknown" checked>
            <a href="#" id="miscClearFilters">Clear filters</a>
          </div>

          <div class="misc-scroll">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle misc-table">
                <thead>
                  <tr class="small text-muted">
                    <th style="width: 92px;">Date</th>
                    <th>Description</th>
                    <th class="text-end" style="width: 110px;">Amount</th>
                    <th style="width: 30%;">Path</th>
                    <th class="text-end" style="width: 110px;">Action</th>
                  </tr>
                </thead>
                <tbody id="miscTableBody">
                  <tr><td colspan="5" class="text-center py-4 muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between mt-2">
            <div class="small muted" id="miscCount">—</div>
            <div class="small d-none"><a href="#" id="miscClearFilters2">Clear filters</a></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Endpoints (make sure we have defaults)
  window.CL_URLS = Object.assign({
    KW_GET_URL: '/admin/categories/keywords',     // path-based
    KW_ADD_URL: '/admin/api/keyword_add',
    KW_REMOVE_URL: '/admin/api/keyword_remove',
    INSPECT_URL: '/admin/categories/inspect',
    RENAME_URL: '/admin/categories/rename',
    UPSERT_URL: '/admin/categories/upsert_child'
  }, window.CL_URLS || {});
</script>

<script>
  const CFG = window.CFG || {};

  /* ---------- helpers ---------- */
  function csrfToken(){
    const m = document.querySelector('meta[name="csrf-token"]');
    return m ? m.content : '';
  }
  function headersJSON(){
    const h = { 'Content-Type': 'application/json' };
    const t = csrfToken(); if (t) h['X-CSRFToken'] = t;
    return h;
  }
  function qs(obj){
    const sp = new URLSearchParams();
    Object.entries(obj).forEach(([k,v]) => { if (v !== undefined && v !== null) sp.set(k, v); });
    return sp.toString();
  }

  /* ---------- data access ---------- */
  function getAllCategories() {
    const a = new Set(Object.keys(CFG.SUBCATEGORY_MAPS || {}));
    Object.keys(CFG.CATEGORY_KEYWORDS || {}).forEach(k => a.add(k));
    Object.keys(CFG.SUBSUBCATEGORY_MAPS || {}).forEach(k => a.add(k));
    Object.keys(CFG.SUBSUBSUBCATEGORY_MAPS || {}).forEach(k => a.add(k));
    return Array.from(a).sort();
  }
  function getSubs(cat) {
    const m = CFG.SUBCATEGORY_MAPS || {};
    return cat && m[cat] ? Object.keys(m[cat]).sort() : [];
  }
  function getSSubs(cat, sub) {
    const m = CFG.SUBSUBCATEGORY_MAPS || {};
    return (cat && sub && m[cat] && m[cat][sub]) ? Object.keys(m[cat][sub]).sort() : [];
  }
  function getSSSubs(cat, sub, ssub) {
    const m = CFG.SUBSUBSUBCATEGORY_MAPS || {};
    return (cat && sub && ssub && m[cat] && m[cat][sub] && m[cat][sub][ssub]) ? Object.keys(m[cat][sub][ssub]).sort() : [];
  }

  /* ---------- one-bar helpers ---------- */
  const NEW_SENTINEL = '__NEW__';
  const isNewMode = { cat:false, sub:false, ssub:false, sss:false };

  function setOptionsWithNew(select, list, placeholder='Select…', includeNew=true){
    const prev = select.value;
    select.innerHTML = '';

    const ph = document.createElement('option');
    ph.value = ''; ph.textContent = placeholder; ph.disabled = true; ph.selected = true;
    select.appendChild(ph);

    if (includeNew){
      const newOpt = document.createElement('option');
      newOpt.value = NEW_SENTINEL; newOpt.textContent = '＋ Create new…';
      select.appendChild(newOpt);
    }

    list.forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; select.appendChild(o);
    });

    if (prev && Array.from(select.options).some(o => o.value === prev)){
      select.value = prev;
    } else {
      select.selectedIndex = 0;
    }
  }

  function oneBarEnterNew(level){
    const {select, newWrap} = byLevel(level);
    isNewMode[level] = true;
    select.classList.add('d-none'); newWrap.classList.remove('d-none');
    const input = newWrap.querySelector('input');
    setTimeout(()=>input.focus(), 0);
  }
  function oneBarExitNew(level, clearValue=true){
    const {select, newWrap} = byLevel(level);
    isNewMode[level] = false;
    newWrap.classList.add('d-none'); select.classList.remove('d-none');
    if (clearValue){ select.value = ''; }
  }
  function getValue(level){
    const {select, newWrap} = byLevel(level);
    if (!newWrap.classList.contains('d-none')) {
      return (newWrap.querySelector('input').value || '').trim();
    }
    const v = select.value;
    return (v === NEW_SENTINEL ? '' : (v || ''));
  }
  function clearDescendants(fromLevel){
    const order = ['cat','sub','ssub','sss'];
    const idx = order.indexOf(fromLevel);
    for (let i=idx+1; i<order.length; i++){
      oneBarExitNew(order[i], true);
      const s = byLevel(order[i]).select;
      s.value = '';
    }
  }

  /* ---------- DOM refs ---------- */
  const wrapSub  = document.getElementById('wrap-sub');
  const wrapSSub = document.getElementById('wrap-ssub');
  const wrapSSSb = document.getElementById('wrap-sssb');

  const selCategory   = document.getElementById('selCategory');
  const selSub        = document.getElementById('selSub');
  const selSubSub     = document.getElementById('selSubSub');
  const selSubSubSub  = document.getElementById('selSubSubSub');

  const inpCategory   = document.getElementById('inpCategory');
  const inpSub        = document.getElementById('inpSub');
  const inpSubSub     = document.getElementById('inpSubSub');
  const inpSubSubSub  = document.getElementById('inpSubSubSub');

  const newCategoryWrap = document.getElementById('newCategoryWrap');
  const newSubWrap      = document.getElementById('newSubWrap');
  const newSubSubWrap   = document.getElementById('newSubSubWrap');
  const newSubSubSubWrap= document.getElementById('newSubSubSubWrap');

  const kwInput = document.getElementById('kw_input');
  const btnSaveAll = document.getElementById('btnSaveAll');
  const submitHint = document.getElementById('submitHint');
  const currentPathBadge = document.getElementById('currentPathBadge');
  const kwClearBtn = document.getElementById('kw_clear');

  const post_cat = document.getElementById('post_cat');
  const post_sub = document.getElementById('post_sub');
  const post_ssub = document.getElementById('post_ssub');
  const post_sss = document.getElementById('post_sss');
  const post_keyword = document.getElementById('post_keyword');
  const post_target_level = document.getElementById('post_target_level');
  const post_target_label = document.getElementById('post_target_label');

  /* Misc panel DOM */
  const miscSearch = document.getElementById('miscSearch');
  const miscMinAbs = document.getElementById('miscMinAbs');
  const miscLimit  = document.getElementById('miscLimit');
  const lblMisc    = document.getElementById('lblMisc');
  const lblUncat   = document.getElementById('lblUncat');
  const lblUnknown = document.getElementById('lblUnknown');
  const miscRefresh = document.getElementById('miscRefresh');
  const miscMeta   = document.getElementById('miscMeta');
  const miscCount  = document.getElementById('miscCount');
  const miscTableBody = document.getElementById('miscTableBody');
  const miscClearFilters = document.getElementById('miscClearFilters');

  function byLevel(level){
    if (level==='cat') return {select: selCategory, newWrap: newCategoryWrap};
    if (level==='sub') return {select: selSub, newWrap: newSubWrap};
    if (level==='ssub') return {select: selSubSub, newWrap: newSubSubWrap};
    if (level==='sss') return {select: selSubSubSub, newWrap: newSubSubSubWrap};
    return {};
  }

  function show(el, on){ el.classList.toggle('d-none', !on); }

  /* ---------- value + UI state ---------- */
  function readValues(){
    const cat  = getValue('cat');
    const sub  = cat ? getValue('sub') : '';
    const ssub = sub ? getValue('ssub') : '';
    const sss  = ssub ? getValue('sss') : '';
    return {cat, sub, ssub, sss};
  }

  function currentPath(){
    const {cat, sub, ssub, sss} = readValues();
    return [cat, sub, ssub, sss].filter(Boolean).join('/');
  }

  function updatePathPreview(){
    const p = currentPath();
    currentPathBadge.textContent = p ? p.replaceAll('/', ' › ') : '—';
  }

  function populateSelects(){
    const prev = {
      catSel: selCategory.value, subSel: selSub.value, ssubSel: selSubSub.value, sssSel: selSubSubSub.value,
      catNew: isNewMode.cat, subNew: isNewMode.sub, ssubNew: isNewMode.ssub, sssNew: isNewMode.sss,
      catVal: getValue('cat'), subVal: getValue('sub'), ssubVal: getValue('ssub')
    };

    setOptionsWithNew(selCategory, getAllCategories(), 'Select category…');
    if (!prev.catNew && prev.catSel && Array.from(selCategory.options).some(o => o.value === prev.catSel)){
      selCategory.value = prev.catSel;
    }

    const subs  = getSubs(prev.catVal);
    setOptionsWithNew(selSub, subs, subs.length ? 'Select subcategory…' : 'No subcategories — select to create…');
    if (!prev.subNew && prev.subSel && Array.from(selSub.options).some(o => o.value === prev.subSel)){
      selSub.value = prev.subSel;
    }

    const ssubs = getSSubs(prev.catVal, prev.subVal);
    setOptionsWithNew(selSubSub, ssubs, ssubs.length ? 'Select sub-subcategory…' : 'No sub-subcategories — select to create…');
    if (!prev.ssubNew && prev.ssubSel && Array.from(selSubSub.options).some(o => o.value === prev.ssubSel)){
      selSubSub.value = prev.ssubSel;
    }

    const sssubs = getSSSubs(prev.catVal, prev.subVal, prev.ssubVal);
    setOptionsWithNew(selSubSubSub, sssubs, sssubs.length ? 'Select sub-sub-subcategory…' : 'No deeper level — select to create…');
    if (prev.sssSel && Array.from(selSubSubSub.options).some(o => o.value === prev.sssSel)){
      selSubSubSub.value = prev.sssSel;
    }

    if (prev.catNew)  oneBarEnterNew('cat');  else oneBarExitNew('cat', false);
    if (prev.subNew)  oneBarEnterNew('sub');  else oneBarExitNew('sub', false);
    if (prev.ssubNew) oneBarEnterNew('ssub'); else oneBarExitNew('ssub', false);
    if (prev.sssNew)  oneBarEnterNew('sss');  else oneBarExitNew('sss', false);

    if (window.refreshGlassSelects) window.refreshGlassSelects();
  }

  function updateVisibility(){
    const {cat, sub, ssub} = readValues();
    show(wrapSub,  !!cat);
    show(wrapSSub, !!sub);
    show(wrapSSSb, !!ssub);
  }

  function updateEnablement(){
    const {cat, sub, ssub, sss} = readValues();
    let level='', label='';
    if (sss){ level='subsubsubcategory'; label=sss; }
    else if (ssub){ level='subsubcategory'; label=ssub; }
    else if (sub){ level='subcategory'; label=sub; }
    else if (cat){ level='category'; label=cat; }

    const ok = !!label && !!level && !!cat;
    btnSaveAll.disabled = !ok;
    submitHint.textContent = ok ? 'Ready to save.' : 'Pick or enter a Category to enable.';

    post_cat.value = cat || '';
    post_sub.value = sub || '';
    post_ssub.value = ssub || '';
    post_sss.value = sss || '';
    post_keyword.value = (kwInput.value || '').trim();
    post_target_level.value = level;
    post_target_label.value = label;

    updatePathPreview();
    updateVisibility();
    refreshKeywordsForPath(); // keep right-side keywords in sync
  }

  function onLevelChange(level){
    clearDescendants(level);
    populateSelects();
    updateEnablement();
  }

  function selectIfExists(selectEl, value){
    if (!value) return false;
    const ok = Array.from(selectEl.options).some(o => o.value === value);
    if (ok){ selectEl.value = value; }
    return ok;
  }

  function applyPathToLeft(pathStr){
    if (!pathStr) return;
    const parts = pathStr.split('>').map(s => s.trim()).filter(Boolean);
    ['cat','sub','ssub','sss'].forEach(l => oneBarExitNew(l, true));
    populateSelects();
    if (parts[0]){
      selectIfExists(selCategory, parts[0]);
      onLevelChange('cat');
    }
    if (parts[1]){
      selectIfExists(selSub, parts[1]);
      onLevelChange('sub');
    }
    if (parts[2]){
      selectIfExists(selSubSub, parts[2]);
      onLevelChange('ssub');
    }
    if (parts[3]){
      selectIfExists(selSubSubSub, parts[3]);
      onLevelChange('sss');
    }
    kwInput.focus();
  }
  window.applyPathToLeft = applyPathToLeft;

  /* ---------- Manage modal wiring (unchanged) ---------- */
  function buildManageBody(level, items){
    if (!items.length){
      return `<div class="text-center muted">No items at this level.</div>`;
    }
    return `
      <div class="table-responsive">
        <table class="table table-sm align-middle manage-table">
          <thead>
            <tr>
              <th style="width:60%">Name</th>
              <th class="text-end">Delete</th>
            </tr>
          </thead>
          <tbody>
            ${items.map(i => `
              <tr>
                <td><input type="text" class="form-control form-control-sm edit-name" data-old="${i}" value="${i}"></td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-danger btn-delete" data-name="${i}" type="button">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  function openManageModal(level, items, ctx){
    const title = {
      category: 'Manage Categories',
      subcategory: 'Manage Subcategories',
      subsubcategory: 'Manage Sub-subcategories',
      subsubsubcategory: 'Manage Sub-sub-subcategories'
    }[level] || 'Manage';

    document.getElementById('manageTitle').textContent = title;
    document.getElementById('manageBody').innerHTML = buildManageBody(level, items);

    const modalEl = document.getElementById('manageModal');
    const modal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(modalEl) : null;
    if (modal) modal.show();

    document.getElementById('saveManage').onclick = async () => {
      const edits = Array.from(document.querySelectorAll('.edit-name'))
        .map(inp => ({ old: inp.dataset.old, new: inp.value.trim() }));
      const deletes = Array.from(document.querySelectorAll('.btn-delete'))
        .filter(btn => btn.dataset.deleted === 'true')
        .map(btn => btn.dataset.name);

      const res = await fetch('/admin/api/manage_category', {
        method: 'POST',
        headers: headersJSON(),
        body: JSON.stringify({ level, ctx, edits, deletes, cascade: !!document.getElementById('chkCascade')?.checked })
      }).then(r => r.json()).catch(()=>({ok:false, error:'Network error'}));

      if (!res.ok){
        alert(res.error || 'Save failed');
        return;
      }
      if (modal) modal.hide();
      location.reload();
    };
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.manage-link');
    if (!btn) return;
    e.preventDefault();
    const level = btn.dataset.level;
    const { cat, sub, ssub } = readValues();
    let items = [];
    if (level === 'category') items = getAllCategories();
    if (level === 'subcategory') {
      if (!cat) { alert('Pick a Category first.'); return; }
      items = getSubs(cat);
    }
    if (level === 'subsubcategory') {
      if (!cat || !sub) { alert('Pick a Category and Subcategory first.'); return; }
      items = getSSubs(cat, sub);
    }
    if (level === 'subsubsubcategory') {
      if (!cat || !sub || !ssub) { alert('Pick a Category, Subcategory and Sub-subcategory first.'); return; }
      items = getSSSubs(cat, sub, ssub);
    }
    openManageModal(level, items, { cat, sub, ssub });
  });

  /* ---------- Keywords for current path (right card) ---------- */
  const kwpList   = document.getElementById('kwp-list');
  const kwpCount  = document.getElementById('kwp-count');
  const kwpNew    = document.getElementById('kwp-new');
  const kwpAddBtn = document.getElementById('kwp-add');
  const kwpStatus = document.getElementById('kwp-status');

  function setKwpMsg(msg, ok=true){
    kwpStatus.textContent = msg || '';
    kwpStatus.classList.toggle('text-danger', !ok);
  }

  function renderKwp(list){
    const arr = Array.isArray(list) ? list : (Array.isArray(list?.keywords) ? list.keywords : []);
    kwpCount.textContent = `${arr.length} keyword${arr.length===1?'':'s'}`;
    kwpList.innerHTML = arr.length ? arr.map(k=>`
      <span class="kwp-chip">
        <span>${k}</span>
        <button title="Remove" data-k="${k}">×</button>
      </span>
    `).join('') : '<span class="muted">No keywords yet.</span>';
  }

  async function fetchKeywords(path){
    if (!path){ renderKwp([]); return; }
    setKwpMsg('Loading…');
    try{
      const url = `${window.CL_URLS.KW_GET_URL}?${qs({ path })}`;
      const res = await fetch(url);
      const j = await res.json().catch(()=>({}));
      renderKwp(j);
      setKwpMsg('');
    }catch(e){
      setKwpMsg('Failed to load keywords', false);
    }
  }

  async function addKeyword(path, kw){
    if (!path || !kw) return;
    setKwpMsg('Adding…');
    try{
      const res = await fetch(window.CL_URLS.KW_ADD_URL, {
        method: 'POST',
        headers: headersJSON(),
        body: JSON.stringify({ path, keyword: kw })
      }).then(r => r.json());
      if (res && res.ok !== false){
        kwpNew.value = '';
        await fetchKeywords(path);
        setKwpMsg('Added.');
      }else{
        throw new Error(res?.error || 'Add failed');
      }
    }catch(e){
      setKwpMsg(String(e.message || e), false);
    }
  }

  async function removeKeyword(path, kw){
    if (!path || !kw) return;
    setKwpMsg('Removing…');
    try{
      const res = await fetch(window.CL_URLS.KW_REMOVE_URL, {
        method: 'POST',
        headers: headersJSON(),
        body: JSON.stringify({ path, keyword: kw })
      }).then(r => r.json());
      if (res && res.ok !== false){
        await fetchKeywords(path);
        setKwpMsg('Removed.');
      }else{
        throw new Error(res?.error || 'Remove failed');
      }
    }catch(e){
      setKwpMsg(String(e.message || e), false);
    }
  }

  function refreshKeywordsForPath(){
    fetchKeywords(currentPath());
  }

  kwpAddBtn.addEventListener('click', ()=>{
    const p = currentPath();
    const k = (kwpNew.value || '').trim();
    if (!p){ setKwpMsg('Pick a path first.', false); return; }
    if (!k){ setKwpMsg('Type a keyword.', false); return; }
    addKeyword(p, k);
  });

  kwpNew.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter'){
      e.preventDefault();
      kwpAddBtn.click();
    }
  });

  kwpList.addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-k]');
    if (!b) return;
    const p = currentPath();
    const k = b.dataset.k || '';
    if (confirm(`Remove keyword “${k}”?`)){
      removeKeyword(p, k);
    }
  });

  /* ---------- Misc + builder wiring ---------- */
  function miscLabelsParam(){
    const labs = [];
    if (lblMisc.checked) labs.push('Miscellaneous');
    if (lblUncat.checked) labs.push('Uncategorized');
    if (lblUnknown.checked) labs.push('Unknown');
    if (!labs.length) labs.push('Miscellaneous');
    return labs.join('|');
  }

  function setMiscLoading(){
    miscTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 muted">Loading…</td></tr>';
    miscCount.textContent = '—';
    miscMeta.textContent = '—';
  }

  function fmtAmt(n){
    try {
      const f = Number(n || 0);
      return (f < 0 ? '-' : '') + '$' + Math.abs(f).toFixed(2);
    } catch(e) { return n; }
  }

  async function fetchMisc(){
    setMiscLoading();
    const params = {
      labels: miscLabelsParam(),
      limit: miscLimit.value || '100',
      q: (miscSearch.value || '').trim(),
      min_abs: (miscMinAbs.value || '').trim()
    };
    const url = `/admin/categories/misc?${qs(params)}`;
    try{
      const r = await fetch(url);
      if (!r.ok) throw new Error(await r.text());
      const j = await r.json();
      renderMisc(j);
    }catch(err){
      miscTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">Failed to load: ${String(err)}</td></tr>`;
    }
  }

  function renderMisc(j){
    const rows = (j && j.transactions) ? j.transactions : [];
    miscMeta.textContent = j && j.as_of ? `as of ${j.as_of}` : '—';
    miscCount.textContent = `${rows.length} row(s)`;

    if (!rows.length){
      miscTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 muted">No rows.</td></tr>';
      return;
    }

    const html = rows.map(r => {
      const date = (r.date || '').slice(0,10);
      const desc = (r.desc || '');
      const amt  = fmtAmt(r.amount);
      const path = (r.path || '');
      const safeDesc = desc.replace(/"/g,'&quot;');
      const safePath = path.replace(/"/g,'&quot;');
      return `
        <tr>
          <td class="mono small">${date || '—'}</td>
          <td>${desc}</td>
          <td class="text-end mono">${amt}</td>
          <td>
            <a href="#" class="link-path small" data-path="${safePath}">${path}</a>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary btn-use" data-key="${safeDesc}">Use as keyword</button>
          </td>
        </tr>
      `;
    }).join('');
    miscTableBody.innerHTML = html;
  }

  document.addEventListener('click', (e) => {
    const useBtn = e.target.closest('.btn-use');
    if (useBtn){
      e.preventDefault();
      const val = (useBtn.dataset.key || '').trim().toUpperCase();
      if (val){
        kwInput.value = val;
        updateEnablement();
        kwInput.focus();
      }
    }
    const pathLink = e.target.closest('.link-path');
    if (pathLink){
      e.preventDefault();
      const p = pathLink.dataset.path || '';
      applyPathToLeft(p.replaceAll('/', ' > '));
    }
  });

  miscRefresh.addEventListener('click', fetchMisc);
  miscSearch.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); fetchMisc(); } });
  [miscSearch, miscMinAbs, miscLimit, lblMisc, lblUncat, lblUnknown].forEach(el => {
    el.addEventListener('change', fetchMisc);
  });
  miscClearFilters.addEventListener('click', (e)=>{
    e.preventDefault();
    miscSearch.value = '';
    miscMinAbs.value = '';
    miscLimit.value = '100';
    lblMisc.checked = lblUncat.checked = lblUnknown.checked = true;
    fetchMisc();
  });

  kwClearBtn.addEventListener('click', () => {
    kwInput.value = '';
    updateEnablement();
  });

  [selCategory, selSub, selSubSub, selSubSubSub].forEach((sel) => {
    sel.addEventListener('change', () => {
      const level = (sel === selCategory) ? 'cat' : (sel === selSub) ? 'sub' : (sel === selSubSub) ? 'ssub' : 'sss';
      if (sel.value === NEW_SENTINEL){
        oneBarEnterNew(level);
        clearDescendants(level);
        populateSelects();
        updateEnablement();
      } else {
        onLevelChange(level);
      }
    });
  });

  [inpCategory, inpSub, inpSubSub, inpSubSubSub].forEach(inp => {
    inp.addEventListener('input', () => {
      populateSelects();
      updateEnablement();
    });
  });

  document.querySelectorAll('.onebar-cancel').forEach(btn => {
    btn.addEventListener('click', () => {
      const level = btn.dataset.target;
      oneBarExitNew(level, true);
      populateSelects();
      updateEnablement();
    });
  });

  kwInput.addEventListener('input', updateEnablement);

  document.getElementById('formUpsert').addEventListener('submit', e => {
    updateEnablement();
    if (btnSaveAll.disabled) e.preventDefault();
  });

  // init
  populateSelects();
  updateVisibility();
  updateEnablement();
  fetchMisc();
</script>
{% endblock %}

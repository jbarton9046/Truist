{% extends "layout.html" %}
{% block content %}
<style>
  /* ============== Base ============== */
  .muted { color:#6c757d; }
  .mono { font-variant-numeric: tabular-nums; }
  .chip { display:inline-block; padding:.2rem .5rem; border:1px solid #dee2e6; border-radius:999px; margin:.1rem .25rem; font-size:.85rem; }
  .stat-card { border:1px solid #e9ecef; border-radius:.75rem; padding:.75rem; }

  /* one-bar chooser */
  .onebar { display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
  .onebar .onebar-new { display:flex; align-items:center; gap:.5rem; }
  .onebar .onebar-new.d-none { display:none !important; }
  .onebar .onebar-select.d-none { display:none !important; }

  /* modal table tweaks */
  .manage-table input.form-control-sm { min-width: 260px; }

  /* misc panel */
  .misc-card { border:1px solid #e9ecef; border-radius:.75rem; }
  .misc-table tbody tr td { vertical-align: middle; }
  .misc-controls .form-control, .misc-controls .form-select { height: 36px; }
  .misc-scroll { max-height: 60vh; overflow:auto; }
  .pointer { cursor:pointer; }

  /* --- Keyword Finder (light defaults to be themed below) --- */
  .kb-card { border-radius:1rem; border:1px solid #e9ecef; background:#fff; }
  .kb-card .kb-head { padding:.6rem .9rem; border-bottom:1px solid #edf2f7; }
  .kb-card .kb-body { padding:.75rem; }
  .kb-muted { color:#6c757d; }
  .kb-toolbar {
    position: sticky; top:.25rem; z-index:5; background:#fff; padding:.6rem .8rem;
    border:1px solid #eaecf0; border-radius:.75rem; box-shadow:0 1px 0 rgba(0,0,0,.02);
    margin-bottom: .75rem;
  }
  .kb-chip {
    display:inline-flex; align-items:center; gap:.35rem; text-decoration:none;
    padding:.2rem .55rem; border-radius:999px; background:#f1f3f5; color:#212529;
    border:1px solid #e9ecef; margin:.15rem .25rem 0 0; font-size:.9rem; cursor:pointer;
  }
  .kb-chip:hover { background:#e9ecef; }
  .kb-manage {
    display:inline-flex; align-items:center; gap:.35rem; text-decoration:none;
    padding:.15rem .5rem; border-radius:999px; background:#e7f1ff; color:#0a58ca;
    border:1px solid #cfe2ff; font-weight:600;
  }
  .kb-manage:hover { background:#dbe9ff; border-color:#b6d4fe; color:#0a58ca; }
  .kb-path { max-width:480px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .kb-table thead th { position:sticky; top:0; background:#fff; z-index:1; }

  /* ===========================
     Dark / glass overrides
     (tokens from layout.html)
     =========================== */

  /* Keywords Used: card + head */
  .kb-card{
    border-radius:16px;
    border:1px solid var(--card-border) !important;
    background: var(--card-bg) !important;
    color: var(--text);
    box-shadow: 0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter: saturate(120%) blur(4px);
  }
  .kb-card .kb-head{
    background: var(--thead-bg) !important;
    color: var(--text) !important;
    border-bottom:1px solid var(--hair) !important;
    font-weight:700; letter-spacing:.2px;
    border-top-left-radius:16px; border-top-right-radius:16px;
    -webkit-backdrop-filter:saturate(120%) blur(6px);
    backdrop-filter:saturate(120%) blur(6px);
  }

  /* List / container inside Keywords Used */
  #kwMiniList{ max-height:35vh; overflow:auto; background:transparent; isolation:isolate; }
  .kb-card .list-group{ border:1px solid var(--hair); border-radius:12px; background:transparent; }
  .kb-card .list-group-item{ background:transparent; color:var(--text); border-color:var(--hair); }
  .kb-card .list-group-item:hover{ background:rgba(255,255,255,.05); }

  /* Frosted sticky table headers (this page) */
  .misc-card .table thead th,
  .kb-table thead th{
    position: sticky;
    top: 0;
    z-index: 7;
    background: rgba(8,12,20,.78) !important;
    color: var(--text) !important;
    border-bottom:1px solid var(--hair) !important;
    font-weight:700; letter-spacing:.2px;
    padding:.65rem .9rem;
    -webkit-backdrop-filter: saturate(130%) blur(16px);
    backdrop-filter: saturate(130%) blur(16px);
    box-shadow:
      inset 0 1px 0 rgba(255,255,255,.05),
      0 10px 18px rgba(2, 6, 23, .25);
  }
  .misc-card .table thead th:first-child{ border-top-left-radius:12px; }
  .misc-card .table thead th:last-child{  border-top-right-radius:12px; }

  /* === Keywords Used counts: ghost blue numbers (no pill), floated right === */
  #kwMiniList .list-group-item{
    position: relative;
    padding-right: 40px;
    font-family: inherit;
  }
  #kwMiniList .list-group-item .badge{
    position: absolute;
    top: 50%;
    right: 12px;
    transform: translateY(-50%);
    background: transparent !important;
    border: 0 !important;
    box-shadow: none !important;
    color: var(--link, #9ec5ff) !important;
    font-weight: 700;
    font-size: .95rem;
    line-height: 1;
    padding: 0;
    min-width: 0;
    width: auto;
    height: auto;
    pointer-events: none;
    text-shadow: 0 0 10px rgba(158,197,255,.35);
  }
  #kwMiniList .list-group-item .badge.rounded-pill{ border-radius: 0 !important; }

  /* Helper/hint text to match theme */
  .form-text, #submitHint { color: var(--muted) !important; }
  #kwMiniFilter.form-control{
    background: color-mix(in oklab, var(--card-bg) 85%, #000 0%);
    color: var(--text);
    border: 1px solid var(--hair);
  }
  #kwMiniFilter::placeholder{
    color: color-mix(in oklab, var(--muted) 90%, transparent);
    opacity: 1;
  }

  /* Bits you asked to hide (DOM remains for JS) */
  #miscMeta{ display:none !important; }
  #kbTip{ display:none !important; }
  #kwMiniDetails .kb-placeholder{ display:none !important; }

  /* ============= GLASS SELECT (non-destructive wrapper) ============= */
  .gs-wrap{ position:relative; width:100%; }
  .gs-native{
    position:absolute; inset:0; width:100%; height:100%;
    opacity:0; pointer-events:none;
  }
  .gs-trigger{
    width:100%; display:flex; align-items:center; justify-content:space-between; gap:.5rem;
    padding:.55rem .9rem; border-radius:12px; cursor:pointer; user-select:none;
    background: color-mix(in oklab, var(--card-bg) 90%, transparent);
    color: var(--text); border:1px solid var(--hair);
    box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 4px 14px rgba(0,0,0,.25);
  }
  .gs-trigger:focus-visible{ outline:2px solid #80b3ff; outline-offset:2px; }
  .gs-label{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .gs-caret{ opacity:.8; }

  /* Popup itself (will be portaled to body on open) */
  .gs-popup{
    position: fixed;
    min-width: 240px;
    max-height:320px; overflow:auto;
    z-index:1051;
    padding:6px; border-radius:14px; border:1px solid var(--card-border);
    background: color-mix(in oklab, var(--card-bg) 82%, transparent);
    -webkit-backdrop-filter: blur(18px) saturate(140%);
    backdrop-filter: blur(18px) saturate(140%);
    box-shadow: 0 18px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
  }
  .gs-list{ margin:0; padding:0; list-style:none; }
  .gs-option{
    padding:.6rem .75rem; border-radius:10px; display:flex; align-items:center; gap:.5rem; cursor:pointer;
    color: var(--text);
  }
  .gs-option:hover, .gs-option[aria-current="true"]{ background:rgba(255,255,255,.06) }
  .gs-option[aria-selected="true"]{
    background:rgba(129,196,255,.10); box-shadow:inset 0 0 0 1px rgba(129,196,255,.35)
  }
  .gs-option[data-disabled="true"]{ color: var(--muted); cursor:default; }
  .gs-divider{ height:1px; margin:6px 0; background:var(--hair); opacity:.8; border-radius:1px; }

  /* NEW: the blur layer behind the popup (like drawer) */
  .gs-scrim{
    position:fixed; inset:0; z-index:1040;
    -webkit-backdrop-filter: blur(14px) saturate(140%);
    backdrop-filter: blur(14px) saturate(140%);
    background: rgba(8,12,20,.28);
  }

  /* ---- tiny entrance animations for glass select ---- */
  @keyframes gsPopIn { from { opacity: 0; transform: translateY(6px) scale(.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
  @keyframes gsFadeIn { from { opacity: 0; } to { opacity: 1; } }
  .gs-popup{ animation: gsPopIn .14s ease-out; transform-origin: top left; will-change: transform, opacity; }
  .gs-scrim{ animation: gsFadeIn .12s ease-out; will-change: opacity; }
</style>

<div class="container-fluid my-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="m-0">🧩 Category Builder</h2>
    <!-- NEW: Category → Recurring button -->
    <div class="d-flex align-items-center gap-2">
      <button id="btnCatToRecurring" class="btn btn-sm btn-primary">Add category to Recurring</button>
    </div>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else ('warning' if category=='warning' else ('danger' if category=='danger' else 'info')) }} mb-2">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ========================= -->
  <!-- Row 1: Keywords | Build   -->
  <!-- ========================= -->
  <div class="row g-3">

    <!-- 1) Keywords Used -->
    <div class="col-12 col-xl-6">
      <div class="kb-card">
        <div class="kb-head d-flex justify-content-between align-items-center">
          <div class="fw-semibold">Keywords Used</div>
          <div class="small kb-muted"><span id="kwMiniTotal">0</span> total</div>
        </div>
        <div class="kb-body">
          <input id="kwMiniFilter" class="form-control form-control-sm mb-2" placeholder="Filter keywords…">
          <div class="list-group small" id="kwMiniList" style="max-height:35vh; overflow:auto;"></div>

          <div class="mt-2" id="kwMiniDetails" style="max-height:20vh; overflow:auto;">
            <div class="small kb-muted kb-placeholder">Select a keyword to see its categories.</div>
          </div>
        </div>
      </div>
      <div class="small kb-muted mt-2" id="kbTip">
        Tip: Click a <strong>path</strong> to load it into the builder on the right.
      </div>

      <!-- CFG JSON + parse (one source of truth) -->
      <script id="cfg-json" type="application/json">
        {{ cfg | default({}) | tojson | safe }}
      </script>
      <script>
        window.CFG = window.CFG || JSON.parse(document.getElementById('cfg-json').textContent || '{}');
      </script>

      <!-- Compact keywords logic (5-path cap + Show all) -->
      <script>
        (function(){
          const CFG = window.CFG || {};
          const elFilter  = document.getElementById('kwMiniFilter');
          const elList    = document.getElementById('kwMiniList');
          const elTotal   = document.getElementById('kwMiniTotal');
          const elDetails = document.getElementById('kwMiniDetails');

          const MAX_PATHS_SHOWN = 5;
          const norm = s => String(s||'').trim().toLowerCase();

          function collectAllKeywordsAndPaths(cfg){
            const kwSet = new Map();     // normalized -> display
            const pathsByKw = new Map(); // normalized -> Set(paths)

            function add(kw, pathArr){
              const n = norm(kw);
              if (!n) return;
              if (!kwSet.has(n)) kwSet.set(n, String(kw).trim());
              const path = pathArr.filter(Boolean).join(' > ');
              if (!pathsByKw.has(n)) pathsByKw.set(n, new Set());
              pathsByKw.get(n).add(path);
            }

            Object.entries(cfg.CATEGORY_KEYWORDS || {}).forEach(([cat, kws])=>{
              (kws||[]).forEach(kw=> add(kw, [cat]));
            });
            Object.entries(cfg.SUBCATEGORY_MAPS || {}).forEach(([cat, subs])=>{
              Object.entries(subs||{}).forEach(([sub, kws])=>{
                (kws||[]).forEach(kw=> add(kw, [cat, sub]));
              });
            });
            Object.entries(cfg.SUBSUBCATEGORY_MAPS || {}).forEach(([cat, subs])=>{
              Object.entries(subs||{}).forEach(([sub, ssubs])=>{
                Object.entries(ssubs||{}).forEach(([ssub, kws])=>{
                  (kws||[]).forEach(kw=> add(kw, [cat, sub, ssub]));
                });
              });
            });
            Object.entries(cfg.SUBSUBSUBCATEGORY_MAPS || {}).forEach(([cat, subs])=>{
              Object.entries(subs||{}).forEach(([sub, ssubs])=>{
                Object.entries(ssubs||{}).forEach(([ssub, ssss])=>{
                  Object.entries(ssss||{}).forEach(([sss, kws])=>{
                    (kws||[]).forEach(kw=> add(kw, [cat, sub, ssub, sss]));
                  });
                });
              });
            });

            const stats = cfg.KEYWORD_STATS || {};
            const countFor = (display)=>{
              const s = stats[display] || stats[display?.toUpperCase?.()] || stats[display?.toLowerCase?.()];
              return s && typeof s.count === 'number' ? s.count : undefined;
            };

            return Array.from(kwSet.entries()).map(([n, display])=>{
              const paths = Array.from(pathsByKw.get(n) || []);
              return { n, display, paths, pathsCount: paths.length, usage: countFor(display) };
            });
          }

          const ALL = collectAllKeywordsAndPaths(CFG).sort((a,b)=> a.display.localeCompare(b.display));
          elTotal.textContent = ALL.length;

          function renderList(q=''){
            const query = norm(q);
            elList.innerHTML = '';
            let shown = 0;
            ALL.forEach(item=>{
              if (query && !item.display.toLowerCase().includes(query)) return;
              shown++;
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
              btn.dataset.kw = item.display;

              const left = document.createElement('span');
              left.textContent = item.display;

              const right = document.createElement('span');
              right.className = 'badge rounded-pill text-bg-light';
              right.textContent = item.pathsCount;

              btn.appendChild(left);
              btn.appendChild(right);
              elList.appendChild(btn);
            });
            if (!shown) {
              const li = document.createElement('div');
              li.className = 'list-group-item text-muted';
              li.textContent = 'No keywords match your filter.';
              elList.appendChild(li);
            }
          }

          function renderDetailsFor(keyword, showAll=false){
            const n = norm(keyword);
            const item = ALL.find(i => i.n === n);
            if (!item){
              elDetails.innerHTML = '<div class="small kb-muted">Select a keyword to see its categories.</div>';
              return;
            }

            const total = item.paths.length;
            const visible = showAll ? item.paths : item.paths.slice(0, MAX_PATHS_SHOWN);

            const lines = visible.map(p => {
              const esc = p.replace(/"/g,'&quot;');
              return `<li class="mb-1">
                <span class="badge bg-secondary-subtle text-secondary-emphasis">${p || '—'}</span>
                <a href="#" class="ms-2 small kw-path" data-path="${esc}">Use path</a>
              </li>`;
            }).join('');

            const usage = (typeof item.usage === 'number') ? `<span class="ms-2 small kb-muted">• ${item.usage} seen</span>` : '';
            const more = (!showAll && total > MAX_PATHS_SHOWN)
              ? `<div class="mt-1"><a href="#" class="small kw-show-all" data-kw="${item.display}">Show all (${total - MAX_PATHS_SHOWN} more)</a></div>`
              : '';

            elDetails.innerHTML =
              `<div class="small">
                <div class="mb-1"><strong>${item.display}</strong> used in ${item.pathsCount} path(s) ${usage}</div>
                <ul class="ps-3 mb-2" style="max-height:20vh; overflow:auto;">${lines || '<li class="kb-muted">No paths found.</li>'}</ul>
                ${more}
              </div>`;
          }

          elFilter.addEventListener('input', (e)=> renderList(e.target.value));
          elList.addEventListener('click', (e)=>{
            const btn = e.target.closest('.list-group-item');
            if (!btn) return;
            renderDetailsFor(btn.dataset.kw);
          });
          elDetails.addEventListener('click', (e)=>{
            const aPath = e.target.closest('.kw-path');
            if (aPath){
              e.preventDefault();
              const path = aPath.dataset.path || '';
              if (typeof window.applyPathToLeft === 'function') {
                window.applyPathToLeft(path);
              }
              return;
            }
            const aAll = e.target.closest('.kw-show-all');
            if (aAll){
              e.preventDefault();
              renderDetailsFor(aAll.dataset.kw, true);
            }
          });

          renderList('');
        })();
      </script>
    </div>

    <!-- 2) Build Path & Keyword -->
    <div class="col-12 col-xl-6">
      <form id="formUpsert" method="POST" action="{{ url_for('admin_categories.upsert_path_and_keyword') }}">
        <div class="card shadow-sm">
          <div class="card-header fw-bold">Build Path &amp; Add Keyword</div>
          <div class="card-body">
            <div class="row g-3">

              <!-- Category -->
              <div class="col-12" id="wrap-cat">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Category</span>
                  <button type="button" class="btn btn-link p-0 align-baseline manage-link" data-level="category">Manage</button>
                  <span class="text-muted">·</span>
                  <a href="#" class="link-manage" title="Manage in drawer" data-manage data-level="category">View drawer</a>
                </label>
                <div class="onebar" data-level="cat">
                  <select id="selCategory" class="form-select onebar-select"></select>
                  <div class="onebar-new d-none" id="newCategoryWrap">
                    <input id="inpCategory" class="form-control" placeholder="New category name">
                    <button type="button" class="btn btn-outline-secondary btn-sm onebar-cancel" data-target="cat">Select existing</button>
                  </div>
                </div>
              </div>

              <!-- Subcategory -->
              <div class="col-12 d-none" id="wrap-sub">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Subcategory</span>
                  <button type="button" class="btn btn-link p-0 align-baseline manage-link" data-level="subcategory">Manage</button>
                  <span class="text-muted">·</span>
                  <a href="#" class="link-manage" title="Manage in drawer" data-manage data-level="subcategory">View drawer</a>
                </label>
                <div class="onebar" data-level="sub">
                  <select id="selSub" class="form-select onebar-select"></select>
                  <div class="onebar-new d-none" id="newSubWrap">
                    <input id="inpSub" class="form-control" placeholder="New subcategory name">
                    <button type="button" class="btn btn-outline-secondary btn-sm onebar-cancel" data-target="sub">Select existing</button>
                  </div>
                </div>
              </div>

              <!-- Sub-subcategory -->
              <div class="col-12 d-none" id="wrap-ssub">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Sub-subcategory</span>
                  <button type="button" class="btn btn-link p-0 align-baseline manage-link" data-level="subsubcategory">Manage</button>
                  <span class="text-muted">·</span>
                  <a href="#" class="link-manage" title="Manage in drawer" data-manage data-level="subsubcategory">View drawer</a>
                </label>
                <div class="onebar" data-level="ssub">
                  <select id="selSubSub" class="form-select onebar-select"></select>
                  <div class="onebar-new d-none" id="newSubSubWrap">
                    <input id="inpSubSub" class="form-control" placeholder="New sub-subcategory name">
                    <button type="button" class="btn btn-outline-secondary btn-sm onebar-cancel" data-target="ssub">Select existing</button>
                  </div>
                </div>
              </div>

              <!-- Sub-sub-subcategory -->
              <div class="col-12 d-none" id="wrap-sssb">
                <label class="form-label d-flex align-items-center gap-2">
                  <span>Sub-sub-subcategory</span>
                  <button type="button" class="btn btn-link p-0 align-baseline manage-link" data-level="subsubsubcategory">Manage</button>
                  <span class="text-muted">·</span>
                  <a href="#" class="link-manage" title="Manage in drawer" data-manage data-level="subsubsubcategory">View drawer</a>
                </label>
                <div class="onebar" data-level="sss">
                  <select id="selSubSubSub" class="form-select onebar-select"></select>
                  <div class="onebar-new d-none" id="newSubSubSubWrap">
                    <input id="inpSubSubSub" class="form-control" placeholder="New sub-sub-subcategory name">
                    <button type="button" class="btn btn-outline-secondary btn-sm onebar-cancel" data-target="sss">Select existing</button>
                  </div>
                </div>
              </div>

              <hr class="mt-2 mb-1">

              <!-- Optional Keyword -->
              <div class="col-12">
                <label class="form-label">Keyword (optional)</label>
                <div class="input-group">
                  <input type="text" class="form-control" id="kw_input" placeholder="e.g., COSTCO">
                  <button type="button" id="kw_clear" class="btn btn-outline-secondary">Clear</button>
                </div>
                <div class="form-text">Tip: click “Use path” in the Keywords panel to auto-fill selections here.</div>
              </div>

              <div class="col-12">
                <div class="muted small mb-1">Current path</div>
                <div id="currentPathBadge" class="badge bg-secondary">—</div>
              </div>

              <div class="col-12">
                <button type="submit" id="btnSaveAll" class="btn btn-primary" disabled>Save Path</button>
                <small class="form-text text-muted" id="submitHint">Pick or enter a Category to enable.</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Hidden posts for UPSERT -->
        <input type="hidden" name="cat" id="post_cat">
        <input type="hidden" name="sub" id="post_sub">
        <input type="hidden" name="ssub" id="post_ssub">
        <input type="hidden" name="sss" id="post_sss">
        <input type="hidden" name="keyword" id="post_keyword">
        <input type="hidden" name="target_level" id="post_target_level">
        <input type="hidden" name="target_label" id="post_target_label">
      </form>
    </div>
  </div>

  <!-- ========================= -->
  <!-- Row 2: Misc underneath    -->
  <!-- ========================= -->
  <div class="row g-3 mt-1">
    <div class="col-12">
      <div class="card misc-card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-bold">🧭 Misc Transactions</div>
          <div class="d-flex align-items-center gap-2">
            <div class="small muted me-2" id="miscMeta">—</div>
            <button id="miscRefresh" class="btn btn-outline-primary btn-sm" type="button">Refresh</button>
          </div>
        </div>

        <div class="card-body">
          <div class="d-none">
            <input type="text" id="miscSearch" value="">
            <input type="number" step="0.01" id="miscMinAbs" value="">
            <select id="miscLimit">
              <option>50</option>
              <option selected>100</option>
              <option>200</option>
              <option>300</option>
              <option>500</option>
            </select>
            <input class="form-check-input" type="checkbox" id="lblMisc" checked>
            <input class="form-check-input" type="checkbox" id="lblUncat" checked>
            <input class="form-check-input" type="checkbox" id="lblUnknown" checked>
            <a href="#" id="miscClearFilters">Clear filters</a>
          </div>

          <div class="misc-scroll">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle misc-table">
                <thead>
                  <tr class="small text-muted">
                    <th style="width: 92px;">Date</th>
                    <th>Description</th>
                    <th class="text-end" style="width: 110px;">Amount</th>
                    <th style="width: 30%;">Path</th>
                    <th class="text-end" style="width: 110px;">Action</th>
                  </tr>
                </thead>
                <tbody id="miscTableBody">
                  <tr><td colspan="5" class="text-center py-4 muted">Loading…</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between mt-2">
            <div class="small muted" id="miscCount">—</div>
            <div class="small d-none"><a href="#" id="miscClearFilters2">Clear filters</a></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Modal (unchanged) -->
  <div class="modal fade" id="manageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="manageTitle">Manage</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="manageBody">
          <!-- filled by JS -->
        </div>
        <div class="modal-footer">
          <div class="me-auto d-flex align-items-center gap-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="chkCascade">
              <label class="form-check-label" for="chkCascade">Cascade delete children & keywords</label>
            </div>
            <button class="btn btn-outline-secondary btn-sm" id="btnPreviewCascade" type="button">Preview impact</button>
            <span class="muted small" id="cascadePreview" style="display:none;">Preview: —</span>
          </div>
          <button class="btn btn-primary" id="saveManage" type="button">Save Changes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: Add Category → Recurring (modal) -->
  <div class="modal fade" id="catToRecurringModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Category to Recurring</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <div class="col-12 col-md-6">
              <label class="form-label">Category</label>
              <select id="rcCat" class="form-select form-select-sm"></select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Subcategory</label>
              <select id="rcSub" class="form-select form-select-sm"></select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Sub-subcategory</label>
              <select id="rcSsub" class="form-select form-select-sm"></select>
            </div>
            <div class="col-12 col-md-6">
              <label class="form-label">Sub-sub-sub</label>
              <select id="rcSss" class="form-select form-select-sm"></select>
            </div>

            <div class="col-12">
              <div class="small text-muted" id="rcMeta">—</div>
            </div>

            <div class="col-12">
              <label class="form-label">Proposed keywords (edit as needed)</label>
              <input id="rcKeywords" class="form-control" placeholder="e.g. NETFLIX; NETFLIX.COM; *NETFLIX*">
              <div class="form-text">Semicolon-separated. We’ll create rules from these and attach to this category path.</div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Amount rule</label>
              <select id="rcAmountMode" class="form-select form-select-sm">
                <option value="none">Ignore amount</option>
                <option value="median">≈ median ±10%</option>
                <option value="tight">≈ median ±3%</option>
              </select>
              <div class="form-text" id="rcAmtHint">—</div>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Frequency hint</label>
              <select id="rcFreq" class="form-select form-select-sm">
                <option value="">Auto-detect</option>
                <option>Monthly</option>
                <option>Biweekly</option>
                <option>Quarterly</option>
                <option>Annual</option>
              </select>
            </div>

            <div class="col-12 col-md-4">
              <label class="form-label">Lookback window</label>
              <select id="rcLookback" class="form-select form-select-sm">
                <option value="90">90 days</option>
                <option value="180">180 days</option>
                <option value="365" selected>365 days</option>
                <option value="all">All time</option>
              </select>
            </div>

            <div class="col-12 mt-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="rcSimulate" checked>
                <label class="form-check-label" for="rcSimulate">Preview first (don’t save yet)</label>
              </div>
            </div>

            <div class="col-12">
              <div class="border rounded p-2 small" id="rcPreviewBox" style="min-height:80px;">
                <div class="text-muted">Pick a path and click Preview.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" id="rcPreview" class="btn btn-outline-primary">Preview</button>
          <button type="button" id="rcConfirm" class="btn btn-primary">Add to Recurring</button>
        </div>
      </div>
    </div>
  </div>

  <div id="manageArea" class="mt-4 d-none"></div>
</div>



<script>
  // Safe defaults so Keyword Finder / drawer work even if CL_URLS isn’t injected from layout
  window.CL_URLS = Object.assign({
    KW_GET_URL: '/admin/api/keywords_for_name',
    KW_ADD_URL: '/admin/api/keyword_add',
    KW_REMOVE_URL: '/admin/api/keyword_remove',
    INSPECT_URL: '/admin/categories/inspect',
    RENAME_URL: '/admin/categories/rename',
    UPSERT_URL: '/admin/categories/upsert_child'
  }, window.CL_URLS || {});
</script>

<script>
  const CFG = window.CFG || {};

  /* ---------- data access ---------- */
  function getAllCategories() {
    const a = new Set(Object.keys(CFG.SUBCATEGORY_MAPS || {}));
    Object.keys(CFG.CATEGORY_KEYWORDS || {}).forEach(k => a.add(k));
    Object.keys(CFG.SUBSUBCATEGORY_MAPS || {}).forEach(k => a.add(k));
    Object.keys(CFG.SUBSUBSUBCATEGORY_MAPS || {}).forEach(k => a.add(k));
    return Array.from(a).sort();
  }
  function getSubs(cat) {
    const m = CFG.SUBCATEGORY_MAPS || {};
    return cat && m[cat] ? Object.keys(m[cat]).sort() : [];
  }
  function getSSubs(cat, sub) {
    const m = CFG.SUBSUBCATEGORY_MAPS || {};
    return (cat && sub && m[cat] && m[cat][sub]) ? Object.keys(m[cat][sub]).sort() : [];
  }
  function getSSSubs(cat, sub, ssub) {
    const m = CFG.SUBSUBSUBCATEGORY_MAPS || {};
    return (cat && sub && ssub && m[cat] && m[cat][sub] && m[cat][sub][ssub]) ? Object.keys(m[cat][sub][ssub]).sort() : [];
  }

  /* ---------- one-bar helpers ---------- */
  const NEW_SENTINEL = '__NEW__';
  const isNewMode = { cat:false, sub:false, ssub:false, sss:false };

  function setOptionsWithNew(select, list, placeholder='Select…', includeNew=true){
    const prev = select.value;
    select.innerHTML = '';

    const ph = document.createElement('option');
    ph.value = ''; ph.textContent = placeholder; ph.disabled = true; ph.selected = true;
    select.appendChild(ph);

    if (includeNew){
      const newOpt = document.createElement('option');
      newOpt.value = NEW_SENTINEL; newOpt.textContent = '＋ Create new…';
      select.appendChild(newOpt);
    }

    list.forEach(v => {
      const o = document.createElement('option'); o.value = v; o.textContent = v; select.appendChild(o);
    });

    if (prev && Array.from(select.options).some(o => o.value === prev)){
      select.value = prev;
    } else {
      select.selectedIndex = 0;
    }
  }

  function oneBarEnterNew(level){
    const {select, newWrap} = byLevel(level);
    isNewMode[level] = true;
    select.classList.add('d-none'); newWrap.classList.remove('d-none');
    const input = newWrap.querySelector('input');
    setTimeout(()=>input.focus(), 0);
  }
  function oneBarExitNew(level, clearValue=true){
    const {select, newWrap} = byLevel(level);
    isNewMode[level] = false;
    newWrap.classList.add('d-none'); select.classList.remove('d-none');
    if (clearValue){ select.value = ''; }
  }
  function getValue(level){
    const {select, newWrap} = byLevel(level);
    if (!newWrap.classList.contains('d-none')) {
      return (newWrap.querySelector('input').value || '').trim();
    }
    const v = select.value;
    return (v === NEW_SENTINEL ? '' : (v || ''));
  }
  function clearDescendants(fromLevel){
    const order = ['cat','sub','ssub','sss'];
    const idx = order.indexOf(fromLevel);
    for (let i=idx+1; i<order.length; i++){
      oneBarExitNew(order[i], true);
      const s = byLevel(order[i]).select;
      s.value = '';
    }
  }

  /* ---------- DOM refs ---------- */
  const wrapSub  = document.getElementById('wrap-sub');
  const wrapSSub = document.getElementById('wrap-ssub');
  const wrapSSSb = document.getElementById('wrap-sssb');

  const selCategory   = document.getElementById('selCategory');
  const selSub        = document.getElementById('selSub');
  const selSubSub     = document.getElementById('selSubSub');
  const selSubSubSub  = document.getElementById('selSubSubSub');

  const inpCategory   = document.getElementById('inpCategory');
  const inpSub        = document.getElementById('inpSub');
  const inpSubSub     = document.getElementById('inpSubSub');
  const inpSubSubSub  = document.getElementById('inpSubSubSub');

  const newCategoryWrap = document.getElementById('newCategoryWrap');
  const newSubWrap      = document.getElementById('newSubWrap');
  const newSubSubWrap   = document.getElementById('newSubSubWrap');
  const newSubSubSubWrap= document.getElementById('newSubSubSubWrap');

  const kwInput = document.getElementById('kw_input');
  const btnSaveAll = document.getElementById('btnSaveAll');
  const submitHint = document.getElementById('submitHint');
  const currentPathBadge = document.getElementById('currentPathBadge');
  const kwClearBtn = document.getElementById('kw_clear');

  const post_cat = document.getElementById('post_cat');
  const post_sub = document.getElementById('post_sub');
  const post_ssub = document.getElementById('post_ssub');
  const post_sss = document.getElementById('post_sss');
  const post_keyword = document.getElementById('post_keyword');
  const post_target_level = document.getElementById('post_target_level');
  const post_target_label = document.getElementById('post_target_label');

  /* Misc panel DOM */
  const miscSearch = document.getElementById('miscSearch');
  const miscMinAbs = document.getElementById('miscMinAbs');
  const miscLimit  = document.getElementById('miscLimit');
  const lblMisc    = document.getElementById('lblMisc');
  const lblUncat   = document.getElementById('lblUncat');
  const lblUnknown = document.getElementById('lblUnknown');
  const miscRefresh = document.getElementById('miscRefresh');
  const miscMeta   = document.getElementById('miscMeta');
  const miscCount  = document.getElementById('miscCount');
  const miscTableBody = document.getElementById('miscTableBody');
  const miscClearFilters = document.getElementById('miscClearFilters');

  function byLevel(level){
    if (level==='cat') return {select: selCategory, newWrap: newCategoryWrap};
    if (level==='sub') return {select: selSub, newWrap: newSubWrap};
    if (level==='ssub') return {select: selSubSub, newWrap: newSubSubWrap};
    if (level==='sss') return {select: selSubSubSub, newWrap: newSubSubSubWrap};
    return {};
  }

  function show(el, on){ el.classList.toggle('d-none', !on); }

  /* ---------- value + UI state ---------- */
  function readValues(){
    const cat  = getValue('cat');
    const sub  = cat ? getValue('sub') : '';
    const ssub = sub ? getValue('ssub') : '';
    const sss  = ssub ? getValue('sss') : '';
    return {cat, sub, ssub, sss};
  }

  function updatePathPreview(){
    const {cat, sub, ssub, sss} = readValues();
    const parts = [cat, sub, ssub, sss].filter(Boolean);
    currentPathBadge.textContent = parts.length ? parts.join(' › ') : '—';
  }

  function populateSelects(){
    const prev = {
      catSel: selCategory.value, subSel: selSub.value, ssubSel: selSubSub.value, sssSel: selSubSubSub.value,
      catNew: isNewMode.cat, subNew: isNewMode.sub, ssubNew: isNewMode.ssub, sssNew: isNewMode.sss,
      catVal: getValue('cat'), subVal: getValue('sub'), ssubVal: getValue('ssub')
    };

    setOptionsWithNew(selCategory, getAllCategories(), 'Select category…');
    if (!prev.catNew && prev.catSel && Array.from(selCategory.options).some(o => o.value === prev.catSel)){
      selCategory.value = prev.catSel;
    }

    const subs  = getSubs(prev.catVal);
    setOptionsWithNew(selSub, subs, subs.length ? 'Select subcategory…' : 'No subcategories — select to create…');
    if (!prev.subNew && prev.subSel && Array.from(selSub.options).some(o => o.value === prev.subSel)){
      selSub.value = prev.subSel;
    }

    const ssubs = getSSubs(prev.catVal, prev.subVal);
    setOptionsWithNew(selSubSub, ssubs, ssubs.length ? 'Select sub-subcategory…' : 'No sub-subcategories — select to create…');
    if (!prev.ssubNew && prev.ssubSel && Array.from(selSubSub.options).some(o => o.value === prev.ssubSel)){
      selSubSub.value = prev.ssubSel;
    }

    const sssubs = getSSSubs(prev.catVal, prev.subVal, prev.ssubVal);
    setOptionsWithNew(selSubSubSub, sssubs, sssubs.length ? 'Select sub-sub-subcategory…' : 'No deeper level — select to create…');
    if (prev.sssSel && Array.from(selSubSubSub.options).some(o => o.value === prev.sssSel)){
      selSubSubSub.value = prev.sssSel;
    }

    if (prev.catNew)  oneBarEnterNew('cat');  else oneBarExitNew('cat', false);
    if (prev.subNew)  oneBarEnterNew('sub');  else oneBarExitNew('sub', false);
    if (prev.ssubNew) oneBarEnterNew('ssub'); else oneBarExitNew('ssub', false);
    if (prev.sssNew)  oneBarEnterNew('sss');  else oneBarExitNew('sss', false);

    /* refresh custom glass selects after options change */
    if (window.refreshGlassSelects) window.refreshGlassSelects();
  }

  function updateVisibility(){
    const {cat, sub, ssub} = readValues();
    show(wrapSub,  !!cat);
    show(wrapSSub, !!sub);
    show(wrapSSSb, !!ssub);
  }

  function updateEnablement(){
    const {cat, sub, ssub, sss} = readValues();
    let level='', label='';
    if (sss){ level='subsubsubcategory'; label=sss; }
    else if (ssub){ level='subsubcategory'; label=ssub; }
    else if (sub){ level='subcategory'; label=sub; }
    else if (cat){ level='category'; label=cat; }

    const ok = !!label && !!level && !!cat;
    btnSaveAll.disabled = !ok;
    submitHint.textContent = ok ? 'Ready to save.' : 'Pick or enter a Category to enable.';

    post_cat.value = cat || '';
    post_sub.value = sub || '';
    post_ssub.value = ssub || '';
    post_sss.value = sss || '';
    post_keyword.value = (kwInput.value || '').trim();
    post_target_level.value = level;
    post_target_label.value = label;

    updatePathPreview();
    updateVisibility();
  }

  function onLevelChange(level){
    clearDescendants(level);
    populateSelects();
    updateEnablement();
  }

  function selectIfExists(selectEl, value){
    if (!value) return false;
    const ok = Array.from(selectEl.options).some(o => o.value === value);
    if (ok){ selectEl.value = value; }
    return ok;
  }

  function applyPathToLeft(pathStr){
    if (!pathStr) return;
    const parts = pathStr.split('>').map(s => s.trim()).filter(Boolean);
    ['cat','sub','ssub','sss'].forEach(l => oneBarExitNew(l, true));
    populateSelects();
    if (parts[0]){
      selectIfExists(selCategory, parts[0]);
      onLevelChange('cat');
    }
    if (parts[1]){
      selectIfExists(selSub, parts[1]);
      onLevelChange('sub');
    }
    if (parts[2]){
      selectIfExists(selSubSub, parts[2]);
      onLevelChange('ssub');
    }
    if (parts[3]){
      selectIfExists(selSubSubSub, parts[3]);
      onLevelChange('sss');
    }
    kwInput.focus();
  }
  /* make available to Keyword panel script */
  window.applyPathToLeft = applyPathToLeft;

  /* ---------- manage area (modal) ---------- */
  function qs(obj){
    const sp = new URLSearchParams();
    Object.entries(obj).forEach(([k,v]) => { if (v !== undefined && v !== null) sp.set(k, v); });
    return sp.toString();
  }

  async function previewCascadeTotals(level, ctx, names){
    let totals = { nodes: 0, keywords: 0, transactions: 0, okCount: 0 };
    for (const name of names){
      const params = { level, cat: ctx.cat || '', sub: ctx.sub || '', ssub: ctx.ssub || '', sss: '' };
      if (level === 'category') { params.cat = name; params.sub = params.ssub = params.sss = ''; }
      if (level === 'subcategory') { params.sub = name; params.ssub = params.sss = ''; }
      if (level === 'subsubcategory') { params.ssub = name; params.sss = ''; }
      if (level === 'subsubsubcategory') { params.sss = name; }
      try{
        const r = await fetch(`/admin/categories/cascade_preview?${qs(params)}`);
        if (!r.ok) continue;
        const j = await r.json();
        if (j && j.ok && j.data){
          const n = (j.data.nodes_total ?? j.data.total_nodes ?? j.data.nodes?.total ?? j.data.nodes?.total_nodes ?? 1);
          const k = (j.data.keywords ?? 0);
          const t = (j.data.transactions ?? 0);
          totals.nodes += Number(n)||0;
          totals.keywords += Number(k)||0;
          totals.transactions += Number(t)||0;
          totals.okCount += 1;
        }
      }catch(_e){}
    }
    return totals;
  }

  function buildManageBody(level, items){
    if (!items.length){
      return `<div class="text-center muted">No items at this level.</div>`;
    }
    return `
      <div class="table-responsive">
        <table class="table table-sm align-middle manage-table">
          <thead>
            <tr>
              <th style="width:60%">Name</th>
              <th class="text-end">Delete</th>
            </tr>
          </thead>
          <tbody>
            ${items.map(i => `
              <tr>
                <td><input type="text" class="form-control form-control-sm edit-name" data-old="${i}" value="${i}"></td>
                <td class="text-end">
                  <button class="btn btn-sm btn-outline-danger btn-delete" data-name="${i}" type="button">Delete</button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    `;
  }

  function openManageModal(level, items, ctx){
    const title = {
      category: 'Manage Categories',
      subcategory: 'Manage Subcategories',
      subsubcategory: 'Manage Sub-subcategories',
      subsubsubcategory: 'Manage Sub-sub-subcategories'
    }[level] || 'Manage';

    document.getElementById('manageTitle').textContent = title;
    document.getElementById('manageBody').innerHTML = buildManageBody(level, items);

    const modalEl = document.getElementById('manageModal');
    const modal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(modalEl) : null;
    if (modal) modal.show();

    const btnPreview = document.getElementById('btnPreviewCascade');
    const divPreview = document.getElementById('cascadePreview');
    const chkCascade = document.getElementById('chkCascade');

    async function computeAndShowPreview() {
      const deletes = Array.from(document.querySelectorAll('.btn-delete'))
        .filter(btn => btn.dataset.deleted === 'true')
        .map(btn => btn.dataset.name);
      if (!deletes.length){ divPreview.style.display='none'; return; }
      divPreview.style.display='inline';
      divPreview.textContent = 'Preview: calculating…';
      try{
        const totals = await previewCascadeTotals(level, ctx, deletes);
        if (totals.okCount > 0){
          divPreview.textContent = `Preview: ${totals.nodes} node(s), ${totals.keywords} keyword(s), affecting ${totals.transactions} transaction row(s).`;
        }else{
          divPreview.textContent = 'Preview unavailable (endpoint not found). You can still proceed.';
        }
      }catch(e){
        divPreview.textContent = 'Preview failed. You can still proceed.';
      }
    }
    btnPreview.onclick = (e)=>{ e.preventDefault(); computeAndShowPreview(); };

    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', e => {
        e.preventDefault();
        const isDeleted = btn.dataset.deleted === 'true';
        btn.dataset.deleted = isDeleted ? 'false' : 'true';
        btn.closest('tr').style.opacity = isDeleted ? '1' : '0.5';
        if (chkCascade?.checked) { computeAndShowPreview(); }
      });
    });

    document.getElementById('saveManage').onclick = async () => {
      const edits = Array.from(document.querySelectorAll('.edit-name'))
        .map(inp => ({ old: inp.dataset.old, new: inp.value.trim() }));
      const deletes = Array.from(document.querySelectorAll('.btn-delete'))
        .filter(btn => btn.dataset.deleted === 'true')
        .map(btn => btn.dataset.name);
      const wantsCascade = !!chkCascade?.checked;

      if (wantsCascade && deletes.length){
        let msg = 'This will cascade delete selected item(s) and all of their children & keywords.\n\n';
        try{
          const totals = await previewCascadeTotals(level, ctx, deletes);
          if (totals.okCount > 0){
            msg += `Impact:\n• ${totals.nodes} node(s)\n• ${totals.keywords} keyword(s)\n• ${totals.transactions} transaction row(s)\n\n`;
          }
        }catch(_e){}
        msg += 'Proceed?';
        if (!confirm(msg)) return;
      }

      const res = await fetch('/admin/api/manage_category', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ level, ctx, edits, deletes, cascade: wantsCascade })
      }).then(r => r.json()).catch(()=>({ok:false, error:'Network error'}));

      if (!res.ok){
        alert(res.error || 'Save failed');
        return;
      }
      if (modal) modal.hide();
      location.reload();
    };
  }

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.manage-link');
    if (!btn) return;
    e.preventDefault();
    const level = btn.dataset.level;
    const { cat, sub, ssub } = readValues();
    let items = [];
    if (level === 'category') items = getAllCategories();
    if (level === 'subcategory') {
      if (!cat) { alert('Pick a Category first.'); return; }
      items = getSubs(cat);
    }
    if (level === 'subsubcategory') {
      if (!cat || !sub) { alert('Pick a Category and Subcategory first.'); return; }
      items = getSSubs(cat, sub);
    }
    if (level === 'subsubsubcategory') {
      if (!cat || !sub || !ssub) { alert('Pick a Category, Subcategory and Sub-subcategory first.'); return; }
      items = getSSSubs(cat, sub, ssub);
    }
    openManageModal(level, items, { cat, sub, ssub });
  });

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-manage]');
    if (!btn) return;
    e.preventDefault();

    const { cat, sub, ssub, sss } = readValues();
    const level = btn.dataset.level || 'category';

    if (level === 'category' && !cat) { alert('Pick a Category first.'); return; }
    if (level === 'subcategory' && (!cat || !sub)) { alert('Pick a Category and Subcategory first.'); return; }
    if (level === 'subsubcategory' && (!cat || !sub || !ssub)) { alert('Pick a Category, Subcategory, and Sub-subcategory first.'); return; }
    if (level === 'subsubsubcategory' && (!cat || !sub || !ssub || !sss)) { alert('Pick a full path first.'); return; }

    const state = { level, cat, sub, ssub, sss, month: (window.CURRENT_MONTH || ''), allowHidden: true };
    window.__drawerCtx = state;

    if (typeof window.openDrawerForPath === 'function') {
      window.openDrawerForPath(state);
    } else if (typeof window.openCategoryManager === 'function') {
      window.openCategoryManager(state);
    } else {
      alert('Drawer UI not loaded yet.');
      return;
    }

    // --- Nudge the Keywords tab to populate immediately ---
    const start = Date.now();
    (function tryKick() {
      const hasDrawer = document.getElementById('kw-list') ||
                        document.querySelector('[data-drawer], .drawer, .category-drawer');
      if (hasDrawer) {
        try { window.refreshKeywords?.(); } catch(_) {}
        return;
      }
      if (Date.now() - start < 1200) { requestAnimationFrame(tryKick); }
    })();
  });

  /* ---------- Misc panel wiring ---------- */
  function miscLabelsParam(){
    const labs = [];
    if (lblMisc.checked) labs.push('Miscellaneous');
    if (lblUncat.checked) labs.push('Uncategorized');
    if (lblUnknown.checked) labs.push('Unknown');
    if (!labs.length) labs.push('Miscellaneous');
    return labs.join('|');
  }

  function setMiscLoading(){
    miscTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 muted">Loading…</td></tr>';
    miscCount.textContent = '—';
    miscMeta.textContent = '—';
  }

  function fmtAmt(n){
    try {
      const f = Number(n || 0);
      return (f < 0 ? '-' : '') + '$' + Math.abs(f).toFixed(2);
    } catch(e) { return n; }
  }

  function escHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  async function fetchMisc(){
    setMiscLoading();
    const params = {
      labels: miscLabelsParam(),
      limit: miscLimit.value || '100',
      q: (miscSearch.value || '').trim(),
      min_abs: (miscMinAbs.value || '').trim()
    };
    const url = `/admin/categories/misc?${qs(params)}`;
    try{
      const r = await fetch(url);
      if (!r.ok) throw new Error(await r.text());
      const j = await r.json();
      renderMisc(j);
    }catch(err){
      miscTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger">Failed to load: ${String(err)}</td></tr>`;
    }
  }

  function renderMisc(j){
    const rows = (j && j.transactions) ? j.transactions : [];
    miscMeta.textContent = j && j.as_of ? `as of ${j.as_of}` : '—';
    miscCount.textContent = `${rows.length} row(s)`;

    if (!rows.length){
      miscTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 muted">No rows.</td></tr>';
      return;
    }

    const html = rows.map(r => {
      const date = (r.date || '').slice(0,10);
      const desc = (r.desc || '');
      const amt  = fmtAmt(r.amount);
      const path = (r.path || '');
      const safeDesc = escHtml(desc);
      const safePath = escHtml(path);
      return `
        <tr>
          <td class="mono small">${date || '—'}</td>
          <td>${safeDesc}</td>
          <td class="text-end mono">${amt}</td>
          <td>
            <a href="#" class="link-path small" data-path="${safePath}">${safePath}</a>
          </td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary btn-use" data-key="${safeDesc}">Use as keyword</button>
          </td>
        </tr>
      `;
    }).join('');
    miscTableBody.innerHTML = html;
  }

  document.addEventListener('click', (e) => {
    const useBtn = e.target.closest('.btn-use');
    if (useBtn){
      e.preventDefault();
      const val = (useBtn.dataset.key || '').trim().toUpperCase();
      if (val){
        kwInput.value = val;
        updateEnablement();
        kwInput.focus();
      }
    }
    const pathLink = e.target.closest('.link-path');
    if (pathLink){
      e.preventDefault();
      const p = pathLink.dataset.path || '';
      applyPathToLeft(p);
    }
  });

  miscRefresh.addEventListener('click', fetchMisc);
  miscSearch.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { e.preventDefault(); fetchMisc(); } });
  [miscSearch, miscMinAbs, miscLimit, lblMisc, lblUncat, lblUnknown].forEach(el => {
    el.addEventListener('change', fetchMisc);
  });
  miscClearFilters.addEventListener('click', (e)=>{
    e.preventDefault();
    miscSearch.value = '';
    miscMinAbs.value = '';
    miscLimit.value = '100';
    lblMisc.checked = lblUncat.checked = lblUnknown.checked = true;
    fetchMisc();
  });

  kwClearBtn.addEventListener('click', () => {
    kwInput.value = '';
    updateEnablement();
  });

  /* ---------- builder wiring ---------- */
  [selCategory, selSub, selSubSub, selSubSubSub].forEach((sel) => {
    sel.addEventListener('change', () => {
      const level = (sel === selCategory) ? 'cat' : (sel === selSub) ? 'sub' : (sel === selSubSub) ? 'ssub' : 'sss';
      if (sel.value === NEW_SENTINEL){
        oneBarEnterNew(level);
        clearDescendants(level);
        populateSelects();
        updateEnablement();
      } else {
        onLevelChange(level);
      }
    });
  });

  [inpCategory, inpSub, inpSubSub, inpSubSubSub].forEach(inp => {
    inp.addEventListener('input', () => {
      populateSelects();
      updateEnablement();
    });
  });

  document.querySelectorAll('.onebar-cancel').forEach(btn => {
    btn.addEventListener('click', () => {
      const level = btn.dataset.target;
      oneBarExitNew(level, true);
      populateSelects();
      updateEnablement();
    });
  });

  kwInput.addEventListener('input', updateEnablement);

  document.getElementById('formUpsert').addEventListener('submit', e => {
    updateEnablement();
    if (btnSaveAll.disabled) e.preventDefault();
  });

  populateSelects();
  updateVisibility();
  updateEnablement();
  fetchMisc();
</script>

<!-- === NEW: Glass Select (blurred custom dropdown via portal + scrim) === -->
<script>
(function(){
  function wrapSelect(select){
    if (select.dataset.gsInit === '1') return;
    select.dataset.gsInit = '1';

    const wrap = document.createElement('div'); wrap.className='gs-wrap';
    select.parentNode.insertBefore(wrap, select);
    wrap.appendChild(select);
    select.classList.add('gs-native');

    const trigger = document.createElement('button');
    trigger.type='button';
    trigger.className='gs-trigger';
    trigger.setAttribute('aria-haspopup','listbox');
    trigger.setAttribute('aria-expanded','false');
    trigger.innerHTML = '<span class="gs-label"></span><span class="gs-caret">▾</span>';
    wrap.insertBefore(trigger, select);
    const labelEl = trigger.querySelector('.gs-label');

    // Popup lives in body when open
    const popup = document.createElement('div'); popup.className='gs-popup'; popup.hidden=true;
    const list = document.createElement('ul'); list.className='gs-list'; list.setAttribute('role','listbox');
    popup.appendChild(list);

    // Scrim (blur layer)
    const scrim = document.createElement('div'); scrim.className='gs-scrim'; scrim.hidden = true;

    function syncLabel(){
      const opt = select.selectedOptions[0];
      labelEl.textContent = opt ? opt.textContent : 'Select…';
    }

    function placePopup(){
      const r = trigger.getBoundingClientRect();
      popup.style.left = Math.round(r.left) + 'px';
      popup.style.top  = Math.round(r.bottom + 6) + 'px';
      popup.style.minWidth = Math.max(240, Math.round(r.width)) + 'px';
      popup.style.maxWidth = Math.round(Math.min(window.innerWidth - 24, r.width * 1.6)) + 'px';
    }

    function close(){
      if (popup.hidden) return;
      popup.hidden = true;
      scrim.hidden = true;
      trigger.setAttribute('aria-expanded','false');
      if (popup.parentNode !== wrap) wrap.appendChild(popup);
      if (scrim.parentNode) scrim.parentNode.removeChild(scrim);
      window.removeEventListener('resize', onWin);
      window.removeEventListener('scroll', onWin, true);
    }

    function open(){
      if (!popup.parentNode || popup.parentNode === wrap) document.body.appendChild(popup);
      if (!scrim.parentNode) document.body.appendChild(scrim);
      scrim.hidden = false;
      popup.hidden = false;
      trigger.setAttribute('aria-expanded','true');
      placePopup();
      popup.focus?.();
      window.addEventListener('resize', onWin);
      window.addEventListener('scroll', onWin, true);
    }

    function toggle(){ popup.hidden ? open() : close(); }
    function onWin(){ placePopup(); }

    function apply(value){
      select.value = value;
      select.dispatchEvent(new Event('change', { bubbles:true }));
      syncLabel(); close();
    }

    function rebuild(){
      list.innerHTML = '';
      const opts = Array.from(select.options);
      opts.forEach((o, idx)=>{
        if (idx===1 && opts[0]?.disabled){
          const hr = document.createElement('div'); hr.className='gs-divider'; list.appendChild(hr);
        }
        const li = document.createElement('li');
        li.className='gs-option'; li.setAttribute('role','option');
        li.dataset.value = o.value;
        if (o.disabled) li.dataset.disabled = 'true';
        if (o.selected) li.setAttribute('aria-selected','true');
        li.textContent = o.textContent;
        li.addEventListener('click', ()=>{ if (!o.disabled) apply(o.value); });
        li.addEventListener('mousemove', ()=>{
          list.querySelectorAll('.gs-option[aria-current="true"]').forEach(x=>x.removeAttribute('aria-current'));
          li.setAttribute('aria-current','true');
        });
        list.appendChild(li);
      });
      syncLabel();
      mirrorVisibility();
    }

    const mo = new MutationObserver(rebuild);
    mo.observe(select, { childList:true, subtree:true, attributes:true, attributeFilter:['value','disabled','class'] });

    function mirrorVisibility(){
      trigger.style.display = select.classList.contains('d-none') ? 'none' : '';
    }

    // typing
    let buf='', t=null;
    function typeAhead(k){
      buf += k.toLowerCase(); clearTimeout(t); t=setTimeout(()=>buf='',600);
      const f = Array.from(select.options).find(o=>!o.disabled && o.text.toLowerCase().startsWith(buf));
      if (f) apply(f.value);
    }
    trigger.addEventListener('keydown', (e)=>{
      if (e.key===' '||e.key==='Enter'||e.key==='ArrowDown'){ e.preventDefault(); open(); return; }
      if (/^[\w\s]$/.test(e.key)) typeAhead(e.key);
    });

    trigger.addEventListener('click', toggle);
    scrim.addEventListener('click', close);
    document.addEventListener('click', (e)=>{ if (!popup.hidden && !popup.contains(e.target) && !trigger.contains(e.target)) close(); });

    rebuild();
  }

  // Public: upgrade all current selects
  window.refreshGlassSelects = function(){
    document.querySelectorAll('.onebar-select').forEach(wrapSelect);
  };

  if (document.readyState !== 'loading') window.refreshGlassSelects();
  else document.addEventListener('DOMContentLoaded', window.refreshGlassSelects);
})();
</script>

<script>
  // =========================
  // === Keyword Finder JS ===
  // =========================
  (function(){
    const QS = (s,r=document)=>r.querySelector(s);
    const QSA = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const esc = s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');

    const el = {
      form: QS('#kb-form'),
      q: QS('#kb-q'),
      resultKw: QS('#kb-resultKw'),
      body: QS('#kb-body'),
      count: QS('#kb-count'),
      cloud: QS('#kb-cloud'),
      kwcount: QS('#kb-kwcount'),
      status: QS('#kb-status'),
      btnClear: QS('#kb-clear'),
      btnMD: QS('#kb-md'),
      btnReindex: QS('#kb-reindex'),
    };

    let INDEX = new Map();

    const levelName = d => ['category','subcategory','subsubcategory','subsubsubcategory'][Math.min(d-1,3)] || 'category';

    function buildIndexFromCFG(){
      const idx = new Map();
      const add = (kw, parts) => {
        const key = String(kw||'').trim().toLowerCase();
        if (!key) return;
        const path = parts.filter(Boolean).join(' / ');
        if (!idx.has(key)) idx.set(key, new Set());
        idx.get(key).add(path);
      };

      const CK  = (window.CFG && window.CFG.CATEGORY_KEYWORDS) || {};
      const SK  = (window.CFG && window.CFG.SUBCATEGORY_KEYWORDS) || {};
      const S2K = (window.CFG && window.CFG.SUBSUBCATEGORY_KEYWORDS) || {};
      const S3K = (window.CFG && window.CFG.SUBSUBSUBCATEGORY_KEYWORDS) || {};

      Object.keys(CK).forEach(cat=>{ (CK[cat]||[]).forEach(kw=> add(kw, [cat])); });
      Object.keys(SK).forEach(cat=>{ const o = SK[cat]||{}; Object.keys(o).forEach(sub=>{ (o[sub]||[]).forEach(kw=> add(kw, [cat, sub])); }); });
      Object.keys(S2K).forEach(cat=>{ const o = S2K[cat]||{}; Object.keys(o).forEach(sub=>{ const oo = o[sub]||{}; Object.keys(oo).forEach(ssub=>{ (oo[ssub]||[]).forEach(kw=> add(kw, [cat, sub, ssub])); }); }); });
      Object.keys(S3K).forEach(cat=>{ const o = S3K[cat]||{}; Object.keys(o).forEach(sub=>{ const oo = o[sub]||{}; Object.keys(oo).forEach(ssub=>{ const ooo = oo[ssub]||{}; Object.keys(ooo).forEach(sss=>{ (ooo[sss]||[]).forEach(kw=> add(kw, [cat, sub, ssub, sss])); }); }); }); });

      return idx;
    }

    function renderCloud(){
      const entries = Array.from(INDEX.entries())
        .map(([k,set])=>({kw:k,count:set.size}))
        .sort((a,b)=> a.kw.localeCompare(b.kw));
      el.kwcount.textContent = entries.length;
      el.cloud.innerHTML = entries.map(e=>
        `<span class="kb-chip" data-kw="${esc(e.kw)}" title="${esc(e.kw)} (${e.count})">
          ${esc(e.kw)} <span class="kb-muted">(${e.count})</span>
        </span>`).join('');
      document.querySelectorAll('.kb-chip').forEach(ch=>ch.addEventListener('click',()=>{
        const kw=ch.getAttribute('data-kw')||''; el.q.value=kw; runSearch();
      }));
    }

    function renderMatches(keyword){
      const key = (keyword||'').trim().toLowerCase();
      el.resultKw.textContent = key ? `for “${keyword}”` : '';
      if (!key){
        el.count.textContent='0';
        el.body.innerHTML=`<tr><td colspan="3" class="text-muted">Type a keyword and press Search.</td></tr>`;
        return;
      }
      if (!INDEX || INDEX.size===0){
        el.count.textContent='0';
        el.body.innerHTML=`<tr><td colspan="3" class="text-muted">Index is empty. Click Re-index.</td></tr>`;
        return;
      }
      const hits = Array.from(INDEX.keys()).filter(k=>k.includes(key));
      const paths = new Set(); hits.forEach(h=> INDEX.get(h).forEach(p=>paths.add(p)));
      const rows = Array.from(paths).sort((a,b)=> a.localeCompare(b));

      el.count.textContent = rows.length;
      el.body.innerHTML = rows.length ? rows.map(p=>{
        const parts=p.split(' / ').map(s=>s.trim()).filter(Boolean);
        const ds={ level: levelName(parts.length), cat:parts[0]||'', sub:parts[1]||'', ssub:parts[2]||'', sss:parts[3]||'' };
        return `<tr>
          <td class="kb-path" title="${esc(p)}">${esc(p)}</td>
          <td>${esc(ds.level)}</td>
          <td class="text-end">
            <a href="#"
               class="kb-manage"
               data-manage
               data-level="${esc(ds.level)}"
               data-cat="${esc(ds.cat)}"
               data-sub="${esc(ds.sub)}"
               data-ssub="${esc(ds.ssub)}"
               data-sss="${esc(ds.sss)}" data-month="${window.CURRENT_MONTH||''}" >manage</a>
          </td>
        </tr>`;
      }).join('') : `<tr><td colspan="3" class="text-muted">No paths found for that keyword.</td></tr>`;
    }

    function reindexFast(){
      const t0 = performance.now();
      INDEX = buildIndexFromCFG();
      renderCloud();
      el.status.textContent = `Ready (local) in ${Math.round(performance.now()-t0)}ms.`;
    }

    function runSearch(ev){
      if (ev && typeof ev.preventDefault === 'function') ev.preventDefault();
      renderMatches(el.q.value||'');
    }

    if (el.form) el.form.addEventListener('submit', runSearch);
    if (el.btnClear) el.btnClear.addEventListener('click', ()=>{ el.q.value=''; renderMatches(''); });
    if (el.btnMD) el.btnMD.addEventListener('click', ()=>{ el.q.value='MOBILE DEPOSIT'; renderMatches('MOBILE DEPOSIT'); });
    if (el.btnReindex) el.btnReindex.addEventListener('click', (e)=> reindexFast());

    reindexFast();
  })();
</script>

<script>
(function(){
  // ========= FETCH + KEYWORD SHIM (runs once) =========
  if (window.__builderFetchWrapped) return;
  window.__builderFetchWrapped = true;

  const origFetch = window.fetch;

  // -------- context helpers ----------
  function ctxFromDrawer(){
    const c = (window.__drawerCtx || {});
    return {
      level: c.level || 'category',
      cat:   c.cat   || '',
      sub:   c.sub   || '',
      ssub:  c.ssub  || '',
      sss:   c.sss   || ''
    };
  }
  function pathFromCtx(ctx){ return [ctx.cat, ctx.sub, ctx.ssub, ctx.sss].filter(Boolean).join('/'); }

  // Merge keywords from CFG at any depth (supports both *MAPS and *KEYWORDS shapes)
  function fromCFGKeywords(parts){
    const CFG = window.CFG || {};
    const [cat, sub, ssub, sss] = parts;
    const out = new Set();

    // level 1
    if (cat){
      (CFG.CATEGORY_KEYWORDS?.[cat] || []).forEach(k => out.add(String(k)));
    }
    // level 2
    if (cat && sub){
      (CFG.SUBCATEGORY_MAPS?.[cat]?.[sub] || []).forEach(k => out.add(String(k)));
      (CFG.SUBCATEGORY_KEYWORDS?.[cat]?.[sub] || []).forEach(k => out.add(String(k)));
    }
    // level 3
    if (cat && sub && ssub){
      (CFG.SUBSUBCATEGORY_MAPS?.[cat]?.[sub]?.[ssub] || []).forEach(k => out.add(String(k)));
      (CFG.SUBSUBCATEGORY_KEYWORDS?.[cat]?.[sub]?.[ssub] || []).forEach(k => out.add(String(k)));
    }
    // level 4
    if (cat && sub && ssub && sss){
      (CFG.SUBSUBSUBCATEGORY_MAPS?.[cat]?.[sub]?.[ssub]?.[sss] || []).forEach(k => out.add(String(k)));
      (CFG.SUBSUBSUBCATEGORY_KEYWORDS?.[cat]?.[sub]?.[ssub]?.[sss] || []).forEach(k => out.add(String(k)));
    }

    return Array.from(out);
  }

  // Small utility
  const qs = (o)=>Object.entries(o).map(([k,v])=>encodeURIComponent(k)+'='+encodeURIComponent(v)).join('&');

  // -------- unified fetch wrapper ----------
  window.fetch = async function(input, init){
    try{
      let url = (typeof input === 'string') ? input : (input && input.url) || '';
      const req = (typeof input === 'string') ? null : input;
      const method = (init?.method || req?.method || 'GET').toUpperCase();

      if (url){
        const u = new URL(url, window.location.origin);

        // Always add allow_hidden=1 to /inspect calls
        if (u.pathname.includes('/admin/categories/inspect') && !u.searchParams.has('allow_hidden')){
          u.searchParams.set('allow_hidden','1');
          url = u.toString();
          input = (typeof input === 'string') ? url : new Request(url, req || init || {});
        }

        // Intercept only the drawer keyword **GET** endpoints and return a raw array
        const isKeywordGET =
          method === 'GET' &&
          /\/admin\/(api|categories)\/(keywords|keywords_for_name|keywords_for_path)\b/i.test(u.pathname);

        if (isKeywordGET){
          // derive name/path from URL or drawer ctx
          let name = u.searchParams.get('name') || '';
          let path = u.searchParams.get('path') || '';
          if (!name || !path){
            const ctx = ctxFromDrawer();
            const parts = [ctx.cat, ctx.sub, ctx.ssub, ctx.sss].filter(Boolean);
            if (!name) name = parts[parts.length - 1] || '';
            if (!path) path = parts.join('/');
          }

          // Build parts and ensure 'name' is the tail
          let parts = (path || '').split('/').map(s=>s.trim()).filter(Boolean);
          if (name && parts[parts.length-1] !== name) parts.push(name);

          const keywords = fromCFGKeywords(parts);

          // Return a PLAIN ARRAY the drawer expects
          return new Response(JSON.stringify(keywords), {
            status: 200,
            headers: { 'Content-Type': 'application/json' }
          });
        }
      }
    }catch(e){
      console.warn('[builder] fetch wrapper error, falling back', e);
    }
    return origFetch(input, init);
  };

  // -------- Page-level helpers (optional) ----------
  function pickKwListEl(){
    return document.getElementById('kw-list') ||
           document.querySelector('[data-kw-list]') ||
           document.querySelector('.kw-list') ||
           document.getElementById('keywordsList') ||
           document.getElementById('kwList');
  }

  // Manually force the keywords list to load (uses our GET shim above)
  async function refreshKeywords(){
    let list = pickKwListEl(), tries = 0;
    while (!list && tries < 60){ await new Promise(r=>setTimeout(r,20)); list = pickKwListEl(); tries++; }
    if (!list) return;

    list.innerHTML = '<span class="muted">Loading…</span>';

    const ctx = ctxFromDrawer();
    const parts = [ctx.cat, ctx.sub, ctx.ssub, ctx.sss].filter(Boolean);
    const name  = parts[parts.length-1] || '';
    const path  = parts.join('/');

    try{
      // our fetch shim will return a raw array here
      const r = await fetch(`/admin/categories/keywords?${qs({ name, path })}`, { headers:{'Accept':'application/json'} });
      const arr = await r.json();
      if (!Array.isArray(arr) || !arr.length){ list.innerHTML = '<span class="muted">No keywords yet.</span>'; return; }

      list.innerHTML = arr.map(k =>
        `<span class="pill"><span class="pill-text">${String(k)}</span><button class="kw-x" data-kw="${encodeURIComponent(k)}" title="Remove">×</button></span>`
      ).join(' ');

      // Click-to-remove (POST calls are NOT intercepted)
      list.addEventListener('click', async function onX(e){
        const btn = e.target.closest('.kw-x'); if (!btn) return;
        e.preventDefault();
        const keyword = decodeURIComponent(btn.dataset.kw||'');
        const body = JSON.stringify({
          keyword,
          path,
          action: 'remove',
          remove: true
        });

        const posts = [
          '/admin/api/keyword_remove',
          '/admin/categories/keyword_remove',
          '/admin/categories/keywords'
        ];
        for (const p of posts){
          try{
            const pr = await fetch(p, { method:'POST', headers:{'Content-Type':'application/json'}, body });
            if (pr.ok) break;
          }catch(_e){}
        }
        refreshKeywords();
      }, { once:true });

    }catch(_e){
      list.innerHTML = '<span class="text-danger">Failed to load keywords.</span>';
    }
  }

  async function tryPost(urls, body){
    let last;
    for (const u of urls){
      try{
        const r = await fetch(u, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body||{}) });
        if (r.ok){
          const ct = (r.headers.get('content-type')||'').toLowerCase();
          return ct.includes('json') ? await r.json() : await r.text();
        }
        last = new Error('POST '+u+' → '+r.status);
      }catch(e){ last = e; }
    }
    throw last || new Error('No keyword POST endpoint worked');
  }

  async function deleteKeyword({ keyword, path }){
    const posts = [
      '/admin/api/keyword_remove',
      '/admin/categories/keyword_remove',
      '/admin/categories/keywords'
    ];
    try{ await tryPost(posts, { keyword, path, remove:true, action:'remove' }); }catch(_e){}
  }

  async function addKeyword(kw){
    const ctx = ctxFromDrawer();
    const body = {
      keyword: kw,
      name: [ctx.cat, ctx.sub, ctx.ssub, ctx.sss].filter(Boolean).pop()||'',
      path: pathFromCtx(ctx),
      ...ctx,
      action: 'add'
    };
    const posts = [
      '/admin/api/keyword_add',
      '/admin/categories/keyword_add',
      '/admin/categories/keywords'
    ];
    try{ await tryPost(posts, body); }catch(_e){}
  }

  // Expose to the drawer
  window.refreshKeywords = refreshKeywords;
  window.deleteKeyword   = deleteKeyword;
  window.addKeyword      = addKeyword;

})();
</script>

<!-- ====== NEW: Category → Recurring JS ====== -->
<script>
(function(){
  let modal;

  function money(n){
    const v = Number(n||0);
    const s = v < 0 ? '-$' : '$';
    return s + Math.abs(v).toFixed(2);
  }

  function populate(sel, items, ph){
    sel.innerHTML = '';
    const o0 = document.createElement('option'); o0.value=''; o0.textContent = ph || '—';
    sel.appendChild(o0);
    items.forEach(v=>{ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o); });
  }

  function getPath(){
    const cat  = document.getElementById('rcCat').value || '';
    const sub  = document.getElementById('rcSub').value || '';
    const ssub = document.getElementById('rcSsub').value || '';
    const sss  = document.getElementById('rcSss').value || '';
    return { cat, sub, ssub, sss };
  }

  function setMeta(text){ document.getElementById('rcMeta').textContent = text || '—'; }

  async function callJSON(urls, body){
    let last;
    for (const u of urls){
      try{
        const r = await fetch(u, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (r.ok) return await r.json().catch(()=>({}));
        last = new Error(`${u} → ${r.status}`);
      }catch(e){ last = e; }
    }
    throw last || new Error('no endpoint');
  }

  async function preview(){
    const {cat, sub, ssub, sss} = getPath();
    const lb   = document.getElementById('rcLookback').value || '365';
    const amtMode = document.getElementById('rcAmountMode').value || 'none';
    const freq    = document.getElementById('rcFreq').value || '';

    if (!cat){ alert('Pick at least a Category.'); return; }

    setMeta('Loading preview…');

    const payload = { path:{cat,sub,ssub,sss}, lookback: lb, amount_mode: amtMode, frequency_hint: freq };

    try{
      const res = await callJSON(
        ['/admin/recurring/propose_from_category','/api/recurring/propose_from_category'],
        payload
      );
      const box = document.getElementById('rcPreviewBox');
      const kw  = Array.isArray(res.keywords) ? res.keywords : [];
      const cnt = Number(res.count||res.sample_count||0);
      const med = res.median || res.amount?.median;
      const dates = res.dates || [];
      const sample = Array.isArray(res.sample) ? res.sample : [];
      if (kw.length) document.getElementById('rcKeywords').value = kw.join('; ');
      const amtHint = document.getElementById('rcAmtHint');
      if (amtMode === 'none') amtHint.textContent = 'Amount ignored';
      if (amtMode === 'median') amtHint.textContent = med ? `~ ${money(med)} ±10%` : 'median unavailable';
      if (amtMode === 'tight')  amtHint.textContent = med ? `~ ${money(med)} ±3%`  : 'median unavailable';
      setMeta(`${cnt || sample.length} transaction(s) found${dates?.length? ' • '+dates.length+' dates':''}`);

      const list = (sample.slice(0,8)).map(r=>{
        const d = (r.date||'').slice(0,10);
        const m = String(r.merchant || r.description || r.desc || '').toUpperCase();
        const a = r.amount!=null? money(r.amount) : '';
        return `<div class="d-flex justify-content-between"><span class="text-truncate me-2" style="max-width:70%;">${m||'—'}</span><span class="mono">${a}</span></div>`;
      }).join('');
      box.innerHTML = list || '<div class="text-muted">No sample returned.</div>';
    }catch(err){
      setMeta('Preview unavailable.');
      document.getElementById('rcPreviewBox').innerHTML =
        '<div class="text-muted">No preview endpoint found. You can still save — keywords and median will be computed server-side.</div>';
    }
  }

  async function confirmAdd(){
    const {cat, sub, ssub, sss} = getPath();
    const lb     = document.getElementById('rcLookback').value || '365';
    const kws    = (document.getElementById('rcKeywords').value || '').split(';').map(s=>s.trim()).filter(Boolean);
    const amtMode= document.getElementById('rcAmountMode').value || 'none';
    const freq   = document.getElementById('rcFreq').value || '';
    const simulate = document.getElementById('rcSimulate').checked;

    if (!cat){ alert('Pick at least a Category.'); return; }

    const payload = {
      path: { cat, sub, ssub, sss },
      keywords: kws,
      amount_mode: amtMode,
      frequency: freq || '',
      lookback: lb,
      simulate: !!simulate
    };

    try{
      const res = await callJSON(
        ['/admin/recurring/upsert_from_category','/api/recurring/upsert_from_category'],
        payload
      );
      if (simulate){
        alert('Preview built server-side. Disable “Preview first” to save.\n\nPayload:\n' + JSON.stringify(payload, null, 2));
      }else{
        alert('Added to Recurring.');
      }
      const mEl = document.getElementById('catToRecurringModal');
      (bootstrap && bootstrap.Modal.getInstance(mEl))?.hide();
    }catch(err){
      alert('Could not add to Recurring.\n\n' + String(err) + '\n\nTried endpoints:\n' +
        '/admin/recurring/upsert_from_category\n/api/recurring/upsert_from_category');
    }
  }

  function openModal(){
    const mEl = document.getElementById('catToRecurringModal');
    modal = bootstrap && bootstrap.Modal ? new bootstrap.Modal(mEl) : null;
    if (modal) modal.show();

    const rcCat  = document.getElementById('rcCat');
    const rcSub  = document.getElementById('rcSub');
    const rcSsub = document.getElementById('rcSsub');
    const rcSss  = document.getElementById('rcSss');

    populate(rcCat, getAllCategories(), 'Select category…');
    populate(rcSub, [], '—'); populate(rcSsub, [], '—'); populate(rcSss, [], '—');
    setMeta('—');
    document.getElementById('rcKeywords').value = '';
    document.getElementById('rcPreviewBox').innerHTML = '<div class="text-muted">Pick a path and click Preview.</div>';
    document.getElementById('rcAmtHint').textContent = '—';

    rcCat.onchange = ()=>{
      const cat = rcCat.value || '';
      populate(rcSub, cat ? getSubs(cat) : [], 'Select subcategory…');
      populate(rcSsub, [], '—');
      populate(rcSss, [], '—');
      setMeta('—');
    };
    rcSub.onchange = ()=>{
      const cat = rcCat.value || '';
      const sub = rcSub.value || '';
      populate(rcSsub, (cat && sub) ? getSSubs(cat, sub) : [], 'Select sub-subcategory…');
      populate(rcSss, [], '—');
      setMeta('—');
    };
    rcSsub.onchange = ()=>{
      const cat = rcCat.value || '';
      const sub = rcSub.value || '';
      const ssub= rcSsub.value || '';
      populate(rcSss, (cat && sub && ssub) ? getSSSubs(cat, sub, ssub) : [], 'Select sub-sub-sub…');
      setMeta('—');
    };
    rcSss.onchange = ()=> setMeta('—');

    document.getElementById('rcPreview').onclick = preview;
    document.getElementById('rcConfirm').onclick = confirmAdd;
  }

  function attach(){
    const btn = document.getElementById('btnCatToRecurring');
    if (!btn) return;
    btn.addEventListener('click', openModal);
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', attach);
  else attach();
})();
</script>

{% endblock %}

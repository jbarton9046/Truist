{% extends "layout.html" %}
{% block title %}Charts & Insights{% endblock %}
{% block content %}
<style>
  .page-header{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}
  .controls{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}

  .stat-card{position:relative;overflow:visible}
  .stat-card .chart,.stat-card .plot-container,.stat-card .js-plotly-plot{overflow:visible}

  .muted{color:var(--muted)!important}
  .mono{font-variant-numeric:tabular-nums}

  .grid{display:grid;gap:1rem;grid-template-columns:1fr}
  @media (min-width:1200px){.grid{grid-template-columns:1fr 1fr}}

  .chart{width:100%;height:420px}
  .chart.tall{height:520px}

  .chip{padding:.15rem .5rem;border-radius:999px;border:1px solid var(--hair);font-size:.85rem;background:rgba(255,255,255,.06);color:var(--text)}
  .tabs{display:flex;gap:.4rem;flex-wrap:wrap}
  .tab{padding:.3rem .6rem;border:1px solid var(--card-border);border-radius:.5rem;background:rgba(255,255,255,.06);cursor:pointer;user-select:none}
  .tab.active{background:var(--card-bg);box-shadow:0 1px 0 rgba(16,24,40,.06)}

  /* Match Goals: accent ink + left alignment */
  body[data-route="/charts"]{
    --text:var(--accent-ink)!important;
    --muted:var(--accent-ink)!important;
    --thead-fg:var(--accent-ink)!important;
    --table-head-fg:var(--accent-ink)!important;
  }
  body[data-route="/charts"] .table th,
  body[data-route="/charts"] .table td{ text-align:left!important }

  .table-floating{width:100%;border-collapse:separate;border-spacing:0;background:transparent}
  .table-floating thead th{
    background:var(--thead-bg)!important;color:var(--table-head-fg,var(--text))!important;
    border-bottom:1px solid var(--hair)!important;font-weight:700;letter-spacing:.2px
  }
  .table-floating tbody td{border-top:1px solid var(--hair)}
  .table-floating tbody tr:nth-child(odd){background:rgba(255,255,255,.015)}
  .table-floating tbody tr:hover{background:rgba(255,255,255,.05)}

  .kpi-grid{display:grid;gap:.8rem;grid-template-columns:1fr 1fr}
  @media (min-width:992px){.kpi-grid{grid-template-columns:repeat(4,1fr)}}
  .kval{font-size:1.25rem;font-weight:600}
</style>

<div class="container mt-4">
  <div class="page-header">
    <h3 class="m-0">Charts &amp; Insights</h3>
    <div class="controls">
      <div class="tabs" id="viewTabs">
        <div class="tab active" data-view="overview">Overview</div>
        <div class="tab" data-view="expenses">Expenses</div>
        <div class="tab" data-view="income">Income</div>
      </div>

      <label class="form-check-label d-flex align-items-center gap-2 ms-2">
        <input id="normalize" class="form-check-input" type="checkbox">
        Stack as %
      </label>

      <div class="d-flex align-items-center gap-2">
        <label class="form-label m-0 small">Number of Categories</label>
        <input id="topN" type="range" class="form-range" min="5" max="25" step="1" value="10">
        <span id="topNLabel" class="mono small">10</span>
      </div>

      <div class="d-flex align-items-center gap-2">
        <label class="form-label m-0 small">Focus month</label>
        <select id="focusMonth" class="form-select form-select-sm"></select>
      </div>

      <span class="chip">Window: <span id="monthsWindow" class="mono">—</span></span>
    </div>
  </div>

  <!-- OVERVIEW -->
  <div id="pane-overview">
    <div class="grid">
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Income vs Expenses</div>
        <div id="ov_line" class="chart tall"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Net</div>
        <div id="ov_net" class="chart tall"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Savings Rate</div>
        <div id="ov_srate" class="chart"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Cumulative Net</div>
        <div id="ov_cum" class="chart"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Net Rolling Avg</div>
        <div id="ov_roll" class="chart"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Seasonality — Avg by Month-of-Year</div>
        <div id="ov_season" class="chart"></div>
      </div>
    </div>
  </div>

  <!-- EXPENSES -->
  <div id="pane-expenses" style="display:none;">
    <div class="grid">
      <div class="stat-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Top Expenses — Stacked Area</div>
          <div class="muted small">Hover to see breakdown</div>
        </div>
        <div id="ex_area" class="chart tall"></div>
      </div>

      <div class="stat-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Expenses Treemap — <span id="ex_tm_month" class="mono">—</span></div>
          <div class="muted small">Click to drill within chart</div>
        </div>
        <div id="ex_treemap" class="chart tall"></div>
      </div>

      <div class="stat-card">
        <div class="mb-2 fw-semibold">Expense Heatmap (Top N)</div>
        <div id="ex_heatmap" class="chart"></div>
      </div>

      <div class="stat-card">
        <div class="mb-2 fw-semibold">Pareto — Cumulative Share of Spend</div>
        <div id="ex_pareto" class="chart"></div>
      </div>

      <div class="stat-card">
        <div class="mb-2 fw-semibold">Expense Volatility vs Average</div>
        <div id="ex_scatter" class="chart"></div>
      </div>

      <div class="stat-card">
        <div class="mb-2 fw-semibold">Current Month Split — Donut</div>
        <div id="ex_donut" class="chart"></div>
      </div>
    </div>
  </div>

  <!-- INCOME -->
  <div id="pane-income" style="display:none;">
    <div class="kpi-grid mb-3">
      <div class="stat-card"><div class="muted small">Income (last 30 days)</div><div id="inc_kpi_30d" class="kval mono">—</div></div>
      <div class="stat-card"><div class="muted small">Avg monthly (last 3m)</div><div id="inc_kpi_avg3" class="kval mono">—</div></div>
      <div class="stat-card"><div class="muted small">Next 30d (recurrents)</div><div id="inc_kpi_next30" class="kval mono">—</div></div>
      <div class="stat-card"><div class="muted small">Median paycheck (recurrents)</div><div id="inc_kpi_medpay" class="kval mono">—</div></div>
    </div>

    <div class="row g-3">
      <div class="col-xl-7">
        <div class="stat-card h-100">
          <div class="mb-2 fw-semibold">Income MoM — Waterfall</div>
          <div id="in_waterfall" class="chart"></div>
        </div>
      </div>

      <div class="col-xl-5">
        <div class="stat-card h-100">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <div class="fw-semibold">Income Sources (Top N)</div>
            <div class="muted small">auto-grouped deeper if available</div>
          </div>
          <div id="in_table"></div>
        </div>
      </div>

      <div class="col-xl-12">
        <div class="stat-card">
          <div class="mb-2 fw-semibold">Income by Source — Stacked Bars</div>
          <div id="in_stack" class="chart"></div>
        </div>
      </div>

      <div class="col-xl-7">
        <div class="stat-card">
          <div class="mb-2 fw-semibold">Income Heatmap (Top N)</div>
          <div id="in_heatmap" class="chart"></div>
        </div>
      </div>

      <div class="col-xl-5">
        <div class="stat-card">
          <div class="mb-2 fw-semibold">Paycheck timeline (next 60–90d)</div>
          <div id="in_timeline" class="chart"></div>
          <div id="in_upcoming" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Server-injected data (preferred) -->
<script id="catMonthlyData" type="application/json">
{{ (cat_monthly | default({})) | tojson }}
</script>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<script>
(function(){
  'use strict';

  /* ====== theme helpers ====== */
  const cssVar = (name, fallback) => {
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return v || fallback;
  };
  const ACCENT = () => cssVar('--accent-ink','#9ecbff');
  const GRID   = () => 'rgba(255,255,255,.14)';
  const HAIR   = () => cssVar('--hair','rgba(255,255,255,.12)');

  /* floating feel */
  const OP_LINE = 0.68, OP_BAR = 0.72, OP_AREA = 0.48, OP_MARK = 0.78;

  /* ====== base layout (keeps our dark gridlines) ====== */
  const baseLayout = (extra = {}) => {
    const layout = {
      paper_bgcolor:'rgba(0,0,0,0)',
      plot_bgcolor:'rgba(0,0,0,0)',
      font:{color:ACCENT()},
      margin:{l:60,r:40,t:10,b:40},
      xaxis:{type:'category',tickfont:{color:ACCENT()},gridcolor:GRID(),gridwidth:0.6,linecolor:HAIR(),zeroline:false,zerolinecolor:GRID()},
      yaxis:{tickfont:{color:ACCENT()},gridcolor:GRID(),gridwidth:0.6,linecolor:HAIR(),zeroline:false,zerolinecolor:GRID(),rangemode: extra.yZero ? 'tozero' : undefined},
      legend:{orientation:'h', y:-0.25, font:{color:ACCENT()}},
      hoverlabel:{font:{color:ACCENT()}}
    };
    if (extra.xaxis) layout.xaxis = Object.assign({}, layout.xaxis, extra.xaxis);
    if (extra.yaxis) layout.yaxis = Object.assign({}, layout.yaxis, extra.yaxis);
    const { xaxis, yaxis, ...rest } = extra;
    return Object.assign(layout, rest);
  };

  const safeReact = (target, traces, layout, config) => {
    try{
      Plotly.react(target, traces, layout, Object.assign({responsive:true,displayModeBar:false}, config||{}));
    }catch(err){
      try { target.innerHTML = '<div class="muted small ms-2 me-2">This chart could not be rendered for the selected window.</div>'; } catch(_){}
      console.error('Plotly render failed:', err);
    }
  };

  /* ====== utils ====== */
  const toNum = v => (typeof v==='number' && isFinite(v)) ? v : (Number(String(v||'').replace(/[$,]/g,''))||0);
  const sum = a => a.reduce((x,y)=>x+toNum(y),0);
  const money = n => (toNum(n)<0?'-$':'$') + Math.abs(toNum(n)).toLocaleString(undefined,{maximumFractionDigits:0});
  const money2 = n => (toNum(n)<0?'-$':'$') + Math.abs(toNum(n)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const prettyMonth = ym => { if(!ym||ym.length<7)return ym||'—';const [y,m]=ym.split('-').map(Number);return new Date(y,(m||1)-1,1).toLocaleString(undefined,{month:'long',year:'numeric'})};
  const parseISO = s => { const [y,m,d]=String(s||'').slice(0,10).split('-').map(Number); return (y&&m&&d)?new Date(y,m-1,d):null; };

  /* Normalize a category into segments.
     NOTE: we DO NOT split on hyphen here; some names are 'Income - JL Pay' */
  const segsOf = item => {
    if (item && Array.isArray(item.path) && item.path.length) return item.path.map(String);
    const name = String(item?.name || '').trim();
    if (!name) return [];
    const raw = name.replace(/\s*>\s*/g,' / ').replace(/\s*:\s*/g,' / ');
    if (raw.includes(' / ')) return raw.split(' / ').map(s=>s.trim()).filter(Boolean);
    return [name];
  };

  const aggregateTopLevel = categories => {
    const map = new Map();
    for (const c of (categories||[])){
      const top = (segsOf(c)[0] || '(Uncategorized)');
      const arr = (c.monthly||[]).map(toNum);
      if (!map.has(top)) map.set(top, new Array(arr.length).fill(0));
      const dest = map.get(top);
      for(let i=0;i<arr.length;i++) dest[i]+=arr[i];
    }
    return Object.fromEntries(map.entries());
  };

  function buildTree(categories){
    const root={name:'All',path:[],monthly:[],children:[]}; const map=new Map(); map.set('',root);
    const keyOf=s=>s.join(' / ');
    const getNode=segs=>{ const k=keyOf(segs); if(map.has(k))return map.get(k);
      const n={name:segs[segs.length-1],path:[...segs],monthly:[],children:[]};
      const p=getNode(segs.slice(0,-1)); p.children.push(n); map.set(k,n); return n; };
    (categories||[]).forEach(c=>{ const segs=segsOf(c); const leaf=getNode(segs.length?segs:[c.name||'']); leaf.monthly=(c.monthly||[]).map(toNum); });
    const roll=n=>{ if(!n.children.length) return n.monthly||[]; const L=Math.max(0,...n.children.map(ch=>(ch.monthly||[]).length));
      const agg=new Array(L).fill(0); for(const ch of n.children){ const cm=roll(ch); for(let i=0;i<L;i++) agg[i]+=toNum(cm[i]||0); }
      n.monthly=agg; return agg; };
    roll(root); return root;
  }

  /* ====== robust income series builders ====== */
  const subtreeByTop=(root,name)=> (root.children||[]).find(c=>(String(c.name||'')===String(name)))||null;

  function seriesBySecondLevel(sub){
    const map=new Map(); if(!sub) return {};
    const visit=n=>{
      if(!n.children.length){
        const lvl2=n.path[1]||n.name; const arr=n.monthly||[];
        if(!map.has(lvl2)) map.set(lvl2,new Array(arr.length).fill(0));
        const d=map.get(lvl2); for(let i=0;i<arr.length;i++) d[i]+=toNum(arr[i]||0);
      } else n.children.forEach(visit);
    };
    (sub.children||[]).forEach(visit);
    return Object.fromEntries(map.entries());
  }
  function seriesByChildren(sub){
    const map=new Map(); if(!sub) return {};
    (sub.children||[]).forEach(ch=>{
      const arr=(ch.monthly||[]).map(toNum);
      map.set(ch.name||'(child)', arr);
    });
    return Object.fromEntries(map.entries());
  }
  function seriesByLeaves(sub, tailDepth=2){
    const map=new Map(); if(!sub) return {};
    const visit=n=>{
      if(!n.children.length){
        const p = n.path.slice(1); // drop "Income"
        const label = (p.length ? p.slice(-tailDepth).join(' / ') : n.name) || 'Income';
        const arr = (n.monthly||[]).map(toNum);
        if(!map.has(label)) map.set(label,new Array(arr.length).fill(0));
        const d=map.get(label); for(let i=0;i<arr.length;i++) d[i]+=toNum(arr[i]||0);
      } else n.children.forEach(visit);
    };
    (sub.children||[]).forEach(visit);
    return Object.fromEntries(map.entries());
  }

  /* Extract from raw categories even if there's no Income subtree visible */
  function seriesIncomeFromRaw(categories, tailDepth=2){
    const map=new Map();
    for (const c of (categories||[])){
      const segs = segsOf(c);
      const name = String(c.name||'');
      const nameLower = name.toLowerCase();
      const idx = segs.findIndex(s => String(s).toLowerCase() === 'income');

      if (idx === -1 && !/^income\b/.test(nameLower)) continue;

      let after = [];
      if (idx >= 0 && idx < segs.length-1) after = segs.slice(idx+1);
      if (!after.length) after = [segs[segs.length-1]];

      let label = after.slice(-tailDepth).join(' / ').trim();
      label = label.replace(/^income\s*[-:\/]?\s*/i,'').trim();      // strip leading "Income - "
      if (!label) continue;

      const arr = (c.monthly||[]).map(toNum);
      if (!map.has(label)) map.set(label, new Array(arr.length).fill(0));
      const d=map.get(label);
      for (let i=0;i<arr.length;i++) d[i]+=toNum(arr[i]||0);
    }
    return Object.fromEntries(map.entries());
  }

  function seriesIncomeHeuristicFromRaw(categories){
    const map=new Map();
    const incLike = /(pay|paycheck|salary|deposit|reimb|refund|bonus|stipend|w-?2|1099)/i;
    for (const c of (categories||[])){
      const name = String(c.name||'');
      const arr  = (c.monthly||[]).map(toNum);
      if (sum(arr) <= 0) continue;
      if (!incLike.test(name)) continue;
      let label = name.replace(/^income\s*[-:\/]?\s*/i,'').trim();
      if (!label) label = name;
      if (!map.has(label)) map.set(label, new Array(arr.length).fill(0));
      const d = map.get(label);
      for (let i=0;i<arr.length;i++) d[i]+=toNum(arr[i]||0);
    }
    return Object.fromEntries(map.entries());
  }

  const pickTopN=(obj,N)=> Object.entries(obj)
    .map(([k,v])=>[k,(v||[]).map(toNum), (v||[]).reduce((a,b)=>a+toNum(b),0)])
    .filter(([, ,t])=>t>0)
    .sort((a,b)=>b[2]-a[2])
    .slice(0,N)
    .map(([k,v])=>[k,v]);

  const rollingStats=(arr,k=3)=>{ const y=arr.map(toNum),mean=[],sd=[];for(let i=0;i<y.length;i++){const s=Math.max(0,i-k+1),sl=y.slice(s,i+1);const m=sl.length?sl.reduce((a,v)=>a+v,0)/sl.length:0;const v=sl.length>1?sl.reduce((a,v)=>a+(v-m)**2,0)/(sl.length-1):0;mean.push(m);sd.push(Math.sqrt(v));}return{mean,sd}};
  const monthNamesShort=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const seasonality=(monthKeys,series)=>{const sums=Array(12).fill(0),cnt=Array(12).fill(0);series.forEach((v,i)=>{const mk=String(monthKeys[i]||'');if(mk.length>=7){const m=Number(mk.slice(5,7))-1;sums[m]+=toNum(v);cnt[m]+=1;}});return sums.map((s,i)=>cnt[i]?s/cnt[i]:0)};

  /* ====== DOM refs ====== */
  const monthsWindowEl=document.getElementById('monthsWindow');
  const normalizeEl=document.getElementById('normalize');
  const topNEl=document.getElementById('topN'); const topNLabel=document.getElementById('topNLabel');
  const focusMonthEl=document.getElementById('focusMonth');
  const tabs=document.getElementById('viewTabs');
  const paneOverview=document.getElementById('pane-overview');
  const paneExpenses=document.getElementById('pane-expenses');
  const paneIncome=document.getElementById('pane-income');

  const ov_line=document.getElementById('ov_line');
  const ov_net=document.getElementById('ov_net');
  const ov_srate=document.getElementById('ov_srate');
  const ov_cum=document.getElementById('ov_cum');
  const ov_roll=document.getElementById('ov_roll');
  const ov_season=document.getElementById('ov_season');

  const ex_area=document.getElementById('ex_area');
  const ex_treemap=document.getElementById('ex_treemap');
  const ex_heatmap=document.getElementById('ex_heatmap');
  const ex_pareto=document.getElementById('ex_pareto');
  const ex_scatter=document.getElementById('ex_scatter');
  const ex_donut=document.getElementById('ex_donut');
  const ex_tm_month=document.getElementById('ex_tm_month');

  const in_waterfall=document.getElementById('in_waterfall');
  const in_table=document.getElementById('in_table');
  const in_stack=document.getElementById('in_stack');
  const in_heatmap=document.getElementById('in_heatmap');
  const in_timeline=document.getElementById('in_timeline');

  const kpi30d=document.getElementById('inc_kpi_30d');
  const kpiAvg3=document.getElementById('inc_kpi_avg3');
  const kpiNext=document.getElementById('inc_kpi_next30');
  const kpiMed=document.getElementById('inc_kpi_medpay');

  /* ====== state ====== */
  let months=[], topSeries={}, treeDeep=null, categoriesRaw=[];
  let incomeByMonth=[], expenseByMonth=[], netByMonth=[];
  let incomeSubSeries={};
  let handlersAttached=false;

  /* ====== charts (omitted here for brevity; keep your existing renderers) ====== */
  // ... keep your existing renderOverview / stackedArea / stackedBars / treemap / heatmap /
  // pareto / scatterVolAvg / donut / incomeWaterfall / incomeTable / resizeAllPlots / loadRecurrentsIncome /
  // attachDrillHandlers — unchanged from the previous file you pasted, except the seasonality() bug fix above.

  // (For space here, those functions are unchanged; if you need the full file again, I can resend it verbatim.)

  /* ====== REFRESH ====== */
  function nonZeroCount(obj){ return Object.values(obj||{}).filter(arr => (arr||[]).some(v=>toNum(v)!==0)).length; }

  function refreshAll(){
    const N=Number(topNEl.value)||10; topNLabel.textContent=N;
    if (monthsWindowEl) monthsWindowEl.textContent=months.length?(months[0]+' … '+months[months.length-1]):'—';

    // ---- Overview (your existing render calls) ----
    // (call your renderOverview etc.)

    /* Expenses render — unchanged */
    // ...

    /* ---- Income grouping (robust & logged) ---- */
    const incomeTop = subtreeByTop(treeDeep,'Income');
    const s2    = seriesBySecondLevel(incomeTop);
    const sLeaf = seriesByLeaves(incomeTop, 2);
    const sChild= seriesByChildren(incomeTop);
    const rawDeep = seriesIncomeFromRaw(categoriesRaw, 2);
    const rawHeur = seriesIncomeHeuristicFromRaw(categoriesRaw);

    const counts = {
      subtree_children : (incomeTop && (incomeTop.children||[]).length) || 0,
      s2: nonZeroCount(s2),
      sLeaf: nonZeroCount(sLeaf),
      sChild: nonZeroCount(sChild),
      rawDeep: nonZeroCount(rawDeep),
      rawHeur: nonZeroCount(rawHeur)
    };

    // Pick the best available detail
    if      (counts.s2     >= 2) incomeSubSeries = s2;
    else if (counts.sLeaf  >= 2) incomeSubSeries = sLeaf;
    else if (counts.sChild >= 2) incomeSubSeries = sChild;
    else if (counts.rawDeep>= 2) incomeSubSeries = rawDeep;
    else if (counts.rawHeur>= 2) incomeSubSeries = rawHeur;
    else                          incomeSubSeries = { Income: incomeByMonth.slice() };

    console.info('BT income probe', counts,
      { sampleRawIncome:
          (categoriesRaw||[])
            .filter(c => (c.path||[]).some(p=>/income/i.test(p)) || /income/i.test(String(c.name||'')))
            .slice(0,8)
            .map(c=>({name:c.name, path:(c.path||[]).join(' / '), total:sum(c.monthly||[]) }))
      });

    const inEntries = pickTopN(incomeSubSeries, Math.max(5, Math.min(15, N)));

    // ---- render income charts/table (unchanged) ----
    // incomeWaterfall(...); incomeTable(...); stackedBars(...); heatmap(...);

    // KPIs, handlers, resize (unchanged) …
  }

  /* ====== bootstrap ====== */
  (async function main(){
    let payload=null;
    try { payload = JSON.parse(document.getElementById('catMonthlyData')?.textContent || 'null'); } catch {}
    if (!payload || !Array.isArray(payload.months) || !Array.isArray(payload.categories)) {
      try{ const r=await fetch('/api/cat_monthly'); payload=await r.json(); }catch(_){}
    }
    if (!payload || !Array.isArray(payload.months) || !Array.isArray(payload.categories)) {
      document.getElementById('pane-overview').innerHTML='<div class="stat-card"><div class="muted">No category data available.</div></div>';
      return;
    }

    months        = payload.months || [];
    categoriesRaw = payload.categories || [];
    topSeries     = aggregateTopLevel(categoriesRaw);
    treeDeep      = buildTree(categoriesRaw);

    incomeByMonth = (topSeries['Income']||[]).map(toNum);
    expenseByMonth = Object.entries(topSeries).filter(([k])=>k!=='Income')
      .reduce((arr,[,vals])=>{ vals.forEach((v,i)=> arr[i]=(arr[i]||0)+toNum(v)); return arr; }, new Array(months.length).fill(0));
    netByMonth = incomeByMonth.map((v,i)=>v-(expenseByMonth[i]||0));

    // populate UI + first render (your existing calls)
    // populateFocusMonth(); refreshAll(); loadRecurrentsIncome(); window.addEventListener('resize', resizeAllPlots);
  })();
})();
</script>

{% endblock %}

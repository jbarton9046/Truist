{% extends "layout.html" %}
{% block title %}Charts{% endblock %}
{% block content %}

<style>
  /* ---------- original page styles (kept) ---------- */
  .page-header{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}
  .actions{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .stat-card{background:#fff;border:1px solid #e9ecef;border-radius:12px;padding:.9rem;box-shadow:0 6px 16px rgba(0,0,0,.06)}
  .panel-title{font-weight:600;margin-bottom:.5rem}
  .chip{display:inline-flex;align-items:center;gap:.4rem;padding:.2rem .55rem;border:1px solid #e5e7eb;border-radius:999px;background:#f9fafb;font-size:.85rem;color:#111827}
  .tabbar{display:flex;gap:.4rem;flex-wrap:wrap}
  .tab{padding:.2rem .6rem;border:1px solid #e5e7eb;border-radius:999px;background:#fff;font-size:.85rem;color:#111827;cursor:pointer}
  .tab.active{background:#eef2ff;border-color:#c7d2fe;color:#111827}
  .grid{display:grid;gap:1rem}
  .grid-2{grid-template-columns:1.2fr .8fr}
  @media (max-width: 992px){.grid-2{grid-template-columns:1fr}}
  .table-floating{width:100%;border-collapse:separate;border-spacing:0}
  .table-floating thead th{background:#f8fafc;color:#111827;border-bottom:1px solid #e5e7eb;position:sticky;top:var(--sticky-top,0);z-index:1;font-weight:700;letter-spacing:.2px}
  .table-floating tbody td{border-top:1px solid #e5e7eb;vertical-align:middle}
  .table-floating tbody tr:nth-child(odd){background:#fbfdff}
  .table-floating tbody tr:hover{background:#f3f4f6}
  .sh{font-variant-numeric:tabular-nums}
</style>

<!-- ---------- page-scoped DARK/FLOATING look to MATCH Goals ---------- -->
<style id="bt-charts-dark-match">
  /* Page-level accent + compact row height like Goals */
  body[data-route="/charts"]{
    --text: var(--accent-ink) !important;
    --muted: var(--accent-ink) !important;
    --thead-fg: var(--accent-ink) !important;
    --table-head-fg: var(--accent-ink) !important;
  }
  body[data-route="/charts"] *{ color: var(--accent-ink) !important; }
  body[data-route="/charts"] .form-control::placeholder{ color: var(--accent-ink) !important; opacity:.85; }

  body[data-route="/charts"] .stat-card{
    background: var(--card-bg) !important;
    border: 1px solid var(--card-border) !important;
    color: var(--text) !important;
    border-radius: 16px !important;
    box-shadow: 0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05) !important;
    backdrop-filter: saturate(120%) blur(4px);
  }
  body[data-route="/charts"] .chip,
  body[data-route="/charts"] .tab{
    background: rgba(255,255,255,.06) !important;
    border-color: var(--card-border) !important;
    color: var(--text) !important;
  }
  body[data-route="/charts"] .tab.active{
    background: rgba(255,255,255,.10) !important;
    border-color: var(--card-border) !important;
    box-shadow: none !important;
  }

  /* Tables: left-align + compact cell padding to match Goals row height */
  body[data-route="/charts"] .table thead th{
    background: var(--thead-bg) !important;
    color: var(--thead-fg) !important;
    border-bottom: 1px solid var(--hair) !important;
    font-weight: 700; letter-spacing: .2px;
  }
  body[data-route="/charts"] .table th,
  body[data-route="/charts"] .table td{
    text-align: left !important;
    padding: .48rem .70rem !important;
  }
</style>

<div class="container mt-4">
  <div class="page-header">
    <h3 class="m-0">Charts &amp; Insights</h3>
    <div class="actions">
      <div class="tabbar">
        <button class="tab active" data-tab="overview">Overview</button>
        <button class="tab" data-tab="cashflow">Cashflow</button>
        <button class="tab" data-tab="categories">Categories</button>
        <button class="tab" data-tab="accounts">Accounts</button>
      </div>
    </div>
  </div>

  <!-- ===== Overview ===== -->
  <div id="tab-overview" class="grid grid-2">
    <div class="stat-card">
      <div class="panel-title">Monthly Net (last 12)</div>
      <div id="ov-net12" style="height:320px"></div>
    </div>
    <div class="stat-card">
      <div class="panel-title">Income vs Expenses</div>
      <div id="ov-inc-exp" style="height:320px"></div>
    </div>

    <div class="stat-card">
      <div class="panel-title">Top Categories (CM vs LFM vs Goal)</div>
      <div id="ov-topcats" style="height:380px"></div>
    </div>
    <div class="stat-card">
      <div class="panel-title">Category Mix (current month)</div>
      <div id="ov-pie" style="height:380px"></div>
    </div>
  </div>

  <!-- ===== Cashflow ===== -->
  <div id="tab-cashflow" class="grid grid-2" style="display:none">
    <div class="stat-card">
      <div class="panel-title">Running Balance (last 90d)</div>
      <div id="cf-running" style="height:340px"></div>
    </div>
    <div class="stat-card">
      <div class="panel-title">Daily Inflows vs Outflows (last 90d)</div>
      <div id="cf-inout" style="height:340px"></div>
    </div>
  </div>

  <!-- ===== Categories ===== -->
  <div id="tab-categories" class="grid grid-2" style="display:none">
    <div class="stat-card">
      <div class="panel-title">Category Trends (last 6 months)</div>
      <div id="cat-trends" style="height:340px"></div>
    </div>
    <div class="stat-card">
      <div class="panel-title">Heatmap by Month</div>
      <div id="cat-heatmap" style="height:340px"></div>
    </div>
  </div>

  <!-- ===== Accounts ===== -->
  <div id="tab-accounts" class="grid grid-2" style="display:none">
    <div class="stat-card">
      <div class="panel-title">Balances by Account</div>
      <div id="acct-bars" style="height:340px"></div>
    </div>
    <div class="stat-card">
      <div class="panel-title">Balance Share</div>
      <div id="acct-pie" style="height:340px"></div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-2.30.1.min.js"></script>
<script id="charts-bootstrap" type="application/json">
{{ (charts_bootstrap | default({})) | tojson }}
</script>

<script>
(function(){
  'use strict';

  const $ = (sel, ctx=document)=> ctx.querySelector(sel);
  const $$= (sel, ctx=document)=> Array.from(ctx.querySelectorAll(sel));

  const payloadEl = $('#charts-bootstrap');
  let payload = {};
  try { payload = JSON.parse(payloadEl.textContent || '{}'); } catch {}
  const months   = payload.months   || [];
  const series   = payload.series   || {};
  const accounts = payload.accounts || [];

  function monLabel(ym){ const [y,m]=String(ym).split('-').map(Number); return new Date(y,m-1,1).toLocaleString(undefined,{month:'short',year:'2-digit'}); }

  /* ---------- Overview charts ---------- */
  (function(){
    const net = (series.Net || []).map(Number);
    Plotly.react('ov-net12', [{
      type:'bar', x: months.map(monLabel), y: net
    }], { margin:{t:24,r:16,b:40,l:40} });

    const inc = (series.Income||[]).map(Number);
    const exp = (series.Expenses||[]).map(Number);
    Plotly.react('ov-inc-exp', [
      {type:'scatter', mode:'lines+markers', name:'Income', y:inc, x:months.map(monLabel)},
      {type:'scatter', mode:'lines+markers', name:'Expenses', y:exp, x:months.map(monLabel)}
    ], { margin:{t:24,r:16,b:40,l:40} });

    const topCats = (payload.top_categories || []).slice(0,10);
    const labels  = topCats.map(c => c.name);
    const cmVals  = topCats.map(c => Math.abs(Number(c.cm||0)));
    const lfmVals = topCats.map(c => Math.abs(Number(c.lfm||0)));
    const goals   = topCats.map(c => Math.abs(Number(c.goal||0)));
    Plotly.react('ov-topcats', [
      {type:'bar', name:'Actual (CM)',  x:labels, y:cmVals},
      {type:'bar', name:'Actual (LFM)', x:labels, y:lfmVals},
      {type:'bar', name:'Goal',         x:labels, y:goals}
    ], {barmode:'group', margin:{t:24,r:16,b:80,l:48}});

    const pieVals = (payload.mix||[]).map(x => Math.abs(Number(x.value||0)));
    const pieLabs = (payload.mix||[]).map(x => x.name);
    Plotly.react('ov-pie', [{
      type:'pie', values: pieVals, labels: pieLabs, textinfo:'label+percent'
    }], { margin:{t:24,r:16,b:16,l:16} });
  })();

  /* ---------- Cashflow charts ---------- */
  (function(){
    const runX = (payload.cf || {}).days || [];
    const runY = (payload.cf || {}).running || [];
    Plotly.react('cf-running', [{type:'scatter',mode:'lines',x:runX,y:runY}], { margin:{t:24,r:16,b:40,l:48} });

    const inY  = (payload.cf || {}).inflows  || [];
    const outY = (payload.cf || {}).outflows || [];
    Plotly.react('cf-inout', [
      {type:'bar', name:'Inflows', x:runX, y:inY},
      {type:'bar', name:'Outflows', x:runX, y:outY}
    ], {barmode:'group', margin:{t:24,r:16,b:40,l:48}});
  })();

  /* ---------- Categories ---------- */
  (function(){
    const cats = Object.keys(payload.cat_series || {});
    const sel  = cats.slice(0, Math.min(5,cats.length));
    const traces = sel.map(name => ({
      type:'scatter', mode:'lines+markers', name,
      x: months.map(monLabel),
      y: (payload.cat_series[name] || []).map(Number)
    }));
    Plotly.react('cat-trends', traces, { margin:{t:24,r:16,b:40,l:48} });

    const hm = payload.cat_heatmap || {z:[],x:[],y:[]};
    Plotly.react('cat-heatmap', [{
      type:'heatmap', z: hm.z, x: hm.x, y: hm.y, colorscale:'Blues'
    }], { margin:{t:24,r:16,b:40,l:80} });
  })();

  /* ---------- Accounts ---------- */
  (function(){
    const names = accounts.map(a=>a.name);
    const bals  = accounts.map(a=>Number(a.balance||0));
    Plotly.react('acct-bars', [{type:'bar', x:names, y:bals}], { margin:{t:24,r:16,b:80,l:48} });
    Plotly.react('acct-pie',  [{type:'pie', values:bals, labels:names, textinfo:'label+percent'}], { margin:{t:24,r:16,b:16,l:16} });
  })();

  /* ---------- tabs ---------- */
  $$('.tab').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      $$('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const id = btn.getAttribute('data-tab');
      ['overview','cashflow','categories','accounts'].forEach(k=>{
        $('#tab-'+k).style.display = (k===id)?'grid':'none';
      });
      setTimeout(()=>{ try{ Plotly.Plots.resize($('#tab-'+id)); }catch(e){} }, 40);
    });
  });

})();
</script>

<!-- Plotly sweeper to recolor axes/legend to Accent + transparent bg (matches Goals) -->
<script id="bt-plotly-accentize">
  (function(){
    function cssVar(name, fallback){
      var v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
      return v || fallback;
    }
    function patchPlot(gd){
      if (!gd || !gd.layout) return;
      var accent = cssVar('--accent-ink', '#9ecbff');
      var hair   = cssVar('--hair', 'rgba(255,255,255,.12)');
      var gridC  = 'rgba(255,255,255,.14)';
      var u = { paper_bgcolor:'rgba(0,0,0,0)', plot_bgcolor:'rgba(0,0,0,0)', font:{color:accent}, legend:{font:{color:accent}} };
      var keys = Object.keys(gd.layout).filter(function(k){ return /^(x|y)axis(\d+)?$/.test(k); });
      keys.forEach(function(k){
        var ax = gd.layout[k] || {};
        u[k] = Object.assign({}, ax, {
          tickfont: Object.assign({}, ax.tickfont||{}, { color: accent }),
          gridcolor: gridC,
          zerolinecolor: gridC,
          linecolor: hair,
          title: (function(){
            var t = ax.title || {};
            var f = Object.assign({}, (t.font||{}), { color: accent });
            return Object.assign({}, t, { font: f });
          })()
        });
      });
      try { Plotly.relayout(gd, u); } catch(e){}
    }
    function sweep(){
      if (!window.Plotly) return;
      document.querySelectorAll('.js-plotly-plot').forEach(function(gd){ try{ patchPlot(gd); } catch(e){} });
    }
    if (window.Plotly) sweep();
    var tries=0;
    var i=setInterval(function(){ if (window.Plotly){ sweep(); clearInterval(i); } if(++tries>30) clearInterval(i); }, 250);
    try{ new MutationObserver(sweep).observe(document.body, {childList:true, subtree:true}); }catch(e){}
    window.addEventListener('resize', sweep);
  })();
</script>

{% endblock %}

{% extends "layout.html" %}
{% block title %}Charts & Insights{% endblock %}
{% block content %}
<style>
  .page-header{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin-bottom:1rem;flex-wrap:wrap}
  .controls{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}

  .stat-card{position:relative;overflow:visible}
  .stat-card .chart,.stat-card .plot-container,.stat-card .js-plotly-plot{overflow:visible}

  .muted{color:var(--muted)!important}
  .mono{font-variant-numeric:tabular-nums}

  .grid{display:grid;gap:1rem;grid-template-columns:1fr}
  @media (min-width:1200px){.grid{grid-template-columns:1fr 1fr}}

  .chart{width:100%;height:420px}
  .chart.tall{height:520px}

  .chip{padding:.15rem .5rem;border-radius:999px;border:1px solid var(--hair);font-size:.85rem;background:rgba(255,255,255,.06);color:var(--text)}
  .tabs{display:flex;gap:.4rem;flex-wrap:wrap}
  .tab{padding:.3rem .6rem;border:1px solid var(--card-border);border-radius:.5rem;background:rgba(255,255,255,.06);cursor:pointer;user-select:none}
  .tab.active{background:var(--card-bg);box-shadow:0 1px 0 rgba(16,24,40,.06)}

  /* Match Goals: accent ink + left alignment */
  body[data-route="/charts"]{
    --text:var(--accent-ink)!important;
    --muted:var(--accent-ink)!important;
    --thead-fg:var(--accent-ink)!important;
    --table-head-fg:var(--accent-ink)!important;
  }
  body[data-route="/charts"] .table th,
  body[data-route="/charts"] .table td{ text-align:left!important }

  .table-floating{width:100%;border-collapse:separate;border-spacing:0;background:transparent}
  .table-floating thead th{
    background:var(--thead-bg)!important;color:var(--table-head-fg,var(--text))!important;
    border-bottom:1px solid var(--hair)!important;font-weight:700;letter-spacing:.2px
  }
  .table-floating tbody td{border-top:1px solid var(--hair)}
  .table-floating tbody tr:nth-child(odd){background:rgba(255,255,255,.015)}
  .table-floating tbody tr:hover{background:rgba(255,255,255,.05)}

  .kpi-grid{display:grid;gap:.8rem;grid-template-columns:1fr 1fr}
  @media (min-width:992px){.kpi-grid{grid-template-columns:repeat(4,1fr)}}
  .kval{font-size:1.25rem;font-weight:600}
</style>

<div class="container mt-4">
  <div class="page-header">
    <h3 class="m-0">Charts &amp; Insights</h3>
    <div class="controls">
      <div class="tabs" id="viewTabs">
        <div class="tab active" data-view="overview">Overview</div>
        <div class="tab" data-view="expenses">Expenses</div>
        <div class="tab" data-view="income">Income</div>
      </div>

      <label class="form-check-label d-flex align-items-center gap-2 ms-2">
        <input id="normalize" class="form-check-input" type="checkbox">
        Stack as %
      </label>

      <div class="d-flex align-items-center gap-2">
        <label class="form-label m-0 small">Number of Categories</label>
        <input id="topN" type="range" class="form-range" min="5" max="25" step="1" value="10">
        <span id="topNLabel" class="mono small">10</span>
      </div>

      <div class="d-flex align-items-center gap-2">
        <label class="form-label m-0 small">Focus month</label>
        <select id="focusMonth" class="form-select form-select-sm"></select>
      </div>

      <span class="chip">Window: <span id="monthsWindow" class="mono">—</span></span>
    </div>
  </div>

  <!-- OVERVIEW -->
  <div id="pane-overview">
    <div class="grid">
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Income vs Expenses</div>
        <div id="ov_line" class="chart tall"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Net</div>
        <div id="ov_net" class="chart tall"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Savings Rate</div>
        <div id="ov_srate" class="chart"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Cumulative Net</div>
        <div id="ov_cum" class="chart"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Net Rolling Avg</div>
        <div id="ov_roll" class="chart"></div>
      </div>
      <div class="stat-card">
        <div class="mb-2 fw-semibold">Seasonality — Avg by Month-of-Year</div>
        <div id="ov_season" class="chart"></div>
      </div>
    </div>
  </div>

  <!-- EXPENSES -->
  <div id="pane-expenses" style="display:none;">
    <div class="grid">
      <div class="stat-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Top Expenses — Stacked Area</div>
          <div class="muted small">Hover to see breakdown</div>
        </div>
        <div id="ex_area" class="chart tall"></div>
      </div>

      <div class="stat-card">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Expenses Treemap — <span id="ex_tm_month" class="mono">—</span></div>
          <div class="muted small">Click to drill within chart</div>
        </div>
        <div id="ex_treemap" class="chart tall"></div>
      </div>

      <div class="stat-card">
        <div class="mb-2 fw-semibold">Expense Heatmap (Top N)</div>
        <div id="ex_heatmap" class="chart"></div>
      </div>

      <div class="stat-card">
        <div class="mb-2 fw-semibold">Pareto — Cumulative Share of Spend</div>
        <div id="ex_pareto" class="chart"></div>
      </div>

      <div class="stat-card">
        <div class="mb-2 fw-semibold">Expense Volatility vs Average</div>
        <div id="ex_scatter" class="chart"></div>
      </div>

      <div class="stat-card">
        <div class="mb-2 fw-semibold">Current Month Split — Donut</div>
        <div id="ex_donut" class="chart"></div>
      </div>
    </div>
  </div>

  <!-- INCOME -->
  <div id="pane-income" style="display:none;">
    <div class="kpi-grid mb-3">
      <div class="stat-card"><div class="muted small">Income (last 30 days)</div><div id="inc_kpi_30d" class="kval mono">—</div></div>
      <div class="stat-card"><div class="muted small">Avg monthly (last 3m)</div><div id="inc_kpi_avg3" class="kval mono">—</div></div>
      <div class="stat-card"><div class="muted small">Next 30d (recurrents)</div><div id="inc_kpi_next30" class="kval mono">—</div></div>
      <div class="stat-card"><div class="muted small">Median paycheck (recurrents)</div><div id="inc_kpi_medpay" class="kval mono">—</div></div>
    </div>

    <div class="row g-3">
      <div class="col-xl-7">
        <div class="stat-card h-100">
          <div class="mb-2 fw-semibold">Income MoM — Waterfall</div>
          <div id="in_waterfall" class="chart"></div>
        </div>
      </div>

      <div class="col-xl-5">
        <div class="stat-card h-100">
          <div class="mb-2 fw-semibold">Income Sources (Top N)</div>
          <div id="in_table"></div>
        </div>
      </div>

      <div class="col-xl-12">
        <div class="stat-card">
          <div class="mb-2 fw-semibold">Income by Source — Stacked Bars</div>
          <div id="in_stack" class="chart"></div>
        </div>
      </div>

      <div class="col-xl-7">
        <div class="stat-card">
          <div class="mb-2 fw-semibold">Income Heatmap (Top N)</div>
          <div id="in_heatmap" class="chart"></div>
        </div>
      </div>

      <div class="col-xl-5">
        <div class="stat-card">
          <div class="mb-2 fw-semibold">Paycheck timeline (next 60–90d)</div>
          <div id="in_timeline" class="chart"></div>
          <div id="in_upcoming" class="mt-2"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Server-injected data (preferred) -->
<script id="catMonthlyData" type="application/json">
{{ (cat_monthly | default({})) | tojson }}
</script>

<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

<script>
(function(){
  'use strict';

  /* Theme helpers */
  const cssVar = (name, fallback) => {
    const v = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    return v || fallback;
  };
  const ACCENT = () => cssVar('--accent-ink','#9ecbff');
  const GRID   = () => 'rgba(255,255,255,.14)';
  const HAIR   = () => cssVar('--hair','rgba(255,255,255,.12)');

  /* Floating feel */
  const OP_LINE = 0.68, OP_BAR = 0.72, OP_AREA = 0.48, OP_MARK = 0.78;

  const baseLayout = (extra={}) => ({
    paper_bgcolor:'rgba(0,0,0,0)',
    plot_bgcolor:'rgba(0,0,0,0)',
    font:{color:ACCENT()},
    margin:{l:60,r:40,t:10,b:40},
    xaxis:{type:'category', tickfont:{color:ACCENT()}, gridcolor:GRID(), linecolor:HAIR(), zerolinecolor:GRID()},
    yaxis:{tickfont:{color:ACCENT()}, gridcolor:GRID(), linecolor:HAIR(), zerolinecolor:GRID(), rangemode:extra.yZero?'tozero':undefined},
    legend:{orientation:'h', y:-0.25, font:{color:ACCENT()}},
    hoverlabel:{font:{color:ACCENT()}},
    ...extra
  });

  function safeReact(target, traces, layout, config){
    try{
      Plotly.react(target, traces, layout, Object.assign({responsive:true,displayModeBar:false}, config||{}));
    }catch(err){
      try { target.innerHTML = '<div class="muted small ms-2 me-2">This chart could not be rendered for the selected window.</div>'; } catch(_){}
      console.error('Plotly render failed:', err);
    }
  }

  /* Utils & math */
  const toNum = v => (typeof v==='number' && isFinite(v)) ? v : (Number(String(v||'').replace(/[$,]/g,''))||0);
  const sum = a => a.reduce((x,y)=>x+toNum(y),0);
  const money = n => (toNum(n)<0?'-$':'$') + Math.abs(toNum(n)).toLocaleString(undefined,{maximumFractionDigits:0});
  const money2 = n => (toNum(n)<0?'-$':'$') + Math.abs(toNum(n)).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  const prettyMonth = ym => { if(!ym||ym.length<7)return ym||'—';const [y,m]=ym.split('-').map(Number);return new Date(y,(m||1)-1,1).toLocaleString(undefined,{month:'long',year:'numeric'})};
  const parseISO = s => { const [y,m,d]=String(s||'').slice(0,10).split('-').map(Number); return (y&&m&&d)?new Date(y,m-1,d):null; };

  /* Prefer real path array if present */
  const segsOf = item => {
    if (item && Array.isArray(item.path) && item.path.length) return item.path.map(String);
    const name = String(item?.name || '');
    return name.includes(' / ') ? name.split(' / ').map(s=>s.trim()).filter(Boolean) : [name];
  };

  /* Aggregations / tree */
  const aggregateTopLevel = categories => {
    const map = new Map();
    for (const c of (categories||[])){
      const top = segsOf(c)[0] || '(Uncategorized)';
      const arr = (c.monthly||[]).map(toNum);
      if (!map.has(top)) map.set(top, new Array(arr.length).fill(0));
      const dest = map.get(top); for(let i=0;i<arr.length;i++) dest[i]+=arr[i];
    }
    return Object.fromEntries(map.entries());
  };

  function buildTree(categories){
    const root={name:'All',path:[],monthly:[],children:[]}; const map=new Map(); map.set('',root);
    const keyOf=s=>s.join(' / ');
    const getNode=segs=>{ const k=keyOf(segs); if(map.has(k))return map.get(k);
      const n={name:segs[segs.length-1],path:[...segs],monthly:[],children:[]};
      const p=getNode(segs.slice(0,-1)); p.children.push(n); map.set(k,n); return n; };
    (categories||[]).forEach(c=>{ const segs=segsOf(c); const leaf=getNode(segs.length?segs:[c.name||'']); leaf.monthly=(c.monthly||[]).map(toNum); });
    const roll=n=>{ if(!n.children.length) return n.monthly||[]; const L=Math.max(0,...n.children.map(ch=>(ch.monthly||[]).length));
      const agg=new Array(L).fill(0); for(const ch of n.children){ const cm=roll(ch); for(let i=0;i<L;i++) agg[i]+=toNum(cm[i]||0); }
      n.monthly=agg; return agg; };
    roll(root); return root;
  }

  function buildTreemapNodes(root, expensesOnly=true){
    const out=[];
    function visit(node, parentId){
      const id = (node.path||[]).join(' / ');
      const isTop = node.path && node.path.length===1;
      const isIncomeTop = isTop && String(node.name||'').toLowerCase()==='income';
      if (node.path && node.path.length && (!expensesOnly || !isIncomeTop)) {
        out.push({ id, label: node.name || '—', parent: parentId || '', value: (node.monthly||[]).map(toNum) });
      }
      (node.children||[]).forEach(ch => {
        if (expensesOnly && String(ch.name||'').toLowerCase()==='income') return;
        visit(ch, id);
      });
    }
    (root.children||[]).forEach(ch => visit(ch, ''));
    return out;
  }

  const subtreeByTop=(root,name)=> (root.children||[]).find(c=>(String(c.name||'')===String(name)))||null;

  /* Sum leaves into their level-2 bucket under a subtree (Income) */
  function seriesBySecondLevel(sub){
    const map=new Map(); if(!sub) return {};
    const visit=n=>{
      if(!n.children.length){
        const lvl2=n.path[1]||n.name; const arr=n.monthly||[];
        if(!map.has(lvl2)) map.set(lvl2,new Array(arr.length).fill(0));
        const d=map.get(lvl2); for(let i=0;i<arr.length;i++) d[i]+=toNum(arr[i]||0);
      } else n.children.forEach(visit);
    };
    (sub.children||[]).forEach(visit);
    return Object.fromEntries(map.entries());
  }
  /* Fallback: group by immediate children */
  function seriesByChildren(sub){
    const map=new Map(); if(!sub) return {};
    (sub.children||[]).forEach(ch=>{
      const arr=(ch.monthly||[]).map(toNum);
      map.set(ch.name||'(child)', arr);
    });
    return Object.fromEntries(map.entries());
  }

  const pickTopN=(obj,N)=> Object.entries(obj)
    .map(([k,v])=>[k,(v||[]).map(toNum), (v||[]).reduce((a,b)=>a+toNum(b),0)])
    .filter(([, ,t])=>t>0)
    .sort((a,b)=>b[2]-a[2])
    .slice(0,N)
    .map(([k,v])=>[k,v]);

  const rollingStats=(arr,k=3)=>{ const y=arr.map(toNum),mean=[],sd=[];for(let i=0;i<y.length;i++){const s=Math.max(0,i-k+1),sl=y.slice(s,i+1);const m=sl.length?sl.reduce((a,v)=>a+v,0)/sl.length:0;const v=sl.length>1?sl.reduce((a,v)=>a+(v-m)**2,0)/(sl.length-1):0;mean.push(m);sd.push(Math.sqrt(v));}return{mean,sd}};
  const monthNamesShort=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const seasonality=(monthKeys,series)=>{const sums=Array(12).fill(0),cnt=Array(12).fill(0);series.forEach((v,i)=>{const mk=String(monthKeys[i]||'');if(mk.length>=7){const m=Number(mk.slice(5,7))-1;sums[m]+=toNum(v);cnt[m]+=1;}});return sums.map((s,i)=>cnt[i]?s/cnt[i]:0)};

  /* DOM refs */
  const monthsWindow=document.getElementById('monthsWindow');
  const normalizeEl=document.getElementById('normalize');
  const topNEl=document.getElementById('topN'); const topNLabel=document.getElementById('topNLabel');
  const focusMonthEl=document.getElementById('focusMonth');
  const tabs=document.getElementById('viewTabs');
  const paneOverview=document.getElementById('pane-overview');
  const paneExpenses=document.getElementById('pane-expenses');
  const paneIncome=document.getElementById('pane-income');

  const ov_line=document.getElementById('ov_line');
  const ov_net=document.getElementById('ov_net');
  const ov_srate=document.getElementById('ov_srate');
  const ov_cum=document.getElementById('ov_cum');
  const ov_roll=document.getElementById('ov_roll');
  const ov_season=document.getElementById('ov_season');

  const ex_area=document.getElementById('ex_area');
  const ex_treemap=document.getElementById('ex_treemap');
  const ex_heatmap=document.getElementById('ex_heatmap');
  const ex_pareto=document.getElementById('ex_pareto');
  const ex_scatter=document.getElementById('ex_scatter');
  const ex_donut=document.getElementById('ex_donut');
  const ex_tm_month=document.getElementById('ex_tm_month');

  const in_waterfall=document.getElementById('in_waterfall');
  const in_table=document.getElementById('in_table');
  const in_stack=document.getElementById('in_stack');
  const in_heatmap=document.getElementById('in_heatmap');
  const in_timeline=document.getElementById('in_timeline');

  const kpi30d=document.getElementById('inc_kpi_30d');
  const kpiAvg3=document.getElementById('inc_kpi_avg3');
  const kpiNext=document.getElementById('inc_kpi_next30');
  const kpiMed=document.getElementById('inc_kpi_medpay');

  /* Data holders */
  let months=[], topSeries={}, treeDeep=null;
  let incomeByMonth=[], expenseByMonth=[], netByMonth=[];
  let incomeSubSeries={};
  let handlersAttached=false;

  /* Charts */
  function renderOverview(){
    safeReact(ov_line, [
      {type:'scatter',mode:'lines+markers',opacity:OP_LINE,name:'Income',x:months,y:incomeByMonth,hovertemplate:'%{x}<br>Income: %{y:,.0f}<extra></extra>'},
      {type:'scatter',mode:'lines+markers',opacity:OP_LINE,name:'Expenses',x:months,y:expenseByMonth,hovertemplate:'%{x}<br>Expenses: %{y:,.0f}<extra></extra>'}
    ], baseLayout({}));

    const colors = netByMonth.map(v=>v>=0?'#22c55e':'#ef4444');
    safeReact(ov_net, [{type:'bar',opacity:OP_BAR,x:months,y:netByMonth,marker:{color:colors},hovertemplate:'%{x}<br>Net: %{y:,.0f}<extra></extra>'}],
      baseLayout({yaxis:{title:'Income − Expenses',tickfont:{color:ACCENT()},gridcolor:GRID(),linecolor:HAIR()},yZero:true}));

    const sRate = incomeByMonth.map((inc,i)=> toNum(inc)?(toNum(netByMonth[i])/Math.max(1,toNum(inc)))*100:0).map(v=>Math.max(-200,Math.min(200,v)));
    safeReact(ov_srate,[{type:'scatter',mode:'lines+markers',opacity:OP_LINE,x:months,y:sRate,hovertemplate:'%{x}<br>Savings rate: %{y:.1f}%<extra></extra>'}],
      baseLayout({yaxis:{title:'%',rangemode:'tozero'},shapes:[{type:'line',xref:'paper',x0:0,x1:1,y0:0,y1:0,line:{width:1,dash:'dot'}}]}));

    let run=0; const cum=netByMonth.map(v=>run+=toNum(v));
    safeReact(ov_cum,[{type:'scatter',mode:'lines',opacity:OP_AREA,fill:'tozeroy',x:months,y:cum,hovertemplate:'%{x}<br>Cumulative: %{y:,.0f}<extra></extra>'}],
      baseLayout({shapes:[{type:'line',xref:'paper',x0:0,x1:1,y0:0,y1:0,line:{width:1,dash:'dot'}}]}));

    const rs=rollingStats(netByMonth,3);
    const upper=rs.mean.map((m,i)=>m+(rs.sd[i]||0)), lower=rs.mean.map((m,i)=>m-(rs.sd[i]||0));
    safeReact(ov_roll,[
      {type:'scatter',x:months,y:lower,mode:'lines',line:{width:0},name:'-1σ',hoverinfo:'skip',opacity:0},
      {type:'scatter',x:months,y:upper,mode:'lines',fill:'tonexty',line:{width:0},name:'+1σ',hoverinfo:'skip',opacity:0.25},
      {type:'scatter',x:months,y:rs.mean,mode:'lines+markers',name:'Rolling mean',opacity:OP_LINE,hovertemplate:'%{x}<br>Mean: %{y:,.0f}<extra></extra>'}
    ], baseLayout({}));

    const incSeason=seasonality(months,incomeByMonth), expSeason=seasonality(months,expenseByMonth);
    safeReact(ov_season,[
      {type:'bar',x:monthNamesShort,y:incSeason,name:'Income',opacity:OP_BAR,hovertemplate:'%{x}<br>%{y:,.0f}<extra></extra>'},
      {type:'bar',x:monthNamesShort,y:expSeason,name:'Expenses',opacity:OP_BAR,hovertemplate:'%{x}<br>%{y:,.0f}<extra></extra>'}
    ], baseLayout({barmode:'group',yaxis:{title:'Average amount',tickfont:{color:ACCENT()},gridcolor:GRID()},xaxis:{title:'Month-of-year'}}));
  }

  function stackedArea(targetEl, months, entries, normalize){
    if(!entries.length){ safeReact(targetEl,[],baseLayout({})); return;}
    const traces = entries.map(([name,arr]) => normalize
      ? {x:months,y:arr,name,stackgroup:'one',groupnorm:'percent',type:'scatter',mode:'lines',opacity:OP_AREA,hovertemplate:`%{x}<br>${name}: %{y:.1f}%<extra></extra>`}
      : {x:months,y:arr,name,stackgroup:'one',type:'scatter',mode:'lines',opacity:OP_AREA,hovertemplate:`%{x}<br>${name}: %{y:,.0f}<extra></extra>`});
    safeReact(targetEl,traces,baseLayout({yaxis:{title:normalize?'% of total':'Amount',rangemode:'tozero'}}));
  }

  function stackedBars(targetEl, months, entries, normalize){
    const traces = entries.map(([name,arr])=>({type:'bar',name,x:months,y:arr,opacity:OP_BAR,hovertemplate:`%{x}<br>${name}: %{y:,.0f}<extra></extra>`}));
    safeReact(targetEl,traces,baseLayout({barmode:'stack',barnorm:normalize?'percent':undefined,yaxis:{title:normalize?'% of total':'Amount',rangemode:'tozero'}}));
  }

  function treemap(targetEl, nodes, focusIdx){
    const values = nodes.map(n=>toNum((n.value&&n.value[focusIdx])||0));
    const total = values.reduce((a,b)=>a+Math.max(0,b),0);
    if(!nodes.length || total<=0){
      targetEl.innerHTML = '<div class="muted small ms-2 me-2">No expense detail for this month.</div>';
      return;
    }
    safeReact(targetEl,[{
      type:'treemap',
      labels:nodes.map(n=>n.label),
      parents:nodes.map(n=>n.parent),
      values:values,
      ids:nodes.map(n=>n.id),
      branchvalues:'total',
      maxdepth:2,
      pathbar:{visible:true},
      hovertemplate:'%{label}<br>%{value:,.0f}<extra></extra>'
    }], baseLayout({margin:{l:10,r:10,t:0,b:0}}));
  }

  function heatmap(targetEl, months, entries){
    const z=entries.map(([,arr])=>arr), y=entries.map(([name])=>name);
    safeReact(targetEl,[{type:'heatmap',z,y,x:months,hovertemplate:'%{y}<br>%{x}: %{z:,.0f}<extra></extra>',colorscale:'Blues'}],
      baseLayout({margin:{l:110,r:30,t:10,b:40}}));
  }

  function pareto(targetEl, entries){
    const totals=entries.map(([,arr])=>sum(arr)); const labels=entries.map(([n])=>n);
    const cum=[]; let r=0; const grand=sum(totals); for(let i=0;i<totals.length;i++){r+=totals[i]; cum.push(grand?(r/grand)*100:0);}
    const bar={type:'bar',x:labels,y:totals,name:'Total',opacity:OP_BAR,hovertemplate:'%{x}: %{y:,.0f}<extra></extra>'};
    const line={type:'scatter',x:labels,y:cum,name:'Cumulative %',yaxis:'y2',mode:'lines+markers',opacity:OP_LINE,hovertemplate:'%{x}: %{y:.1f}%<extra></extra>'};
    safeReact(targetEl,[bar,line],
      {...baseLayout({margin:{l:60,r:50,t:10,b:100}}),
       yaxis:{title:'Amount',tickfont:{color:ACCENT()},gridcolor:GRID(),linecolor:HAIR()},
       yaxis2:{overlaying:'y',side:'right',range:[0,100],title:'Cumulative %',tickfont:{color:ACCENT()},gridcolor:GRID(),linecolor:HAIR()},
       xaxis:{tickangle:-45}});
  }

  function scatterVolAvg(targetEl, entries){
    const avg=a=>a.length?sum(a)/a.length:0;
    const stdev=arr=>{const n=arr.length;if(n<2)return 0;const m=avg(arr);const v=arr.reduce((s,v)=>s+(toNum(v)-m)**2,0)/(n-1);return Math.sqrt(v)};
    const xs=[],ys=[],sizes=[],labels=[];
    entries.forEach(([name,arr])=>{const a=avg(arr);const vol=a?(stdev(arr)/Math.abs(a))*100:0;xs.push(a);ys.push(vol);sizes.push(Math.max(6,Math.sqrt(sum(arr))));labels.push(name)});
    safeReact(targetEl,[{type:'scattergl',mode:'markers',x:xs,y:ys,text:labels,marker:{size:sizes,sizemode:'diameter',opacity:OP_MARK},hovertemplate:'%{text}<br>Avg/mo: %{x:,.0f}<br>Vol: %{y:.0f}%<extra></extra>'}],
      baseLayout({xaxis:{title:'Average per month'},yaxis:{title:'Volatility (stdev / mean %)',rangemode:'tozero'}}));
  }

  function donut(targetEl, entries, monthIdx){
    const labels=[], values=[]; entries.forEach(([n,a])=>{labels.push(n);values.push(toNum(a[monthIdx]||0))});
    let other=0; const keepL=[], keepV=[]; const grand=values.reduce((a,b)=>a+Math.max(0,b),0)||1;
    values.forEach((v,i)=>{ if(v/grand<0.03) other+=v; else {keepL.push(labels[i]); keepV.push(v);} });
    if(other>0){keepL.push('Other'); keepV.push(other);}
    safeReact(targetEl,[{type:'pie',labels:keepL,values:keepV,hole:0.55,opacity:0.9,hovertemplate:'%{label}: %{value:,.0f} (%{percent})<extra></extra>'}],
      baseLayout({margin:{l:10,r:10,t:10,b:10}}));
  }

  function incomeWaterfall(targetEl, months, income){
    if(!income.length){ safeReact(targetEl,[],baseLayout({})); return; }
    const diffs=income.map((v,i)=> i===0?v:(v-income[i-1]));
    safeReact(targetEl,[{type:'waterfall',x:months,y:diffs,opacity:OP_BAR,
      increasing:{marker:{color:'#22c55e',opacity:OP_BAR}},decreasing:{marker:{color:'#ef4444',opacity:OP_BAR}},
      hovertemplate:'%{x}<br>Δ %{y:,.0f}<extra></extra>'}],
      baseLayout({yaxis:{title:'Change vs prior'}}));
  }

  function incomeTable(targetEl, months, entries){
    const grand=entries.reduce((t,[,arr])=>t+sum(arr),0);
    const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]));
    const rows=entries.map(([name,arr])=>{
      const total=sum(arr), avg=months.length?total/months.length:0, last=arr[arr.length-1]||0, pct=grand?(total/grand)*100:0;
      return `<tr>
        <td>${esc(name)}</td>
        <td class="mono">${total.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
        <td class="mono">${avg.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
        <td class="mono">${last.toLocaleString(undefined,{maximumFractionDigits:0})}</td>
        <td class="mono">${pct.toFixed(1)}%</td>
      </tr>`;
    }).join('');
    targetEl.innerHTML=`
      <div class="table-responsive" style="max-height:420px;overflow:auto;">
        <table class="table table-sm align-middle table-floating mb-0">
          <thead>
            <tr>
              <th>Source</th>
              <th>Total (window)</th>
              <th>Avg / mo</th>
              <th>Last month</th>
              <th>% of income</th>
            </tr>
          </thead>
          <tbody>${rows || `<tr><td colspan="5" class="muted">No income sources in range.</td></tr>`}</tbody>
        </table>
      </div>`;
  }

  function resizeAllPlots(){
    const els=[ov_line,ov_net,ov_srate,ov_cum,ov_roll,ov_season,ex_area,ex_treemap,ex_heatmap,ex_pareto,ex_scatter,ex_donut,in_waterfall,in_stack,in_heatmap,in_timeline];
    requestAnimationFrame(()=>{ els.forEach(el=>{try{Plotly.Plots.resize(el)}catch(_){}}); });
  }

  /* paycheck timeline (from /api/recurrents) */
  async function loadRecurrentsIncome(){
    try{
      const r=await fetch('/api/recurrents?horizon=90'); const data=await r.json();
      const streams=(data.streams||[]); const incomeMerchants=new Set(streams.filter(s=>(s.categories||[]).some(c=>String(c).toLowerCase()==='income')).map(s=>s.merchant));
      const incomeStreams=streams.filter(s=>incomeMerchants.has(s.merchant));
      const amounts=incomeStreams.map(s=>toNum(s.amount)).filter(v=>v>0).sort((a,b)=>a-b);
      const med=amounts.length?(amounts.length%2?amounts[(amounts.length-1)/2]:(amounts[amounts.length/2-1]+amounts[amounts.length/2])/2):0;
      document.getElementById('inc_kpi_medpay').textContent=med?money(med):'—';

      const today=new Date(); today.setHours(0,0,0,0);
      const plus30=new Date(today.getFullYear(),today.getMonth(),today.getDate()+30);
      const upcomingAll=(data.upcoming||[]).map(u=>({...u,dt:parseISO(u.date)})).filter(u=>u.dt);
      const upcomingIncome=upcomingAll.filter(u=>incomeMerchants.has(u.merchant)).sort((a,b)=>a.dt-b.dt);
      const next30Income=upcomingIncome.filter(u=>u.dt<=plus30).reduce((t,u)=>t+toNum(u.amount),0);
      document.getElementById('inc_kpi_next30').textContent=upcomingIncome.length?money(next30Income):'—';

      safeReact(in_timeline,[{type:'scatter',mode:'markers',opacity:OP_MARK,x:upcomingIncome.map(u=>u.date),y:upcomingIncome.map(u=>toNum(u.amount)),text:upcomingIncome.map(u=>`${u.merchant}<br>${money2(u.amount)}`),hovertemplate:'%{x}<br>%{text}<extra></extra>'}],
        baseLayout({xaxis:{title:'Upcoming dates'},yaxis:{title:'Amount',rangemode:'tozero'}}));

      const host=document.getElementById('in_upcoming');
      const rows=upcomingIncome.slice(0,10).map(u=>`<tr><td>${u.date}</td><td>${u.merchant}</td><td class="mono">${money2(u.amount)}</td></tr>`).join('');
      host.innerHTML=`<div class="table-responsive" style="max-height:200px;overflow:auto;">
        <table class="table table-sm table-floating mb-0">
          <thead><tr><th>Date</th><th>Merchant</th><th>Amount</th></tr></thead>
          <tbody>${rows || `<tr><td colspan="3" class="muted">No upcoming income in horizon.</td></tr>`}</tbody>
        </table>
      </div>`;
    }catch{
      safeReact(in_timeline,[],baseLayout({}));
      document.getElementById('in_upcoming').innerHTML='<div class="muted small">Couldn’t load upcoming from /api/recurrents.</div>';
    }
  }

  function attachDrillHandlers(months){
    if(handlersAttached) return; handlersAttached=true;
    if(in_waterfall && typeof in_waterfall.on==='function' && window.openCategoryManager){
      in_waterfall.on('plotly_click',ev=>{const pt=ev.points?.[0]; if(!pt) return; const month=String(pt.x).slice(0,7); window.openCategoryManager({level:'category',cat:'Income',month});});
    }
  }

  function refreshAll(){
    const N=Number(topNEl.value)||10; topNLabel.textContent=N;
    monthsWindow.textContent=months.length?(months[0]+' … '+months[months.length-1]):'—';

    renderOverview();

    /* Expenses */
    const exObj=Object.fromEntries(Object.entries(topSeries).filter(([k])=>k!=='Income'));
    const exEntries=pickTopN(exObj,N);
    stackedArea(ex_area,months,exEntries,!!normalizeEl.checked);

    document.getElementById('ex_tm_month').textContent=months.length?prettyMonth(months[Math.max(0,focusMonthEl.selectedIndex)]):'—';
    const focusIdx=Math.max(0,Math.min(focusMonthEl.selectedIndex, Math.max(0, months.length-1)));
    let nodes=[];
    try{
      if(treeDeep && (treeDeep.children||[]).length){
        nodes = buildTreemapNodes(treeDeep,true);   // expenses only
      }else{
        nodes = exEntries.map(([name,arr])=>({label:name,parent:'',value:arr,id:name}));
      }
    }catch(_){
      nodes = exEntries.map(([name,arr])=>({label:name,parent:'',value:arr,id:name}));
    }
    treemap(ex_treemap,nodes,focusIdx);

    heatmap(ex_heatmap,months,exEntries);
    pareto(ex_pareto,exEntries);
    scatterVolAvg(ex_scatter,exEntries);
    donut(ex_donut,exEntries,focusIdx);

    /* Income (robust fallbacks) */
    const incomeTop = subtreeByTop(treeDeep,'Income');
    incomeSubSeries = seriesBySecondLevel(incomeTop);
    if (!Object.keys(incomeSubSeries).length) incomeSubSeries = seriesByChildren(incomeTop);
    if (!Object.keys(incomeSubSeries).length) incomeSubSeries = { Income: incomeByMonth.slice() };

    const inEntries = pickTopN(incomeSubSeries, Math.max(5, Math.min(15, N)));
    incomeWaterfall(in_waterfall,months,incomeByMonth);
    incomeTable(in_table,months,inEntries);
    stackedBars(in_stack,months,inEntries,!!normalizeEl.checked);
    heatmap(in_heatmap,months,inEntries);

    attachDrillHandlers(months);
    const lastMonthIncome=incomeByMonth.at(-1)||0; kpi30d.textContent=incomeByMonth.length?money(lastMonthIncome):'—';
    const last3=incomeByMonth.slice(-3); const avg3=last3.length?last3.reduce((a,v)=>a+toNum(v),0)/last3.length:0; kpiAvg3.textContent=last3.length?money(avg3):'—';

    resizeAllPlots();
  }

  /* UI */
  tabs.addEventListener('click',e=>{
    const t=e.target.closest('.tab'); if(!t) return;
    tabs.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
    const view=t.getAttribute('data-view');
    paneOverview.style.display=(view==='overview')?'':'none';
    paneExpenses.style.display=(view==='expenses')?'':'none';
    paneIncome.style.display=(view==='income')?'':'none';
    setTimeout(refreshAll,0);
  });
  normalizeEl.addEventListener('change',refreshAll);
  topNEl.addEventListener('input',refreshAll);
  focusMonthEl.addEventListener('change',refreshAll);

  function populateFocusMonth(){
    focusMonthEl.innerHTML='';
    months.forEach((m,i)=>{ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=prettyMonth(m); focusMonthEl.appendChild(opt); });
    focusMonthEl.selectedIndex=Math.max(0,months.length-1);
  }

  /* Bootstrap */
  (async function main(){
    let payload=null;
    try { payload = JSON.parse(document.getElementById('catMonthlyData')?.textContent || 'null'); } catch {}
    if (!payload || !Array.isArray(payload.months) || !Array.isArray(payload.categories)) {
      try{ const r=await fetch('/api/cat_monthly'); payload=await r.json(); }catch(_){}
    }
    if (!payload || !Array.isArray(payload.months) || !Array.isArray(payload.categories)) {
      document.getElementById('pane-overview').innerHTML='<div class="stat-card"><div class="muted">No category data available.</div></div>';
      return;
    }

    months = payload.months || [];
    topSeries = aggregateTopLevel(payload.categories || []);
    treeDeep = buildTree(payload.categories || []);

    incomeByMonth = (topSeries['Income']||[]).map(toNum);
    expenseByMonth = Object.entries(topSeries).filter(([k])=>k!=='Income')
      .reduce((arr,[,vals])=>{ vals.forEach((v,i)=> arr[i]=(arr[i]||0)+toNum(v)); return arr; }, new Array(months.length).fill(0));
    netByMonth = incomeByMonth.map((v,i)=>v-(expenseByMonth[i]||0));

    populateFocusMonth();
    refreshAll();
    loadRecurrentsIncome();
    window.addEventListener('resize', resizeAllPlots);
  })();
})();
</script>
{% endblock %}

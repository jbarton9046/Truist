<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ title if title else "BartonTech" }}</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- PWA -->
    <link rel="manifest" type="application/manifest+json" href="{{ url_for('static', filename='manifest.webmanifest') }}">
    <meta name="theme-color" content="#0d6efd">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/icon-180-apple.png') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BartonTech">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
      :root { --nav-h: 56px; --sticky-top: var(--nav-h); }
      html, body { min-height: 100%; }
      body {
        padding-top: calc(var(--nav-h) + env(safe-area-inset-top, 0px));
        padding-left:  env(safe-area-inset-left, 0px);
        padding-right: env(safe-area-inset-right, 0px);
      }
      .offcanvas.manage-drawer, #dashCategoryManager.offcanvas { width: 480px; }
      .muted { color:#6c757d; }
      .mono { font-variant-numeric: tabular-nums; }
      .tx-neg { color:#c0392b; font-weight:600; }
      .tx-pos { color:#1e7e34; font-weight:600; }

      /* Sticky table headers (no navbar offset) */
      .table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--table-head-bg, transparent);
        color: var(--table-head-fg, inherit);
      }
    </style>

    <!-- Site CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/neon-tech.css') }}?v=2025-09-02-01">

    <!-- >>> SITE-WIDE DARK / FLOATING THEME <<< -->
    <style id="app-theme">
      :root{
        --page-bg-1:#0b1220;
        --page-bg-2:#0f172a;
        --glow-1:#243b55;
        --glow-2:#1b3a6b;

        /* Accent ink used everywhere */
        --accent-ink:#9ecbff;
        --text: var(--accent-ink);
        --muted: var(--accent-ink);

        --card-bg:rgba(255,255,255,.045);
        --card-border:rgba(255,255,255,.10);
        --hair:rgba(255,255,255,.08);

        --thead-bg:rgba(255,255,255,.06);
        --thead-fg: var(--accent-ink);

        --table-head-bg: var(--thead-bg);
        --table-head-fg: var(--thead-fg);

        /* Plotly grid tone (soft bluish) */
        --plotly-grid: rgba(158,203,255,.11);

        /* Global scrollbar tokens (use accent ink) */
        --scroll-track: transparent;
        --scroll-thumb: color-mix(in oklab, var(--accent-ink) 58%, transparent);
        --scroll-thumb-hover: color-mix(in oklab, var(--accent-ink) 82%, transparent);
        --scroll-border: rgba(255,255,255,.22);
      }

      html.theme-dark, body.theme-dark {
        background:
          radial-gradient(1200px 700px at -10% -10%, var(--glow-1) 0%, transparent 45%),
          radial-gradient(900px 600px at 110% 0%, var(--glow-2) 0%, transparent 40%),
          linear-gradient(180deg, var(--page-bg-2) 0%, var(--page-bg-1) 100%) !important;
        color: var(--text);
      }

      .navbar {
        background: var(--card-bg) !important;
        border-bottom: 1px solid var(--card-border) !important;
        backdrop-filter: saturate(120%) blur(6px);
      }
      .navbar, .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-text {
        color: var(--text) !important;
      }
      .navbar .nav-link.active, .navbar .nav-link:hover { color: #ffffff !important; }

      .card, .stat-card, .panel, .list-group, .offcanvas, .modal-content {
        background: var(--card-bg) !important;
        border: 1px solid var(--card-border) !important;
        color: var(--text);
        box-shadow:
          0 12px 28px rgba(0,0,0,.35),
          inset 0 1px 0 rgba(255,255,255,.05);
        border-radius: 16px;
        backdrop-filter: saturate(120%) blur(4px);
      }
      .card .card-header,
      .stat-card .card-header,
      .panel .card-header{
        background: var(--thead-bg) !important;
        color: var(--text) !important;
        border-bottom: 1px solid var(--hair) !important;
        font-weight: 700;
        letter-spacing: .2px;
      }

      .form-control, .form-select, .input-group-text, .btn-outline-secondary, .btn-outline-light {
        background: rgba(255,255,255,.06) !important;
        border-color: var(--card-border) !important;
        color: var(--text) !important;
      }
      .form-control::placeholder { color: color-mix(in oklab, var(--accent-ink) 70%, transparent); }
      .btn-outline-light { color: var(--text) !important; }
      .btn-primary { background: #2563eb; border-color: #2563eb; }

      .table-responsive{
        border:1px solid var(--card-border);
        border-radius:14px;
        background:var(--card-bg);
        box-shadow:0 8px 24px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.04);
        overflow:auto;
        position: relative;
        /* keep layout steady when scrollbar appears */
        scrollbar-gutter: stable both-edges;
      }

      .theme-dark .table{
        --bs-table-bg: transparent;
        --bs-table-color: var(--text);
        --bs-table-border-color: var(--hair);
        --bs-table-striped-bg: rgba(255,255,255,.02);
        --bs-table-striped-color: var(--text);
        --bs-table-hover-bg: rgba(255,255,255,.05);
        --bs-table-hover-color: var(--text);
      }
      .theme-dark .table > :not(caption) > * > *{
        background-color: transparent !important;
        box-shadow: none !important;
      }
      .theme-dark .table td.bg-white, .theme-dark .table th.bg-white,
      .theme-dark .table td.bg-light, .theme-dark .table th.bg-light{
        background-color: transparent !important;
      }

      .table-floating,
      .table-floating .table{
        width:100%;
        border-collapse:separate;
        border-spacing:0;
        color:var(--text);
        background:transparent;
      }
      .table-floating > :not(caption) > thead > tr > th,
      .table-floating .table > :not(caption) > thead > tr > th{
        border-bottom:1px solid var(--hair);
        font-weight:700; letter-spacing:.2px;
      }
      .table-floating > :not(caption) > tbody > tr > td,
      .table-floating .table > :not(caption) > tbody > tr > td{
        border-top:1px solid var(--hair);
        vertical-align:middle;
      }
      .table-floating > :not(caption) > tbody > tr:nth-child(odd),
      .table-floating .table > :not(caption) > tbody > tr:nth-child(odd){
        background:rgba(255,255,255,.015);
      }
      .table-floating > :not(caption) > tbody > tr:hover,
      .table-floating .table > :not(caption) > tbody > tr:hover{
        background:rgba(255,255,255,.05);
      }

      .table thead th,
      .table thead td{
        background: var(--thead-bg) !important;
        color: var(--table-head-fg, var(--text)) !important;
        border-bottom:1px solid var(--hair) !important;
      }
      .table thead th:first-child { border-top-left-radius: 12px; }
      .table thead th:last-child  { border-top-right-radius: 12px; }

      canvas { background: transparent !important; }

      .muted { color: var(--muted) !important; }

      /* ===========================
         Global floating scrollbars
         =========================== */

      /* Firefox – page level */
      html.theme-dark, body.theme-dark {
        scrollbar-width: thin;
        scrollbar-color: var(--scroll-thumb) var(--scroll-track);
      }

      /* Firefox – common inner scrollers */
      .table-responsive,
      .offcanvas,
      .offcanvas-body,
      .modal,
      .modal-body {
        scrollbar-width: thin;
        scrollbar-color: var(--scroll-thumb) var(--scroll-track);
      }

      /* WebKit (Chrome/Edge/Safari) – page level */
      html.theme-dark::-webkit-scrollbar,
      body.theme-dark::-webkit-scrollbar{
        width:12px; height:12px;
      }
      html.theme-dark::-webkit-scrollbar-track,
      body.theme-dark::-webkit-scrollbar-track{
        background: var(--scroll-track);
      }
      html.theme-dark::-webkit-scrollbar-thumb,
      body.theme-dark::-webkit-scrollbar-thumb{
        background: var(--scroll-thumb);
        border-radius: 999px;
        border: 3px solid transparent;          /* padding ring */
        background-clip: padding-box;            /* keeps inner color */
        box-shadow:
          0 2px 8px rgba(0,0,0,.35),
          inset 0 0 0 1px var(--scroll-border);  /* inner ring */
      }
      html.theme-dark::-webkit-scrollbar-thumb:hover,
      body.theme-dark::-webkit-scrollbar-thumb:hover{
        background: var(--scroll-thumb-hover);
      }
      html.theme-dark::-webkit-scrollbar-corner,
      body.theme-dark::-webkit-scrollbar-corner{
        background: transparent;
      }

      /* WebKit – inner scrollers */
      .table-responsive::-webkit-scrollbar,
      .offcanvas::-webkit-scrollbar,
      .offcanvas-body::-webkit-scrollbar,
      .modal::-webkit-scrollbar,
      .modal-body::-webkit-scrollbar{
        width:12px; height:12px;
      }
      .table-responsive::-webkit-scrollbar-track,
      .offcanvas::-webkit-scrollbar-track,
      .offcanvas-body::-webkit-scrollbar-track,
      .modal::-webkit-scrollbar-track,
      .modal-body::-webkit-scrollbar-track{
        background: var(--scroll-track);
      }
      .table-responsive::-webkit-scrollbar-thumb,
      .offcanvas::-webkit-scrollbar-thumb,
      .offcanvas-body::-webkit-scrollbar-thumb,
      .modal::-webkit-scrollbar-thumb,
      .modal-body::-webkit-scrollbar-thumb{
        background: var(--scroll-thumb);
        border-radius: 999px;
        border: 3px solid transparent;
        background-clip: padding-box;
        box-shadow:
          0 2px 8px rgba(0,0,0,.35),
          inset 0 0 0 1px var(--scroll-border);
      }
      .table-responsive::-webkit-scrollbar-thumb:hover,
      .offcanvas::-webkit-scrollbar-thumb:hover,
      .offcanvas-body::-webkit-scrollbar-thumb:hover,
      .modal::-webkit-scrollbar-thumb:hover,
      .modal-body::-webkit-scrollbar-thumb:hover{
        background: var(--scroll-thumb-hover);
      }
      .table-responsive::-webkit-scrollbar-corner,
      .offcanvas::-webkit-scrollbar-corner,
      .offcanvas-body::-webkit-scrollbar-corner,
      .modal::-webkit-scrollbar-corner,
      .modal-body::-webkit-scrollbar-corner{
        background: transparent;
      }
    </style>

    <!-- Sticky header hot-fix -->
    <style id="bt-table-head-fix">
      .table thead th { top: 0 !important; }
      .table.sticky-offset thead th,
      .sticky-offset .table thead th { top: 0 !important; }
      .table-responsive { overflow: auto; }
      thead, thead tr, thead th { margin-top: 0 !important; }
      .table thead th { z-index: 3; box-shadow: inset 0 -1px 0 rgba(255,255,255,.08); }
    </style>

    <!-- Frosted, floating sticky table headers (global) — UPDATED to match navbar -->
    <style id="bt-table-head-frost">
      /* keep thead sticky inside its own scroller */
      .table-responsive thead {
        position: sticky;
        top: 0;
        z-index: 4;
      }

      /* TRUE navbar-like glass for table headers */
      .table thead th {
        backdrop-filter: saturate(120%) blur(6px);
        -webkit-backdrop-filter: saturate(120%) blur(6px);
        background:
          linear-gradient(
            180deg,
            color-mix(in oklab, var(--thead-bg) 85%, transparent) 0%,
            color-mix(in oklab, var(--thead-bg) 70%, transparent) 100%
          ) !important;
        border-bottom: 1px solid var(--hair) !important;
        box-shadow:
          inset 0 1px 0 rgba(255,255,255,.06),
          0 10px 18px rgba(2, 6, 23, .25);
        will-change: backdrop-filter;
        z-index: 4;
        padding: .65rem .9rem;
        font-weight: 700;
        letter-spacing: .2px;
      }

      /* rounded strip ends */
      .table thead th:first-child { border-top-left-radius: 12px; }
      .table thead th:last-child  { border-top-right-radius: 12px; }

      /* allow rows (not container paint) to be the backdrop */
      .cm-scroll,
      .tx-scroll {
        background: transparent;
        isolation: isolate;   /* prevents ancestor backdrops from interfering */
      }
    </style>

    <!-- Goals page: left alignment only (no color overrides) -->
    <style id="bt-goals-left">
      body[data-route="/goals"] .table th,
      body[data-route="/goals"] .table td{ text-align:left !important; }
      body[data-route="/goals"] .table .text-end,
      body[data-route="/goals"] .table .text-center,
      body[data-route="/goals"] .table [style*="text-align: right"],
      body[data-route="/goals"] .table [style*="text-align:right"],
      body[data-route="/goals"] .table [style*="text-align: center"],
      body[data-route="/goals"] .table [style*="text-align:center"]{ text-align:left !important; }
      body[data-route="/goals"] .table .form-control,
      body[data-route="/goals"] .table .input-group .form-control{ text-align:left !important; }
    </style>

    <script> document.documentElement.classList.add('theme-dark'); </script>
    <script>
      (function(){
        document.addEventListener('DOMContentLoaded', function(){
          document.body.setAttribute('data-route', location.pathname || '');
        });
      })();
    </script>
  </head>

  <body class="theme-neo theme-dark">
    {% include "navbar.html" %}

    <main class="container-fluid">
      {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    {% include "_drawer.html" %}

    <script>
      // Global [data-manage] click handler
      (function(){
        document.addEventListener('click', function (e) {
          const el = e.target.closest('[data-manage]');
          if (!el) return;
          if (window.dashManage) {
            window.dashManage(e, el);
          } else {
            e.preventDefault();
          }
        });
      })();
    </script>

    <script>
      // Force allow_hidden=1 on builder inspect calls
      (function(){
        if (location.pathname !== '/builder') return;
        const origFetch = window.fetch;
        window.fetch = function(input, init){
          try {
            let url = typeof input === 'string' ? input : (input && input.url) || '';
            if (url && url.indexOf('/admin/categories/inspect') !== -1 && !/[?&]allow_hidden=/.test(url)) {
              const u = new URL(url, window.location.origin);
              u.searchParams.set('allow_hidden', '1');
              input = typeof input === 'string' ? u.toString() : new Request(u.toString(), input);
            }
          } catch(e) {}
          return origFetch(input, init);
        };
      })();
    </script>

    <script>
      // Set CSS vars for sticky offsets based on navbar height
      (function(){
        function setStickyOffsets(){
          const nav = document.querySelector('.navbar.fixed-top, .navbar-sticky, .app-header.fixed-top, .navbar');
          const h = nav ? Math.ceil(nav.getBoundingClientRect().height) : 56;
          document.documentElement.style.setProperty('--nav-h', h + 'px');
          document.documentElement.style.setProperty('--sticky-top', h + 'px');
        }
        window.addEventListener('load', setStickyOffsets, { once: true });
        window.addEventListener('resize', setStickyOffsets);
      })();
    </script>

    <!-- bt-cvslm normalizer (non-destructive) -->
    <script>
      (function () {
        const wants = /current\s*vs\s*last\s*month/i;

        function normalizeCvslmCard() {
          document.querySelectorAll('.card, .stat-card, .panel').forEach(card => {
            const heading = card.querySelector('.card-header, .card-title, .panel-title, .summary-label, h1, h2, h3, h4, h5, h6, caption');
            const txt = (heading ? heading.textContent : card.textContent) || '';
            if (!wants.test(txt)) return;

            // mark once
            if (!card.classList.contains('bt-cvslm-match')) card.classList.add('bt-cvslm-match');

            // find/skin table but DO NOT clobber backgrounds set by theme
            const table = card.querySelector('table');
            if (!table) return;

            table.classList.add('table','table-hover','table-striped','table-floating');
            if (!table.tHead && table.tBodies && table.tBodies[0] && table.tBodies[0].rows.length) {
              const first = table.tBodies[0].rows[0];
              const thead = document.createElement('thead');
              const tr = document.createElement('tr');
              Array.from(first.cells).forEach(td => {
                const th = document.createElement('th');
                th.innerHTML = td.innerHTML;
                tr.appendChild(th);
              });
              thead.appendChild(tr);
              table.insertBefore(thead, table.tBodies[0]);
              first.remove();
            }

            // alignment only; don’t touch background so frosted header/zebra remain
            table.querySelectorAll('th,td').forEach(c => {
              c.style.textAlign = 'left';
            });
          });
        }

        function init(){
          normalizeCvslmCard();
          setTimeout(normalizeCvslmCard, 200);
          setTimeout(normalizeCvslmCard, 600);
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, { once:true });
        else init();
        window.addEventListener('bt:page-ready', normalizeCvslmCard);
      })();
    </script>

    <!-- Plotly grid/tick theming -->
    <script id="bt-plotly-dark">
      (function () {
        if (location.pathname !== '/charts') return;

        function cssVar(n, f){ const v=getComputedStyle(document.documentElement).getPropertyValue(n).trim(); return v||f; }
        const accent = cssVar('--accent-ink', '#9ecbff');
        const hair   = cssVar('--hair', 'rgba(255,255,255,.12)');
        const grid   = cssVar('--plotly-grid', 'rgba(158,203,255,.11)');

        function skin(gd){
          if (!gd || !window.Plotly) return;
          try {
            Plotly.relayout(gd, {
              'paper_bgcolor': 'rgba(0,0,0,0)',
              'plot_bgcolor' : 'rgba(0,0,0,0)',
              'font.color'   : accent,
              'legend.font.color': accent,

              'xaxis.gridcolor'      : grid,
              'xaxis.gridwidth'      : 0.6,
              'xaxis.zeroline'       : false,
              'xaxis.linecolor'      : hair,
              'xaxis.tickfont.color' : accent,
              'xaxis.title.font.color': accent,

              'yaxis.gridcolor'      : grid,
              'yaxis.gridwidth'      : 0.6,
              'yaxis.zeroline'       : false,
              'yaxis.linecolor'      : hair,
              'yaxis.tickfont.color' : accent,
              'yaxis.title.font.color': accent
            });
          } catch(_) {}
        }

        window.addEventListener('load', function(){
          document.querySelectorAll('.js-plotly-plot').forEach(skin);
        }, { once:true });

        document.addEventListener('plotly_afterplot', function(e){
          skin(e && e.target);
        }, { passive:true });
      })();
    </script>

    <script src="{{ url_for('static', filename='js/movers_weekly.js') }}" defer></script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ title if title else "BartonTech" }}</title>

    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

    <!-- PWA -->
    <link rel="manifest" type="application/manifest+json" href="{{ url_for('static', filename='manifest.webmanifest') }}">
    <meta name="theme-color" content="#0d6efd">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='icons/favicon-16.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/icon-180-apple.png') }}">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="BartonTech">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>

    <style>
      :root { --nav-h: 56px; --sticky-top: var(--nav-h); }
      html, body { min-height: 100%; }
      body {
        padding-top: calc(var(--nav-h) + env(safe-area-inset-top, 0px));
        padding-left:  env(safe-area-inset-left, 0px);
        padding-right: env(safe-area-inset-right, 0px);
      }
      .offcanvas.manage-drawer, #dashCategoryManager.offcanvas { width: 480px; }
      .muted { color:#6c757d; }
      .mono { font-variant-numeric: tabular-nums; }
      .tx-neg { color:#c0392b; font-weight:600; }
      .tx-pos { color:#1e7e34; font-weight:600; }

      /* Sticky table headers (no navbar offset) */
      .table thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: var(--table-head-bg, transparent);
        color: var(--table-head-fg, inherit);
      }
    </style>

    <!-- Site CSS (cache-busted so new drawer styles apply) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/neon-tech.css') }}?v=2025-09-03-02">

    <!-- >>> SITE-WIDE DARK / FLOATING THEME <<< -->
    <style id="app-theme">
      :root{
        --page-bg-1:#0b1220;
        --page-bg-2:#0f172a;
        --glow-1:#243b55;
        --glow-2:#1b3a6b;

        /* Accent ink used everywhere */
        --accent-ink:#9ecbff;
        --text: var(--accent-ink);
        --muted: var(--accent-ink);

        --card-bg:rgba(255,255,255,.045);
        --card-border:rgba(255,255,255,.10);
        --hair:rgba(255,255,255,.08);

        --thead-bg:rgba(255,255,255,.06);
        --thead-fg: var(--accent-ink);

        --table-head-bg: var(--thead-bg);
        --table-head-fg: var(--thead-fg);

        /* Plotly grid tone (soft bluish) */
        --plotly-grid: rgba(158,203,255,.11);

        /* Global scrollbar tokens (use accent ink) */
        --scroll-track: transparent;
        --scroll-thumb: color-mix(in oklab, var(--accent-ink) 58%, transparent);
        --scroll-thumb-hover: color-mix(in oklab, var(--accent-ink) 82%, transparent);
        --scroll-border: rgba(255,255,255,.22);
      }

      html.theme-dark, body.theme-dark {
        background:
          radial-gradient(1200px 700px at -10% -10%, var(--glow-1) 0%, transparent 45%),
          radial-gradient(900px 600px at 110% 0%, var(--glow-2) 0%, transparent 40%),
          linear-gradient(180deg, var(--page-bg-2) 0%, var(--page-bg-1) 100%) !important;
        color: var(--text);
      }

      .navbar {
        background: var(--card-bg) !important;
        border-bottom: 1px solid var(--card-border) !important;
        backdrop-filter: saturate(120%) blur(6px);
      }
      .navbar, .navbar .navbar-brand, .navbar .nav-link, .navbar .navbar-text {
        color: var(--text) !important;
      }
      .navbar .nav-link.active, .navbar .nav-link:hover { color: #ffffff !important; }

      .card, .stat-card, .panel, .list-group, .offcanvas, .modal-content {
        background: var(--card-bg) !important;
        border: 1px solid var(--card-border) !important;
        color: var(--text);
        box-shadow:
          0 12px 28px rgba(0,0,0,.35),
          inset 0 1px 0 rgba(255,255,255,.05);
        border-radius: 16px;
        backdrop-filter: saturate(120%) blur(4px);
      }
      .card .card-header,
      .stat-card .card-header,
      .panel .card-header{
        background: var(--thead-bg) !important;
        color: var(--text) !important;
        border-bottom: 1px solid var(--hair) !important;
        font-weight: 700;
        letter-spacing: .2px;
      }

      .form-control, .form-select, .input-group-text, .btn-outline-secondary, .btn-outline-light {
        background: rgba(255,255,255,.06) !important;
        border-color: var(--card-border) !important;
        color: var(--text) !important;
      }
      .form-control::placeholder { color: color-mix(in oklab, var(--accent-ink) 70%, transparent); }
      .btn-outline-light { color: var(--text) !important; }
      .btn-primary { background: #2563eb; border-color: #2563eb; }

      .table-responsive{
        border:1px solid var(--card-border);
        border-radius:14px;
        background:var(--card-bg);
        box-shadow:0 8px 24px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.04);
        overflow:auto;
        position: relative;
        /* keep layout steady when scrollbar appears */
        scrollbar-gutter: stable both-edges;
      }

      .theme-dark .table{
        --bs-table-bg: transparent;
        --bs-table-color: var(--text);
        --bs-table-border-color: var(--hair);
        --bs-table-striped-bg: rgba(255,255,255,.02);
        --bs-table-striped-color: var(--text);
        --bs-table-hover-bg: rgba(255,255,255,.05);
        --bs-table-hover-color: var(--text);
      }
      .theme-dark .table > :not(caption) > * > *{
        background-color: transparent !important;
        box-shadow: none !important;
      }
      .theme-dark .table td.bg-white, .theme-dark .table th.bg-white,
      .theme-dark .table td.bg-light, .theme-dark .table th.bg-light{
        background-color: transparent !important;
      }

      .table-floating,
      .table-floating .table{
        width:100%;
        border-collapse:separate;
        border-spacing:0;
        color:var(--text);
        background:transparent;
      }
      .table-floating > :not(caption) > thead > tr > th,
      .table-floating .table > :not(caption) > thead > tr > th{
        border-bottom:1px solid var(--hair);
        font-weight:700; letter-spacing:.2px;
      }
      .table-floating > :not(caption) > tbody > tr > td,
      .table-floating .table > :not(caption) > tbody > tr > td{
        border-top:1px solid var(--hair);
        vertical-align:middle;
      }
      .table-floating > :not(caption) > tbody > tr:nth-child(odd),
      .table-floating .table > :not(caption) > tbody > tr:nth-child(odd){
        background:rgba(255,255,255,.015);
      }
      .table-floating > :not(caption) > tbody > tr:hover,
      .table-floating .table > :not(caption) > tbody > tr:hover{
        background:rgba(255,255,255,.05);
      }

      .table thead th,
      .table thead td{
        background: var(--thead-bg) !important;
        color: var(--table-head-fg, var(--text)) !important;
        border-bottom:1px solid var(--hair) !important;
      }
      .table thead th:first-child { border-top-left-radius: 12px; }
      .table thead th:last-child  { border-top-right-radius: 12px; }

      canvas { background: transparent !important; }

      .muted { color: var(--muted) !important; }

      /* ===========================
         Global floating scrollbars
         =========================== */

      /* Firefox – page level */
      html.theme-dark, body.theme-dark {
        scrollbar-width: thin;
        scrollbar-color: var(--scroll-thumb) var(--scroll-track);
      }

      /* Firefox – common inner scrollers */
      .table-responsive,
      .offcanvas,
      .offcanvas-body,
      .modal,
      .modal-body {
        scrollbar-width: thin;
        scrollbar-color: var(--scroll-thumb) var(--scroll-track);
      }

      /* WebKit (Chrome/Edge/Safari) – page level */
      html.theme-dark::-webkit-scrollbar,
      body.theme-dark::-webkit-scrollbar{
        width:12px; height:12px;
      }
      html.theme-dark::-webkit-scrollbar-track,
      body.theme-dark::-webkit-scrollbar-track{
        background: var(--scroll-track);
      }
      html.theme-dark::-webkit-scrollbar-thumb,
      body.theme-dark::-webkit-scrollbar-thumb{
        background: var(--scroll-thumb);
        border-radius: 999px;
        border: 3px solid transparent;          /* padding ring */
        background-clip: padding-box;            /* keeps inner color */
        box-shadow:
          0 2px 8px rgba(0,0,0,.35),
          inset 0 0 0 1px var(--scroll-border);  /* inner ring */
      }
      html.theme-dark::-webkit-scrollbar-thumb:hover,
      body.theme-dark::-webkit-scrollbar-thumb:hover{
        background: var(--scroll-thumb-hover);
      }
      html.theme-dark::-webkit-scrollbar-corner,
      body.theme-dark::-webkit-scrollbar-corner{
        background: transparent;
      }

      /* WebKit – inner scrollers */
      .table-responsive::-webkit-scrollbar,
      .offcanvas::-webkit-scrollbar,
      .offcanvas-body::-webkit-scrollbar,
      .modal::-webkit-scrollbar,
      .modal-body::-webkit-scrollbar{
        width:12px; height:12px;
      }
      .table-responsive::-webkit-scrollbar-track,
      .offcanvas::-webkit-scrollbar-track,
      .offcanvas-body::-webkit-scrollbar-track,
      .modal::-webkit-scrollbar-track,
      .modal-body::-webkit-scrollbar-track{
        background: var(--scroll-track);
      }
      .table-responsive::-webkit-scrollbar-thumb,
      .offcanvas::-webkit-scrollbar-thumb,
      .offcanvas-body::-webkit-scrollbar-thumb,
      .modal::-webkit-scrollbar-thumb,
      .modal-body::-webkit-scrollbar-thumb{
        background: var(--scroll-thumb);
        border-radius: 999px;
        border: 3px solid transparent;
        background-clip: padding-box;
        box-shadow:
          0 2px 8px rgba(0,0,0,.35),
          inset 0 0 0 1px var(--scroll-border);
      }
      .table-responsive::-webkit-scrollbar-thumb:hover,
      .offcanvas::-webkit-scrollbar-thumb:hover,
      .offcanvas-body::-webkit-scrollbar-thumb:hover,
      .modal::-webkit-scrollbar-thumb:hover,
      .modal-body::-webkit-scrollbar-thumb:hover{
        background: var(--scroll-thumb-hover);
      }
      .table-responsive::-webkit-scrollbar-corner,
      .offcanvas::-webkit-scrollbar-corner,
      .offcanvas-body::-webkit-scrollbar-corner,
      .modal::-webkit-scrollbar-corner,
      .modal-body::-webkit-scrollbar-corner{
        background: transparent;
      }
    </style>

    <!-- Sticky header hot-fix -->
    <style id="bt-table-head-fix">
      .table thead th { top: 0 !important; }
      .table.sticky-offset thead th,
      .sticky-offset .table thead th { top: 0 !important; }
      .table-responsive { overflow: auto; }
      thead, thead tr, thead th { margin-top: 0 !important; }
      .table thead th { z-index: 3; box-shadow: inset 0 -1px 0 rgba(255,255,255,.08); }
    </style>

    <!-- Frosted, floating sticky table headers (global) — UPDATED to match navbar -->
    <style id="bt-table-head-frost">
      /* keep thead sticky inside its own scroller */
      .table-responsive thead {
        position: sticky;
        top: 0;
        z-index: 4;
      }

      /* TRUE navbar-like glass for table headers */
      .table thead th {
        backdrop-filter: saturate(120%) blur(6px);
        -webkit-backdrop-filter: saturate(120%) blur(6px);
        background:
          linear-gradient(
            180deg,
            color-mix(in oklab, var(--thead-bg) 85%, transparent) 0%,
            color-mix(in oklab, var(--thead-bg) 70%, transparent) 100%
          ) !important;
        border-bottom: 1px solid var(--hair) !important;
        box-shadow:
          inset 0 1px 0 rgba(255,255,255,.06),
          0 10px 18px rgba(2, 6, 23, .25);
        will-change: backdrop-filter;
        z-index: 4;
        padding: .65rem .9rem;
        font-weight: 700;
        letter-spacing: .2px;
      }

      /* rounded strip ends */
      .table thead th:first-child { border-top-left-radius: 12px; }
      .table thead th:last-child  { border-top-right-radius: 12px; }

      /* allow rows (not container paint) to be the backdrop */
      .cm-scroll,
      .tx-scroll {
        background: transparent;
        isolation: isolate;   /* prevents ancestor backdrops from interfering */
      }
    </style>

    <!-- Goals page: left alignment only (no color overrides) -->
    <style id="bt-goals-left">
      body[data-route="/goals"] .table th,
      body[data-route="/goals"] .table td{ text-align:left !important; }
      body[data-route="/goals"] .table .text-end,
      body[data-route="/goals"] .table .text-center,
      body[data-route="/goals"] .table [style*="text-align: right"],
      body[data-route="/goals"] .table [style*="text-align:right"],
      body[data-route="/goals"] .table [style*="text-align: center"],
      body[data-route="/goals"] .table [style*="text-align:center"]{ text-align:left !important; }
      body[data-route="/goals"] .table .form-control,
      body[data-route="/goals"] .table .input-group .form-control{ text-align:left !important; }
    </style>

    <script> document.documentElement.classList.add('theme-dark'); </script>
    <script>
      (function(){
        document.addEventListener('DOMContentLoaded', function(){
          document.body.setAttribute('data-route', location.pathname || '');
        });
      })();
    </script>
  </head>

  <body class="theme-neo theme-dark">
    {% include "navbar.html" %}

    <main class="container-fluid">
      {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    {% include "_drawer.html" %}

    <!-- Drawer config: set API endpoints BEFORE the controller runs -->
    <script>
      // Use your working admin/api defaults; pages can still override via window.CL_URLS.
      window.CL_URLS = Object.assign({
        PATH_TXN_URL : '/api/path/transactions',
        ACTION_URL   : '/admin/api/category_action',

        // IMPORTANT: these default to admin/api to match Category Builder behavior.
        KW_GET_URL   : '/admin/api/keywords_for_name',
        KW_ADD_URL   : '/admin/api/keyword_add',
        KW_REMOVE_URL: '/admin/api/keyword_remove'
      }, window.CL_URLS || {});
    </script>

    <!-- Drawer polish (breadcrumbs + keyword pill with tiny ×) -->
    <style id="drawer-polish">
      /* Breadcrumb links always use app ink */
      #dashCategoryManager #drawer-breadcrumb a{
        color: var(--text) !important;
        text-decoration: none;
        font-weight: 700;
      }
      #dashCategoryManager #drawer-breadcrumb a:hover{
        color:#fff !important;
        text-decoration: underline;
        text-underline-offset: 2px;
      }

      /* Drawer table sizing: amount left-aligned; category stays one line */
      #dashCategoryManager .offcanvas-body table{ table-layout: fixed; }
      #dashCategoryManager .offcanvas-body table th,
      #dashCategoryManager .offcanvas-body table td{ padding:.55rem .8rem; vertical-align: middle; }
      #dashCategoryManager .offcanvas-body table td:nth-child(1){ width:110px; white-space:nowrap; }
      #dashCategoryManager .offcanvas-body table td:nth-child(2){ width:auto; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
      #dashCategoryManager .offcanvas-body table td:nth-child(3){ width:120px; text-align:left !important; }
      #dashCategoryManager .offcanvas-body table td:nth-child(4){ width:160px; white-space:nowrap; }
      #dashCategoryManager .offcanvas-body table td:nth-child(4) .pill{ white-space:nowrap; }

      /* Keyword pill with tiny close in the upper-right corner */
      #dashCategoryManager .kw-pill{
        position: relative;
        display:inline-flex; align-items:center;
        gap:.35rem; line-height:1;
        padding:.22rem .65rem;
        padding-right: 1.4rem;               /* room for the × */
        border-radius:999px;
        background: color-mix(in oklab, var(--accent-ink) 12%, transparent);
        color: var(--accent-ink);
        border:1px solid color-mix(in oklab, var(--accent-ink) 40%, transparent);
        font-weight:600; font-size:.85rem;
      }
      #dashCategoryManager .kw-pill .kw-x{
        position:absolute; right:-6px; top:-6px;
        width:18px; height:18px; border-radius:50%;
        display:inline-grid; place-items:center;
        font-size:.9rem; line-height:1;
        border:1px solid rgba(255,255,255,.35);
        background: rgba(255,255,255,.12);
        color: var(--accent-ink);
        cursor:pointer;
      }
      #dashCategoryManager .kw-pill .kw-x:hover{ background: rgba(255,255,255,.18); }
    </style>

    <!-- UNIVERSAL DRAWER CONTROLLER (inline; replaces external drawer.js) -->
    <script>
    /*
      Drawer UI — Overview/Keywords/Actions intact; pills & palette; overlay month selector;
      robust endpoints with fallbacks between /admin/api, /admin/categories and /api; global [data-manage] delegate.
    */
    (function(){
      'use strict';

      // If already present, keep openers and exit (avoid double-binding)
      if (window.openCategoryManager && window.openCategoryManager.__cl_neon_fit === true) {
        if (!window.openDrawerForPath)     window.openDrawerForPath     = (state)=>window.openCategoryManager(state||{});
        if (!window.openDrawerForCategory) window.openDrawerForCategory = (cat,opts)=>window.openCategoryManager({ level:'category', cat:cat||'', allowHidden:!!(opts&&opts.allowHidden) });
        return;
      }

      // URLs (server may override via window.CL_URLS)
      const urls = window.CL_URLS || {};
      const PATH_TXN_URL  = urls.PATH_TXN_URL  || '/api/path/transactions';
      const ACTION_URL    = urls.ACTION_URL    || '/admin/api/category_action';

      // Normalize/guard candidate lists
      const normalizeBases = (arr=[]) => {
        const out = [];
        arr.forEach(s => {
          if (!s || typeof s !== 'string') return;
          const t = s.trim();
          if (!t || /^undefined$/i.test(t) || /^null$/i.test(t)) return;
          const absolute = /^(https?:)?\/\//i.test(t) || t.startsWith('/');
          const fixed = absolute ? t : ('/' + t);
          if (!out.includes(fixed)) out.push(fixed);
        });
        return out;
      };

      // Keyword endpoints: try name- and path-based APIs across admin/api, admin/categories, and api.
      const KW_GET_CANDIDATES = normalizeBases([
        urls.KW_GET_URL,
        '/admin/api/keywords_for_name',      '/api/keywords_for_name',
        '/admin/categories/keywords_for_name','/categories/keywords_for_name',
        '/admin/api/keywords',               '/api/keywords',
        '/admin/categories/keywords',        '/categories/keywords'
      ]);

      const KW_ADD_CANDIDATES = normalizeBases([
        urls.KW_ADD_URL,
        '/admin/api/keyword_add',            '/api/keyword_add',
        '/admin/categories/keyword_add',     '/categories/keyword_add',
        '/admin/api/keywords',               '/api/keywords',
        '/admin/categories/keywords',        '/categories/keywords'
      ]);

      const KW_REM_CANDIDATES = normalizeBases([
        urls.KW_REMOVE_URL,
        '/admin/api/keyword_remove',         '/api/keyword_remove',
        '/admin/categories/keyword_remove',  '/categories/keyword_remove',
        '/admin/api/keywords',               '/api/keywords',
        '/admin/categories/keywords',        '/categories/keywords'
      ]);

      async function tryGetJson(bases, queryParams){
        const qpBase = new URLSearchParams(queryParams||{});
        qpBase.set('_', Date.now());
        let lastErr = null;

        for (const base of bases){
          try {
            const isByName = /keywords_for_name/i.test(base);
            const isUnified = /\/keywords(?:$|\?)/i.test(base);
            const qp = new URLSearchParams();

            // Always pass path context to help backends that accept it
            ['level','cat','sub','ssub','sss'].forEach(k => { if (queryParams && queryParams[k]) qp.set(k, queryParams[k]); });

            if (isByName) {
              const name = (queryParams && (queryParams.name || queryParams.last)) || '';
              qp.set('name', name);
            } else if (isUnified) {
              // unified /keywords might support either 'name' or path – include both
              if (queryParams && (queryParams.name || queryParams.last)) qp.set('name', (queryParams.name || queryParams.last));
            }

            qp.set('_', Date.now());

            const r = await fetch(base + '?' + qp.toString(), { headers:{'Accept':'application/json'} });
            if (r.ok) return await r.json();
            lastErr = new Error('GET ' + base + ' → ' + r.status);
          } catch(e){ lastErr = e; }
        }
        throw lastErr || new Error('No keyword GET endpoint succeeded');
      }

      async function tryPostJson(bases, payload, action){ // action: 'add' | 'remove'
        let lastErr = null;
        for (const base of bases){
          try{
            let body = { ...payload };
            // For unified /keywords POST, include action flags to route server-side
            if (/\/keywords(?:$|\?)/i.test(base)) {
              body = { ...body, action: action, remove: (action === 'remove') };
            }
            const r = await fetch(base, {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify(body || {})
            });
            if (r.ok) {
              return ((r.headers.get('content-type')||'').includes('json')) ? r.json() : r.text();
            }
            lastErr = new Error('POST ' + base + ' → ' + r.status);
          } catch(e){ lastErr = e; }
        }
        throw lastErr || new Error('No keyword POST endpoint succeeded');
      }

      // DOM helpers
      const QS  = s=>document.querySelector(s);
      const QSA = s=>Array.from(document.querySelectorAll(s));
      const $   = id=>document.getElementById(id);
      const on  = (el,ev,fn,opts)=>el&&el.addEventListener(ev,fn,opts||false);
      const fmtUSD = n => { try { return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(+n||0); } catch { return '$'+Number(+n||0).toFixed(2);} };
      const esc = s => String(s||'').replace(/[&<>"']/g,c=>c==='&'?'&amp;':c==='<'?'&lt;':c==='>'?'&gt;':c==='"'?'&quot;':'&#39;');
      const fmtDate = s => s||'';

      const state = {
        ctx: { level:'category', cat:'', sub:'', ssub:'', sss:'', month:'', allowHidden:false },
        months: [], tx: [], children: [], total:0, magnitude_total:0, showAll:false
      };
      const pathParts = ()=>[state.ctx.cat,state.ctx.sub,state.ctx.ssub,state.ctx.sss].filter(Boolean);

      // ---------- sync pill colors to page keyword field ----------
      function syncPillPaletteFromKeywordField() {
        const ref =
          document.querySelector('input[placeholder*="Filter keywords" i]') ||
          document.querySelector('.keywords-panel input.form-control') ||
          document.querySelector('input[type="search"], input[type="text"]');

        const host = $('dashCategoryManager');
        if (!host) return;

        const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent-ink').trim() || '#9ecbff';
        const fallbackBg     = `color-mix(in oklab, ${accent} 14%, transparent)`;
        const fallbackBorder = `color-mix(in oklab, ${accent} 40%, transparent)`;
        const fallbackFg     = accent;

        if (!ref) {
          host.style.setProperty('--pill-bg', fallbackBg);
          host.style.setProperty('--pill-border', fallbackBorder);
          host.style.setProperty('--pill-fg', fallbackFg);
          host.style.setProperty('--pill-bg-hover', `color-mix(in oklab, ${accent} 22%, transparent)`);
          host.style.setProperty('--pill-border-hover', `color-mix(in oklab, ${accent} 58%, transparent)`);
          host.style.setProperty('--pill-fg-hover', fallbackFg);
          return;
        }

        const cs = getComputedStyle(ref);
        const bg = cs.backgroundColor || fallbackBg;
        const fg = cs.color || fallbackFg;
        const bc = (cs.borderColor && cs.borderColor !== 'rgba(0, 0, 0, 0)') ? cs.borderColor : fallbackBorder;

        const toHover = (rgb, alpha) => {
          if (rgb.startsWith('rgba(')) return rgb;
          if (rgb.startsWith('rgb(')) return rgb.replace('rgb(', 'rgba(').replace(')', `, ${alpha})`);
          return rgb;
        };

        host.style.setProperty('--pill-bg', bg);
        host.style.setProperty('--pill-border', bc);
        host.style.setProperty('--pill-fg', fg);
        host.style.setProperty('--pill-bg-hover', toHover(bg, 0.9));
        host.style.setProperty('--pill-border-hover', toHover(bc, 0.9));
        host.style.setProperty('--pill-fg-hover', fg);
      }

      // ---------- months helpers ----------
      function monthKeyFromDateStr(s){
        if (!s) return '0000-00';
        const t=String(s).trim();
        if (t.includes('-')) return t.slice(0,7);
        const [mm,,yy]=t.split('/'); return (yy&&mm)?`${yy}-${String(mm).padStart(2,'0')}`:'0000-00';
      }
      function monthLabelFromKey(k){
        const [yy,mm]=String(k||'').split('-').map(Number); const d=new Date(yy||0,(mm||1)-1,1);
        return isFinite(+d)?d.toLocaleString(undefined,{month:'short',year:'numeric'}):k;
      }
      const monthId = k => 'm-'+String(k||'').replace(/[^0-9-]/g,'');

      // ---------- breadcrumb ----------
      function renderBreadcrumb(){
        const host=$('drawer-breadcrumb'); if(!host) return;
        const parts=pathParts();
        if (!parts.length){ host.innerHTML='<a class="link-primary" href="#" data-bc-index="-1">All Categories</a>'; return; }
        const segs=['<a class="link-primary" href="#" data-bc-index="-1">All Categories</a>'];
        parts.forEach((p,i)=>{ segs.push('<span class="sep">›</span>'); segs.push('<a class="link-primary" href="#" data-bc-index="'+i+'">'+esc(p)+'</a>'); });
        host.innerHTML = segs.join(' ');
        host.querySelectorAll('a[data-bc-index]').forEach(a=>{
          on(a,'click', function(e){
            e.preventDefault();
            const idx=Number(a.getAttribute('data-bc-index')||-1);
            if (idx<0){ state.ctx.level='category'; state.ctx.cat=state.ctx.sub=state.ctx.ssub=state.ctx.sss=''; }
            else { ['cat','sub','ssub','sss'].slice(idx+1).forEach(k=>state.ctx[k]=''); state.ctx.level=['category','subcategory','subsubcategory','subsubsubcategory'][idx]||'category'; }
            fetchPathTx(state.ctx);
          }, {passive:false});
        });
      }

      // ---------- children (pills) ----------
      function renderChildren(){
        const host=$('drawer-children'); if(!host) return;
        const kids=state.children||[];
        if(!kids.length){ host.innerHTML='<span class="text-muted">No children.</span>'; return; }
        host.innerHTML = kids.map(name =>
          `<a class="pill" data-child="${encodeURIComponent(name)}"><span class="label">${esc(name)}</span><span class="chev">›</span></a>`
        ).join('');
        host.querySelectorAll('.pill').forEach(p=>{
          on(p,'click',()=>{ const name=decodeURIComponent(p.dataset.child||'');
            if (!state.ctx.cat) state.ctx.cat=name, state.ctx.level='category';
            else if (!state.ctx.sub) state.ctx.sub=name, state.ctx.level='subcategory';
            else if (!state.ctx.ssub) state.ctx.ssub=name, state.ctx.level='subsubcategory';
            else state.ctx.sss=name, state.ctx.level='subsubsubcategory';
            fetchPathTx(state.ctx);
          }, {passive:true});
        });
      }

      // ---------- transactions ----------
      function renderTx(){
        const body=$('drawer-tx-body'); if(!body) return;
        const rows=state.tx||[];
        if(!rows.length){ body.innerHTML='<tr><td colspan="4" class="text-muted">No transactions.</td></tr>'; return; }

        const groups=new Map();
        for(const t of rows){
          const key=monthKeyFromDateStr(t.date);
          if(!groups.has(key)) groups.set(key,{label:monthLabelFromKey(key),items:[],net:0});
          const g=groups.get(key); const amt=Number(t.amount||0); g.items.push(t); g.net+=amt;
        }
        const keys=Array.from(groups.keys()).sort().reverse();

        body.innerHTML = keys.map(k=>{
          const g=groups.get(k); const net=Number(g.net||0); const netCls=net<0?'tx-neg':'tx-pos';
          const header = `<tr class="month-divider" id="${esc(monthId(k))}"><td colspan="4"><span class="fw-bold">${esc(g.label)}</span> — <span class="${netCls}">Net: ${fmtUSD(net)}</span></td></tr>`;
          const items = g.items.map(t=>{
            const amt=Number(t.amount||0), cls=amt<0?'tx-neg':'tx-pos';
            const catPath = t.sssubcategory || t.subsubcategory || t.subcategory || t.category || t.cat || '';
            return `<tr>
              <td class="mono">${esc(fmtDate(t.date||''))}</td>
              <td>${esc(t.description||'')}</td>
              <td class="mono ${cls}">${fmtUSD(amt)}</td>
              <td><span class="pill pill-sm">${esc(catPath)}</span></td>
            </tr>`;
          }).join('');
          return header + items;
        }).join('');
      }

      // ---------- FULL overlay month selector ----------
      function setMonthLabel(v){
        const lbl = !v ? 'Latest month' : (String(v).toLowerCase()==='all'?'All months':monthLabelFromKey(v));
        const el=$('drawer-months-label'); if (el) el.textContent=lbl;
      }
      function renderMonthsAndEmit(){
        const sel=$('drawer-months'); if(!sel) return;
        const arr = Array.from(new Set((state.months||[]).filter(Boolean))).sort().reverse();

        // hidden select (state)
        sel.innerHTML='';
        [['','Latest month'],['all','All months']].forEach(([val,lbl])=>{
          const o=document.createElement('option'); o.value=val; o.textContent=lbl; sel.appendChild(o);
        });
        arr.forEach(m=>{ const o=document.createElement('option'); o.value=m; o.textContent=monthLabelFromKey(m); sel.appendChild(o); });
        sel.value = state.showAll ? 'all' : (state.ctx.month || sel.value || '');
        setMonthLabel(sel.value);

        // overlay list (keep first 3 nodes: Latest, All, divider)
        const list = $('drawer-months-overlay-list');
        if (list){
          list.querySelectorAll('[data-value]:not([data-value=""]):not([data-value="all"])').forEach(n=>n.remove());
          arr.forEach(m=>{
            const btn = document.createElement('div');
            btn.className = 'glass-item';
            btn.setAttribute('data-value', m);
            btn.textContent = monthLabelFromKey(m);
            list.appendChild(btn);
          });
        }

        try {
          document.dispatchEvent(new CustomEvent('cm:months', { detail: { months: arr, selected: sel.value||'', showAll: state.showAll }}));
        } catch {}
      }
      (function bindMonthOverlay(){
        const openBtn = $('drawer-months-open');
        const overlay = $('drawer-months-overlay');
        const cancel  = $('drawer-months-cancel');
        const list    = $('drawer-months-overlay-list');
        const sel     = $('drawer-months');

        if (!openBtn || !overlay || !list || !sel) return;

        const close = ()=>{ overlay.hidden = true; document.removeEventListener('keydown', esc); };
        const esc   = (e)=>{ if (e.key === 'Escape') close(); };

        on(openBtn, 'click', (e)=>{ e.preventDefault(); overlay.hidden = false; document.addEventListener('keydown', esc); });
        on(cancel, 'click', close);
        on(overlay, 'click', (e)=>{ if (e.target === overlay) close(); });

        on(list, 'click', (e)=>{
          const it = e.target.closest('.glass-item'); if(!it) return;
          const v = it.getAttribute('data-value') || '';
          sel.value = v; setMonthLabel(v); close();
          sel.dispatchEvent(new Event('change',{bubbles:true}));
        });
      })();

      // ---------- keywords ----------
      function payloadForKeywords(){
        const parts=pathParts(); const last=parts[parts.length-1]||'';
        return { level:state.ctx.level||'category', cat:state.ctx.cat||'', sub:state.ctx.sub||'', ssub:state.ctx.ssub||'', sss:state.ctx.sss||'', name:last, last:last };
      }

      async function fetchKeywords(){
        try {
          const j = await tryGetJson(KW_GET_CANDIDATES, payloadForKeywords());
          if (Array.isArray(j)) return j;
          if (j && Array.isArray(j.keywords)) return j.keywords;
          if (j && Array.isArray(j.data)) return j.data;
          return [];
        } catch(e){
          console.error(e);
          return [];
        }
      }
      async function addKeyword(kw){
        if(!kw) return;
        try { await tryPostJson(KW_ADD_CANDIDATES, Object.assign({}, payloadForKeywords(), { keyword: kw }), 'add'); }
        catch(e){ console.error(e); }
      }
      async function removeKeyword(kw){
        if(!kw) return;
        try { await tryPostJson(KW_REM_CANDIDATES, Object.assign({}, payloadForKeywords(), { keyword: kw, remove: true }), 'remove'); }
        catch(e){ console.error(e); }
      }

      async function refreshKeywords(){
        const host=$('kw-list'); if(!host) return;
        host.innerHTML='<span class="muted">Loading…</span>';
        const kws = await fetchKeywords();

        if (!kws.length){
          host.innerHTML = '<span class="muted">No keywords yet.</span>';
          return;
        }

        host.innerHTML = kws.map(k =>
          `<span class="kw-pill">${esc(k)}
             <button class="kw-x" data-kw="${encodeURIComponent(k)}" title="Remove">×</button>
           </span>`
        ).join(' ');

        host.querySelectorAll('.kw-x').forEach(btn=>{
          btn.addEventListener('click', async (e)=>{
            e.preventDefault();
            await removeKeyword(decodeURIComponent(btn.dataset.kw||''));
            refreshKeywords();
          }, {passive:false});
        });
      }

      // ---------- actions (same API) ----------
      function payloadForActions(){ return Object.assign({}, state.ctx); }
      async function runAction(kind){
        const payload=Object.assign({ kind }, payloadForActions());
        try{ const r=await fetch(ACTION_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); return await r.json(); }catch{return{ok:false}}
      }
      // (External pages can call runAction if they need to)

      // ---------- fetch path/tx ----------
      async function fetchPathTx(ctx){
        const body=$('drawer-tx-body'); if(body) body.innerHTML='<tr><td colspan="4" class="text-muted">Loading…</td></tr>';
        const kids=$('drawer-children'); if (kids) kids.innerHTML='<span class="text-muted">Loading…</span>';

        const q=new URLSearchParams();
        q.set('level',ctx.level||'category');
        if (ctx.cat)  q.set('cat',ctx.cat);
        if (ctx.sub)  q.set('sub',ctx.sub);
        if (ctx.ssub) q.set('ssub',ctx.ssub);
        if (ctx.sss)  q.set('sss',ctx.sss);
        if (ctx.allowHidden) q.set('allow_hidden','1');
        const ml=String(ctx.month||'').toLowerCase();
        if (ml==='all') q.set('month','all'); else if (ctx.month) q.set('month',ctx.month);
        q.set('months','all'); q.set('_',Date.now());

        let j;
        try {
          const r=await fetch((PATH_TXN_URL||'/api/path/transactions')+'?'+q.toString(),{headers:{'Accept':'application/json'}});
          if(!r.ok) throw new Error(r.status);
          j=await r.json();
        } catch(e){
          console.error('fetchPathTx',e);
          if(body) body.innerHTML='<tr><td colspan="4" class="text-danger">Failed to load.</td></tr>';
          if(kids) kids.textContent='Failed to load.';
          return;
        }

        state.months = Array.isArray(j.months)?j.months:(Array.isArray(j.month_list)?j.month_list:[]); 
        state.tx = Array.isArray(j.tx)?j.tx:(Array.isArray(j.transactions)?j.transactions:[]);
        state.children = Array.isArray(j.children)?j.children:(Array.isArray(j.kids)?j.kids:(Array.isArray(j.child)?j.child:[]));
        state.total = Number(j.total ?? j.net_total ?? j.sum ?? 0);
        state.magnitude_total = Number(j.magnitude_total ?? j.abs_total ?? 0);
        state.showAll = (String(j.month||'').toLowerCase()==='all') || (ml==='all');

        const totalEl=$('drawer-total'); if (totalEl) totalEl.textContent=fmtUSD(state.total);
        renderBreadcrumb();
        renderChildren();
        renderTx();
        renderMonthsAndEmit();

        // sync pill palette after render too
        syncPillPaletteFromKeywordField();
      }

      // ---------- tabs ----------
      QSA('.drawer-tab').forEach(tab=>{
        on(tab,'click',e=>{
          e.preventDefault();
          const target = tab.getAttribute('data-tab') || 'overview';
          QSA('.drawer-tab').forEach(t=>t.classList.remove('active'));
          QSA('.drawer-pane').forEach(p=>p.style.display='none');
          tab.classList.add('active');
          const pane = QS(`.drawer-pane[data-pane="${target}"]`); if (pane) pane.style.display='block';
          if (target==='keywords') refreshKeywords();
        });
      });

      // ---------- month select change (overlay sets this) ----------
      const monthSel=$('drawer-months');
      if (monthSel){
        on(monthSel,'change',async e=>{
          const v=(e.target.value||'').trim();
          state.ctx.month=v||''; state.showAll=(String(v).toLowerCase()==='all');
          await fetchPathTx(state.ctx);
          if (v && v!=='all'){ const anchor=document.getElementById(monthId(v)); if (anchor) anchor.scrollIntoView({behavior:'smooth', block:'start'}); }
        });
      }

      // ---------- keyword add ----------
      const addInput=$('kw-add-input'), addBtn=$('kw-add-btn');
      if (addInput && addBtn){
        const commit=()=>{ const kw=(addInput.value||'').trim(); if(!kw) return; addKeyword(kw).then(()=>{ addInput.value=''; refreshKeywords();}); };
        on(addBtn,'click',e=>{ e.preventDefault(); commit(); });
        on(addInput,'keydown',e=>{ if(e.key==='Enter') commit(); });
      }

      // ---------- open / close ----------
      let offcanvas=null;
      function ensureOC(){
        const el=$('dashCategoryManager'); if(!el) return null;
        if (window.bootstrap && window.bootstrap.Offcanvas){
          offcanvas = offcanvas || new bootstrap.Offcanvas(el);
          return offcanvas;
        }
        return null;
      }
      function openDrawer(ctx){
        const c=ctx||{};
        state.ctx.level=c.level||'category';
        state.ctx.cat=c.cat||''; state.ctx.sub=c.sub||''; state.ctx.ssub=c.ssub||''; state.ctx.sss=c.sss||'';
        state.ctx.month=c.month||''; state.ctx.allowHidden=!!c.allowHidden;

        renderBreadcrumb();
        fetchPathTx(state.ctx);

        // match pill colors to page's keyword field
        syncPillPaletteFromKeywordField();

        const el=$('dashCategoryManager'); if(!el) return;
        const oc=ensureOC(); if(oc&&oc.show) oc.show(); else { el.classList.add('show'); el.style.display='block'; }
      }
      function closeDrawer(){ if(offcanvas&&offcanvas.hide) offcanvas.hide(); else { const el=$('dashCategoryManager'); if(el){ el.classList.remove('show'); el.style.display='none'; } } }

      function openCategoryManager(ctx){ openDrawer(ctx||{}); }
      openCategoryManager.__cl_neon_fit = true;
      window.openCategoryManager = openCategoryManager;

      // Legacy openers for older pages
      if (!window.openDrawerForPath)     window.openDrawerForPath     = (state)=>openCategoryManager(state||{});
      if (!window.openDrawerForCategory) window.openDrawerForCategory = (cat,opts)=>openCategoryManager({ level:'category', cat:cat||'', allowHidden:!!(opts&&opts.allowHidden) });

      // >>> Global [data-manage] / .drawer-link / .view-drawer delegate <<<
      if (!window.dashManage) {
        window.dashManage = function(e, el){
          try{
            if (e) e.preventDefault();
            if (!el) return false;
            const ds = el.dataset || {};
            const inferLevel =
              ds.level ||
              (ds.sss ? 'subsubsubcategory' :
               ds.ssub ? 'subsubcategory' :
               ds.sub ? 'subcategory' : 'category');
            openCategoryManager({
              level: inferLevel,
              cat: ds.cat || '',
              sub: ds.sub || '',
              ssub: ds.ssub || '',
              sss: ds.sss || '',
              month: ds.month || '',
              allowHidden: (ds.allowHidden === 'false') ? false : true
            });
            return false;
          }catch(_){ return false; }
        };
      }

      document.addEventListener('click', function (e) {
        const el =
          e.target.closest('[data-manage]') ||
          e.target.closest('.view-drawer') ||
          e.target.closest('.drawer-link') ||
          e.target.closest('[data-open="drawer"]');
        if (!el) return;
        window.dashManage && window.dashManage(e, el);
      });
    })();
    </script>

    <!-- Force allow_hidden=1 on builder inspect calls (scoped to /builder) -->
    <script>
      (function(){
        if (location.pathname !== '/builder') return;
        const origFetch = window.fetch;
        window.fetch = function(input, init){
          try {
            let url = typeof input === 'string' ? input : (input && input.url) || '';
            if (url && url.indexOf('/admin/categories/inspect') !== -1 && !/[?&]allow_hidden=/.test(url)) {
              const u = new URL(url, window.location.origin);
              u.searchParams.set('allow_hidden', '1');
              input = typeof input === 'string' ? u.toString() : new Request(u.toString(), input);
            }
          } catch(e) {}
          return origFetch(input, init);
        };
      })();
    </script>

    <!-- Set CSS vars for sticky offsets based on navbar height -->
    <script>
      (function(){
        function setStickyOffsets(){
          const nav = document.querySelector('.navbar.fixed-top, .navbar-sticky, .app-header.fixed-top, .navbar');
          const h = nav ? Math.ceil(nav.getBoundingClientRect().height) : 56;
          document.documentElement.style.setProperty('--nav-h', h + 'px');
          document.documentElement.style.setProperty('--sticky-top', h + 'px');
        }
        window.addEventListener('load', setStickyOffsets, { once: true });
        window.addEventListener('resize', setStickyOffsets);
      })();
    </script>

    <!-- bt-cvslm normalizer (non-destructive) -->
    <script>
      (function () {
        const wants = /current\s*vs\s*last\s*month/i;

        function normalizeCvslmCard() {
          document.querySelectorAll('.card, .stat-card, .panel').forEach(card => {
            const heading = card.querySelector('.card-header, .card-title, .panel-title, .summary-label, h1, h2, h3, h4, h5, h6, caption');
            const txt = (heading ? heading.textContent : card.textContent) || '';
            if (!wants.test(txt)) return;

            // mark once
            if (!card.classList.contains('bt-cvslm-match')) card.classList.add('bt-cvslm-match');

            // find/skin table but DO NOT clobber backgrounds set by theme
            const table = card.querySelector('table');
            if (!table) return;

            table.classList.add('table','table-hover','table-striped','table-floating');
            if (!table.tHead && table.tBodies && table.tBodies[0] && table.tBodies[0].rows.length) {
              const first = table.tBodies[0].rows[0];
              const thead = document.createElement('thead');
              const tr = document.createElement('tr');
              Array.from(first.cells).forEach(td => {
                const th = document.createElement('th');
                th.innerHTML = td.innerHTML;
                tr.appendChild(th);
              });
              thead.appendChild(tr);
              table.insertBefore(thead, table.tBodies[0]);
              first.remove();
            }

            // alignment only; don’t touch background so frosted header/zebra remain
            table.querySelectorAll('th,td').forEach(c => {
              c.style.textAlign = 'left';
            });
          });
        }

        function init(){
          normalizeCvslmCard();
          setTimeout(normalizeCvslmCard, 200);
          setTimeout(normalizeCvslmCard, 600);
        }
        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init, { once:true });
        else init();
        window.addEventListener('bt:page-ready', normalizeCvslmCard);
      })();
    </script>

    <!-- Plotly grid/tick theming -->
    <script id="bt-plotly-dark">
      (function () {
        if (location.pathname !== '/charts') return;

        function cssVar(n, f){ const v=getComputedStyle(document.documentElement).getPropertyValue(n).trim(); return v||f; }
        const accent = cssVar('--accent-ink', '#9ecbff');
        const hair   = cssVar('--hair', 'rgba(255,255,255,.12)');
        const grid   = cssVar('--plotly-grid', 'rgba(158,203,255,.11)');

        function skin(gd){
          if (!gd || !window.Plotly) return;
          try {
            Plotly.relayout(gd, {
              'paper_bgcolor': 'rgba(0,0,0,0)',
              'plot_bgcolor' : 'rgba(0,0,0,0)',
              'font.color'   : accent,
              'legend.font.color': accent,

              'xaxis.gridcolor'      : grid,
              'xaxis.gridwidth'      : 0.6,
              'xaxis.zeroline'       : false,
              'xaxis.linecolor'      : hair,
              'xaxis.tickfont.color' : accent,
              'xaxis.title.font.color': accent,

              'yaxis.gridcolor'      : grid,
              'yaxis.gridwidth'      : 0.6,
              'yaxis.zeroline'       : false,
              'yaxis.linecolor'      : hair,
              'yaxis.tickfont.color' : accent,
              'yaxis.title.font.color': accent
            });
          } catch(_) {}
        }

        window.addEventListener('load', function(){
          document.querySelectorAll('.js-plotly-plot').forEach(skin);
        }, { once:true });

        document.addEventListener('plotly_afterplot', function(e){
          skin(e && e.target);
        }, { passive:true });
      })();
    </script>

    <script src="{{ url_for('static', filename='js/movers_weekly.js') }}" defer></script>
  </body>
</html>

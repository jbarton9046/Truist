<!-- Right-side Category Manager Drawer -->
<div class="offcanvas offcanvas-end manage-drawer" tabindex="-1" id="dashCategoryManager" aria-labelledby="dashCategoryManagerLabel" style="width:480px;">
  <div class="offcanvas-header">
    <div class="d-flex flex-column gap-1">
      <h5 class="offcanvas-title" id="dashCategoryManagerLabel">
        <nav id="drawer-breadcrumb" class="drawer-breadcrumb"></nav>
      </h5>

      <!-- Header controls: Month + Total -->
      <div class="small d-flex align-items-center flex-wrap gap-2">
        <span>Month:</span>

        <!-- Hidden native select (state source for JS) -->
        <select id="drawer-months" class="d-none"></select>

        <!-- Button that opens the FULL overlay selector -->
        <button id="drawer-months-open" class="glass-btn" type="button">
          <span id="drawer-months-label">Latest month</span>
          <svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M4 6l4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>

        <span class="mx-1">•</span>
        <span>Total:</span>
        <span id="drawer-total" class="fw-semibold">—</span>
      </div>
    </div>

    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <style>
    /* ---------- Base layout & THEME (scoped to the drawer) ---------- */
    #dashCategoryManager,
    #dashCategoryManager .offcanvas-header,
    #dashCategoryManager .offcanvas-body { color: var(--text); }

    #dashCategoryManager .text-muted,
    #dashCategoryManager .muted { color: var(--muted) !important; }

    #dashCategoryManager .form-control,
    #dashCategoryManager .form-select {
      color: var(--text);
      background: rgba(0,0,0,.25);
      border-color: var(--hair);
    }
    #dashCategoryManager .form-control::placeholder { color: color-mix(in oklab, var(--accent-ink) 65%, white); }

    /* ---------- Breadcrumb: chip-style, professional look ---------- */
    #dashCategoryManager .drawer-breadcrumb{
      display:flex; flex-wrap:wrap; align-items:center;
      gap:.35rem .45rem;
    }
    #dashCategoryManager .drawer-breadcrumb a{
      display:inline-flex; align-items:center; gap:.4rem;
      max-width: 100%;
      padding:.28rem .6rem; border-radius:.6rem;
      background: color-mix(in oklab, var(--accent-ink) 12%, transparent);
      color: var(--text); border:1px solid var(--hair);
      text-decoration:none;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      transition: background .15s ease, border-color .15s ease, transform .05s ease;
    }
    #dashCategoryManager .drawer-breadcrumb a:hover{
      background: color-mix(in oklab, var(--accent-ink) 18%, transparent);
      border-color: color-mix(in oklab, var(--accent-ink) 48%, transparent);
    }
    #dashCategoryManager .drawer-breadcrumb a .crumb-text{
      display:inline-block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
      max-width: 12rem;
    }
    #dashCategoryManager .drawer-breadcrumb a:not(:last-child)::after{
      content:"›"; margin-left:.35rem; opacity:.65;
    }

    /* ---------- Tabs ---------- */
    #dashCategoryManager .drawer-tabbar{
      display:flex; gap:.4rem; border-bottom:1px solid rgba(255,255,255,.08); margin:.25rem 0 .75rem;
    }
    #dashCategoryManager .drawer-tab{
      padding:.35rem .65rem; border-radius:.5rem .5rem 0 0; text-decoration:none; color:var(--text);
    }
    #dashCategoryManager .drawer-tab.active{
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-bottom-color:transparent;
    }
    #dashCategoryManager .drawer-pane{ display:none; }

    /* ---------- Table theme ---------- */
    #dashCategoryManager table thead th{
      background: var(--thead-bg) !important;
      color: var(--table-head-fg, var(--text)) !important;
      border-bottom: 1px solid var(--hair);
    }
    #dashCategoryManager table td, #dashCategoryManager table th{ color: var(--text); }

    .mono{ font-variant-numeric: tabular-nums; }
    .tx-neg{ color:#d36b6b; } .tx-pos{ color:#6bd39c; }

    /* ---------- Pills: colors driven by global accent ---------- */
    #dashCategoryManager{
      --pill-fg: var(--accent-ink);
      --pill-bg: color-mix(in oklab, var(--accent-ink) 14%, transparent);
      --pill-border: color-mix(in oklab, var(--accent-ink) 40%, transparent);
      --pill-bg-hover: color-mix(in oklab, var(--accent-ink) 22%, transparent);
      --pill-border-hover: color-mix(in oklab, var(--accent-ink) 58%, transparent);
    }
    #dashCategoryManager .pill{
      display:inline-flex; align-items:center; gap:.5rem; line-height:1;
      padding:.35rem .75rem; border-radius:999px;
      background:var(--pill-bg); color:var(--pill-fg); border:1px solid var(--pill-border);
      text-decoration:none; cursor:pointer; transition:background .15s, border-color .15s, color .15s;
    }
    #dashCategoryManager .pill:hover{
      background:var(--pill-bg-hover); border-color:var(--pill-border-hover);
    }
    #dashCategoryManager .pill-sm{ padding:.25rem .55rem; font-size:.875rem; cursor:default; }
    .pill-row{ display:flex; flex-wrap:wrap; gap:.5rem .6rem; }
    .pill .chev{ opacity:.7; }

    /* ---------- Small “glass” button in header ---------- */
    .glass-btn{
      display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:.6rem;
      border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      color:#cfe1ff; line-height:1; box-shadow: 0 1px 0 rgba(0,0,0,.25) inset;
    }
    .glass-btn:hover{ background:rgba(255,255,255,.14); }

    /* ---------- FULL overlay selector (glass panel) ---------- */
    #drawer-months-overlay[hidden]{ display:none; }
    #drawer-months-overlay{
      position:fixed; inset:0; z-index:1055; background:rgba(0,0,0,.45);
      backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
      display:flex; align-items:center; justify-content:center; padding:2rem;
    }
    .glass-panel{
      width:min(720px, 92vw); max-height:min(72vh, 640px); overflow:hidden;
      border-radius:1rem; border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(16,24,40,.70), rgba(16,24,40,.82));
      box-shadow:0 20px 60px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.06) inset;
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
      display:flex; flex-direction:column;
    }
    .glass-panel .hdr{
      padding: .9rem 1.1rem; font-weight:600; color:#cfe1ff;
      border-bottom:1px solid rgba(255,255,255,.12);
    }
    .glass-panel .list{ overflow:auto; padding:.35rem .35rem 1rem; }
    .glass-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:.6rem .9rem; margin:.15rem .25rem; border-radius:.65rem;
      color:#d9e7ff; background:transparent; border:0; width:calc(100% - .5rem);
      text-align:left;
    }
    .glass-item:hover{ background:rgba(255,255,255,.08); }
    .glass-divider{ height:1px; background:rgba(255,255,255,.12); margin:.25rem .5rem; }
    .panel-actions{ display:flex; gap:.5rem; justify-content:flex-end; padding:.7rem .9rem; border-top:1px solid rgba(255,255,255,.12); }
    .btn-ghost{ padding:.45rem .75rem; border-radius:.6rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); color:#e6f0ff; }
    .btn-ghost:hover{ background:rgba(255,255,255,.12); }

    /* ---------- Keywords pills: inline, borderless close icon (NEW) ---------- */
    #kw-list .pill{
      position: static;            /* no offset for a floating X */
      padding-right: .75rem;       /* normal padding */
    }
    /* new class to avoid any legacy .pill-close rules elsewhere */
    #kw-list .pill .kw-x{
      appearance: none; -webkit-appearance: none;
      background: none; border: 0;
      display: inline-flex; align-items: center; justify-content: center;
      position: static;            /* inline, part of the chip */
      width: 16px; height: 16px;
      margin-left: .1rem;
      line-height: 1; font-weight: 700; font-size: 14px;
      cursor: pointer;
      transform: translateY(-1px); /* optical centering with text */

      /* >>> CHANGED: match pill text color and keep full opacity */
      color: currentColor;
      opacity: 1;
    }
    #kw-list .pill:hover .kw-x{ opacity: 1; }
    #kw-list .pill .kw-x:focus-visible{
      outline: 2px solid color-mix(in oklab, var(--accent-ink) 50%, transparent);
      outline-offset: 2px; border-radius: 4px;
    }
  </style>

  <div class="offcanvas-body">
    <!-- Tabs -->
    <div class="drawer-tabbar">
      <a href="#" class="drawer-tab active" data-tab="overview">Overview</a>
      <a href="#" class="drawer-tab" data-tab="keywords">Keywords</a>
      <a href="#" class="drawer-tab" data-tab="actions">Actions</a>
    </div>

    <!-- Children -->
    <div class="mb-2">
      <div class="fw-semibold mb-1">Children:</div>
      <div id="drawer-children" class="pill-row"></div>
    </div>

    <!-- Overview -->
    <div class="drawer-pane" data-pane="overview" style="display:block;">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th class="w-25">Date</th>
              <th>Description</th>
              <th class="w-25">Amount</th> <!-- removed text-end to align with left-align JS/CSS -->
              <th class="w-25">Cat</th>
            </tr>
          </thead>
          <tbody id="drawer-tx-body">
            <tr><td colspan="4" class="text-muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Keywords -->
    <div class="drawer-pane" data-pane="keywords">
      <div class="d-flex align-items-center gap-2 mb-2">
        <input id="kw-add-input" class="form-control form-control-sm" placeholder="Add keyword…" />
        <button id="kw-add-btn" class="btn btn-sm btn-primary">Add</button>
      </div>
      <!-- NOTE: added data-path so pills can inherit if they don't carry it -->
      <div id="kw-list" class="d-flex flex-wrap gap-2 small" data-path="{{ path_str }}"></div>
    </div>

    <!-- Actions -->
    <div class="drawer-pane" data-pane="actions">
      <div class="small text-muted">Hook <code>[data-action]</code> buttons to <code>runAction(kind)</code> in <code>drawer.js</code>.</div>
    </div>
  </div>
</div>

<!-- FULL overlay (month picker) -->
<div id="drawer-months-overlay" hidden>
  <div class="glass-panel" role="dialog" aria-modal="true" aria-labelledby="drawer-months-title">
    <div class="hdr" id="drawer-months-title">Select month…</div>
    <div class="list" id="drawer-months-overlay-list">
      <!-- static header items -->
      <div class="glass-item" data-value="">Latest month</div>
      <div class="glass-item" data-value="all">All months</div>
      <div class="glass-divider"></div>
      <!-- dynamic months inserted by JS -->
    </div>
    <div class="panel-actions">
      <button type="button" class="btn-ghost" id="drawer-months-cancel">Close</button>
    </div>
  </div>
</div>

<!-- Minimal, non-conflicting helpers: tab switch + delegate to global refreshKeywords -->
<script>
(function(){
  'use strict';
  const dash = document.getElementById('dashCategoryManager');
  if (!dash) return;

  // Tab switching (the universal controller also binds; this keeps behavior
  // if that script is ever absent, and otherwise does not conflict)
  const tabs  = dash.querySelectorAll('.drawer-tab');
  const panes = dash.querySelectorAll('.drawer-pane');

  function showPane(name){
    tabs.forEach(t => t.classList.toggle('active', (t.dataset.tab === name)));
    panes.forEach(p => p.style.display = (p.dataset.pane === name) ? 'block' : 'none');
    if (name === 'keywords' && typeof window.refreshKeywords === 'function') {
      // use the universal controller's fetcher to avoid duplicate logic
      window.refreshKeywords();
      // slight delay for breadcrumb changes rendered just before tab switch
      setTimeout(window.refreshKeywords, 120);
    }
  }

  tabs.forEach(t => t.addEventListener('click', function(e){
    e.preventDefault();
    showPane(this.getAttribute('data-tab') || 'overview');
  }));

  // If the offcanvas shows with Keywords active, refresh via global fetcher
  document.addEventListener('show.bs.offcanvas', function(ev){
    if (ev.target && ev.target.id === 'dashCategoryManager') {
      const active = dash.querySelector('.drawer-tab.active')?.dataset.tab || 'overview';
      if (active === 'keywords' && typeof window.refreshKeywords === 'function') {
        window.refreshKeywords();
        setTimeout(window.refreshKeywords, 120);
      }
    }
  });
})();
</script>

<!-- Keyword pill close-buttons & deletion wiring -->
<script>
(function(){
  'use strict';
  const list = document.getElementById('kw-list');
  if (!list) return;

  // Add a close (×) button to any pill missing one
  function decoratePills(root){
    (root || list).querySelectorAll('.pill').forEach(pill => {
      // Remove any legacy close buttons that might carry old styles
      pill.querySelectorAll('.pill-close').forEach(n => n.remove());

      // If we already added the new button, skip
      if (pill.querySelector('.kw-x')) return;

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'kw-x';
      btn.setAttribute('aria-label', 'Remove keyword');
      btn.textContent = '×';
      // ensure pill has role=button for accessibility if it's clickable
      if (!pill.getAttribute('role')) pill.setAttribute('role', 'button');
      // inherit data-path from the list if pill doesn't have one
      if (!pill.hasAttribute('data-path') && list.dataset.path) {
        pill.setAttribute('data-path', list.dataset.path);
      }
      pill.appendChild(btn);
    });
  }

  // Initial decoration (in case server-side rendered)
  decoratePills();

  // Re-decorate after external refreshes add pills
  const mo = new MutationObserver(muts => {
    let needs = false;
    for (const m of muts) {
      if (m.addedNodes && m.addedNodes.length) { needs = true; break; }
    }
    if (needs) decoratePills();
  });
  mo.observe(list, { childList: true, subtree: true });

  // Deletion handler with graceful fallbacks
  async function handleDelete(pill){
    const kw = pill.dataset.keyword || pill.getAttribute('data-keyword') || pill.textContent.trim();
    const path = pill.dataset.path || pill.getAttribute('data-path') || list.dataset.path || '';

    // 1) If a global controller exists, let it do the real work
    if (typeof window.deleteKeyword === 'function') {
      try {
        await window.deleteKeyword({ keyword: kw, path });
      } catch(e) { /* swallow to still update UI */ }
    } else {
      // 2) Otherwise, try direct API DELETE (minimal, no dependency on globals)
      if (kw && path) {
        try {
          const url = `/api/keywords?path=${encodeURIComponent(path)}&keyword=${encodeURIComponent(kw)}`;
          await fetch(url, { method: 'DELETE' });
        } catch(e) {
          /* ignore; UI will still remove optimistically */
        }
      }
      // 3) Also emit a custom event for any external listeners
      const ev = new CustomEvent('keyword:delete', { detail: { keyword: kw, path }, bubbles: true });
      pill.dispatchEvent(ev);
    }

    // 4) Optimistic UI: remove the pill immediately
    pill.remove();

    // 5) Ask the global refresher (if present) to resync
    if (typeof window.refreshKeywords === 'function') {
      setTimeout(window.refreshKeywords, 50);
    }
  }

  // Delegate clicks on the ×
  list.addEventListener('click', (e) => {
    const btn = e.target.closest('.kw-x');
    if (!btn) return;
    e.preventDefault();
    e.stopPropagation();
    const pill = btn.closest('.pill');
    if (pill) handleDelete(pill);
  });

  // Keyboard support (Delete/Backspace when pill focused)
  list.addEventListener('keydown', (e) => {
    if (!e.target.classList.contains('pill')) return;
    if (e.key === 'Backspace' || e.key === 'Delete') {
      e.preventDefault();
      const pill = e.target;
      const btn = pill.querySelector('.kw-x');
      if (btn) btn.click();
    }
  });
})();
</script>

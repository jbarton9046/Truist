<!-- Right-side Category Manager drawer (frozed look, NON-sticky header/month) -->
<div class="offcanvas offcanvas-end manage-drawer" tabindex="-1" id="dashCategoryManager" aria-labelledby="dashCategoryManagerLabel" style="width:480px;">
  <div class="offcanvas-header">
    <div class="d-flex flex-column gap-1">
      <h5 class="offcanvas-title" id="dashCategoryManagerLabel">
        <nav id="drawer-breadcrumb" class="drawer-breadcrumb"></nav>
        <span id="drawer-selected-path" hidden>(All Categories)</span>
      </h5>
      <div class="small muted d-flex align-items-center gap-2 flex-wrap">
        <span>Month:</span>

        <!-- Hidden native select (kept for compatibility) -->
        <select id="drawer-months" class="visually-hidden"></select>

        <!-- Custom frozed month dropdown -->
        <div class="bt-select" id="drawer-months-ui">
          <button type="button"
                  class="bt-select-toggle"
                  id="drawer-months-btn"
                  aria-haspopup="listbox"
                  aria-expanded="false"
                  aria-controls="drawer-months-list">
            <span class="bt-select-label">All months</span>
            <span class="bt-caret" aria-hidden="true">▾</span>
          </button>
          <div class="bt-select-panel" id="drawer-months-list" role="listbox" tabindex="-1" hidden></div>
        </div>

        <span class="mx-1">•</span>
        <span>Total:</span>
        <span id="drawer-total" class="fw-semibold">—</span>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body">
    <!-- ===== Drawer-only styles (scoped) ===== -->
    <style>
      /* Tokens — match transactions.html “frozed” look (light tint + heavy blur) */
      #dashCategoryManager{
        --cm-fsz:      0.92rem;
        --cm-fsz-th:   0.95rem;
        --cm-line:     1.28;
        --cm-pad-y:    .58rem;
        --cm-pad-x:    .70rem;

        --hdr-bg: var(--thead-bg, rgba(255,255,255,.06)); /* light tint */
        --hdr-blur: 14px;                                 /* heavy blur */

        --panel-shadow: 0 20px 40px rgba(2,6,23,.40), 0 2px 10px rgba(2,6,23,.25);
      }
      @media (max-width: 520px){
        #dashCategoryManager{
          --cm-fsz:    0.86rem;
          --cm-fsz-th: 0.90rem;
          --cm-pad-y:  .52rem;
          --cm-pad-x:  .64rem;
        }
      }

      /* Emergency guardrails (stops vertical text weirdness) */
      #dashCategoryManager #drawer-tx *{
        writing-mode: horizontal-tb !important;
        text-orientation: mixed !important;
        word-break: normal !important;
        overflow-wrap: normal !important;
        hyphens: manual !important;
        white-space: normal !important;
        box-sizing: border-box !important;
      }

      /* Drawer scroller: vertical only */
      #dashCategoryManager .table-responsive{
        overflow-y: auto !important;
        overflow-x: hidden !important;
        max-height: 58vh;
        background: transparent;
        isolation: isolate;
      }

      /* Table layout & widths */
      #dashCategoryManager #drawer-tx{
        width: 100% !important;
        border-collapse: separate !important;
        table-layout: fixed !important;
        font-size: var(--cm-fsz);
        line-height: var(--cm-line);
      }
      #dashCategoryManager #drawer-tx col.col-date   { width: 24% !important; }
      #dashCategoryManager #drawer-tx col.col-desc   { width: 42% !important; }
      #dashCategoryManager #drawer-tx col.col-amount { width: 16% !important; }
      #dashCategoryManager #drawer-tx col.col-cat    { width: 18% !important; }

      @media (max-width: 520px){
        #dashCategoryManager #drawer-tx col.col-date   { width: 27% !important; }
        #dashCategoryManager #drawer-tx col.col-desc   { width: 39% !important; }
        #dashCategoryManager #drawer-tx col.col-amount { width: 16% !important; }
        #dashCategoryManager #drawer-tx col.col-cat    { width: 18% !important; }
      }

      /* Keep Date & Amount on one line; Desc & Cat can wrap */
      #dashCategoryManager #drawer-tx tbody td:nth-child(1),
      #dashCategoryManager #drawer-tx tbody td:nth-child(3){
        white-space: nowrap !important;
        font-variant-numeric: tabular-nums;
      }
      #dashCategoryManager #drawer-tx tbody td:nth-child(2),
      #dashCategoryManager #drawer-tx tbody td:nth-child(4){
        white-space: normal !important;
        word-break: break-word !important;
        overflow-wrap: break-word !important;
        hyphens: auto !important;
      }

      #dashCategoryManager #drawer-tx th,
      #dashCategoryManager #drawer-tx td{
        padding: var(--cm-pad-y) var(--cm-pad-x) !important;
      }
      #dashCategoryManager #drawer-tx thead th{ font-size: var(--cm-fsz-th) !important; }

      /* THEAD — frozed style (NON-sticky now) */
      #dashCategoryManager #drawer-tx thead th{
        backdrop-filter: saturate(120%) blur(var(--hdr-blur));
        -webkit-backdrop-filter: saturate(120%) blur(var(--hdr-blur));
        background: var(--hdr-bg) !important;
        border-bottom: 1px solid var(--hair);
        box-shadow:
          inset 0 1px 0 rgba(255,255,255,.06),
          0 10px 18px rgba(2, 6, 23, .25);
        color: var(--table-head-fg, var(--text));
        font-weight:700; letter-spacing:.2px;
      }

      /* Month row — same frozed skin but NOT sticky */
      #dashCategoryManager #drawer-tx tr.month-row > td{
        padding: 0 !important;
        border: 0 !important;
        background: transparent !important;
      }
      #dashCategoryManager #drawer-tx tr.month-row > td .month-shell{
        isolation: isolate;
        padding: .60rem var(--cm-pad-x);
        border-top: 1px solid var(--hair);
        border-bottom: 1px solid var(--hair);

        background: var(--hdr-bg) !important;
        backdrop-filter: saturate(120%) blur(var(--hdr-blur));
        -webkit-backdrop-filter: saturate(120%) blur(var(--hdr-blur));

        color: var(--table-head-fg, var(--text));
        font-weight:700; letter-spacing:.2px;
      }
      #dashCategoryManager #drawer-tx .net.tx-neg{ color:#c0392b; font-weight:700; }
      #dashCategoryManager #drawer-tx .net.tx-pos{ color:#1e7e34; font-weight:700; }

      /* === Children chips (restored styling) === */
      #dashCategoryManager .child-pill{
        display:inline-flex; align-items:center; gap:.35rem;
        padding:.34rem .62rem;
        border-radius:999px;
        background: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 45%, transparent);
        border:1px solid var(--hair);
        color: var(--text);
        line-height:1; cursor:pointer; user-select:none;
        transition: background .15s ease, border-color .15s ease, transform .05s ease;
        margin: .15rem .35rem .15rem 0;
      }
      #dashCategoryManager .child-pill:hover{
        background: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 70%, transparent);
        border-color: color-mix(in oklab, var(--text) 24%, transparent);
      }
      #dashCategoryManager .child-pill:active{ transform: translateY(1px); }
      #dashCategoryManager .child-pill .dot{ width:6px; height:6px; border-radius:50%; background: currentColor; opacity:.65; display:inline-block; }
      #dashCategoryManager .child-pill .label{ font-weight:600; }
      #dashCategoryManager .child-pill .chev{ font-weight:700; opacity:.7; transform: translateY(-1px); }

      .drawer-breadcrumb{ display:flex; gap:.35rem; flex-wrap:wrap; align-items:center; }
      .drawer-breadcrumb a{ text-decoration:none; font-weight:700; color: var(--accent-ink); }
      .drawer-breadcrumb a:hover{ text-decoration:underline; }
      .drawer-breadcrumb .sep{ color:#8aa3c6; }
      .muted{ color: color-mix(in oklab, var(--text) 72%, transparent); }
      .drawer-tabs{ display:flex; gap:.5rem; margin-bottom:.65rem; border-bottom:1px solid var(--hair); }
      .drawer-tab{ padding:.4rem .7rem; border-radius:.6rem .6rem 0 0; text-decoration:none; color: var(--text); background: transparent; border:1px solid transparent; }
      .drawer-tab:hover{ background: rgba(255,255,255,.06); border-color: var(--hair); }
      .drawer-tab.active{
        background: linear-gradient(180deg, color-mix(in oklab, var(--thead-bg) 92%, transparent) 0%, color-mix(in oklab, var(--thead-bg) 78%, transparent) 100%);
        border:1px solid var(--hair); border-bottom-color: transparent;
      }

      /* ===== Custom frozed select ===== */
      #dashCategoryManager .bt-select{
        position: relative;
        display: inline-block;
        z-index: 15; /* above table */
      }
      #dashCategoryManager .bt-select-toggle{
        display: inline-flex;
        align-items: center;
        gap: .5rem;
        padding: .35rem .65rem;
        border-radius: 10px;
        border: 1px solid var(--hair);
        color: var(--text);
        background: var(--hdr-bg);
        backdrop-filter: saturate(120%) blur(var(--hdr-blur));
        -webkit-backdrop-filter: saturate(120%) blur(var(--hdr-blur));
        line-height: 1.1;
      }
      #dashCategoryManager .bt-caret{ opacity: .85; }
      #dashCategoryManager .bt-select-panel{
        position: absolute;
        top: calc(100% + 8px);
        right: 0;
        min-width: 230px;
        max-width: 300px;
        width: max-content;
        max-height: 320px;
        overflow: auto;
        padding: .35rem;
        border-radius: 14px;
        border: 1px solid var(--hair);
        background: var(--hdr-bg);
        backdrop-filter: saturate(120%) blur(18px);
        -webkit-backdrop-filter: saturate(120%) blur(18px);
        box-shadow: var(--panel-shadow);
      }
      #dashCategoryManager .bt-option{
        display: flex;
        width: 100%;
        padding: .50rem .6rem;
        border: 0;
        border-radius: 10px;
        background: transparent;
        color: var(--text);
        text-align: left;
        cursor: pointer;
      }
      #dashCategoryManager .bt-option:hover{ background: rgba(255,255,255,.07); }
      #dashCategoryManager .bt-option.selected{
        background: rgba(255,255,255,.10);
        font-weight: 700;
      }

      /* Fallback: if blur unsupported, increase opacity a bit */
      @supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
        #dashCategoryManager #drawer-tx thead th,
        #dashCategoryManager #drawer-tx tr.month-row > td .month-shell,
        #dashCategoryManager .bt-select-toggle,
        #dashCategoryManager .bt-select-panel{
          background: rgba(20,30,50,.85) !important;
        }
      }
    </style>

    <!-- Tabs -->
    <div class="drawer-tabs">
      <a href="#" class="drawer-tab active" data-tab="overview">Overview</a>
      <a href="#" class="drawer-tab" data-tab="keywords">Keywords</a>
      <a href="#" class="drawer-tab" data-tab="actions">Actions</a>
    </div>

    <!-- Pane: Overview -->
    <div class="drawer-pane" data-pane="overview" style="display:block;">
      <div class="mb-2"><strong>Children:</strong> <div id="drawer-children" class="mt-1"></div></div>

      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0" id="drawer-tx" aria-label="Transactions by month">
          <colgroup>
            <col class="col-date">
            <col class="col-desc">
            <col class="col-amount">
            <col class="col-cat">
          </colgroup>
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Amount</th>
              <th>Cat</th>
            </tr>
          </thead>
          <tbody id="drawer-tx-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Pane: Keywords -->
    <div class="drawer-pane" data-pane="keywords" style="display:none;">
      <div class="small muted mb-1">
        Keywords attached to: <span id="kw-current-level" class="fw-semibold">(select a node)</span>.
        Click × to remove. Case-insensitive “contains” match.
      </div>
      <div id="kw-list" class="mb-2"><span class="muted">No keywords yet.</span></div>
      <div class="input-group input-group-sm">
        <input id="kw-add-input" class="form-control" placeholder="Add keyword (e.g. MOBILE DEPOSIT)">
        <button id="kw-add-btn" class="btn btn-outline-primary">Add</button>
      </div>
    </div>

    <!-- Pane: Actions -->
    <div class="drawer-pane" data-pane="actions" style="display:none;">
      <div class="d-grid gap-2">
        <button id="drawer-inspect" class="btn btn-sm btn-outline-secondary">Inspect Path JSON</button>
        <button id="drawer-rename"  class="btn btn-sm btn-outline-secondary">Rename Current Node</button>
        <button id="drawer-upsert"  class="btn btn-sm btn-outline-primary">Create/Attach Child Under This Path</button>
      </div>
      <div class="small muted mt-2">These call your admin endpoints: inspect, rename, upsert.</div>
    </div>
  </div>
</div>

<!-- Server endpoints (persistent) -->
<script>
  window.CL_URLS = window.CL_URLS || {};
  window.CL_URLS.PATH_TXN_URL = '/api/path/transactions';
  window.CL_URLS.INSPECT_URL  = '/admin/categories/inspect';
  window.CL_URLS.RENAME_URL   = '/admin/categories/rename';
  window.CL_URLS.UPSERT_URL   = '/admin/categories/upsert';
  /* Optional keyword endpoints:
  window.CL_URLS.KW_GET_URL    = '/admin/keywords/get';
  window.CL_URLS.KW_ADD_URL    = '/admin/keywords/add';
  window.CL_URLS.KW_REMOVE_URL = '/admin/keywords/remove';
  */
</script>
<script src="{{ url_for('static', filename='js/drawer.js') }}"></script>

<!-- Right-side Category Manager Drawer -->
<div class="offcanvas offcanvas-end manage-drawer" tabindex="-1" id="dashCategoryManager" aria-labelledby="dashCategoryManagerLabel" style="width:480px;">
  <div class="offcanvas-header">
    <div class="d-flex flex-column gap-1">
      <h5 class="offcanvas-title" id="dashCategoryManagerLabel">
        <nav id="drawer-breadcrumb" class="drawer-breadcrumb"></nav>
      </h5>

      <!-- Header controls: Month + Total -->
      <div class="small d-flex align-items-center flex-wrap gap-2">
        <span>Month:</span>

        <!-- Hidden native select (state source for JS) -->
        <select id="drawer-months" class="d-none"></select>

        <!-- Button that opens the FULL overlay selector -->
        <button id="drawer-months-open" class="glass-btn" type="button">
          <span id="drawer-months-label">Latest month</span>
          <svg viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="M4 6l4 4 4-4" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        </button>

        <span class="mx-1">•</span>
        <span>Total:</span>
        <span id="drawer-total" class="fw-semibold">—</span>
      </div>
    </div>

    <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <style>
    /* ---------- Base layout & THEME (scoped to the drawer) ---------- */
    #dashCategoryManager,
    #dashCategoryManager .offcanvas-header,
    #dashCategoryManager .offcanvas-body { color: var(--text); }

    #dashCategoryManager .text-muted,
    #dashCategoryManager .muted { color: var(--muted) !important; }

    #dashCategoryManager .form-control,
    #dashCategoryManager .form-select {
      color: var(--text);
      background: rgba(0,0,0,.25);
      border-color: var(--hair);
    }
    #dashCategoryManager .form-control::placeholder { color: color-mix(in oklab, var(--accent-ink) 65%, white); }

    /* ---------- Breadcrumb: chip-style ---------- */
    #dashCategoryManager .drawer-breadcrumb{
      display:flex; flex-wrap:wrap; align-items:center; gap:.35rem .45rem;
    }
    #dashCategoryManager .drawer-breadcrumb a{
      display:inline-flex; align-items:center; gap:.4rem; max-width:100%;
      padding:.28rem .6rem; border-radius:.6rem;
      background: color-mix(in oklab, var(--accent-ink) 12%, transparent);
      color: var(--text); border:1px solid var(--hair);
      text-decoration:none; box-shadow: inset 0 1px 0 rgba(255,255,255,.05);
      transition: background .15s ease, border-color .15s ease;
    }
    #dashCategoryManager .drawer-breadcrumb a:hover{
      background: color-mix(in oklab, var(--accent-ink) 18%, transparent);
      border-color: color-mix(in oklab, var(--accent-ink) 48%, transparent);
    }
    #dashCategoryManager .drawer-breadcrumb a:not(:last-child)::after{
      content:"›"; margin-left:.35rem; opacity:.65;
    }

    /* ---------- Tabs ---------- */
    #dashCategoryManager .drawer-tabbar{
      display:flex; gap:.4rem; border-bottom:1px solid rgba(255,255,255,.08); margin:.25rem 0 .75rem;
    }
    #dashCategoryManager .drawer-tab{ padding:.35rem .65rem; border-radius:.5rem .5rem 0 0; text-decoration:none; color:var(--text); }
    #dashCategoryManager .drawer-tab.active{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12); border-bottom-color:transparent; }
    #dashCategoryManager .drawer-pane{ display:none; }

    /* ---------- Table theme ---------- */
    #dashCategoryManager table thead th{
      background: var(--thead-bg) !important; color: var(--table-head-fg, var(--text)) !important; border-bottom: 1px solid var(--hair);
    }
    #dashCategoryManager table td, #dashCategoryManager table th{ color: var(--text); }

    .mono{ font-variant-numeric: tabular-nums; }
    .tx-neg{ color:#d36b6b; } .tx-pos{ color:#6bd39c; }

    /* ---------- Pills ---------- */
    #dashCategoryManager{
      --pill-fg: var(--accent-ink);
      --pill-bg: color-mix(in oklab, var(--accent-ink) 14%, transparent);
      --pill-border: color-mix(in oklab, var(--accent-ink) 40%, transparent);
      --pill-bg-hover: color-mix(in oklab, var(--accent-ink) 22%, transparent);
      --pill-border-hover: color-mix(in oklab, var(--accent-ink) 58%, transparent);
    }
    #dashCategoryManager .pill{
      display:inline-flex; align-items:center; gap:.5rem; line-height:1;
      padding:.35rem .75rem; border-radius:999px;
      background:var(--pill-bg); color:var(--pill-fg); border:1px solid var(--pill-border);
      text-decoration:none; cursor:pointer; transition:background .15s, border-color .15s, color .15s;
    }
    #dashCategoryManager .pill:hover{ background:var(--pill-bg-hover); border-color:var(--pill-border-hover); }
    #dashCategoryManager .pill-sm{ padding:.25rem .55rem; font-size:.875rem; cursor:default; }
    .pill-row{ display:flex; flex-wrap:wrap; gap:.5rem .6rem; }
    .pill .chev{ opacity:.7; }

    /* ---------- Small glass button ---------- */
    .glass-btn{
      display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .6rem; border-radius:.6rem;
      border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.10);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      color:#cfe1ff; line-height:1; box-shadow: 0 1px 0 rgba(0,0,0,.25) inset;
    }
    .glass-btn:hover{ background:rgba(255,255,255,.14); }

    /* ---------- FULL overlay selector ---------- */
    #drawer-months-overlay[hidden]{ display:none; }
    #drawer-months-overlay{
      position:fixed; inset:0; z-index:1055; background:rgba(0,0,0,.45);
      backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
      display:flex; align-items:center; justify-content:center; padding:2rem;
    }
    .glass-panel{
      width:min(720px, 92vw); max-height:min(72vh, 640px); overflow:hidden;
      border-radius:1rem; border:1px solid rgba(255,255,255,.16);
      background:linear-gradient(180deg, rgba(16,24,40,.70), rgba(16,24,40,.82));
      box-shadow:0 20px 60px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.06) inset;
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
      display:flex; flex-direction:column;
    }
    .glass-panel .hdr{ padding:.9rem 1.1rem; font-weight:600; color:#cfe1ff; border-bottom:1px solid rgba(255,255,255,.12); }
    .glass-panel .list{ overflow:auto; padding:.35rem .35rem 1rem; }
    .glass-item{
      display:flex; align-items:center; justify-content:space-between;
      padding:.6rem .9rem; margin:.15rem .25rem; border-radius:.65rem;
      color:#d9e7ff; background:transparent; border:0; width:calc(100% - .5rem); text-align:left;
    }
    .glass-item:hover{ background:rgba(255,255,255,.08); }
    .glass-divider{ height:1px; background:rgba(255,255,255,.12); margin:.25rem .5rem; }
    .panel-actions{ display:flex; gap:.5rem; justify-content:flex-end; padding:.7rem .9rem; border-top:1px solid rgba(255,255,255,.12); }
    .btn-ghost{ padding:.45rem .75rem; border-radius:.6rem; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18); color:#e6f0ff; }
    .btn-ghost:hover{ background:rgba(255,255,255,.12); }

    /* ---------- Keyword pills: inline close ---------- */
    #kw-list .pill{ position: static; padding-right:.75rem; }
    #kw-list .pill .kw-x{
      appearance:none; -webkit-appearance:none; background:none; border:0;
      display:inline-flex; align-items:center; justify-content:center;
      position:static; width:16px; height:16px; margin-left:.1rem;
      line-height:1; font-weight:700; font-size:14px; opacity:.55; cursor:pointer;
      transform: translateY(-1px);
    }
    #kw-list .pill:hover .kw-x{ opacity:.9; }
    #kw-list .pill .kw-x:focus-visible{
      outline:2px solid color-mix(in oklab, var(--accent-ink) 50%, transparent);
      outline-offset:2px; border-radius:4px;
    }
    /* Kill any legacy absolute-X rules */
    #dashCategoryManager .kw-pill .kw-x,
    #dashCategoryManager #kw-list .pill .kw-x{ position:static!important; background:none!important; border:0!important; box-shadow:none!important; }
  </style>

  <div class="offcanvas-body">
    <div class="drawer-tabbar">
      <a href="#" class="drawer-tab active" data-tab="overview">Overview</a>
      <a href="#" class="drawer-tab" data-tab="keywords">Keywords</a>
      <a href="#" class="drawer-tab" data-tab="actions">Actions</a>
    </div>

    <div class="mb-2">
      <div class="fw-semibold mb-1">Children:</div>
      <div id="drawer-children" class="pill-row"></div>
    </div>

    <div class="drawer-pane" data-pane="overview" style="display:block;">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0">
          <thead>
            <tr>
              <th class="w-25">Date</th>
              <th>Description</th>
              <th class="w-25">Amount</th>
              <th class="w-25">Cat</th>
            </tr>
          </thead>
          <tbody id="drawer-tx-body">
            <tr><td colspan="4" class="text-muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="drawer-pane" data-pane="keywords">
      <div class="d-flex align-items-center gap-2 mb-2">
        <input id="kw-add-input" class="form-control form-control-sm" placeholder="Add keyword…" />
        <button id="kw-add-btn" class="btn btn-sm btn-primary">Add</button>
      </div>
      <div id="kw-list" class="d-flex flex-wrap gap-2 small" data-path=""></div>
    </div>

    <div class="drawer-pane" data-pane="actions">
      <div class="small text-muted">Hook <code>[data-action]</code> buttons to <code>runAction(kind)</code>.</div>
    </div>
  </div>
</div>

<!-- FULL overlay (month picker) -->
<div id="drawer-months-overlay" hidden>
  <div class="glass-panel" role="dialog" aria-modal="true" aria-labelledby="drawer-months-title">
    <div class="hdr" id="drawer-months-title">Select month…</div>
    <div class="list" id="drawer-months-overlay-list">
      <div class="glass-item" data-value="">Latest month</div>
      <div class="glass-item" data-value="all">All months</div>
      <div class="glass-divider"></div>
    </div>
    <div class="panel-actions">
      <button type="button" class="btn-ghost" id="drawer-months-cancel">Close</button>
    </div>
  </div>
</div>

<!-- Tabs + refresh-on-open -->
<script>
(function(){
  'use strict';
  const dash = document.getElementById('dashCategoryManager'); if (!dash) return;
  const tabs  = dash.querySelectorAll('.drawer-tab');
  const panes = dash.querySelectorAll('.drawer-pane');

  function showPane(name){
    tabs.forEach(t => t.classList.toggle('active', (t.dataset.tab === name)));
    panes.forEach(p => p.style.display = (p.dataset.pane === name) ? 'block' : 'none');
    if (name === 'keywords' && typeof window.refreshKeywords === 'function') {
      window.refreshKeywords();
      setTimeout(window.refreshKeywords, 120);
    }
  }
  tabs.forEach(t => t.addEventListener('click', (e)=>{ e.preventDefault(); showPane(t.dataset.tab||'overview'); }));
  document.addEventListener('show.bs.offcanvas', (ev)=>{
    if (ev.target && ev.target.id === 'dashCategoryManager') {
      const active = dash.querySelector('.drawer-tab.active')?.dataset.tab || 'overview';
      if (active === 'keywords' && window.refreshKeywords) { window.refreshKeywords(); setTimeout(window.refreshKeywords, 120); }
    }
  });
})();
</script>

<!-- Keyword pill close-buttons & deletion wiring -->
<script>
(function(){
  'use strict';
  const list = document.getElementById('kw-list'); if (!list) return;

  function decoratePills(root){
    (root||list).querySelectorAll('.pill').forEach(pill=>{
      pill.querySelectorAll('.pill-close').forEach(n=>n.remove());
      if (pill.querySelector('.kw-x')) return;
      const btn = document.createElement('button');
      btn.type='button'; btn.className='kw-x'; btn.setAttribute('aria-label','Remove keyword'); btn.textContent='×';
      if (!pill.getAttribute('role')) pill.setAttribute('role','button');
      pill.appendChild(btn);
    });
  }
  decoratePills();
  new MutationObserver(m=>{ if (m.some(x=>x.addedNodes && x.addedNodes.length)) decoratePills(); }).observe(list,{childList:true,subtree:true});

  async function handleDelete(pill){
    const kw = pill.dataset.keyword || pill.getAttribute('data-keyword') || pill.textContent.trim();
    const path = pill.dataset.path || list.dataset.path || '';
    if (window.deleteKeyword) { try { await window.deleteKeyword({ keyword: kw, path }); } catch(e){} }
    pill.remove();
    if (window.refreshKeywords) setTimeout(window.refreshKeywords, 50);
  }
  list.addEventListener('click', (e)=>{
    const btn = e.target.closest('.kw-x'); if (!btn) return;
    e.preventDefault(); e.stopPropagation();
    const pill = btn.closest('.pill'); if (pill) handleDelete(pill);
  });
  list.addEventListener('keydown', (e)=>{
    if (!e.target.classList.contains('pill')) return;
    if (e.key==='Backspace' || e.key==='Delete'){ e.preventDefault(); e.target.querySelector('.kw-x')?.click(); }
  });
})();
</script>

<!-- ===== Universal Drawer Controller (compact, self-contained) ===== -->
<script>
(function(){
  'use strict';
  if (window.openCategoryManager && window.refreshKeywords) return; // already present on non-builder pages

  const $ = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const host = $('#dashCategoryManager');
  const kwList = $('#kw-list');
  if (!host) return;

  const urls = window.CL_URLS || {};
  const PATH_TXN_URL = urls.PATH_TXN_URL || '/api/path/transactions';

  // Multi-backend keyword candidates (by path OR by name/levels OR unified /keywords)
  const GETS = [
    urls.KW_GET_URL, '/admin/categories/keywords', '/admin/api/keywords', '/api/keywords',
    '/admin/categories/keywords_for_name', '/api/keywords_for_name'
  ].filter(Boolean);
  const POSTS_ADD = [
    urls.KW_ADD_URL, '/admin/categories/keyword/add', '/admin/api/keyword_add', '/api/keyword_add', '/admin/categories/keywords', '/api/keywords'
  ];
  const POSTS_REM = [
    urls.KW_REMOVE_URL, '/admin/categories/keyword/remove', '/admin/api/keyword_remove', '/api/keyword_remove', '/admin/categories/keywords', '/api/keywords'
  ];

  const state = { ctx:{ level:'category', cat:'', sub:'', ssub:'', sss:'', month:'' }, months:[], children:[], tx:[], total:0 };

  // -------- helpers
  const esc = s => String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
  const fmtUSD = n => { try { return new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(+n||0); } catch { return '$'+Number(+n||0).toFixed(2);} };

  const pathParts = ()=>[state.ctx.cat,state.ctx.sub,state.ctx.ssub,state.ctx.sss].filter(Boolean);
  const setKwPathAttr = ()=>{ kwList.dataset.path = pathParts().join(' › '); };

  // -------- renderers
  function renderBreadcrumb(){
    const nav = $('#drawer-breadcrumb'); if (!nav) return;
    const parts = pathParts();
    const root = `<a href="#" data-bc="-1">All Categories</a>`;
    const segs = [root];
    parts.forEach((p,i)=>{ segs.push(`<a href="#" data-bc="${i}">${esc(p)}</a>`); });
    nav.innerHTML = segs.join(' ');
    nav.querySelectorAll('a[data-bc]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const idx = +a.dataset.bc;
        if (idx < 0) state.ctx.cat=state.ctx.sub=state.ctx.ssub=state.ctx.sss='';
        else ['cat','sub','ssub','sss'].slice(idx+1).forEach(k=>state.ctx[k]='');
        fetchPathTx();
      });
    });
  }

  function renderChildren(){
    const wrap = $('#drawer-children'); if (!wrap) return;
    const kids = state.children||[];
    if (!kids.length){ wrap.innerHTML='<span class="muted">No children.</span>'; return; }
    wrap.innerHTML = kids.map(k=>`<a class="pill" data-child="${esc(k)}"><span class="label">${esc(k)}</span><span class="chev">›</span></a>`).join('');
    wrap.querySelectorAll('[data-child]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const name = el.getAttribute('data-child');
        if (!state.ctx.cat) state.ctx.cat=name;
        else if (!state.ctx.sub) state.ctx.sub=name;
        else if (!state.ctx.ssub) state.ctx.ssub=name;
        else state.ctx.sss=name;
        fetchPathTx();
      });
    });
  }

  function renderTx(){
    const body=$('#drawer-tx-body'); if(!body) return;
    const rows=state.tx||[];
    if(!rows.length){ body.innerHTML='<tr><td colspan="4" class="text-muted">No transactions.</td></tr>'; return; }
    body.innerHTML = rows.map(t=>{
      const amt=Number(t.amount||0), cls=amt<0?'tx-neg':'tx-pos';
      const catPath = t.sssubcategory || t.subsubcategory || t.subcategory || t.category || '';
      return `<tr>
        <td class="mono">${esc(t.date||'')}</td>
        <td>${esc(t.description||'')}</td>
        <td class="mono ${cls}">${fmtUSD(amt)}</td>
        <td><span class="pill pill-sm">${esc(catPath)}</span></td>
      </tr>`;
    }).join('');
  }

  // -------- keywords I/O (works for path or name/levels or unified)
  async function kwGet(){
    const parts = pathParts();
    const last = parts[parts.length-1] || '';
    const qpCommon = new URLSearchParams({ level: state.ctx.level, cat: state.ctx.cat, sub: state.ctx.sub, ssub: state.ctx.ssub, sss: state.ctx.sss, name:last });
    qpCommon.set('_', Date.now());

    for (const base of GETS){
      try{
        let url = base;
        if (/keywords_for_name/i.test(base)) url += '?' + qpCommon.toString();
        else url += '?' + new URLSearchParams({ path: kwList.dataset.path || parts.join(' › '), _ : Date.now() }).toString();

        const r = await fetch(url, { headers:{'Accept':'application/json'} });
        if (!r.ok) continue;
        const j = await r.json();
        if (Array.isArray(j)) return j;
        if (j && Array.isArray(j.keywords)) return j.keywords;
        if (j && Array.isArray(j.data)) return j.data;
      }catch(_){}
    }
    return [];
  }
  async function kwPost(cands, keyword, remove){
    const payload = { keyword, path: kwList.dataset.path || pathParts().join(' › '), level: state.ctx.level, cat: state.ctx.cat, sub: state.ctx.sub, ssub: state.ctx.ssub, sss: state.ctx.sss };
    for (const base of cands){
      try{
        const body = (/\/keywords(?:$|\?)/.test(base)) ? { ...payload, action: remove?'remove':'add', remove: !!remove } : payload;
        const r = await fetch(base, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (r.ok) return true;
      }catch(_){}
    }
    return false;
  }

  // -------- public API
  async function refreshKeywords(){
    const list = $('#kw-list'); if (!list) return;
    setKwPathAttr();
    list.innerHTML = '<span class="muted">Loading…</span>';
    const kws = await kwGet();
    list.innerHTML = kws.length ? kws.map(k=>`<span class="pill" data-keyword="${esc(k)}">${esc(k)}<button class="kw-x" aria-label="Remove">×</button></span>`).join(' ') : '<span class="muted">No keywords yet.</span>';
  }
  async function addKeyword({ keyword }){ if (!keyword) return false; return kwPost(POSTS_ADD, keyword, false); }
  async function deleteKeyword({ keyword }){ if (!keyword) return false; return kwPost(POSTS_REM, keyword, true); }

  window.refreshKeywords = window.refreshKeywords || refreshKeywords;
  window.addKeyword      = window.addKeyword      || addKeyword;
  window.deleteKeyword   = window.deleteKeyword   || deleteKeyword;

  // -------- path + tx fetch (kept minimal for builder)
  async function fetchPathTx(){
    // keep path attr in sync
    setKwPathAttr();
    renderBreadcrumb();

    // fetch children/tx if endpoint exists; otherwise just refresh keywords
    try{
      const q = new URLSearchParams({ level: state.ctx.level, cat: state.ctx.cat, sub: state.ctx.sub, ssub: state.ctx.ssub, sss: state.ctx.sss, months:'all', _: Date.now() });
      const r = await fetch((PATH_TXN_URL||'/api/path/transactions') + '?' + q.toString(), { headers:{'Accept':'application/json'} });
      if (r.ok){
        const j = await r.json();
        state.children = j.children || j.kids || [];
        state.tx = j.tx || j.transactions || [];
        state.total = Number(j.total ?? j.net_total ?? 0);
        const totalEl = document.getElementById('drawer-total'); if (totalEl) totalEl.textContent = fmtUSD(state.total);
        renderChildren(); renderTx();
      }
    }catch(_){}
    // always refresh keywords for current path
    refreshKeywords();
  }

  // -------- Add box wiring
  (function(){
    const input = $('#kw-add-input'), btn = $('#kw-add-btn');
    if (!input || !btn) return;
    const commit = async ()=>{
      const v = (input.value||'').trim(); if (!v) return;
      await addKeyword({ keyword:v }); input.value=''; refreshKeywords();
    };
    btn.addEventListener('click', e=>{ e.preventDefault(); commit(); });
    input.addEventListener('keydown', e=>{ if (e.key === 'Enter') commit(); });
  })();

  // -------- Open API for buttons (optional)
  function openCategoryManager(ctx){
    // adopt incoming context (if any)
    const c = ctx || {};
    state.ctx.level=c.level||state.ctx.level;
    state.ctx.cat=c.cat||''; state.ctx.sub=c.sub||''; state.ctx.ssub=c.ssub||''; state.ctx.sss=c.sss||'';
    fetchPathTx();

    // show the offcanvas (works even if Bootstrap not loaded)
    const el = host;
    const oc = (window.bootstrap && window.bootstrap.Offcanvas) ? (window._cmOC || (window._cmOC = new bootstrap.Offcanvas(el))) : null;
    if (oc) oc.show(); else { el.classList.add('show'); el.style.display='block'; }
  }
  window.openCategoryManager = window.openCategoryManager || openCategoryManager;

  // initial paint (root)
  fetchPathTx();
})();
</script>

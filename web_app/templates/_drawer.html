<!-- Right-side Category Manager drawer (RESTORED BASELINE + sticky month header) -->
<div class="offcanvas offcanvas-end manage-drawer" tabindex="-1" id="dashCategoryManager" aria-labelledby="dashCategoryManagerLabel" style="width:480px;">
  <div class="offcanvas-header">
    <div class="d-flex flex-column">
      <h5 class="offcanvas-title" id="dashCategoryManagerLabel">
        <!-- Breadcrumb (clickable) -->
        <nav id="drawer-breadcrumb" class="drawer-breadcrumb"></nav>
        <!-- Keep original path label (hidden) so existing JS can still update it -->
        <span id="drawer-selected-path" hidden>(All Categories)</span>
      </h5>
      <div class="small text-muted">
        Month:
        <select id="drawer-months" class="form-select form-select-sm d-inline-block w-auto align-middle"></select>
        &nbsp;•&nbsp;
        <span id="drawer-total" class="fw-semibold">—</span>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body">
    <!-- === Scoped RESET so the drawer table looks like it did originally === -->
    <style>
      /* Tabs (original simple look) */
      .drawer-tabs { display:flex; gap:.5rem; border-bottom:1px solid #edf2f7; margin-bottom:.6rem; }
      .drawer-tab { padding:.35rem .65rem; border-radius:.5rem .5rem 0 0; text-decoration:none; color:#495057; }
      .drawer-tab.active { background:#f8f9fa; border:1px solid #edf2f7; border-bottom-color:#f8f9fa; }

      /* Children pills (original; remove leading bullet) */
      .child-pill { display:inline-block; padding:.2rem .55rem; background:#f1f3f5; border-radius:999px; margin:.1rem .25rem 0 0; font-size:.85rem; cursor:pointer; }
      .child-pill::before{ content:none; }

      /* Basic tones from the old drawer */
      .tx-pos { color:#1e7e34; font-weight:600; }
      .tx-neg { color:#c0392b; font-weight:600; }

      .drawer-breadcrumb { display:flex; gap:.35rem; flex-wrap:wrap; align-items:center; }
      .drawer-breadcrumb a { text-decoration:none; font-weight:600; }
      .drawer-breadcrumb a:hover { text-decoration:underline; }
      .drawer-breadcrumb .sep { color:#adb5bd; }

      /* ---------- HARD resets to undo any neon-tech drawer overrides ---------- */
      /* We will HIDE the thead entirely; month headers include column labels */
      #dashCategoryManager #drawer-tx thead{ display:none !important; }

      /* Column sizing like the simple original (also used to align sticky grid labels) */
      #dashCategoryManager #drawer-tx .col-date   { width:110px; white-space:nowrap; }
      #dashCategoryManager #drawer-tx .col-amount { width:130px; text-align:right; white-space:nowrap; }
      #dashCategoryManager #drawer-tx .col-desc,
      #dashCategoryManager #drawer-tx .col-cat    { width:auto; }

      /* Comfortable row padding, normal wrapping for Description only */
      #dashCategoryManager #drawer-tx td{ padding:.9rem .9rem; vertical-align:top; border-bottom:1px solid var(--hair, #e9ecef); }
      #dashCategoryManager #drawer-tx tr:last-child td{ border-bottom:0; }
      #dashCategoryManager #drawer-tx td.col-desc{ white-space:normal; word-break:break-word; }

      /* Keep the scroller simple */
      #dashCategoryManager .table-responsive{ overflow:auto; border-radius:12px; }

      /* ------------------------------------------------------------------ */
      /* NEW: Combined sticky month header (month banner + column labels)   */
      /* ------------------------------------------------------------------ */
      /* The row that contains the sticky shell */
      #dashCategoryManager #drawer-tx .month-sticky > td{
        padding:0 !important; border:0 !important; background:transparent !important;
      }
      /* Sticky container itself */
      #dashCategoryManager #drawer-tx .month-sticky .sticky-shell{
        position: sticky; top: 0; z-index: 5;
        background: var(--table-head-bg, #f8f9fa) !important;
        color: var(--table-head-fg, inherit) !important;
        border-top: 1px solid var(--hair, #e9ecef);
        border-bottom: 1px solid var(--hair, #e9ecef);
        box-shadow: 0 6px 12px rgba(0,0,0,.08);
        padding: .55rem .9rem .5rem;
      }

      /* Month banner line */
      #dashCategoryManager #drawer-tx .month-sticky .banner{
        display:flex; align-items:center; justify-content:space-between; gap:.75rem;
        margin-bottom:.35rem;
      }
      #dashCategoryManager #drawer-tx .month-sticky .title a{
        font-weight:700; text-decoration:none; color: var(--link, #0d6efd);
      }
      #dashCategoryManager #drawer-tx .month-sticky .net{
        font-variant-numeric: tabular-nums; font-weight:600;
      }
      #dashCategoryManager #drawer-tx .month-sticky .net.neg{ color:#c0392b; }
      #dashCategoryManager #drawer-tx .month-sticky .net.pos{ color:#1e7e34; }

      /* Column labels placed under the month banner; align to table columns */
      /* Use the same widths as the table using CSS variables for perfect alignment */
      #dashCategoryManager #drawer-tx{
        --col-date: 110px;
        --col-amount: 130px;
      }
      #dashCategoryManager #drawer-tx .col-head{
        display:grid;
        grid-template-columns: var(--col-date) 1fr var(--col-amount) 1fr; /* Date | Desc | Amount | Category */
        gap:.5rem;
        font-size:.85rem; opacity:.85;
      }
      #dashCategoryManager #drawer-tx .col-head .amount{ justify-self:end; }
    </style>

    <!-- Tabs -->
    <div class="drawer-tabs">
      <a href="#" class="drawer-tab active" data-tab="overview">Overview</a>
      <a href="#" class="drawer-tab" data-tab="keywords">Keywords</a>
      <a href="#" class="drawer-tab" data-tab="actions">Actions</a>
    </div>

    <!-- Pane: Overview -->
    <div class="drawer-pane" data-pane="overview" style="display:block;">
      <div class="mb-2"><strong>Children:</strong> <div id="drawer-children" class="mt-1"></div></div>

      <div class="table-responsive" style="max-height:58vh; overflow:auto;">
        <table class="table table-sm align-middle mb-0" id="drawer-tx">
          <!-- lock widths for the table so sticky grid labels align perfectly -->
          <colgroup>
            <col style="width:110px">
            <col>
            <col style="width:130px">
            <col>
          </colgroup>

          <thead>
            <tr>
              <th class="col-date">Date</th>
              <th class="col-desc">Description</th>
              <th class="col-amount">Amount</th>
              <th class="col-cat">Category</th>
            </tr>
          </thead>
          <tbody id="drawer-tx-body">
            <!-- drawer.js will render:
                 1) <tr class="month-sticky"><td colspan="4">[sticky-shell]</td></tr>
                 2) normal rows for that month
                 3) next month, repeat (its sticky takes over as you scroll)
            -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Pane: Keywords -->
    <div class="drawer-pane" data-pane="keywords" style="display:none;">
      <div class="small text-muted mb-1">
        Keywords attached to: <span id="kw-current-level" class="fw-semibold">(select a node)</span>.
        Click × to remove. Case-insensitive “contains” match.
      </div>
      <div id="kw-list" class="mb-2"><span class="text-muted">No keywords yet.</span></div>
      <div class="input-group input-group-sm">
        <input id="kw-add-input" class="form-control" placeholder="Add keyword (e.g. MOBILE DEPOSIT)">
        <button id="kw-add-btn" class="btn btn-outline-primary">Add</button>
      </div>
    </div>

    <!-- Pane: Actions -->
    <div class="drawer-pane" data-pane="actions" style="display:none;">
      <div class="d-grid gap-2">
        <button id="drawer-inspect" class="btn btn-sm btn-outline-secondary">Inspect Path JSON</button>
        <button id="drawer-rename"  class="btn btn-sm btn-outline-secondary">Rename Current Node</button>
        <button id="drawer-upsert"  class="btn btn-sm btn-outline-primary">Create/Attach Child Under This Path</button>
      </div>
      <div class="small text-muted mt-2">These call your admin endpoints: inspect, rename, upsert.</div>
    </div>
  </div>
</div>

<!-- Tell drawer.js to use the unified endpoint, then load it -->
<script>
  window.CL_URLS = window.CL_URLS || {};
  window.CL_URLS.PATH_TXN_URL = '/api/path/transactions';

  /* ------------------------------------------------------------------
     Helper you can paste into drawer.js to output the new month header.
     Replace the old <tr class="month-divider">…</tr> with this.
  -------------------------------------------------------------------*/
  window.renderMonthSticky = function(label, netDisplay, netValue){
    const netClass = (netValue||0) < 0 ? 'neg' : 'pos';
    return `
      <tr class="month-sticky">
        <td colspan="4">
          <div class="sticky-shell">
            <div class="banner">
              <div class="title"><a href="#">${label}</a></div>
              <div class="net ${netClass}">Net: ${netDisplay}</div>
            </div>
            <div class="col-head">
              <div>Date</div>
              <div>Description</div>
              <div class="amount">Amount</div>
              <div>Category</div>
            </div>
          </div>
        </td>
      </tr>`;
  };
</script>
<script src="{{ url_for('static', filename='js/drawer.js') }}"></script>

<!-- Right-side Category Manager drawer (modern look, NO sticky) -->
<div class="offcanvas offcanvas-end manage-drawer" tabindex="-1" id="dashCategoryManager" aria-labelledby="dashCategoryManagerLabel" style="width:480px;">
  <div class="offcanvas-header">
    <div class="d-flex flex-column gap-1">
      <h5 class="offcanvas-title" id="dashCategoryManagerLabel">
        <nav id="drawer-breadcrumb" class="drawer-breadcrumb"></nav>
        <span id="drawer-selected-path" hidden>(All Categories)</span>
      </h5>
      <div class="small muted d-flex align-items-center flex-wrap gap-2">
        <span>Month:</span>
        <!-- Native select (kept for data/wiring); visually replaced with Glass Select -->
        <select id="drawer-months" class="form-select form-select-sm d-inline-block w-auto align-middle"></select>
        <span class="mx-1">•</span>
        <span>Total:</span>
        <span id="drawer-total" class="fw-semibold">—</span>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body">
    <!-- ===== Drawer styles (scoped) ===== -->
    <style>
      /* ---------- Tokens ---------- */
      #dashCategoryManager{
        --cm-radius: 16px;
        --cm-inner-radius: 14px;
        --cm-hair: var(--hair, rgba(255,255,255,.08));
        --cm-ink: var(--table-head-fg, var(--text, #cfe3ff));
        --cm-link: #9ecbff;
        --cm-danger: #c0392b;
        --cm-success: #1e7e34;
        --cm-shadow: 0 10px 24px rgba(2,6,23,.35);
      }

      /* ---------- Header / breadcrumb ---------- */
      .drawer-breadcrumb{ display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; }
      .drawer-breadcrumb a{ text-decoration:none; color:var(--cm-link); font-weight:700; }
      .drawer-breadcrumb a:hover{ text-decoration:underline; }
      .drawer-breadcrumb .sep{ color:#8aa3c6; }
      .muted{ color: color-mix(in oklab, var(--cm-ink) 72%, transparent); }

      /* ---------- Tabs ---------- */
      .drawer-tabs{ display:flex; gap:.5rem; margin-bottom:.65rem; border-bottom:1px solid var(--cm-hair); }
      .drawer-tab{ padding:.4rem .7rem; border-radius:.55rem .55rem 0 0; text-decoration:none; color:var(--cm-ink); opacity:.85; }
      .drawer-tab.active{ background: color-mix(in oklab, var(--card-bg, rgba(255,255,255,.045)) 90%, transparent); border:1px solid var(--cm-hair); border-bottom-color:transparent; }

      /* ---------- Child pills (restored look) ---------- */
      .child-pill{
        display:inline-flex; align-items:center; gap:.4rem;
        padding:.32rem .6rem; border-radius:999px;
        border:1px solid var(--cm-hair);
        background: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 40%, transparent);
        color: var(--cm-ink); cursor:pointer; line-height:1; font-size:.875rem;
        transition: background .15s ease, border-color .15s ease, transform .05s ease;
        margin:.15rem .25rem 0 0;
      }
      .child-pill:hover{
        background: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 70%, transparent);
        border-color: color-mix(in oklab, var(--cm-ink) 30%, transparent);
      }
      .child-pill:active{ transform: translateY(1px); }
      .child-pill .dot{ width:6px; height:6px; border-radius:50%; background: currentColor; opacity:.65; display:inline-block; }
      .child-pill .chev{ font-weight:700; opacity:.7; line-height:1; transform: translateY(-1px); }

      /* ---------- Safety rails: horizontal text only ---------- */
      #dashCategoryManager #drawer-tx *{
        writing-mode: horizontal-tb !important;
        word-break: normal !important;
        overflow-wrap: normal !important;
        hyphens: manual !important;
      }

      /* ---------- Table visual (NO sticky rows) ---------- */
      #dashCategoryManager .tx-wrap{
        position: relative;
        border-radius: var(--cm-inner-radius);
        box-shadow: var(--cm-shadow);
        overflow:auto;
        max-height: 58vh;
        isolation:isolate;
        background: var(--card-bg, rgba(255,255,255,.045));
        border: 1px solid var(--card-border, rgba(255,255,255,.10));
      }
      #dashCategoryManager #drawer-tx{ width: 100%; border-collapse: separate; border-spacing:0; }
      #dashCategoryManager #drawer-tx thead th{
        background: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 90%, transparent) !important;
        color: var(--cm-ink) !important;
        border-bottom:1px solid var(--cm-hair);
        font-weight:700; letter-spacing:.2px;
        padding:.65rem .9rem;
      }
      #dashCategoryManager #drawer-tx thead th:first-child{ border-top-left-radius:12px; }
      #dashCategoryManager #drawer-tx thead th:last-child { border-top-right-radius:12px; }

      #dashCategoryManager #drawer-tx td{
        padding:.85rem .9rem;
        border-top:1px solid var(--cm-hair);
        color:var(--cm-ink);
        vertical-align:top;
        background: transparent !important;
      }
      #dashCategoryManager #drawer-tx .text-nowrap{ white-space:nowrap; }
      #dashCategoryManager #drawer-tx .tx-pos{ color: var(--cm-success); font-weight:600; }
      #dashCategoryManager #drawer-tx .tx-neg{ color: var(--cm-danger); font-weight:600; }

      /* Month rows (non-sticky) */
      #dashCategoryManager #drawer-tx tr.month-divider td{
        background: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 85%, transparent) !important;
        border-top:1px solid var(--cm-hair);
        border-bottom:1px solid var(--cm-hair);
        font-weight:700; letter-spacing:.2px;
      }

      /* Column widths (fit without horizontal scroll) */
      #dashCategoryManager #drawer-tx col.col-date   { width: 100px; }
      #dashCategoryManager #drawer-tx col.col-amount { width: 110px; }
      #dashCategoryManager #drawer-tx col.col-cat    { width: 120px; }
      #dashCategoryManager #drawer-tx td.amount{ text-align:right; font-variant-numeric: tabular-nums; }
      #dashCategoryManager #drawer-tx td.cat{ white-space:nowrap; }

      /* === GLASS SELECT (compact + body portal + blurred scrim) === */
      #dashCategoryManager .gs-wrap{ position:relative; width:auto; display:inline-block; }
      #dashCategoryManager .gs-native{
        position:absolute; inset:0; width:100%; height:100%;
        opacity:0; pointer-events:none;
      }
      #dashCategoryManager .gs-trigger{
        display:flex; align-items:center; gap:.5rem;
        padding:.25rem .55rem; border-radius:10px; cursor:pointer; user-select:none;
        background: color-mix(in oklab, var(--card-bg) 90%, transparent);
        color: var(--cm-ink); border:1px solid var(--cm-hair);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 4px 14px rgba(0,0,0,.25);
        font-size:.9rem; line-height:1.1;
      }
      #dashCategoryManager .gs-trigger:focus-visible{ outline:2px solid #80b3ff; outline-offset:2px; }
      #dashCategoryManager .gs-label{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:10ch; }
      #dashCategoryManager .gs-caret{ opacity:.8; }

      .gs-popup{
        position: fixed;
        min-width: 220px;
        max-height:320px; overflow:auto;
        z-index: 1090;
        padding:6px; border-radius:14px; border:1px solid var(--card-border, rgba(255,255,255,.10));
        background: color-mix(in oklab, var(--card-bg, rgba(255,255,255,.045)) 82%, transparent);
        -webkit-backdrop-filter: blur(18px) saturate(140%);
        backdrop-filter: blur(18px) saturate(140%);
        box-shadow: 0 18px 40px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.05);
      }
      .gs-list{ margin:0; padding:0; list-style:none; }
      .gs-option{
        padding:.5rem .65rem; border-radius:10px; display:flex; align-items:center; gap:.5rem; cursor:pointer;
        color: var(--text, #cfe3ff);
      }
      .gs-option:hover, .gs-option[aria-current="true"]{ background:rgba(255,255,255,.06) }
      .gs-option[aria-selected="true"]{
        background:rgba(129,196,255,.10); box-shadow:inset 0 0 0 1px rgba(129,196,255,.35)
      }
      .gs-divider{ height:1px; margin:6px 0; background:var(--hair); opacity:.8; border-radius:1px; }

      .gs-scrim{
        position:fixed; inset:0; z-index:1080;
        -webkit-backdrop-filter: blur(14px) saturate(140%);
        backdrop-filter: blur(14px) saturate(140%);
        background: rgba(8,12,20,.28);
      }

      @keyframes gsPopIn { from { opacity:0; transform: translateY(6px) scale(.98); } to { opacity:1; transform: translateY(0) scale(1); } }
      @keyframes gsFadeIn{ from { opacity:0; } to { opacity:1; } }
      .gs-popup{ animation: gsPopIn .14s ease-out; transform-origin: top left; will-change: transform, opacity; }
      .gs-scrim{ animation: gsFadeIn .12s ease-out; will-change: opacity; }

      /* Small cleanups */
      #dashCategoryManager ul, #dashCategoryManager li{ list-style:none; margin:0; padding:0; }
    </style>

    <!-- Tabs -->
    <div class="drawer-tabs">
      <a href="#" class="drawer-tab active" data-tab="overview">Overview</a>
      <a href="#" class="drawer-tab" data-tab="keywords">Keywords</a>
      <a href="#" class="drawer-tab" data-tab="actions">Actions</a>
    </div>

    <!-- Pane: Overview -->
    <div class="drawer-pane" data-pane="overview" style="display:block;">
      <div class="mb-2"><strong>Children:</strong> <div id="drawer-children" class="mt-1"></div></div>

      <div class="tx-wrap">
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0" id="drawer-tx" aria-label="Transactions by month">
            <colgroup>
              <col class="col-date">
              <col>
              <col class="col-amount">
              <col class="col-cat">
            </colgroup>
            <thead>
              <tr class="small text-muted">
                <th>Date</th>
                <th>Description</th>
                <th class="text-end">Amount</th>
                <th>Cat</th>
              </tr>
            </thead>
            <tbody id="drawer-tx-body">
              <!-- filled by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Pane: Keywords -->
    <div class="drawer-pane" data-pane="keywords" style="display:none;">
      <div class="small muted mb-1">
        Keywords attached to: <span id="kw-current-level" class="fw-semibold">(select a node)</span>.
        Click × to remove. Case-insensitive “contains” match.
      </div>
      <div id="kw-list" class="mb-2"><span class="muted">No keywords yet.</span></div>
      <div class="input-group input-group-sm">
        <input id="kw-add-input" class="form-control" placeholder="Add keyword (e.g., MOBILE DEPOSIT)">
        <button id="kw-add-btn" class="btn btn-outline-primary">Add</button>
      </div>
    </div>

    <!-- Pane: Actions -->
    <div class="drawer-pane" data-pane="actions" style="display:none;">
      <div class="d-grid gap-2">
        <button id="drawer-inspect" class="btn btn-sm btn-outline-secondary">Inspect Path JSON</button>
        <button id="drawer-rename"  class="btn btn-sm btn-outline-secondary">Rename Current Node</button>
        <button id="drawer-upsert"  class="btn btn-sm btn-outline-primary">Create/Attach Child Under This Path</button>
      </div>
      <div class="small muted mt-2">These call your admin endpoints: inspect, rename, upsert.</div>
    </div>
  </div>
</div>

<!-- Server endpoints (persistent) -->
<script>
  window.CL_URLS = window.CL_URLS || {};
  window.CL_URLS.PATH_TXN_URL = '/api/path/transactions';
  window.CL_URLS.INSPECT_URL  = '/admin/categories/inspect';
  window.CL_URLS.RENAME_URL   = '/admin/categories/rename';
  window.CL_URLS.UPSERT_URL   = '/admin/categories/upsert';
  /* Optional keyword endpoints:
  window.CL_URLS.KW_GET_URL    = '/admin/keywords/get';
  window.CL_URLS.KW_ADD_URL    = '/admin/keywords/add';
  window.CL_URLS.KW_REMOVE_URL = '/admin/keywords/remove';
  */
</script>

<!-- === Glass Select helper (wrap #drawer-months) — robust against async population & replacement === -->
<script>
(function(){
  function wrapSelect(select){
    if (!select || select.dataset.gsInit==='1') return;
    select.dataset.gsInit='1';

    // Wrapper
    const wrap = document.createElement('div'); wrap.className='gs-wrap';
    select.parentNode.insertBefore(wrap, select);
    wrap.appendChild(select);
    select.classList.add('gs-native');

    // Trigger
    const trigger = document.createElement('button');
    trigger.type='button';
    trigger.className='gs-trigger';
    trigger.setAttribute('aria-haspopup','listbox');
    trigger.setAttribute('aria-expanded','false');
    trigger.innerHTML = '<span class="gs-label"></span><span class="gs-caret">▾</span>';
    wrap.insertBefore(trigger, select);
    const labelEl = trigger.querySelector('.gs-label');

    // Body-level popup & scrim
    const popup = document.createElement('div'); popup.className='gs-popup'; popup.hidden=true;
    const list  = document.createElement('ul'); list.className='gs-list'; list.setAttribute('role','listbox'); popup.appendChild(list);
    const scrim = document.createElement('div'); scrim.className='gs-scrim'; scrim.hidden=true;

    function syncLabel(){
      const opt = select.selectedOptions[0];
      labelEl.textContent = opt ? opt.textContent : 'Select…';
    }

    function clamp(v, min, max){ return Math.max(min, Math.min(max, v)); }

    function placePopup(){
      const r = trigger.getBoundingClientRect();
      const vw = window.innerWidth, vh = window.innerHeight;
      const width = clamp(Math.max(220, r.width), 220, vw - 24);
      popup.style.minWidth = width + 'px';
      popup.style.maxWidth = width + 'px';

      const popupH = Math.min(320, vh * 0.6);
      popup.style.maxHeight = popupH + 'px';
      const below = r.bottom + 6 + popupH <= vh ? true : (r.top - 6 - popupH < 0 ? true : false);
      const top = below ? (r.bottom + 6) : (r.top - 6 - popupH);
      const left = clamp(r.left, 12, vw - width - 12);

      popup.style.left = Math.round(left) + 'px';
      popup.style.top  = Math.round(top)  + 'px';
    }

    function buildOptions(){
      list.innerHTML = '';
      const opts = Array.from(select.options);
      if (!opts.length){
        const li = document.createElement('li');
        li.className='gs-option'; li.setAttribute('aria-disabled','true');
        li.textContent='Loading…';
        list.appendChild(li);
        return;
      }
      opts.forEach((o)=>{
        const li = document.createElement('li');
        li.className='gs-option'; li.setAttribute('role','option'); li.dataset.value = o.value;
        if (o.selected) li.setAttribute('aria-selected','true');
        li.textContent = o.textContent;
        li.addEventListener('click', ()=> apply(o.value));
        li.addEventListener('mousemove', ()=>{
          list.querySelectorAll('.gs-option[aria-current="true"]').forEach(x=>x.removeAttribute('aria-current'));
          li.setAttribute('aria-current','true');
        });
        list.appendChild(li);
      });
    }

    function close(){
      if (popup.hidden) return;
      popup.hidden = true; scrim.hidden = true;
      trigger.setAttribute('aria-expanded','false');
      if (popup.parentNode !== wrap) wrap.appendChild(popup);
      if (scrim.parentNode) scrim.parentNode.removeChild(scrim);
      window.removeEventListener('resize', onWin);
      window.removeEventListener('scroll', onWin, true);
      clearInterval(waitTimer);
    }

    function open(){
      // Rebuild with whatever is there now
      buildOptions(); syncLabel();

      if (popup.parentNode === wrap) document.body.appendChild(popup);
      if (!scrim.parentNode) document.body.appendChild(scrim);
      scrim.hidden = false; popup.hidden = false;
      trigger.setAttribute('aria-expanded','true');
      placePopup();

      // If options are not ready yet, poll briefly and rebuild once they appear
      let waited = 0;
      waitTimer = setInterval(()=>{
        const has = select && select.options && select.options.length;
        if (has || waited > 2000){ // stop after 2s
          clearInterval(waitTimer);
          if (!popup.hidden){
            buildOptions(); placePopup();
          }
        }
        waited += 150;
      }, 150);

      window.addEventListener('resize', onWin);
      window.addEventListener('scroll', onWin, true);
    }

    function toggle(){ popup.hidden ? open() : close(); }
    function onWin(){ placePopup(); }

    function apply(value){
      select.value = value;
      select.dispatchEvent(new Event('change', { bubbles:true }));
      syncLabel(); close();
    }

    // Observe option changes — rebuild live if open
    const mo = new MutationObserver((muts)=>{
      const childChanged = muts.some(m=>m.type==='childList');
      if (childChanged && !popup.hidden){
        buildOptions(); placePopup();
      }
      syncLabel();
    });
    mo.observe(select, { childList:true, subtree:true, attributes:true, attributeFilter:['value','disabled','class'] });

    // Type-ahead on trigger
    let buf='', t=null, waitTimer=null;
    function typeAhead(k){
      buf += k.toLowerCase(); clearTimeout(t); t=setTimeout(()=>buf='',600);
      const f = Array.from(select.options).find(o=>!o.disabled && o.text.toLowerCase().startsWith(buf));
      if (f) apply(f.value);
    }
    trigger.addEventListener('keydown', (e)=>{
      if (e.key===' '||e.key==='Enter'||e.key==='ArrowDown'){ e.preventDefault(); open(); return; }
      if (/^[\w\s]$/.test(e.key)) typeAhead(e.key);
    });

    trigger.addEventListener('click', toggle);
    scrim.addEventListener('click', close);
    document.addEventListener('click', (e)=>{ if (!popup.hidden && !popup.contains(e.target) && !trigger.contains(e.target)) close(); });

    // Initial label
    syncLabel();
  }

  function initGlassSelect(){
    const sel = document.getElementById('drawer-months');
    if (sel) wrapSelect(sel);
  }

  // If the select node itself is replaced later, re-wrap the new one
  const oc = document.getElementById('dashCategoryManager');
  if (oc){
    const selectWatcher = new MutationObserver(()=>{
      const sel = document.getElementById('drawer-months');
      if (sel && sel.dataset.gsInit!=='1') wrapSelect(sel);
    });
    selectWatcher.observe(oc, { childList:true, subtree:true });
  }

  // Init on load & whenever the drawer is shown
  if (document.readyState !== 'loading') initGlassSelect();
  else document.addEventListener('DOMContentLoaded', initGlassSelect);
  oc?.addEventListener('shown.bs.offcanvas', initGlassSelect);
})();
</script>

<script src="{{ url_for('static', filename='js/drawer.js') }}"></script>

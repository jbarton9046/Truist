<!-- Right-side Category Manager drawer (modern frosted look + sticky month) -->
<div class="offcanvas offcanvas-end manage-drawer" tabindex="-1" id="dashCategoryManager" aria-labelledby="dashCategoryManagerLabel" style="width:480px;">
  <div class="offcanvas-header">
    <div class="d-flex flex-column gap-1">
      <h5 class="offcanvas-title" id="dashCategoryManagerLabel">
        <nav id="drawer-breadcrumb" class="drawer-breadcrumb"></nav>
        <span id="drawer-selected-path" hidden>(All Categories)</span>
      </h5>
      <div class="small muted">
        <span>Month:</span>
        <select id="drawer-months" class="form-select form-select-sm d-inline-block w-auto align-middle"></select>
        <span class="mx-2">•</span>
        <span>Total:</span>
        <span id="drawer-total" class="fw-semibold">—</span>
      </div>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body">
    <!-- ===== Drawer styles (scoped) ===== -->
    <style>
      /* ---------- Tokens ---------- */
      #dashCategoryManager{
        --cm-radius: 16px;
        --cm-inner-radius: 14px;
        --cm-blur: 8px;
        --cm-head-bg: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 85%, transparent);
        --cm-head-bg-2: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 70%, transparent);
        --cm-hair: var(--hair, rgba(255,255,255,.08));
        --cm-ink: var(--table-head-fg, var(--text, #cfe3ff));
        --cm-link: #9ecbff;
        --cm-danger: #c0392b;
        --cm-success: #1e7e34;
        --cm-shadow: 0 10px 24px rgba(2,6,23,.35);
      }

      /* ---------- Header + Chromium look ---------- */
      .drawer-breadcrumb{ display:flex; gap:.4rem; flex-wrap:wrap; align-items:center; }
      .drawer-breadcrumb a{ text-decoration:none; color:var(--cm-link); font-weight:700; }
      .drawer-breadcrumb a:hover{ text-decoration:underline; }
      .drawer-breadcrumb .sep{ color:#8aa3c6; }

      .muted{ color: color-mix(in oklab, var(--cm-ink) 72%, transparent); }

      /* ---------- Tabs (subtle) ---------- */
      .drawer-tabs{ display:flex; gap:.5rem; margin-bottom:.65rem; border-bottom:1px solid var(--cm-hair); }
      .drawer-tab{ padding:.4rem .7rem; border-radius:.55rem .55rem 0 0; text-decoration:none; color:var(--cm-ink); opacity:.85; }
      .drawer-tab.active{ background: var(--cm-head-bg); border:1px solid var(--cm-hair); border-bottom-color:var(--cm-head-bg); }

      /* ---------- Safety rails: force normal table flow inside the drawer ---------- */
      #dashCategoryManager #drawer-tx, 
      #dashCategoryManager #drawer-tx thead,
      #dashCategoryManager #drawer-tx tbody,
      #dashCategoryManager #drawer-tx tfoot{
        display: table !important; /* tbody/thead act as proper table groups */
        width: 100% !important;
        border-collapse: separate !important; border-spacing:0 !important;
        table-layout: fixed !important;
      }
      #dashCategoryManager #drawer-tx thead{ display:none !important; } /* labels live in sticky month */
      #dashCategoryManager #drawer-tx tr{ display: table-row !important; }
      #dashCategoryManager #drawer-tx th,
      #dashCategoryManager #drawer-tx td{
        display: table-cell !important;
        writing-mode: horizontal-tb !important;
        text-orientation: mixed !important;
        word-break: normal !important;
        overflow-wrap: anywhere !important; /* long single tokens can wrap */
        hyphens: manual !important;
      }

      /* ---------- Table column sizing ---------- */
      #dashCategoryManager #drawer-tx{
        --col-date: 100px;
        --col-amount: 110px;
      }

      /* ---------- Rows ---------- */
      #dashCategoryManager .tx-wrap{ 
        position: relative; 
        border-radius: var(--cm-inner-radius);
        box-shadow: var(--cm-shadow);
        overflow:auto;
        max-height: 58vh;
        isolation:isolate; /* backdrop behaves properly */
      }
      /* subtle top/bottom fades inside scroller */
      #dashCategoryManager .tx-wrap::before,
      #dashCategoryManager .tx-wrap::after{
        content:""; position:absolute; left:0; right:0; height:18px; z-index:6; pointer-events:none;
        background: linear-gradient(to bottom, rgba(0,0,0,.25), transparent);
      }
      #dashCategoryManager .tx-wrap::after{
        top:auto; bottom:0; transform: rotate(180deg);
      }

      #dashCategoryManager #drawer-tx td{
        padding:.85rem .9rem;
        border-bottom:1px solid var(--cm-hair);
        color: var(--cm-ink);
        vertical-align: top;
        background: transparent !important;
      }
      #dashCategoryManager #drawer-tx tr:last-child td{ border-bottom:0; }
      #dashCategoryManager #drawer-tx .text-nowrap{ white-space:nowrap; }
      #dashCategoryManager #drawer-tx .tx-pos{ color: var(--cm-success); font-weight:600; }
      #dashCategoryManager #drawer-tx .tx-neg{ color: var(--cm-danger); font-weight:600; }

      /* ---------- Sticky month block (banner + column labels) ---------- */
      #dashCategoryManager #drawer-tx .month-sticky > td{
        padding:0 !important; border:0 !important; background:transparent !important;
      }
      #dashCategoryManager #drawer-tx .month-sticky .sticky-shell{
        position: sticky; top: 0; z-index: 5;
        padding:.6rem .9rem .55rem;
        border-top:1px solid var(--cm-hair);
        border-bottom:1px solid var(--cm-hair);
        backdrop-filter: saturate(140%) blur(var(--cm-blur));
        -webkit-backdrop-filter: saturate(140%) blur(var(--cm-blur));
        background:
          linear-gradient(180deg, var(--cm-head-bg) 0%, var(--cm-head-bg-2) 100%);
        box-shadow: inset 0 1px 0 rgba(255,255,255,.06), 0 10px 18px rgba(2,6,23,.25);
      }
      #dashCategoryManager #drawer-tx .month-sticky .banner{
        display:flex; align-items:center; justify-content:space-between; gap:.75rem; margin-bottom:.4rem;
        color: var(--cm-ink);
      }
      #dashCategoryManager #drawer-tx .month-sticky .title a{
        color: var(--cm-link); font-weight:800; text-decoration:none; letter-spacing:.2px;
      }
      #dashCategoryManager #drawer-tx .month-sticky .title a:hover{ text-decoration:underline; }
      #dashCategoryManager #drawer-tx .month-sticky .net{ font-variant-numeric: tabular-nums; font-weight:700; }
      #dashCategoryManager #drawer-tx .month-sticky .net.neg{ color: var(--cm-danger); }
      #dashCategoryManager #drawer-tx .month-sticky .net.pos{ color: var(--cm-success); }

      #dashCategoryManager #drawer-tx .col-head{
        display:grid;
        grid-template-columns: var(--col-date) 1fr var(--col-amount) 1fr; /* Date | Desc | Amount | Category */
        gap:.5rem; font-size:.85rem; opacity:.85; color: var(--cm-ink);
      }
      #dashCategoryManager #drawer-tx .col-head .amount{ justify-self:end; }

      /* ---------- Column helper widths (for row cells) ---------- */
      #dashCategoryManager #drawer-tx .col-date{ width: var(--col-date); white-space:nowrap; }
      #dashCategoryManager #drawer-tx .col-amount{ width: var(--col-amount); white-space:nowrap; text-align:right; }

      /* ---------- Chips for children ---------- */
      .child-pill{
        display:inline-flex; align-items:center; gap:.4rem;
        padding:.32rem .6rem; border-radius:999px; 
        border:1px solid var(--cm-hair);
        background: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 40%, transparent);
        color: var(--cm-ink);
        cursor:pointer; line-height:1; font-size:.875rem;
        transition: background .15s ease, border-color .15s ease, transform .05s ease;
      }
      .child-pill:hover{
        background: color-mix(in oklab, var(--thead-bg, rgba(255,255,255,.06)) 70%, transparent);
        border-color: color-mix(in oklab, var(--cm-ink) 30%, transparent);
      }
      .child-pill:active{ transform: translateY(1px); }
      .child-pill .dot{ width:6px; height:6px; border-radius:50%; background: currentColor; opacity:.65; display:inline-block; }
      .child-pill .chev{ font-weight:700; opacity:.7; line-height:1; transform: translateY(-1px); }

      /* ---------- Small clean-ups ---------- */
      #dashCategoryManager ul, #dashCategoryManager li{ list-style:none; margin:0; padding:0; }
    </style>

    <!-- Tabs -->
    <div class="drawer-tabs">
      <a href="#" class="drawer-tab active" data-tab="overview">Overview</a>
      <a href="#" class="drawer-tab" data-tab="keywords">Keywords</a>
      <a href="#" class="drawer-tab" data-tab="actions">Actions</a>
    </div>

    <!-- Pane: Overview -->
    <div class="drawer-pane" data-pane="overview" style="display:block;">
      <div class="mb-2"><strong>Children:</strong> <div id="drawer-children" class="mt-1"></div></div>

      <div class="tx-wrap">
        <table class="table table-sm align-middle mb-0" id="drawer-tx" aria-label="Transactions by month">
          <colgroup>
            <col style="width:var(--col-date)">
            <col>
            <col style="width:var(--col-amount)">
            <col>
          </colgroup>
          <tbody id="drawer-tx-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Pane: Keywords -->
    <div class="drawer-pane" data-pane="keywords" style="display:none;">
      <div class="small muted mb-1">
        Keywords attached to: <span id="kw-current-level" class="fw-semibold">(select a node)</span>.
        Click × to remove. Case-insensitive “contains” match.
      </div>
      <div id="kw-list" class="mb-2"><span class="muted">No keywords yet.</span></div>
      <div class="input-group input-group-sm">
        <input id="kw-add-input" class="form-control" placeholder="Add keyword (e.g. MOBILE DEPOSIT)">
        <button id="kw-add-btn" class="btn btn-outline-primary">Add</button>
      </div>
    </div>

    <!-- Pane: Actions -->
    <div class="drawer-pane" data-pane="actions" style="display:none;">
      <div class="d-grid gap-2">
        <button id="drawer-inspect" class="btn btn-sm btn-outline-secondary">Inspect Path JSON</button>
        <button id="drawer-rename"  class="btn btn-sm btn-outline-secondary">Rename Current Node</button>
        <button id="drawer-upsert"  class="btn btn-sm btn-outline-primary">Create/Attach Child Under This Path</button>
      </div>
      <div class="small muted mt-2">These call your admin endpoints: inspect, rename, upsert.</div>
    </div>
  </div>
</div>

<!-- Server endpoints (persistent) -->
<script>
  window.CL_URLS = window.CL_URLS || {};
  window.CL_URLS.PATH_TXN_URL = '/api/path/transactions';
  window.CL_URLS.INSPECT_URL  = '/admin/categories/inspect';
  window.CL_URLS.RENAME_URL   = '/admin/categories/rename';
  window.CL_URLS.UPSERT_URL   = '/admin/categories/upsert';
  /* Optional keyword endpoints:
  window.CL_URLS.KW_GET_URL    = '/admin/keywords/get';
  window.CL_URLS.KW_ADD_URL    = '/admin/keywords/add';
  window.CL_URLS.KW_REMOVE_URL = '/admin/keywords/remove';
  */
</script>
<script src="{{ url_for('static', filename='js/drawer.js') }}"></script>

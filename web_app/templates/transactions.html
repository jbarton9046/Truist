{% extends "layout.html" %}
{% block title %}Transactions{% endblock %}
{% block content %}

<style>
  /* --- Bring over the same page tokens & background used on Goals --- */
  :root{
    --page-bg-1:#0b1220;
    --page-bg-2:#0f172a;
    --glow-1:#243b55;
    --glow-2:#1b3a6b;

    --text:#e6edf6;      /* main page/typography color */
    --muted:#9fb3c8;

    --card-bg:rgba(255,255,255,.045);
    --card-border:rgba(255,255,255,.10);
    --hair:rgba(255,255,255,.08);

    --thead-bg:rgba(255,255,255,.06);
    --table-head-fg:var(--text);

    --sticky-top: 0px;
  }

  html, body{
    background:
      radial-gradient(1200px 700px at -10% -10%, var(--glow-1) 0%, transparent 45%),
      radial-gradient(900px 600px at 110% 0%, var(--glow-2) 0%, transparent 40%),
      linear-gradient(180deg, var(--page-bg-2) 0%, var(--page-bg-1) 100%);
    color:var(--text);
  }
  .muted{color:var(--muted)!important}
  .mono{font-variant-numeric:tabular-nums}

  /* --- Make navbar text match the page ink (scoped to this route) --- */
  body[data-route="/transactions"] .navbar .navbar-brand,
  body[data-route="/transactions"] .navbar .nav-link,
  body[data-route="/transactions"] .navbar .dropdown-item {
    color: var(--text) !important;
  }
  body[data-route="/transactions"] .navbar .nav-link:hover { color:#ffffff !important; opacity:.95; }

  /* Card look that matches Goals */
  .stat-card{
    background:var(--card-bg)!important;border:1px solid var(--card-border)!important;
    border-radius:16px;box-shadow:0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
    backdrop-filter:saturate(120%) blur(4px); color:var(--text);
  }

  /* Shell */
  .tx-wrap { max-width: 1200px; margin: 1rem auto; }
  .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:end; margin-bottom:.75rem; }
  .chip{padding:.15rem .5rem;border-radius:999px;border:1px solid var(--hair);font-size:.85rem;background:rgba(255,255,255,.06);color:var(--text)}

  /* Floating table container (same as Goals) */
  .table-wrap{border:1px solid var(--card-border);border-radius:14px;background:var(--card-bg);
    box-shadow:0 8px 24px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.04);overflow:auto}

  /* Floating table */
  .table-floating{width:100%;border-collapse:separate;border-spacing:0;background:transparent;color:var(--text)}
  .table-floating thead th{
    position:sticky; top:0; z-index:3;
    background:var(--thead-bg)!important;color:var(--table-head-fg)!important;
    border-bottom:1px solid var(--hair)!important;font-weight:700;letter-spacing:.2px;text-align:left!important
  }
  .table-floating tbody td{border-top:1px solid var(--hair);text-align:left!important;vertical-align:middle}
  .table-floating tbody tr:nth-child(odd){background:rgba(255,255,255,.015)}
  .table-floating tbody tr:hover{background:rgba(255,255,255,.05)}

  /* Optional gradient header to mirror Goals table */
  .thead-gradient th{
    background:linear-gradient(90deg,#60a5fa,#7c3aed)!important;
    color:#f8fbff!important; text-shadow:0 1px 0 rgba(0,0,0,.35);
    border-color:transparent!important;
  }

  /* Month separator rows (sticky under thead) */
  .month-row{position:sticky; z-index:2; top:var(--tx-head-h, 40px);
    background:var(--thead-bg)!important; color:var(--table-head-fg)!important}
  .month-row td{font-weight:700;border-bottom:1px solid var(--hair)!important}

  /* Keep your green/red amounts exactly as-is */
  .amt-neg{ color:#ef4444; font-weight:600; }
  .amt-pos{ color:#22c55e; font-weight:600; }

  /* Tighter amount column */
  .col-amount{ padding-right:1.25rem !important; }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="m-0">All Transactions</h3>
    <span class="chip">Rows: <span id="txCount" class="mono">—</span></span>
  </div>

  <div class="toolbar">
    <div>
      <label class="form-label small mb-1">Search</label>
      <input id="q" class="form-control form-control-sm" placeholder="desc/category terms (space = AND)">
    </div>
    <div>
      <label class="form-label small mb-1">Type</label>
      <select id="type" class="form-select form-select-sm">
        <option value="all">All</option>
        <option value="income">Income only</option>
        <option value="expense">Expenses only</option>
        <option value="transfer">Transfers only</option>
      </select>
    </div>
    <div>
      <label class="form-label small mb-1">From</label>
      <input id="date_from" type="date" class="form-control form-control-sm">
    </div>
    <div>
      <label class="form-label small mb-1">To</label>
      <input id="date_to" type="date" class="form-control form-control-sm">
    </div>
    <div>
      <label class="form-label small mb-1">Months</label>
      <select id="months" class="form-select form-select-sm">
        <option value="12">Last 12</option>
        <option value="24" selected>Last 24</option>
        <option value="all">All</option>
      </select>
    </div>
    <div>
      <label class="form-label small mb-1">&nbsp;</label>
      <button id="run" class="btn btn-sm btn-primary w-100">Search</button>
    </div>
  </div>

  <div class="small muted mb-2" id="meta">—</div>

  <div class="table-wrap">
    <div class="table-responsive" style="max-height:70vh; overflow:auto;">
      <!-- add the gradient class to mirror Goals' header strip -->
      <table class="table table-sm table-floating align-middle mb-0" id="tbl">
        <thead class="thead-gradient">
          <tr>
            <th style="width:110px;">Date</th>
            <th>Description</th>
            <th class="text-end col-amount" style="width:140px;">Amount</th>
            <th style="width:240px;">Category</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';

  const $  = id => document.getElementById(id);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  const fmtUSD = n => new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(Number(n)||0);
  const fmtDate = s => s || '';

  // Navbar/table sticky offset (in case layout has a fixed header)
  function setStickyTopOffset(){
    const fixedNav = document.querySelector('.navbar.fixed-top, .navbar-sticky, .app-header.fixed-top');
    const h = fixedNav ? Math.ceil(fixedNav.getBoundingClientRect().height) : 0;
    document.documentElement.style.setProperty('--sticky-top', (h|0) + 'px');
  }
  setStickyTopOffset();
  window.addEventListener('resize', setStickyTopOffset);

  // Ensure month row sits just under the sticky thead
  function setHeadHeightVar(){
    const th = document.querySelector('#tbl thead');
    const h = th ? Math.ceil(th.getBoundingClientRect().height) : 40;
    document.documentElement.style.setProperty('--tx-head-h', h + 'px');
  }
  new ResizeObserver(setHeadHeightVar).observe(document.body);

  function monthKey(s){
    if (!s) return '0000-00';
    const t = String(s);
    if (t.includes('-')) return t.slice(0,7);               // YYYY-MM-DD -> YYYY-MM
    const p = t.split('/');                                  // MM/DD/YYYY
    if (p.length === 3) return `${p[2]}-${String(p[0]).padStart(2,'0')}`;
    return '0000-00';
  }
  function monthLabel(k){
    const [y,m] = k.split('-');
    const d = new Date(Number(y)||0, (Number(m)||1)-1, 1);
    return isFinite(d) ? d.toLocaleString(undefined,{month:'short',year:'numeric'}) : k;
  }

  // Robust numeric parser incl. $(1,234.56) -> -1234.56
  function toNumber(x){
    if (typeof x === 'number') return isFinite(x) ? x : 0;
    if (x == null) return 0;
    let s = String(x).trim();
    let negParens = false;
    if (/^\(.*\)$/.test(s)) { negParens = true; s = s.slice(1, -1); }
    const n = parseFloat(s.replace(/[^0-9.-]/g,''));
    if (!Number.isFinite(n)) return 0;
    return negParens ? -n : n;
  }

  const esc = (s='') => String(s)
    .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

  async function load(){
    const params = new URLSearchParams();
    const q = $('q').value.trim();
    const type = $('type').value;
    const df = $('date_from').value;
    const dt = $('date_to').value;
    const months = $('months').value;

    if (q) params.set('q', q);
    if (type && type !== 'all') params.set('type', type);
    if (df) params.set('date_from', df);
    if (dt) params.set('date_to', dt);
    if (months) params.set('months', months);
    params.set('limit','4000');

    const tbody = $('tbody');
    tbody.innerHTML = `<tr><td colspan="4" class="muted">Loading…</td></tr>`;

    let data;
    try{
      const r = await fetch('/api/tx/all?' + params.toString(), {headers:{'Accept':'application/json'}});
      data = await r.json();
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Failed to load: ${esc(e.message||e)}</td></tr>`;
      $('meta').textContent = '—';
      $('txCount').textContent = '0';
      return;
    }

    const rows = (data && data.transactions) || [];
    $('meta').textContent = `${rows.length.toLocaleString()} transactions`;
    $('txCount').textContent = rows.length.toLocaleString();

    // group by month, compute net, sort months desc then rows desc by date
    const groups = new Map();
    for (const t of rows){
      const k = t.month || monthKey(t.date);
      if (!groups.has(k)) groups.set(k, {label:monthLabel(k), items:[], net:0});
      const g = groups.get(k);
      g.items.push(t);
      g.net += toNumber(t.amount);
    }
    const keys = Array.from(groups.keys()).sort().reverse();

    const out = [];
    for (const k of keys){
      const g = groups.get(k);
      const net = toNumber(g.net);
      const netCls = net < 0 ? 'amt-neg' : (net > 0 ? 'amt-pos' : '');
      out.push(`<tr class="month-row"><td colspan="4">${esc(g.label)} — <span class="${netCls}">Net: ${fmtUSD(net)}</span></td></tr>`);

      // sort within month (newest first)
      g.items.sort((a,b)=> String(b.date).localeCompare(String(a.date)));

      for (const t of g.items){
        const amt = toNumber(t.amount);
        const cls = amt < 0 ? 'amt-neg' : (amt > 0 ? 'amt-pos' : '');
        const cat = (t.category||'') + (t.subcategory ? (' / ' + t.subcategory) : '');
        out.push(`
          <tr>
            <td class="text-nowrap mono">${esc(fmtDate(t.date))}</td>
            <td>${esc(t.description||'')}</td>
            <td class="text-end col-amount mono"><span class="${cls}">${fmtUSD(amt)}</span></td>
            <td>${esc(cat)}</td>
          </tr>
        `);
      }
    }

    tbody.innerHTML = out.join('') || `<tr><td colspan="4" class="muted">No transactions.</td></tr>`;
    setHeadHeightVar(); // ensure sticky offset is correct after render
  }

  // events
  $('run').addEventListener('click', load);
  $('q').addEventListener('keydown', e=>{ if (e.key === 'Enter') load(); });
  $('type').addEventListener('change', load);
  $('months').addEventListener('change', load);
  $('date_from').addEventListener('change', load);
  $('date_to').addEventListener('change', load);

  // initial
  load();
})();
</script>

{% endblock %}

{% extends "layout.html" %}
{% block content %}
<style>
  /* Page shell */
  .tx-wrap { max-width: 1200px; margin: 1rem auto; }
  .toolbar { display:flex; gap:.5rem; flex-wrap:wrap; align-items:end; margin-bottom:.75rem; }

  /* Table container becomes the sticky viewport */
  #txScroller {
    max-height: 70vh;
    overflow: auto;
    position: relative;
    border:1px solid var(--card-border);
    border-radius:14px;
    background:var(--card-bg);
    box-shadow:0 8px 24px rgba(0,0,0,.30), inset 0 1px 0 rgba(255,255,255,.04);
    scrollbar-gutter: stable both-edges;
    /* will hold --thead-h set by JS (fallback 44px) */
    --thead-h: 44px;
  }

  /* Unified table look (dark “goals” theme) */
  .table-modern { width:100%; border-collapse:separate; border-spacing:0; background:transparent; color:var(--text); }
  .table-modern thead th{
    position: sticky; top: 0; z-index: 5;
    background: var(--thead-bg) !important;
    color: var(--table-head-fg,var(--text)) !important;
    border-bottom:1px solid var(--hair) !important;
    font-weight:700; letter-spacing:.2px;
    backdrop-filter: saturate(120%) blur(6px);
  }
  .table-modern tbody td{ border-top:1px solid var(--hair); vertical-align:middle; }
  .table-modern tbody tr:nth-child(odd){ background:rgba(255,255,255,.015); }
  .table-modern tbody tr:hover{ background:rgba(255,255,255,.05); }

  /* Amount coloring (keep your red/green) */
  .amt-neg{ color:#dc2626; font-weight:600; }
  .amt-pos{ color:#16a34a; font-weight:600; }
  .col-amount { padding-right: 1.25rem !important; }

  /* Sticky month separator row: sits just under the header, floats + blurs */
  #tbl tbody tr.month-row{
    position: sticky;
    top: var(--thead-h);               /* lives directly under the header */
    z-index: 3;                        /* under the header (z=5) but above rows */
  }
  #tbl tbody tr.month-row td{
    background: var(--thead-bg) !important;
    color: var(--text) !important;
    border-top: 1px solid var(--hair) !important;
    border-bottom: 1px solid var(--hair) !important;
    font-weight: 700; letter-spacing:.2px;
    backdrop-filter: saturate(120%) blur(6px);
  }
  /* When the controller marks a month as the active stuck one, pop it up */
  #tbl tbody tr.month-row.is-stuck { z-index: 6; }
  #tbl tbody tr.month-row.is-stuck td{
    box-shadow: 0 2px 0 rgba(255,255,255,.04), 0 10px 24px rgba(0,0,0,.28);
  }
</style>

<div class="tx-wrap">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h3 class="m-0">All Transactions</h3>
    <span class="badge rounded-pill bg-primary-subtle text-light-emphasis" id="rowsBadge" style="border:1px solid var(--card-border); background:rgba(255,255,255,.06) !important;">Rows: 0</span>
  </div>

  <div class="toolbar">
    <div>
      <label class="form-label small mb-1">Search</label>
      <input id="q" class="form-control form-control-sm" placeholder="desc/category terms (space = AND)">
    </div>
    <div>
      <label class="form-label small mb-1">Type</label>
      <select id="type" class="form-select form-select-sm bt-selectify">
        <option value="all">All</option>
        <option value="income">Income only</option>
        <option value="expense">Expenses only</option>
      </select>
    </div>
    <div>
      <label class="form-label small mb-1">From</label>
      <input id="date_from" type="date" class="form-control form-control-sm">
    </div>
    <div>
      <label class="form-label small mb-1">To</label>
      <input id="date_to" type="date" class="form-control form-control-sm">
    </div>
    <div>
      <label class="form-label small mb-1">Months</label>
      <select id="months" class="form-select form-select-sm bt-selectify">
        <option value="12">Last 12</option>
        <option value="24" selected>Last 24</option>
        <option value="all">All</option>
      </select>
    </div>
    <div>
      <label class="form-label small mb-1">&nbsp;</label>
      <button id="run" class="btn btn-sm btn-primary w-100">Search</button>
    </div>
  </div>

  <div class="small muted mb-2" id="meta">—</div>

  <div class="table-responsive" id="txScroller">
    <table class="table table-sm table-modern align-middle mb-0" id="tbl">
      <thead>
        <tr>
          <th style="width:110px;">Date</th>
          <th>Description</th>
          <th class="text-end col-amount" style="width:140px;">Amount</th>
          <th style="width:220px;">Category</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script>
(function(){
  const $ = (id)=> document.getElementById(id);
  const fmtUSD = (n)=> new Intl.NumberFormat(undefined,{style:'currency',currency:'USD'}).format(n||0);
  const fmtDate= (s)=> s || '';

  function monthKey(s){
    if (!s) return '0000-00';
    const t = String(s);
    if (t.includes('-')) return t.slice(0,7);
    const parts = t.split('/');
    if (parts.length === 3) return `${parts[2]}-${String(parts[0]).padStart(2,'0')}`;
    return '0000-00';
  }
  function monthLabel(k){
    const [y,m] = k.split('-');
    const d = new Date(Number(y), Number(m)-1, 1);
    return d.toLocaleString(undefined, {month:'short', year:'numeric'});
  }
  function toNumber(x){
    if (typeof x === 'number') return x;
    if (x == null) return 0;
    let s = String(x).trim(); let negParens=false;
    if (/^\(.*\)$/.test(s)){ negParens=true; s=s.slice(1,-1); }
    const n = parseFloat(s.replace(/[^0-9.-]/g,'')); if (!Number.isFinite(n)) return 0;
    return negParens ? -n : n;
  }

  const scroller = $('txScroller');
  const tbl = $('tbl');
  const tbody = $('tbody');

  /* Measure header height and pass to CSS so the month-row knows where to stick */
  function measureHead(){
    const th = (tbl.tHead && tbl.tHead.getBoundingClientRect().height) || 44;
    scroller.style.setProperty('--thead-h', Math.round(th) + 'px');
  }
  new ResizeObserver(measureHead).observe(tbl.tHead || tbl);

  /* Controller: ensure only one month row gets elevated “stuck” styling */
  function updateStickyMonth(){
    const rows = Array.from(tbody.querySelectorAll('tr.month-row'));
    if (!rows.length) return;
    const top = scroller.scrollTop;
    const theadH = parseFloat(getComputedStyle(scroller).getPropertyValue('--thead-h')) || 44;

    // pick the last month row whose top is above the sticky line
    let active = -1;
    for (let i=0;i<rows.length;i++){
      const r = rows[i];
      const y = r.offsetTop;           // offsetTop relative to scroller
      if (y <= top + 1) active = i;    // +1 to avoid flicker at boundary
    }
    rows.forEach((r,i)=> r.classList.toggle('is-stuck', i === active));
  }
  scroller.addEventListener('scroll', updateStickyMonth);

  async function load(){
    const params = new URLSearchParams();
    const q = $('q').value.trim();
    const type = $('type').value;
    const df = $('date_from').value;
    const dt = $('date_to').value;
    const months = $('months').value;
    if (q) params.set('q', q);
    if (type && type !== 'all') params.set('type', type);
    if (df) params.set('date_from', df);
    if (dt) params.set('date_to', dt);
    if (months) params.set('months', months);
    params.set('limit', '4000');

    const r = await fetch('/api/tx/all?' + params.toString(), {headers:{'Accept':'application/json'}});
    const j = await r.json();

    const rows = (j && j.transactions) || [];
    $('meta').textContent = `${rows.length} transactions`;
    $('rowsBadge').textContent = `Rows: ${rows.length}`;

    // group by month and compute monthly net
    const groups = new Map();
    for (const t of rows){
      const k = t.month || monthKey(t.date);
      if (!groups.has(k)) groups.set(k, {label:monthLabel(k), items:[], net:0});
      const g = groups.get(k);
      g.items.push(t);
      g.net += toNumber(t.amount);
    }
    const keys = Array.from(groups.keys()).sort().reverse();

    const out = [];
    for (const k of keys){
      const g = groups.get(k);
      const net = toNumber(g.net);
      const netCls = net < 0 ? 'amt-neg' : (net > 0 ? 'amt-pos' : '');
      out.push(
        `<tr class="month-row"><td colspan="4">${g.label} — <span class="${netCls}">Net: ${fmtUSD(net)}</span></td></tr>`
      );
      for (const t of g.items){
        const amt = toNumber(t.amount);
        const cls = amt < 0 ? 'amt-neg' : (amt > 0 ? 'amt-pos' : '');
        const safeDesc = String(t.description||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        const cat = (t.category||'') + (t.subcategory?(' / '+t.subcategory):'');
        out.push(`
          <tr>
            <td class="text-nowrap">${fmtDate(t.date)}</td>
            <td>${safeDesc}</td>
            <td class="text-end col-amount"><span class="${cls}">${fmtUSD(amt)}</span></td>
            <td>${cat}</td>
          </tr>
        `);
      }
    }
    tbody.innerHTML = out.join('') || `<tr><td colspan="4" class="muted">No transactions.</td></tr>`;

    measureHead();
    updateStickyMonth();               // set the first active month
  }

  $('run').addEventListener('click', load);
  $('q').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') load(); });
  $('type').addEventListener('change', load);
  $('months').addEventListener('change', load);
  $('date_from').addEventListener('change', load);
  $('date_to').addEventListener('change', load);

  // initial load
  load().catch(err=>{
    tbody.innerHTML = `<tr><td colspan="4" class="text-danger">Failed to load: ${err.message}</td></tr>`;
  });
})();
</script>
{% endblock %}

{% extends "layout.html" %}
{% block title %}Recurring{% endblock %}

{% block content %}

<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Recurring Dashboard</h2>
    <div class="d-flex gap-2">
      <input id="search" class="form-control form-control-sm" placeholder="Search (category/freq)..." style="width: 240px;">
      <button id="mergeBtn" class="btn btn-sm btn-outline-danger" disabled>Merge selected</button>
      <button id="manageRulesBtn" class="btn btn-sm btn-outline-primary">Manage rules</button>
      <select id="win" class="form-select form-select-sm" style="width: 140px;">
        <option value="90">Last 90 days</option>
        <option value="180">Last 180 days</option>
        <option value="365" selected>Last 365 days</option>
        <option value="all">All time</option>
      </select>
      <select id="horizon" class="form-select form-select-sm bt-selectify" style="width: 140px;">
        <option value="30" selected>Next 30 days</option>
        <option value="60">Next 60 days</option>
        <option value="90">Next 90 days</option>
        <option value="180">Next 180 days</option>
      </select>
    </div>
  </div>

  <!-- KPI STRIP -->
  <div class="kpi-grid mb-3" id="kpiBar">
    <div class="kpi-tile accent-red" id="tile-floor">
      <div class="kpi-top">
        <div class="kpi-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 3l7 3v6c0 5-3.5 9-7 9s-7-4-7-9V6l7-3z" stroke="currentColor" stroke-width="1.6" fill="none"/>
          </svg>
        </div>
        <div class="kpi-label">Floor</div>
      </div>
      <div class="kpi-value" id="kpi-floor">—</div>
      <div class="kpi-sub"><span id="kpi-floor-sub">— of income</span></div>
      <div class="kpi-meter" role="progressbar" aria-label="Floor vs Income">
        <div id="kpi-floor-meter" class="fill"></div>
      </div>
    </div>

    <div class="kpi-tile accent-green" id="tile-income">
      <div class="kpi-top">
        <div class="kpi-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.6" fill="none"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6" fill="none"/>
          </svg>
        </div>
        <div class="kpi-label">Expected income</div>
      </div>
      <div class="kpi-value" id="kpi-income">—</div>
      <div class="kpi-sub">from detected streams</div>
    </div>

    <div class="kpi-tile accent-blue" id="tile-leftover">
      <div class="kpi-top">
        <div class="kpi-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="7" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.6" fill="none"/>
            <path d="M21 11h-5a2 2 0 100 4h5v-4z" stroke="currentColor" stroke-width="1.6" fill="none"/>
          </svg>
        </div>
        <div class="kpi-label">Leftover</div>
      </div>
      <div class="kpi-value" id="kpi-leftover">—</div>
      <div class="kpi-sub" id="kpi-leftover-sub">after floor</div>
    </div>

    <div class="kpi-tile accent-amber" id="tile-week">
      <div class="kpi-top">
        <div class="kpi-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.6"/>
            <path d="M8 3v4M16 3v4M3 10h18" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <div class="kpi-label">Due this week</div>
      </div>
      <div class="kpi-value" id="kpi-week">—</div>
      <div class="kpi-sub"></div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-7">

      <!-- Recurring Charges -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Recurring Charges</span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 table-floating" id="streamsTable">
            <colgroup>
              <col style="width:32px">
              <col style="width:30%">
              <col style="width:16%">
              <col style="width:18%">
              <col style="width:23%">
              <col style="width:1%">
            </colgroup>
            <thead>
              <tr>
                <th></th>
                <th class="sortable" data-sort="category">Category <span class="sort"></span></th>
                <th class="text-start sortable" data-sort="amount">Amount <span class="sort"></span></th>
                <th class="sortable" data-sort="freq">Freq <span class="sort"></span></th>
                <th class="sortable" data-sort="next">Next <span class="sort"></span></th>
                <th>Trend (6 mo)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted py-3 text-center">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">

      <!-- Scatter Plot (replaces "Projected Month" position) -->
      <div class="card mt-3" id="scatterCard">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Monthly recurring charges (scatter)</span>
          <small class="muted" id="scatterNote"></small>
        </div>
        <div class="card-body">
          <div id="scatterWrap" class="scatter-wrap"></div>
        </div>
      </div>

      <!-- Projected Month (moved down under scatter) -->
      <div class="card mt-3" id="projectedCard">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Projected month</span>
          <small class="muted" id="pmNote"></small>
        </div>
        <div class="card-body small">
          <div class="d-flex justify-content-between mb-1">
            <span>Recurring income</span>
            <span id="pmRecurring">$0.00</span>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <span>Variable income (monthly)</span>
            <span id="pmVariable">$0.00</span>
          </div>
          <hr class="my-2">
          <div class="d-flex justify-content-between mb-1">
            <span class="fw-semibold">Expected income</span>
            <span id="pmExpected" class="fw-semibold">$0.00</span>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <span>Fixed floor (bills)</span>
            <span id="pmFloor">$0.00</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="fw-semibold">Projected leftover</span>
            <span id="pmLeftover" class="fw-semibold">$0.00</span>
          </div>
        </div>
      </div>

      <!-- Due soon (next 7 days) -->
      <div class="card mt-3">
        <div class="card-header">Due next 7 days</div>
        <div class="table-responsive">
          <table class="table table-sm mb-0 table-floating" id="dueSoonTable">
            <colgroup>
              <col style="width:32%">
              <col style="width:30%">
              <col style="width:22%">
              <col style="width:16%">
            </colgroup>
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th class="text-end">Amount</th>
                <th class="text-end">In</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="text-muted py-3 text-center">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ========= Manual Rule Store (boot default) ========= -->
<script id="recurring-overrides" type="application/json">
{
  "include": [],
  "exclude": {},
  "override": [],
  "pins": [],
  "schedules": []
}
</script>

<!-- ========= Rules Modal ========= -->
<div class="modal fade" id="rulesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Manage recurring rules</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ul class="nav nav-tabs" id="rulesTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabInclude" type="button" role="tab">Include (force)</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabExclude" type="button" role="tab">Exclude (hide)</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabOverride" type="button" role="tab">Override (tweak)</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPins" type="button" role="tab">Pins (one-offs)</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSchedules" type="button" role="tab">Schedules</button>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <!-- Include -->
          <div class="tab-pane fade show active" id="tabInclude" role="tabpanel">
            <form id="formInclude" class="row g-2 align-items-end">
              <div class="col-12 col-md-5">
                <label class="form-label small">Keywords (comma separated)</label>
                <input class="form-control" id="incKeywords" placeholder="e.g., VERIZON, FIOS, WIRELESS">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small">Amount</label>
                <input class="form-control" id="incAmount" placeholder="e.g., 85" inputmode="decimal">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small">Freq</label>
                <select class="form-select" id="incFreq">
                  <option value="monthly">monthly</option>
                  <option value="semi_monthly">semi-monthly</option>
                  <option value="biweekly">biweekly</option>
                  <option value="weekly">weekly</option>
                  <option value="quarterly">quarterly</option>
                  <option value="semiannual">semiannual</option>
                  <option value="annual">annual</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label small">Next date</label>
                <input class="form-control" id="incNext" type="date">
              </div>
              <div class="col-12">
                <label class="form-label small">Label (optional)</label>
                <input class="form-control" id="incLabel" placeholder="e.g., Verizon Wireless">
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add include rule</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Keywords</th><th>Amount</th><th>Freq</th><th>Next</th><th>Label</th><th></th></tr></thead>
                <tbody id="includeList"><tr><td colspan="6" class="text-muted">No include rules.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Exclude -->
          <div class="tab-pane fade" id="tabExclude" role="tabpanel">
            <form id="formExclude" class="row g-2 align-items-end">
              <div class="col-12 col-lg-6">
                <label class="form-label small">Keywords to exclude (comma separated)</label>
                <input class="form-control" id="excKeywords" placeholder="e.g., TRIAL, TEST, REFUND">
              </div>
              <div class="col-12 col-lg-6">
                <label class="form-label small">Reason (optional)</label>
                <input class="form-control" id="excReason" placeholder="e.g., trials / noise">
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add exclude rule</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Keywords</th><th>Reason</th><th></th></tr></thead>
                <tbody id="excludeList"><tr><td colspan="3" class="text-muted">No exclude rules.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Override -->
          <div class="tab-pane fade" id="tabOverride" role="tabpanel">
            <form id="formOverride" class="row g-2 align-items-end">
              <div class="col-12 col-lg-5">
                <label class="form-label small">Match keywords (comma separated)</label>
                <input class="form-control" id="ovKeywords" placeholder="e.g., NETFLIX">
              </div>
              <div class="col-6 col-lg-2">
                <label class="form-label small">Amount</label>
                <input class="form-control" id="ovAmount" placeholder="leave blank to keep" inputmode="decimal">
              </div>
              <div class="col-6 col-lg-2">
                <label class="form-label small">Freq</label>
                <select class="form-select" id="ovFreq">
                  <option value="">(no change)</option>
                  <option value="monthly">monthly</option>
                  <option value="semi_monthly">semi-monthly</option>
                  <option value="biweekly">biweekly</option>
                  <option value="weekly">weekly</option>
                  <option value="quarterly">quarterly</option>
                  <option value="semiannual">semiannual</option>
                  <option value="annual">annual</option>
                </select>
              </div>
              <div class="col-6 col-lg-3">
                <label class="form-label small">Next date</label>
                <input class="form-control" id="ovNext" type="date">
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add override</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Keywords</th><th>Set</th><th></th></tr></thead>
                <tbody id="overrideList"><tr><td colspan="3" class="text-muted">No overrides.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Pins -->
          <div class="tab-pane fade" id="tabPins" role="tabpanel">
            <form id="formPin" class="row g-2 align-items-end">
              <div class="col-12 col-md-5">
                <label class="form-label small">Label</label>
                <input class="form-control" id="pinLabel" placeholder="e.g., HOA Special Assessment">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label small">Amount</label>
                <input class="form-control" id="pinAmount" inputmode="decimal" placeholder="e.g., 250">
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label small">Date</label>
                <input class="form-control" id="pinDate" type="date">
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add pin</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Label</th><th>Amount</th><th>Date</th><th></th></tr></thead>
                <tbody id="pinsList"><tr><td colspan="4" class="text-muted">No pins.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Schedules -->
          <div class="tab-pane fade" id="tabSchedules" role="tabpanel">
            <form id="formSched" class="row g-2 align-items-end">
              <div class="col-12 col-md-4">
                <label class="form-label small">Label</label>
                <input class="form-control" id="scLabel" placeholder="e.g., Rent">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small">Amount</label>
                <input class="form-control" id="scAmount" inputmode="decimal" placeholder="e.g., 1800">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label small">Frequency</label>
                <select class="form-select" id="scFreq">
                  <option value="monthly">monthly</option>
                  <option value="semi_monthly">semi-monthly</option>
                  <option value="biweekly">biweekly</option>
                  <option value="weekly">weekly</option>
                  <option value="quarterly">quarterly</option>
                  <option value="semiannual">semiannual</option>
                  <option value="annual">annual</option>
                </select>
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label small">Next date</label>
                <input class="form-control" id="scNext" type="date">
              </div>

              <!-- Anchors (only for semi-monthly) -->
              <div id="scAnchors" class="col-12 d-none">
                <div class="row g-2">
                  <div class="col-4">
                    <label class="form-label small">Anchor A (day)</label>
                    <input class="form-control" id="scAnchorA" type="number" min="1" max="31" placeholder="e.g., 8">
                  </div>
                  <div class="col-4">
                    <label class="form-label small">Anchor B (day)</label>
                    <input class="form-control" id="scAnchorB" type="number" min="1" max="31" placeholder="e.g., 18">
                  </div>
                  <div class="col-4">
                    <label class="form-label small">Grace days</label>
                    <input class="form-control" id="scGrace" type="number" min="0" max="10" placeholder="e.g., 3">
                  </div>
                </div>
                <div class="form-text">Optional: choose two days of month for semi-monthly schedule; grace lets “nearby” charges match.</div>
              </div>

              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add schedule</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Label</th><th>Amount</th><th>Freq</th><th>Next</th><th></th></tr></thead>
                <tbody id="schedulesList"><tr><td colspan="5" class="text-muted">No schedules.</td></tr></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <div class="small me-auto text-muted" id="rulesStatus">Rules auto-save to this browser.</div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ========= Merge Modal ========= -->
<div class="modal fade" id="mergeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Merge selected recurring items</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="small text-muted mb-2" id="mergePickNote">—</div>

        <div class="row g-3">
          <div class="col-12">
            <label class="form-label small">Label</label>
            <input id="mergeLabel" class="form-control" placeholder="e.g., Straight Talk (2 lines)">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label small">Amount mode</label>
            <select id="mergeAmtMode" class="form-select">
              <option value="sum">sum of selected</option>
              <option value="median">median of selected</option>
              <option value="fixed">fixed…</option>
            </select>
          </div>
          <div class="col-12 col-md-4" id="mergeFixedWrap" style="display:none;">
            <label class="form-label small">Fixed amount</label>
            <input id="mergeFixed" class="form-control" inputmode="decimal" placeholder="e.g., 95">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small">Next date (optional)</label>
            <input id="mergeNext" class="form-control" type="date">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label small">Frequency</label>
            <select id="mergeFreq" class="form-select">
              <option value="monthly">monthly</option>
              <option value="semi_monthly">semi-monthly</option>
              <option value="biweekly">biweekly</option>
              <option value="weekly">weekly</option>
              <option value="quarterly">quarterly</option>
              <option value="semiannual">semiannual</option>
              <option value="annual">annual</option>
            </select>
          </div>

          <div class="col-12" id="mergeAnchorsWrap" style="display:none;">
            <div class="row g-2">
              <div class="col-4">
                <label class="form-label small">Anchor A (day)</label>
                <input id="mergeA" class="form-control" type="number" min="1" max="31" value="8">
              </div>
              <div class="col-4">
                <label class="form-label small">Anchor B (day)</label>
                <input id="mergeB" class="form-control" type="number" min="1" max="31" value="18">
              </div>
              <div class="col-4">
                <label class="form-label small">Grace days</label>
                <input id="mergeGrace" class="form-control" type="number" min="0" max="10" value="3">
              </div>
            </div>
            <div class="form-text">For semi-monthly schedules only.</div>
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label small">Variance (± dollars)</label>
            <input id="mergeVarAbs" class="form-control" inputmode="decimal" placeholder="e.g., 10">
          </div>
          <div class="col-12 col-md-6">
            <label class="form-label small">Variance (± percent)</label>
            <input id="mergeVarPct" class="form-control" inputmode="decimal" placeholder="e.g., 15">
          </div>

          <div class="col-12">
            <label class="form-label small">Selected items</label>
            <div id="mergeList" class="small border rounded p-2" style="max-height:180px; overflow:auto;">—</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="small text-muted me-auto" id="mergeStatus">Will merge locally if API is unavailable.</div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="mergeConfirm" class="btn btn-primary">Merge</button>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  // ======= DEBUG BANNER (first JS/fetch error) =======
  const dbg = document.createElement('div');
  dbg.id = 'debugBanner';
  dbg.style.cssText = 'position:fixed;left:12px;bottom:12px;z-index:9999;padding:8px 12px;border-radius:10px;font:12px/1.3 system-ui;background:#1f2937;color:#fde68a;border:1px solid #374151;box-shadow:0 8px 20px rgba(0,0,0,.35);display:none';
  document.body.appendChild(dbg);
  function showDebug(msg){ dbg.textContent = '⚠ ' + msg; dbg.style.display = 'inline-block'; console.error(msg); }
  window.addEventListener('error', e => showDebug(e.message || 'Script error'));
  window.addEventListener('unhandledrejection', e => showDebug((e.reason && (e.reason.message||e.reason)) || 'Promise rejection'));

  // ======= UTIL =======
  const byId = id => document.getElementById(id);
  const money = (n) => {
    const v = Number(n || 0);
    const s = v < 0 ? '-$' : '$';
    return s + Math.abs(v).toFixed(2);
  };
  const parseDate = (s) => {
    const [y, m, d] = (s || '').split('-').map(Number);
    return (y && m && d) ? new Date(y, m - 1, d) : null;
  };
  const daysFromToday = (s) => {
    const dt = parseDate(s);
    if (!dt) return null;
    const t = new Date(); t.setHours(0,0,0,0);
    const d = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    return Math.round((d - t) / (1000 * 60 * 60 * 24));
  };
  const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
  const esc = (s) =>
    String(s || '').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;'}[m]));

  const freqOrder = { weekly:1, biweekly:2, semi_monthly:2.5, monthly:3, quarterly:4, semiannual:5, annual:6, unknown:7 };

  // ======= SPARKLINES =======
  const SPARK_W = 120, SPARK_H = 28;

  function lastNMonthsLabels(n){
    const labels = [];
    const today = new Date();
    const d = new Date(today.getFullYear(), today.getMonth(), 1);
    for (let i = n - 1; i >= 0; i--){
      const mm = new Date(d.getFullYear(), d.getMonth() - i, 1);
      labels.push(mm.toISOString().slice(0, 7)); // YYYY-MM
    }
    return labels;
  }
  function bucketSeriesByMonth(txs, months){
    const sums = Object.fromEntries(months.map(m=>[m,0]));
    for (const t of txs){
      const dateStr = t.date || '';
      let key='';
      if (dateStr.includes('-')){ key = dateStr.slice(0,7); }
      else if (dateStr.includes('/')){ const [mm,dd,yy] = dateStr.split('/'); if (yy && mm) key = `${yy}-${String(mm).padStart(2,'0')}`; }
      if (key && key in sums){
        sums[key] += Math.abs(Number(t.amount||0));
      }
    }
    return months.map(m => Math.round((sums[m]||0)*100)/100);
  }
  function median(vals){ const v=[...vals].filter(x=>isFinite(x)).sort((a,b)=>a-b); if(!v.length) return 0; const m=Math.floor(v.length/2); return v.length%2?v[m]:(v[m-1]+v[m])/2; }
  function outlierFlag(series){ const med=median(series.filter(x=>x>0)); const last=series[series.length-1]||0; return (med>0 && last>med*1.2)?'⚠':''; }

  // Sparkline with explicit hit areas + data attributes (for custom tooltip)
  function svgSparkline(series, labels, w=SPARK_W, h=SPARK_H){
    const pad=2, max=Math.max(...series,1), step=(w-pad*2)/Math.max(series.length-1,1);
    const ys=series.map(v=> h-pad-(max===0?0:(v/max)*(h-pad*2)));
    const xs=series.map((_,i)=> pad+i*step);
    let d=''; for (let i=0;i<series.length;i++){ d+=(i===0?'M':'L')+xs[i]+' '+ys[i]+' '; }
    const points = series.map((v,i)=>`
      <g class="spark-pt" tabindex="0" aria-label="${(labels?.[i] ?? `#${i+1}`)}: ${money(v)}" style="pointer-events:all">
        <circle class="dot" cx="${xs[i]}" cy="${ys[i]}" r="2.2"/>
        <circle class="hit" cx="${xs[i]}" cy="${ys[i]}" r="9"
                data-label="${labels?.[i] ?? `#${i+1}`}" data-value="${money(v)}"
                style="pointer-events:all"></circle>
      </g>`).join('');
    return `
      <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" role="img" aria-label="6 month trend">
        <path d="${d}" stroke="currentColor" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        ${points}
      </svg>`;
  }

  // ---------- CATEGORY helpers ----------
  function txDeepLabel(t){
    const lbl = (t.sub_subcategory || t.subcategory || t.subcat || t.category || t.cat_top || '').toString().trim();
    return lbl || 'Other';
  }
  function deepCategoryForStream(subset){
    const counts = new Map();
    for (const t of subset){ const lbl=txDeepLabel(t); counts.set(lbl,(counts.get(lbl)||0)+1); }
    if (!counts.size) return 'Other';
    return [...counts.entries()].sort((a,b)=> b[1]-a[1])[0][0];
  }
  function categoryPathForLabel(subset, targetLabel){
    const norm = d=>{
      if(!d) return '';
      if(d.includes('-')) return d;
      if(d.includes('/')){ const [mm,dd,yy]=d.split('/'); if(yy && mm && dd) return `${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`; }
      return d;
    };
    let chosen = subset.find(t=> txDeepLabel(t)===targetLabel);
    if(!chosen){ const sorted=subset.slice().sort((a,b)=> (norm(b.date)>norm(a.date)?1:(norm(b.date)<norm(a.date)?-1:0))); chosen=sorted[0]||{}; }
    const cat=(chosen.cat_top||chosen.category||'').toString().trim();
    const sub=(chosen.subcat||chosen.subcategory||'').toString().trim();
    const ssub=(chosen.sub_subcategory||'').toString().trim();
    return { cat, sub, ssub, sss:'', label:(ssub||sub||cat||'Category') };
  }
  function catChip(label, path){
    const txt = esc(label||'Category');
    const level = path.ssub ? 'subsubcategory' : (path.sub ? 'subcategory' : 'category');
    return `<a href="#" class="chip link-manage"
              data-manage data-level="${esc(level)}"
              data-cat="${esc(path.cat||'')}" data-sub="${esc(path.sub||'')}" data-ssub="${esc(path.ssub||'')}"
              onclick="return (window.dashManage ? window.dashManage(event, this) : true);">${txt}</a>`;
  }

  // ---------- RULES STORAGE ----------
  const LS_KEY = 'recurringOverrides';
  function readOverrides(){
    try{
      const ls = localStorage.getItem(LS_KEY);
      if (ls) return JSON.parse(ls);
      const tag = document.getElementById('recurring-overrides');
      const j = JSON.parse(tag.textContent || '{}');
      return Object.assign({include:[], exclude:{}, override:[], pins:[], schedules:[]}, j||{});
    }catch(e){ return { include:[], exclude:{}, override:[], pins:[], schedules:[] }; }
  }
  function writeOverrides(state){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    document.getElementById('recurring-overrides').textContent = JSON.stringify(state, null, 2);
    renderRulesTables(state);
  }

  // ---------- MATCHING ----------
  function mkMatcher(keywords){
    const K = (Array.isArray(keywords)?keywords:String(keywords||'').split(',')).map(s=>s.trim().toLowerCase()).filter(Boolean);
    if (!K.length) return ()=>false;
    return (s)=>{ const t=String(s||'').toLowerCase(); return K.some(k=> t.includes(k)); };
  }
  function streamMatchesKeywords(stream, txsForStream, keywords){
    const m = mkMatcher(keywords);
    if (m(stream.merchant||stream.name)) return true;
    if (txsForStream && txsForStream.some(t => m(t.merchant||t.merchant_name||t.description))) return true;
    return false;
  }

  // ---------- APPLY OVERRIDES + MERGE ----------
  function nextFromFreq(freq, baseDateStr){
    const base = parseDate(baseDateStr) || new Date();
    const d = new Date(base.getFullYear(), base.getMonth(), base.getDate());
    const f = String(freq||'').toLowerCase();
    if (f==='weekly') d.setDate(d.getDate()+7);
    else if (f==='biweekly') d.setDate(d.getDate()+14);
    else if (f==='semi_monthly') d.setDate(d.getDate()+14);
    else if (f==='monthly') d.setMonth(d.getMonth()+1);
    else if (f==='quarterly') d.setMonth(d.getMonth()+3);
    else if (f==='semiannual') d.setMonth(d.getMonth()+6);
    else if (f==='annual') d.setFullYear(d.getFullYear()+1);
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function applyRecurringOverrides(base){
    const ov = readOverrides();
    let streams = (base.streams||[]).map(s=>({...s}));
    const txs = base.transactions || [];
    const txByKey = txs.reduce((acc, t) => { const k=t._stream_key||t.merchant_key||''; (acc[k] ||= []).push(t); return acc; }, {});

    // EXCLUDE
    const excMatchers = Object.entries(ov.exclude||{}).map(([k,reason])=>({ match: mkMatcher(k.split(',')), reason }));
    const isExcludedText = (desc)=> excMatchers.some(x => x.match(desc));

    let filtered = streams.filter(s => {
      const inTx = (txByKey[s._key]||[]).some(t => isExcludedText(t.merchant||t.merchant_name||t.description));
      const self = isExcludedText(s.merchant || s.name || '');
      return !(self || inTx);
    });

    // OVERRIDE (adjust existing)
    (ov.override||[]).forEach(rule => {
      filtered.forEach(s => {
        const subset = txByKey[s._key] || [];
        if (streamMatchesKeywords(s, subset, rule.keywords)){
          if (rule.amount!=null && rule.amount!=='') s.amount = Number(rule.amount);
          if (rule.freq) s.freq = rule.freq;
          if (rule.next) s.next = rule.next;
        }
      });
    });

    // MERGE rules are stored inside include with merge:true
    const includes = (ov.include||[]);
    const mergeIncludes = includes.filter(r => r.merge === true);
    // For each merge rule: remove matched streams, add a single combined one, keep source keys so we can combine transactions for sparkline
    mergeIncludes.forEach(rule => {
      const matched = filtered.filter(s => streamMatchesKeywords(s, txByKey[s._key]||[], rule.keywords));
      const matchedKeys = matched.map(s => s._key);
      if (!matchedKeys.length) return;
      filtered = filtered.filter(s => !matchedKeys.includes(s._key)); // remove originals
      const amount = (rule.amount!=null && rule.amount!=='') ? Number(rule.amount) : matched.reduce((a,s)=>a+Number(s.amount||0),0);
      const next = rule.next || matched.map(s=>s.next).filter(Boolean).sort()[0] || nextFromFreq(rule.freq||'monthly', new Date().toISOString().slice(0,10));
      const freq = rule.freq || (matched[0]?.freq || 'monthly');
      filtered.push({
        _key: 'merge:' + (rule.label||'Merged').toLowerCase().replace(/\s+/g,'_') + ':' + Date.now(),
        merchant: rule.label || 'Merged',
        amount,
        count: '',
        freq,
        next,
        manual: true,
        _merge_of: matchedKeys,
        _merge_var_abs: rule.variance_abs || null,
        _merge_var_pct: rule.variance_pct || null
      });
    });

    // INCLUDE (non-merge) force streams
    includes.filter(r=>!r.merge).forEach(rule => {
      let found = null;
      for (let i=0;i<filtered.length;i++){
        const s=filtered[i]; const subset=txByKey[s._key]||[];
        if (streamMatchesKeywords(s, subset, rule.keywords)) { found=s; break; }
      }
      const label = rule.label || (Array.isArray(rule.keywords) ? rule.keywords[0] : String(rule.keywords||'').split(',')[0]||'Manual');
      if (found){
        if (rule.amount!=null && rule.amount!=='') found.amount = Number(rule.amount);
        if (rule.freq) found.freq = rule.freq;
        if (rule.next) found.next = rule.next;
        if (!found.merchant) found.merchant = label;
      }else{
        filtered.push({
          _key: 'manual:' + label.toLowerCase().replace(/\s+/g,'_') + ':' + Date.now(),
          merchant: label,
          amount: Number(rule.amount||0),
          count: '',
          freq: rule.freq || 'monthly',
          next: rule.next || nextFromFreq(rule.freq||'monthly', new Date().toISOString().slice(0,10)),
          manual: true
        });
      }
    });

    // PINS + UPCOMING (apply excludes here too)
    let upcoming = (base.upcoming||[]).filter(u => !isExcludedText(u.merchant||u.name||''));
    (ov.pins||[]).forEach(p => {
      if (!isExcludedText(p.label||'')){
        upcoming.push({ date: p.date, amount: Number(p.amount||0), merchant: p.label || 'Pinned', _stream_key: 'pin:'+Date.now() });
      }
    });

    // SCHEDULES
    (ov.schedules||[]).forEach(sc => {
      filtered.push({
        _key: 'schedule:' + (sc.label||'').toLowerCase().replace(/\s+/g,'_')+':'+Date.now(),
        merchant: sc.label || 'Scheduled',
        amount: Number(sc.amount||0),
        count: '',
        freq: sc.freq || 'monthly',
        next: sc.next || new Date().toISOString().slice(0,10),
        manual: true
      });
    });

    return { ...base, streams: filtered, upcoming, _txByKey: txByKey };
  }

  // ---------- PAGE RENDER + INTERACTIONS ----------
  const winSel = byId('win'), horSel=byId('horizon'), searchEl=byId('search');
  const mergeBtn = byId('mergeBtn');
  const manageBtn = byId('manageRulesBtn');

  // Sort
  let sortState = { key: 'category', dir: 'asc' };
  function sortableVal(key, s, txByKey){
    if (key==='amount') return Number(s.amount||0);
    if (key==='freq') return (freqOrder[(s.freq||'unknown').toLowerCase()]||9);
    if (key==='next') return s.next ? (parseDate(s.next)?.getTime() || Number.MAX_SAFE_INTEGER) : Number.MAX_SAFE_INTEGER;
    if (key==='category'){
      const deep = deepCategoryForStream(txByKey[s._key] || []);
      return deep.toLowerCase();
    }
    return 0;
  }
  function compareStreams(a,b,txByKey){
    const va=sortableVal(sortState.key,a,txByKey), vb=sortableVal(sortState.key,b,txByKey);
    if (va<vb) return sortState.dir==='asc'?-1:1;
    if (va>vb) return sortState.dir==='asc'? 1:-1;
    return 0;
  }
  function setSortIndicators(){
    document.querySelectorAll('#streamsTable thead th.sortable').forEach(th=>{
      const key=th.getAttribute('data-sort'); th.classList.remove('sorted-asc','sorted-desc');
      if (key===sortState.key){ th.classList.add(sortState.dir==='asc'?'sorted-asc':'sorted-desc'); }
    });
  }
  function bindSort(){
    document.querySelectorAll('#streamsTable thead th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key=th.getAttribute('data-sort');
        if (sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); }
        else { sortState={ key, dir:(key==='category')?'asc':'desc' }; }
        renderStreamsTable();
        setSortIndicators();
      });
    });
  }

  let cachedData=null;
  let upcomingWeekTotal=0;
  const selectedKeys = new Set();

  function updateMergeBtn(){ mergeBtn.disabled = selectedKeys.size < 2; }

  async function load(){
    try{
      const win=winSel.value, horizon=horSel.value;
      const url=`/api/recurrents?win=${encodeURIComponent(win)}&horizon=${encodeURIComponent(horizon)}&top_n=5`;
      const res=await fetch(url);
      if (!res.ok) throw new Error(`API ${url} → ${res.status}`);
      const base=await res.json();
      const data=applyRecurringOverrides(base);
      cachedData=data;

      // KPIs and week total (from filtered upcoming)
      const pm = data.projected_month || {
        income_recurring: Number(data.income_recurring || 0),
        variable_income_monthly: Number(data.variable_income_monthly || 0),
        income_expected: Number(data.income_expected || 0),
        fixed_floor: Number(data.floor || 0),
        leftover: Number(data.leftover != null ? data.leftover : (Number(data.income_expected||0) - Number(data.floor||0)))
      };
      const income=Number(pm.income_expected||data.income_expected||0);
      const floor=Number(pm.fixed_floor||data.floor||0);
      const leftover=Number(pm.leftover!=null?pm.leftover:(income-floor));

      byId('kpi-floor').textContent=money(floor);
      byId('kpi-income').textContent=money(income);
      const lEl=byId('kpi-leftover'); lEl.textContent=money(leftover); lEl.classList.toggle('text-danger',leftover<0);

      const todayTo7 = (data.upcoming||[])
        .map(u=>({...u,days:daysFromToday(u.date)}))
        .filter(u=>u.days!=null && u.days>=0 && u.days<=7);
      upcomingWeekTotal = todayTo7.reduce((a,u)=>a+Number(u.amount||0),0);
      byId('kpi-week').textContent=money(upcomingWeekTotal);
      setFloorMeter(floor, income);

      byId('pmRecurring').textContent=money(pm.income_recurring||0);
      byId('pmVariable').textContent=money(pm.variable_income_monthly||0);
      byId('pmExpected').textContent=money(pm.income_expected||0);
      byId('pmFloor').textContent=money(pm.fixed_floor||0);
      const pmL=byId('pmLeftover'); pmL.textContent=money(pm.leftover||0); pmL.classList.toggle('text-danger', Number(pm.leftover||0)<0);
      byId('pmNote').textContent=`Horizon: ${data.horizon || horSel.value} days • Window: ${data.window || winSel.value}`;

      // Due soon table (filtered upcoming)
      const dueTbody=document.querySelector('#dueSoonTable tbody'); dueTbody.innerHTML='';
      const txs=data.transactions||[];
      const baseTxByKey = data._txByKey || {};
      const txByKey = baseTxByKey; // keep original map; merged rows gather subsets in render
      const upcoming=(data.upcoming||[]).slice().sort((a,b)=> (a.date<b.date?-1:1));
      const dueSoon=upcoming.map(u=>({...u,days:daysFromToday(u.date)})).filter(u=>u.days!=null&&u.days>=0&&u.days<=7).sort((a,b)=> (a.date<b.date?-1:1));
      if(!dueSoon.length){ dueTbody.innerHTML='<tr><td colspan="4" class="text-muted py-3 text-center">Nothing due in the next 7 days.</td></tr>'; }
      else{
        for (const u of dueSoon){
          const key=u._stream_key||u.stream_key||u.merchant_key||'';
          let subset=[]; if (key){ subset=txs.filter(t=>(t._stream_key||t.merchant_key||'')===key); }
          const deep=subset.length?deepCategoryForStream(subset):(u.category||'Other');
          const path=subset.length?categoryPathForLabel(subset,deep):{cat:u.category||'Other',sub:'',ssub:'',sss:''};
          const chip=catChip(deep,path);
          const label = u.days===0 ? '<span class="badge text-bg-danger">Today</span>' : (u.days===1?'1 day':`${u.days} days`);
          const tr=document.createElement('tr');
          tr.innerHTML=`<td>${u.date}</td><td>${chip}</td><td class="text-end">${money(u.amount)}</td><td class="text-end">${label}</td>`;
          dueTbody.appendChild(tr);
          if (window.canonicalizeChip){ const a=tr.querySelector('.chip.link-manage'); if(a) window.canonicalizeChip(a); }
        }
      }

      renderStreamsTable();
      renderScatter();
      bindSort(); setSortIndicators();
    }catch(err){
      showDebug(err.message || String(err));
      const tbody=document.querySelector('#streamsTable tbody');
      if (tbody) tbody.innerHTML='<tr><td colspan="6" class="text-danger py-3 text-center">Failed to load data.</td></tr>';
    }
  }

  function setFloorMeter(floor,income){
    const bar=byId('kpi-floor-meter'), subEl=byId('kpi-floor-sub'), tile=byId('tile-floor');
    if(income>0){ const pct=clamp((floor/income)*100,0,140); bar.style.width=pct.toFixed(0)+'%'; subEl.textContent=`${pct.toFixed(0)}% of income`; tile.classList.toggle('over',pct>100); }
    else { bar.style.width='0%'; subEl.textContent='no income set'; tile.classList.remove('over'); }
  }

  function combinedSubsetFor(stream, txByKey, allTx){
    if (stream._merge_of && stream._merge_of.length){
      const arr=[];
      stream._merge_of.forEach(k => { (txByKey[k]||[]).forEach(t=>arr.push(t)); });
      return arr;
    }
    const key=stream._key||'';
    return allTx.filter(t => (t._stream_key||t.merchant_key||'')===key);
  }

  function renderStreamsTable(){
    if(!cachedData) return;
    const tbody=document.querySelector('#streamsTable tbody'); tbody.innerHTML='';
    const streams=(cachedData.streams||[]).slice();
    const txs=cachedData.transactions||[];
    const txByKey = cachedData._txByKey || {};

    const q=(searchEl.value||'').trim().toLowerCase();
    const filtered = streams.filter(s=>{
      if(!q) return true;
      const subset = combinedSubsetFor(s, txByKey, txs);
      const deep = deepCategoryForStream(subset);
      const hay = [ deep||'', s.freq||'' ].join(' ').toLowerCase();
      return hay.includes(q);
    });

    if(!filtered.length){ tbody.innerHTML='<tr><td colspan="6" class="text-muted py-3 text-center">No streams detected.</td></tr>'; return; }

    filtered.sort((a,b)=>compareStreams(a,b,txByKey));
    const months=lastNMonthsLabels(6);

    for (const s of filtered){
      const subset=combinedSubsetFor(s, txByKey, txs);
      const series=bucketSeriesByMonth(subset, months);
      const warn=outlierFlag(series);
      const nextDays=s.next?daysFromToday(s.next):null;

      const deepLabel=deepCategoryForStream(subset);
      const path=categoryPathForLabel(subset, deepLabel);
      const chipHtml=catChip(deepLabel, path);

      // actions menu: include "Combine with…"
      const actions = `
        <div class="dropdown ms-1">
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown" aria-label="Row actions">⋮</button>
          <div class="dropdown-menu dropdown-menu-end">
            <button class="dropdown-item" data-act="start-merge" data-key="${esc(s._key||'')}">Combine with…</button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" data-act="exclude" data-kw="${esc(s.merchant||'')}">Exclude “${esc(s.merchant||'') || 'stream'}”</button>
            <button class="dropdown-item" data-act="override-amount" data-kw="${esc(s.merchant||'')}" data-amt="${esc(s.amount||'')}">Set amount…</button>
            <button class="dropdown-item" data-act="override-next" data-kw="${esc(s.merchant||'')}" data-next="${esc(s.next||'')}">Set next date…</button>
            <button class="dropdown-item" data-act="override-freq" data-kw="${esc(s.merchant||'')}">Set frequency…</button>
          </div>
        </div>`;

      const checked = selectedKeys.has(s._key||'') ? 'checked' : '';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="text-center align-middle"><input type="checkbox" class="rowSel" data-key="${esc(s._key||'')}" ${checked}></td>
        <td class="streams-category">
          <div class="d-flex align-items-center gap-2">
            ${chipHtml} ${warn?`<span class="variance-tag" title="Last charge >20% above median">variance</span>`:''}
            ${actions}
          </div>
        </td>
        <td class="text-start">${money(s.amount)}</td>
        <td>${(s.freq || '—')}</td>
        <td>${s.next ? `<div>${s.next}</div><div class="small muted">${nextDays===0?'today':(nextDays===1?'in 1 day':(nextDays!=null?`in ${nextDays} days`:'—'))}</div>` : '—'}</td>
        <td class="trend-cell">${svgSparkline(series, months)}</td>
      `;
      tbody.appendChild(tr);
    }

    // row selectors
    tbody.querySelectorAll('.rowSel').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const k = cb.dataset.key;
        if (cb.checked) selectedKeys.add(k); else selectedKeys.delete(k);
        updateMergeBtn();
      });
    });

    // wire actions (exclude/override/quick-merge)
    tbody.querySelectorAll('[data-act]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const act=btn.dataset.act; const kw=btn.dataset.kw||'';
        const ov=readOverrides();

        if (act==='start-merge'){
          const k = btn.dataset.key;
          if (k){ selectedKeys.add(k); updateMergeBtn(); }
          // open the merge modal seeded with this row
          document.getElementById('mergeBtn').click();
          return;
        }

        if (act==='exclude'){
          ov.exclude[kw] = 'manual exclude';
          writeOverrides(ov); load();
        } else if (act==='override-amount'){
          const a = prompt('Set amount (blank to cancel):', btn.dataset.amt||'');
          if (a===null || a==='') return;
          ov.override.push({ keywords: kw, amount: Number(a) });
          writeOverrides(ov); load();
        } else if (act==='override-next'){
          const nxt = prompt('Set next date (YYYY-MM-DD):', btn.dataset.next||'');
          if (!nxt) return;
          ov.override.push({ keywords: kw, next: nxt });
          writeOverrides(ov); load();
        } else if (act==='override-freq'){
          const f = prompt('Set frequency (weekly/biweekly/semi_monthly/monthly/quarterly/semiannual/annual):','monthly');
          if (!f) return;
          ov.override.push({ keywords: kw, freq: f });
          writeOverrides(ov); load();
        }
      });
    });

    updateMergeBtn();
  }

  // ----- Scatter plot (SVG) of recurring charges over time -----
  function renderScatter(){
    const el = document.getElementById('scatterWrap');
    if (!el || !cachedData) return;
    el.innerHTML = '';
    const txs = (cachedData.transactions||[]).filter(t => Number(t.amount||0) !== 0);
    if (!txs.length){ el.innerHTML = '<div class="text-muted small">No transaction data.</div>'; return; }

    // map dates to numbers
    const points = txs.map(t => {
      const ds = String(t.date||'');
      let y, m, d;
      if (ds.includes('-')) { const a=ds.split('-'); y=+a[0]; m=+a[1]; d=+(a[2]||'1'); }
      else if (ds.includes('/')) { const a=ds.split('/'); m=+a[0]; d=+a[1]; y=+a[2]; }
      else { return null; }
      const dt = new Date(y, (m||1)-1, d||1);
      return { x: dt.getTime(), y: Math.abs(Number(t.amount||0)), k: (t._stream_key||t.merchant_key||''), cat: (t.category||t.cat_top||'') };
    }).filter(Boolean);

    if (!points.length){ el.innerHTML = '<div class="text-muted small">No dated points.</div>'; return; }

    // bounds
    const pad=24, W=480, H=220;
    const xs = points.map(p=>p.x), ys=points.map(p=>p.y);
    const minX=Math.min(...xs), maxX=Math.max(...xs);
    const minY=0, maxY=Math.max(...ys,1)*1.1;
    const xScale = x => pad + ( (x-minX) / Math.max(1,(maxX-minX)) ) * (W-pad*2);
    const yScale = y => H - pad - ( (y-minY) / Math.max(1,(maxY-minY)) ) * (H-pad*2);

    // axes ticks (months)
    const s = new Date(minX), e = new Date(maxX);
    s.setDate(1); e.setDate(1);
    const monthTicks=[]; const cur = new Date(s);
    while (cur <= e){ monthTicks.push(new Date(cur)); cur.setMonth(cur.getMonth()+1); }

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', W); svg.setAttribute('height', H); svg.setAttribute('viewBox', `0 0 ${W} ${H}`);
    svg.setAttribute('role','img'); svg.setAttribute('aria-label','Recurring charges scatter plot');

    // axes
    const axis = document.createElementNS(svg.namespaceURI,'g');
    axis.innerHTML = `
      <path d="M${pad} ${H-pad} L ${W-pad} ${H-pad}" stroke="currentColor" opacity=".3"/>
      <path d="M${pad} ${H-pad} L ${pad} ${pad}" stroke="currentColor" opacity=".3"/>
    `;
    svg.appendChild(axis);

    // x ticks
    monthTicks.forEach(d => {
      const x = xScale(d.getTime());
      const t = document.createElementNS(svg.namespaceURI,'line');
      t.setAttribute('x1', x); t.setAttribute('x2', x); t.setAttribute('y1', H-pad); t.setAttribute('y2', H-pad+4);
      t.setAttribute('stroke','currentColor'); t.setAttribute('opacity','.3');
      svg.appendChild(t);

      const lbl = document.createElementNS(svg.namespaceURI,'text');
      lbl.setAttribute('x', x); lbl.setAttribute('y', H-pad+14);
      lbl.setAttribute('text-anchor','middle'); lbl.setAttribute('font-size','10');
      lbl.setAttribute('fill','currentColor'); lbl.setAttribute('opacity','.7');
      lbl.textContent = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      svg.appendChild(lbl);
    });

    // y ticks (nice steps)
    const step = Math.pow(10, Math.floor(Math.log10(maxY)) - 1);
    for (let v=0; v<=maxY; v+= step){
      const y = yScale(v);
      const t = document.createElementNS(svg.namespaceURI,'line');
      t.setAttribute('x1', pad-4); t.setAttribute('x2', pad); t.setAttribute('y1', y); t.setAttribute('y2', y);
      t.setAttribute('stroke','currentColor'); t.setAttribute('opacity','.3');
      svg.appendChild(t);

      const lbl = document.createElementNS(svg.namespaceURI,'text');
      lbl.setAttribute('x', 4); lbl.setAttribute('y', y+3);
      lbl.setAttribute('text-anchor','start'); lbl.setAttribute('font-size','10');
      lbl.setAttribute('fill','currentColor'); lbl.setAttribute('opacity','.7');
      lbl.textContent = money(v);
      svg.appendChild(lbl);
    }

    // points
    const g = document.createElementNS(svg.namespaceURI,'g');
    points.forEach(p => {
      const cx = xScale(p.x), cy = yScale(p.y);
      const dot = document.createElementNS(svg.namespaceURI,'circle');
      dot.setAttribute('cx', cx); dot.setAttribute('cy', cy); dot.setAttribute('r', 3.2);
      dot.setAttribute('fill', 'currentColor');
      const hit = document.createElementNS(svg.namespaceURI,'circle');
      hit.setAttribute('cx', cx); hit.setAttribute('cy', cy); hit.setAttribute('r', 9);
      hit.setAttribute('fill','transparent'); hit.setAttribute('data-tip', `${new Date(p.x).toISOString().slice(0,10)} · ${money(p.y)}`);
      hit.classList.add('scatter-hit');
      const group = document.createElementNS(svg.namespaceURI,'g');
      group.appendChild(dot); group.appendChild(hit);
      g.appendChild(group);
    });
    svg.appendChild(g);
    el.appendChild(svg);

    // tooltip reuse
    const tip = document.getElementById('sparkTip') || (()=>{
      const t = document.createElement('div');
      t.id = 'sparkTip';
      t.style.cssText = 'position:fixed; z-index:9999; padding:6px 10px; border-radius:10px; font-size:12px; color:var(--text); background:var(--card-bg); border:1px solid var(--card-border); box-shadow:0 10px 24px rgba(0,0,0,.45); pointer-events:none; opacity:0; transform:translate(-50%,-110%); transition:opacity .08s ease';
      document.body.appendChild(t); return t;
    })();
    function showTip(x,y,txt){
      tip.textContent = txt;
      const pad = 8, vw = window.innerWidth, vh = window.innerHeight;
      const left = Math.min(vw - pad, Math.max(pad, x));
      let top = y - 8; tip.style.transform = 'translate(-50%,-110%)';
      tip.style.left = left + 'px'; tip.style.top = top + 'px'; tip.style.opacity = '1';
      const r = tip.getBoundingClientRect();
      if (r.top < 0){ top = Math.min(vh - pad, y + 18); tip.style.top = top + 'px'; tip.style.transform = 'translate(-50%,0)'; }
    }
    function hideTip(){ tip.style.opacity = '0'; }

    el.addEventListener('pointermove', (e)=>{
      const c = e.target.closest('.scatter-hit');
      if (c){ showTip(e.clientX, e.clientY, c.getAttribute('data-tip')); } else { hideTip(); }
    });
    el.addEventListener('pointerleave', hideTip);

    byId('scatterNote').textContent = `${points.length} points • ${new Date(minX).toISOString().slice(0,10)} → ${new Date(maxX).toISOString().slice(0,10)}`;
  }

  // ===== Sparkline tooltip (delegated) =====
  const tableEl = document.getElementById('streamsTable');
  const tip = document.createElement('div');
  tip.id = 'sparkTip';
  // match theme colors and keep it close to the cursor
  tip.style.cssText = [
    'position:fixed',
    'z-index:9999',
    'padding:6px 10px',
    'border-radius:10px',
    'font-size:12px',
    'color:var(--text)',
    'background:var(--card-bg)',
    'border:1px solid var(--card-border)',
    'box-shadow:0 10px 24px rgba(0,0,0,.45)',
    'pointer-events:none',
    'opacity:0',
    'transform:translate(-50%,-110%)',
    'transition:opacity .08s ease'
  ].join(';');
  document.body.appendChild(tip);

  function showTip(x,y,txt){
    tip.textContent = txt;

    const pad = 8;
    const vw = window.innerWidth, vh = window.innerHeight;
    const left = Math.min(vw - pad, Math.max(pad, x));
    let top = y - 8; // closer above the cursor
    tip.style.transform = 'translate(-50%,-110%)';
    tip.style.left = left + 'px';
    tip.style.top = top + 'px';
    tip.style.opacity = '1';

    const r = tip.getBoundingClientRect();
    if (r.top < 0){
      top = Math.min(vh - pad, y + 18); // closer below the cursor
      tip.style.top = top + 'px';
      tip.style.transform = 'translate(-50%,0)';
    }
  }
  function hideTip(){ tip.style.opacity = '0'; }

  tableEl.addEventListener('pointermove', (e)=>{
    const c = e.target.closest('.hit');
    if (c){
      const txt = `${c.dataset.label}: ${c.dataset.value}`;
      showTip(e.clientX, e.clientY, txt);
    } else {
      hideTip();
    }
  });
  tableEl.addEventListener('pointerleave', hideTip);
  tableEl.addEventListener('focusin', (e)=>{
    const g = e.target.closest('.spark-pt'); if (!g) return;
    const hit = g.querySelector('.hit');
    const r = g.getBoundingClientRect();
    const txt = `${hit.dataset.label}: ${hit.dataset.value}`;
    showTip(r.left + r.width/2, r.top, txt);
  });
  tableEl.addEventListener('focusout', hideTip);

  // ---------- Merge flow ----------
  const rulesModalEl = document.getElementById('rulesModal');
  let rulesModal = null;
  const mergeModalEl = document.getElementById('mergeModal');
  let mergeModal = null;

  manageBtn.addEventListener('click', ()=>{
    rulesModal = rulesModal || (bootstrap && bootstrap.Modal ? new bootstrap.Modal(rulesModalEl) : null);
    if (rulesModal) rulesModal.show();
    renderRulesTables(readOverrides());
  });

  byId('mergeBtn').addEventListener('click', ()=>{
    if (selectedKeys.size < 2) return;
    mergeModal = mergeModal || (bootstrap && bootstrap.Modal ? new bootstrap.Modal(mergeModalEl) : null);
    const listEl = byId('mergeList');
    const note = byId('mergePickNote');

    const chosen = (cachedData.streams||[]).filter(s=> selectedKeys.has(s._key));
    const lines = chosen.map(s => `<div class="d-flex justify-content-between"><span>${esc(s.merchant||'')}</span><span class="mono">${money(s.amount)}</span></div>`).join('');
    listEl.innerHTML = lines || '—';

    const defaultLabel = (()=>{
      const unique = Array.from(new Set(chosen.map(s=> (s.merchant||'').trim()))).filter(Boolean);
      if (unique.length===1) return unique[0];
      if (unique.length===2) return `${unique[0]} + ${unique[1]}`;
      return `${unique[0]} (+${unique.length-1} more)`;
    })();
    byId('mergeLabel').value = defaultLabel;

    const amtSum = chosen.reduce((a,s)=>a+Number(s.amount||0),0);
    byId('mergeFixed').value = amtSum.toFixed(2);
    byId('mergeAmtMode').value = 'sum';
    byId('mergeFixedWrap').style.display = 'none';

    byId('mergeFreq').value = 'semi_monthly';
    byId('mergeNext').value = '';

    byId('mergeA').value = 8; byId('mergeB').value = 18; byId('mergeGrace').value = 3;
    byId('mergeAnchorsWrap').style.display = 'block';

    note.textContent = `${chosen.length} items selected.`;

    mergeModal?.show();
  });

  byId('mergeAmtMode').addEventListener('change', (e)=>{
    const show = e.target.value === 'fixed';
    byId('mergeFixedWrap').style.display = show ? '' : 'none';
  });
  byId('mergeFreq').addEventListener('change', (e)=>{
    byId('mergeAnchorsWrap').style.display = (e.target.value === 'semi_monthly') ? '' : 'none';
  });

  async function postJSON(urls, body){
    let last;
    for (const u of urls){
      try{
        const r = await fetch(u, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        if (r.ok){
          const ct=(r.headers.get('content-type')||'').toLowerCase();
          return ct.includes('json') ? await r.json() : { ok:true, raw: await r.text() };
        }
        last = new Error(`${u} → ${r.status}`);
      }catch(e){ last = e; }
    }
    throw last || new Error('merge endpoints not available');
  }

  byId('mergeConfirm').addEventListener('click', async ()=>{
    const chosen = (cachedData.streams||[]).filter(s=> selectedKeys.has(s._key));
    if (chosen.length < 2){ alert('Pick at least two items.'); return; }

    const label = (byId('mergeLabel').value||'').trim() || 'Merged';
    const mode = byId('mergeAmtMode').value;
    const freq = byId('mergeFreq').value || 'monthly';
    const next = byId('mergeNext').value || undefined;
    const anchors = (freq==='semi_monthly') ? [ Number(byId('mergeA').value||8), Number(byId('mergeB').value||18) ] : undefined;
    const grace_days = (freq==='semi_monthly') ? Number(byId('mergeGrace').value||3) : undefined;

    const var_abs = Number(byId('mergeVarAbs').value||0) || undefined;
    const var_pct = Number(byId('mergeVarPct').value||0) || undefined;

    const amounts = chosen.map(s=>Number(s.amount||0));
    const amount = mode==='sum' ? amounts.reduce((a,b)=>a+b,0)
                 : mode==='median' ? median(amounts)
                 : Number(byId('mergeFixed').value||0);

    const payload = { keys: chosen.map(s=>s._key), label, amount, freq, next, anchors, grace_days, variance_abs: var_abs, variance_pct: var_pct };

    try{
      await postJSON(['/admin/recurring/merge','/api/recurring/merge','/recurring/merge'], payload);
      bootstrap.Modal.getInstance(mergeModalEl)?.hide();
      selectedKeys.clear(); updateMergeBtn(); load();
    }catch(err){
      // Local fallback: store as include rule with merge:true so UI collapses them into one
      const ov = readOverrides();
      const keywords = Array.from(new Set(chosen.map(s=>(s.merchant||'').trim()))).filter(Boolean);
      ov.include.push({ keywords, amount, freq, next, label, merge:true, variance_abs: var_abs, variance_pct: var_pct });
      writeOverrides(ov);
      bootstrap.Modal.getInstance(mergeModalEl)?.hide();
      selectedKeys.clear(); updateMergeBtn(); load();
      alert('Server merge API not found. Created a local combined rule instead.');
    }
  });

  // Events
  winSel.addEventListener('change', load);
  horSel.addEventListener('change', load);
  byId('search').addEventListener('input', renderStreamsTable);

  // init
  renderRulesTables(readOverrides());
  load();
})();
</script>

<style>
/* ---- Align with global dark/glass theme from layout.html ---- */
.kpi-grid{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
@media (max-width: 992px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width: 576px){ .kpi-grid{ grid-template-columns: 1fr; } }

.kpi-tile{
  border:1px solid var(--card-border); border-radius:14px; padding:12px 14px;
  background: var(--card-bg);
  box-shadow: 0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
  color: var(--text); backdrop-filter: saturate(120%) blur(4px);
}
.kpi-top{ display:flex; align-items:center; gap:8px; margin-bottom:4px; }
.kpi-icon{ display:grid; place-items:center; width:28px; height:28px; border-radius:999px; color: var(--text); background: rgba(255,255,255,.06); border:1px solid var(--card-border); }
.kpi-label{ font-size:12px; color: var(--muted); font-weight:600; }
.kpi-value{ font-size:22px; font-weight:700; line-height:1.1; margin-top:2px; }
.kpi-sub{ font-size:12px; color: var(--muted); margin-top:2px; }

.accent-red   .kpi-icon{ color:#fda4af; }
.accent-green .kpi-icon{ color:#86efac; }
.accent-blue  .kpi-icon{ color:#93c5fd; }
.accent-amber .kpi-icon{ color:#fde68a; }

.kpi-meter{ width:100%; height:10px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid var(--card-border); overflow:hidden; margin-top:6px; }
.kpi-meter .fill{ height:100%; width:0%; background:#f87171; transition:width .25s ease; }
#tile-floor.over .kpi-meter .fill{ background:#dc2626; }

/* ==== CATEGORY "CHIP" ==== */
.chip{ display:inline-block; background:transparent; border:0; color:var(--text); padding:0; margin:0; border-radius:0; font-size:14px; font-weight:700; line-height:1.1; text-decoration:none; }
.chip:hover{ text-decoration: underline; }
.chip:focus{ outline:2px solid color-mix(in oklab, var(--text) 45%, transparent); outline-offset:2px; }

/* table UX */
#streamsTable thead th.sortable { cursor:pointer; user-select:none; }
#streamsTable thead th .sort { opacity:.5; margin-left:4px; font-size:10px; }
#streamsTable thead th.sorted-asc .sort::after  { content:"▲"; }
#streamsTable thead th.sorted-desc .sort::after { content:"▼"; }
#streamsTable thead th:not(.sorted-asc):not(.sorted-desc) .sort::after { content:"↕"; }

#streamsTable td, #streamsTable th,
#dueSoonTable td, #dueSoonTable th{ vertical-align: middle; }

/* variance label */
.variance-tag{ font-size:.85rem; color: color-mix(in oklab, var(--text) 70%, #fff 0%); opacity:.85; }

/* row selector col fixed */
#streamsTable td:first-child, #streamsTable th:first-child { width:32px; }

/* monospace for money blocks we show in merge list */
.mono{ font-variant-numeric: tabular-nums; }

/* tighten cell paddings a bit for better fit */
.table.table-floating > :not(caption) > * > * { padding-top: .6rem; padding-bottom: .6rem; }

/* Sparkline style + bullet/line color sync; FORCE events just in case */
#streamsTable .trend-cell { white-space:nowrap; min-width:190px; }
#streamsTable .trend-cell svg { display:block; margin:0 auto; color: var(--muted); pointer-events:auto; }
#streamsTable .trend-cell svg path { stroke: currentColor; }
#streamsTable .trend-cell svg .dot { fill: currentColor; stroke: currentColor; }
#streamsTable .trend-cell svg .hit { fill: transparent; pointer-events: all !important; }
#streamsTable .trend-cell svg .spark-pt:hover .dot,
#streamsTable .trend-cell svg .spark-pt:focus .dot { filter: drop-shadow(0 0 2px currentColor); }

/* scatter */
.scatter-wrap svg { width:100%; height:auto; color: var(--text); }
</style>
{% endblock %}

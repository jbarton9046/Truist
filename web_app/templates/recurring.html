{% extends "layout.html" %}
{% block title %}Recurring{% endblock %}

{% block content %}

<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Recurring Dashboard</h2>
    <div class="d-flex gap-2">
      <input id="search" class="form-control form-control-sm" placeholder="Search (category/freq)..." style="width: 240px;">
      <button id="mergeBtn" class="btn btn-sm btn-outline-danger" disabled>Merge selected</button>
      <button id="manageRulesBtn" class="btn btn-sm btn-outline-primary">Manage rules</button>
      <select id="win" class="form-select form-select-sm" style="width: 140px;">
        <option value="90">Last 90 days</option>
        <option value="180">Last 180 days</option>
        <option value="365" selected>Last 365 days</option>
        <option value="all">All time</option>
      </select>
      <select id="horizon" class="form-select form-select-sm bt-selectify" style="width: 140px;">
        <option value="30" selected>Next 30 days</option>
        <option value="60">Next 60 days</option>
        <option value="90">Next 90 days</option>
        <option value="180">Next 180 days</option>
      </select>
    </div>
  </div>

  <!-- KPI STRIP -->
  <div class="kpi-grid mb-3" id="kpiBar">
    <div class="kpi-tile accent-red" id="tile-floor">
      <div class="kpi-top">
        <div class="kpi-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <path d="M12 3l7 3v6c0 5-3.5 9-7 9s-7-4-7-9V6l7-3z" stroke="currentColor" stroke-width="1.6" fill="none"/>
          </svg>
        </div>
        <div class="kpi-label">Floor</div>
      </div>
      <div class="kpi-value" id="kpi-floor">—</div>
      <div class="kpi-sub"><span id="kpi-floor-sub">— of income</span></div>
      <div class="kpi-meter" role="progressbar" aria-label="Floor vs Income">
        <div id="kpi-floor-meter" class="fill"></div>
      </div>
    </div>

    <div class="kpi-tile accent-green" id="tile-income">
      <div class="kpi-top">
        <div class="kpi-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="6" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.6" fill="none"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1.6" fill="none"/>
          </svg>
        </div>
        <div class="kpi-label">Expected income</div>
      </div>
      <div class="kpi-value" id="kpi-income">—</div>
      <div class="kpi-sub">from detected streams</div>
    </div>

    <div class="kpi-tile accent-blue" id="tile-leftover">
      <div class="kpi-top">
        <div class="kpi-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="7" width="18" height="12" rx="2" stroke="currentColor" stroke-width="1.6" fill="none"/>
            <path d="M21 11h-5a2 2 0 100 4h5v-4z" stroke="currentColor" stroke-width="1.6" fill="none"/>
          </svg>
        </div>
        <div class="kpi-label">Leftover</div>
      </div>
      <div class="kpi-value" id="kpi-leftover">—</div>
      <div class="kpi-sub" id="kpi-leftover-sub">after floor</div>
    </div>

    <div class="kpi-tile accent-amber" id="tile-week">
      <div class="kpi-top">
        <div class="kpi-icon" aria-hidden="true">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="5" width="18" height="16" rx="2" stroke="currentColor" stroke-width="1.6"/>
            <path d="M8 3v4M16 3v4M3 10h18" stroke="currentColor" stroke-width="1.6"/>
          </svg>
        </div>
        <div class="kpi-label">Due this week</div>
      </div>
      <div class="kpi-value" id="kpi-week">—</div>
      <div class="kpi-sub"></div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-7">

      <!-- Recurring Charges -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Recurring Charges</span>
        </div>
        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 table-floating" id="streamsTable">
            <colgroup>
              <col style="width:32px">
              <col style="width:30%">
              <col style="width:16%">
              <col style="width:18%">
              <col style="width:23%">
              <col style="width:1%">
            </colgroup>
            <thead>
              <tr>
                <th></th>
                <th class="sortable" data-sort="category">Category <span class="sort"></span></th>
                <th class="text-start sortable" data-sort="amount">Amount <span class="sort"></span></th>
                <th class="sortable" data-sort="freq">Freq <span class="sort"></span></th>
                <th class="sortable" data-sort="next">Next <span class="sort"></span></th>
                <th>Trend (6 mo)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="text-muted py-3 text-center">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-12 col-lg-5">
      <!-- MONTHLY RECURRING SCATTER -->
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Monthly recurring charges (scatter)</span>
          <small class="muted" id="scNote"></small>
        </div>
        <div class="card-body">
          <svg id="txScatter" width="100%" height="240" role="img" aria-label="Monthly recurring scatter plot"></svg>
        </div>
      </div>

      <!-- Projected Month (moved down) -->
      <div class="card mt-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Projected month</span>
          <small class="muted" id="pmNote"></small>
        </div>
        <div class="card-body small">
          <div class="d-flex justify-content-between mb-1">
            <span>Recurring income</span>
            <span id="pmRecurring">$0.00</span>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <span>Variable income (monthly)</span>
            <span id="pmVariable">$0.00</span>
          </div>
          <hr class="my-2">
          <div class="d-flex justify-content-between mb-1">
            <span class="fw-semibold">Expected income</span>
            <span id="pmExpected" class="fw-semibold">$0.00</span>
          </div>
          <div class="d-flex justify-content-between mb-1">
            <span>Fixed floor (bills)</span>
            <span id="pmFloor">$0.00</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="fw-semibold">Projected leftover</span>
            <span id="pmLeftover" class="fw-semibold">$0.00</span>
          </div>
        </div>
      </div>

      <!-- Due soon (next 7 days) -->
      <div class="card mt-3">
        <div class="card-header">Due next 7 days</div>
        <div class="table-responsive">
          <table class="table table-sm mb-0 table-floating" id="dueSoonTable">
            <colgroup>
              <col style="width:32%">
              <col style="width:30%">
              <col style="width:22%">
              <col style="width:16%">
            </colgroup>
            <thead>
              <tr>
                <th>Date</th>
                <th>Category</th>
                <th class="text-end">Amount</th>
                <th class="text-end">In</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="4" class="text-muted py-3 text-center">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ========= Manual Rule Store (boot default) ========= -->
<script id="recurring-overrides" type="application/json">
{
  "include": [],
  "exclude": {},
  "override": [],
  "pins": [],
  "schedules": [],
  "merges": []
}
</script>

<!-- ========= Rules Modal ========= -->
<div class="modal fade" id="rulesModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Manage recurring rules</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <ul class="nav nav-tabs" id="rulesTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabInclude" type="button" role="tab">Include (force)</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabExclude" type="button" role="tab">Exclude (hide)</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabOverride" type="button" role="tab">Override (tweak)</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPins" type="button" role="tab">Pins (one-offs)</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSchedules" type="button" role="tab">Schedules</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabMerges" type="button" role="tab">Merges</button>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <!-- Include -->
          <div class="tab-pane fade show active" id="tabInclude" role="tabpanel">
            <form id="formInclude" class="row g-2 align-items-end">
              <div class="col-12 col-md-5">
                <label class="form-label small">Keywords (comma separated)</label>
                <input class="form-control" id="incKeywords" placeholder="e.g., VERIZON, FIOS, WIRELESS">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small">Amount</label>
                <input class="form-control" id="incAmount" placeholder="e.g., 85" inputmode="decimal">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small">Freq</label>
                <select class="form-select" id="incFreq">
                  <option value="monthly">monthly</option>
                  <option value="semi_monthly">semi-monthly</option>
                  <option value="biweekly">biweekly</option>
                  <option value="weekly">weekly</option>
                  <option value="quarterly">quarterly</option>
                  <option value="semiannual">semiannual</option>
                  <option value="annual">annual</option>
                </select>
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label small">Next date</label>
                <input class="form-control" id="incNext" type="date">
              </div>
              <div class="col-12">
                <label class="form-label small">Label (optional)</label>
                <input class="form-control" id="incLabel" placeholder="e.g., Verizon Wireless">
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add include rule</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Keywords</th><th>Amount</th><th>Freq</th><th>Next</th><th>Label</th><th></th></tr></thead>
                <tbody id="includeList"><tr><td colspan="6" class="text-muted">No include rules.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Exclude -->
          <div class="tab-pane fade" id="tabExclude" role="tabpanel">
            <form id="formExclude" class="row g-2 align-items-end">
              <div class="col-12 col-lg-6">
                <label class="form-label small">Keywords to exclude (comma separated)</label>
                <input class="form-control" id="excKeywords" placeholder="e.g., TRIAL, TEST, REFUND">
              </div>
              <div class="col-12 col-lg-6">
                <label class="form-label small">Reason (optional)</label>
                <input class="form-control" id="excReason" placeholder="e.g., trials / noise">
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add exclude rule</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Keywords</th><th>Reason</th><th></th></tr></thead>
                <tbody id="excludeList"><tr><td colspan="3" class="text-muted">No exclude rules.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Override -->
          <div class="tab-pane fade" id="tabOverride" role="tabpanel">
            <form id="formOverride" class="row g-2 align-items-end">
              <div class="col-12 col-lg-5">
                <label class="form-label small">Match keywords (comma separated)</label>
                <input class="form-control" id="ovKeywords" placeholder="e.g., NETFLIX">
              </div>
              <div class="col-6 col-lg-2">
                <label class="form-label small">Amount</label>
                <input class="form-control" id="ovAmount" placeholder="leave blank to keep" inputmode="decimal">
              </div>
              <div class="col-6 col-lg-2">
                <label class="form-label small">Freq</label>
                <select class="form-select" id="ovFreq">
                  <option value="">(no change)</option>
                  <option value="monthly">monthly</option>
                  <option value="semi_monthly">semi-monthly</option>
                  <option value="biweekly">biweekly</option>
                  <option value="weekly">weekly</option>
                  <option value="quarterly">quarterly</option>
                  <option value="semiannual">semiannual</option>
                  <option value="annual">annual</option>
                </select>
              </div>
              <div class="col-6 col-lg-3">
                <label class="form-label small">Next date</label>
                <input class="form-control" id="ovNext" type="date">
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add override</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Keywords</th><th>Set</th><th></th></tr></thead>
                <tbody id="overrideList"><tr><td colspan="3" class="text-muted">No overrides.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Pins -->
          <div class="tab-pane fade" id="tabPins" role="tabpanel">
            <form id="formPin" class="row g-2 align-items-end">
              <div class="col-12 col-md-5">
                <label class="form-label small">Label</label>
                <input class="form-control" id="pinLabel" placeholder="e.g., HOA Special Assessment">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label small">Amount</label>
                <input class="form-control" id="pinAmount" inputmode="decimal" placeholder="e.g., 250">
              </div>
              <div class="col-6 col-md-4">
                <label class="form-label small">Date</label>
                <input class="form-control" id="pinDate" type="date">
              </div>
              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add pin</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Label</th><th>Amount</th><th>Date</th><th></th></tr></thead>
                <tbody id="pinsList"><tr><td colspan="4" class="text-muted">No pins.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Schedules -->
          <div class="tab-pane fade" id="tabSchedules" role="tabpanel">
            <form id="formSched" class="row g-2 align-items-end">
              <div class="col-12 col-md-4">
                <label class="form-label small">Label</label>
                <input class="form-control" id="scLabel" placeholder="e.g., Rent">
              </div>
              <div class="col-6 col-md-2">
                <label class="form-label small">Amount</label>
                <input class="form-control" id="scAmount" inputmode="decimal" placeholder="e.g., 1800">
              </div>
              <div class="col-6 col-md-3">
                <label class="form-label small">Frequency</label>
                <select class="form-select" id="scFreq">
                  <option value="monthly">monthly</option>
                  <option value="semi_monthly">semi-monthly</option>
                  <option value="biweekly">biweekly</option>
                  <option value="weekly">weekly</option>
                  <option value="quarterly">quarterly</option>
                  <option value="semiannual">semiannual</option>
                  <option value="annual">annual</option>
                </select>
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label small">Next date</label>
                <input class="form-control" id="scNext" type="date">
              </div>

              <div id="scAnchors" class="col-12 d-none">
                <div class="row g-2">
                  <div class="col-4">
                    <label class="form-label small">Anchor A (day)</label>
                    <input class="form-control" id="scAnchorA" type="number" min="1" max="31" placeholder="e.g., 8">
                  </div>
                  <div class="col-4">
                    <label class="form-label small">Anchor B (day)</label>
                    <input class="form-control" id="scAnchorB" type="number" min="1" max="31" placeholder="e.g., 18">
                  </div>
                  <div class="col-4">
                    <label class="form-label small">Grace days</label>
                    <input class="form-control" id="scGrace" type="number" min="0" max="10" placeholder="e.g., 3">
                  </div>
                </div>
                <div class="form-text">Optional: choose two days of month for semi-monthly schedule; grace lets “nearby” charges match.</div>
              </div>

              <div class="col-12">
                <button class="btn btn-primary btn-sm" type="submit">Add schedule</button>
              </div>
            </form>

            <div class="table-responsive mt-3">
              <table class="table table-sm">
                <thead><tr><th>Label</th><th>Amount</th><th>Freq</th><th>Next</th><th></th></tr></thead>
                <tbody id="schedulesList"><tr><td colspan="5" class="text-muted">No schedules.</td></tr></tbody>
              </table>
            </div>
          </div>

          <!-- Merges -->
          <div class="tab-pane fade" id="tabMerges" role="tabpanel">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead><tr><th>Label</th><th>Keys merged</th><th>Amount</th><th>Freq</th><th>Next</th><th></th></tr></thead>
                <tbody id="mergesList"><tr><td colspan="6" class="text-muted">No merges.</td></tr></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>

      <div class="modal-footer">
        <div class="small me-auto text-muted" id="rulesStatus">Rules auto-save to this browser.</div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ========= Merge Modal ========= -->
<div class="modal fade" id="mergeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Merge selected recurring items</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="small text-muted mb-2" id="mergePickNote">—</div>

        <div class="row g-3">
          <div class="col-12">
            <label class="form-label small">Label</label>
            <input id="mergeLabel" class="form-control" placeholder="e.g., Oona (combined)">
          </div>

          <div class="col-12 col-md-4">
            <label class="form-label small">Amount mode</label>
            <select id="mergeAmtMode" class="form-select">
              <option value="sum">sum of selected</option>
              <option value="median">median of selected</option>
              <option value="fixed">fixed…</option>
            </select>
          </div>
          <div class="col-12 col-md-4" id="mergeFixedWrap" style="display:none;">
            <label class="form-label small">Fixed amount</label>
            <input id="mergeFixed" class="form-control" inputmode="decimal" placeholder="e.g., 95">
          </div>
          <div class="col-12 col-md-4">
            <label class="form-label small">Next date (optional)</label>
            <input id="mergeNext" class="form-control" type="date">
          </div>

          <div class="col-12 col-md-6">
            <label class="form-label small">Frequency</label>
            <select id="mergeFreq" class="form-select">
              <option value="monthly">monthly</option>
              <option value="semi_monthly">semi-monthly</option>
              <option value="biweekly">biweekly</option>
              <option value="weekly">weekly</option>
              <option value="quarterly">quarterly</option>
              <option value="semiannual">semiannual</option>
              <option value="annual">annual</option>
            </select>
          </div>

          <div class="col-12" id="mergeAnchorsWrap" style="display:none;">
            <div class="row g-2">
              <div class="col-4">
                <label class="form-label small">Anchor A (day)</label>
                <input id="mergeA" class="form-control" type="number" min="1" max="31" value="8">
              </div>
              <div class="col-4">
                <label class="form-label small">Anchor B (day)</label>
                <input id="mergeB" class="form-control" type="number" min="1" max="31" value="18">
              </div>
              <div class="col-4">
                <label class="form-label small">Grace days</label>
                <input id="mergeGrace" class="form-control" type="number" min="0" max="10" value="3">
              </div>
            </div>
            <div class="form-text">For semi-monthly schedules only.</div>
          </div>

          <div class="col-12">
            <label class="form-label small">Selected items</label>
            <div id="mergeList" class="small border rounded p-2" style="max-height:180px; overflow:auto;">—</div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div class="small text-muted me-auto" id="mergeStatus">Creates a single combined stream; originals are hidden.</div>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button id="mergeConfirm" class="btn btn-primary">Merge</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // ---- utility
  const money = n => {
    const v = Number(n || 0);
    const s = v < 0 ? '-$' : '$';
    return s + Math.abs(v).toFixed(2);
  };
  const parseDate = s => { const [y,m,d] = (s||'').split('-').map(Number); return (y&&m&&d) ? new Date(y,m-1,d) : null; };
  const daysFromToday = s => { const dt=parseDate(s); if(!dt) return null; const t=new Date(); t.setHours(0,0,0,0); const d=new Date(dt.getFullYear(),dt.getMonth(),dt.getDate()); return Math.round((d-t)/(1000*60*60*24)); };
  const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
  const freqOrder = { 'weekly':1,'biweekly':2,'semi_monthly':2.5,'monthly':3,'quarterly':4,'semiannual':5,'annual':6,'unknown':7 };
  const byId = id => document.getElementById(id);
  const slug = s=> String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
  function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  const parseTxDate = (d) => {
    if (!d) return null;
    if (d.includes('-')){ const [y,m,dd]=d.split('-').map(Number); return (y&&m&&dd)? new Date(y,m-1,dd): null; }
    if (d.includes('/')){ const [mm,dd,yy]=d.split('/'); const y = Number(yy) + (yy.length===2 ? 2000 : 0); return (y&&mm&&dd)? new Date(y,Number(mm)-1,Number(dd)) : null; }
    return null;
  };

  // ---------- SPARKLINES ----------
  const SPARK_W=120, SPARK_H=28;
  function lastNMonthsLabels(n){
    const labels = [];
    const today = new Date();
    const d = new Date(today.getFullYear(), today.getMonth(), 1);
    for (let i=n-1; i>=0; i--){
      const mm = new Date(d.getFullYear(), d.getMonth()-i, 1);
      labels.push(mm.toISOString().slice(0,7));
    }
    return labels;
  }
  function bucketSeriesByMonth(txs, months){
    const sums = Object.fromEntries(months.map(m=>[m,0]));
    for (const t of txs){
      const [mm,dd,yy] = (t.date||'').split('/');
      let key='';
      if (yy && mm){ key = `${yy}-${String(mm).padStart(2,'0')}`; }
      else if ((t.date||'').includes('-')) { key = (t.date||'').slice(0,7); }
      if (key && key in sums){
        sums[key] += Math.abs(Number(t.amount||0));
      }
    }
    return months.map(m => Math.round((sums[m]||0)*100)/100);
  }
  function median(vals){ const v=[...vals].filter(x=>isFinite(x)).sort((a,b)=>a-b); if(!v.length) return 0; const m=Math.floor(v.length/2); return v.length%2?v[m]:(v[m-1]+v[m])/2; }
  function outlierFlag(series){ const med=median(series.filter(x=>x>0)); const last=series[series.length-1]||0; return (med>0 && last>med*1.2)?'⚠':''; }

  // Sparkline with explicit hit areas + data attributes (for custom tooltip)
  function svgSparkline(series, labels, w=SPARK_W, h=SPARK_H){
    const pad=2, max=Math.max(...series,1), step=(w-pad*2)/Math.max(series.length-1,1);
    const ys=series.map(v=> h-pad-(max===0?0:(v/max)*(h-pad*2)));
    const xs=series.map((_,i)=> pad+i*step);
    let d=''; for (let i=0;i<series.length;i++){ d+=(i===0?'M':'L')+xs[i]+' '+ys[i]+' '; }
    const points = series.map((v,i)=>`
      <g class="spark-pt" tabindex="0" aria-label="${(labels?.[i] ?? `#${i+1}`)}: ${money(v)}" style="pointer-events:all">
        <circle class="dot" cx="${xs[i]}" cy="${ys[i]}" r="2.2"/>
        <circle class="hit" cx="${xs[i]}" cy="${ys[i]}" r="9"
                data-label="${labels?.[i] ?? `#${i+1}`}" data-value="${money(v)}"
                style="pointer-events:all"></circle>
      </g>`).join('');
    return `
      <svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}" role="img" aria-label="6 month trend">
        <path d="${d}" stroke="currentColor" fill="none" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        ${points}
      </svg>`;
  }

  // ---------- CATEGORY helpers ----------
  function txDeepLabel(t){
    const lbl = (t.sub_subcategory || t.subcategory || t.subcat || t.category || t.cat_top || '').toString().trim();
    return lbl || 'Other';
  }
  function deepCategoryForStream(subset){
    const counts = new Map();
    for (const t of subset){ const lbl=txDeepLabel(t); counts.set(lbl,(counts.get(lbl)||0)+1); }
    if (!counts.size) return 'Other';
    return [...counts.entries()].sort((a,b)=> b[1]-a[1])[0][0];
  }
  function categoryPathForLabel(subset, targetLabel){
    const norm = d=>{
      if(!d) return '';
      if(d.includes('-')) return d;
      if(d.includes('/')){ const [mm,dd,yy]=d.split('/'); if(yy && mm && dd) return `${yy}-${String(mm).padStart(2,'0')}-${String(dd).padStart(2,'0')}`; }
      return d;
    };
    let chosen = subset.find(t=> txDeepLabel(t)===targetLabel);
    if(!chosen){ const sorted=subset.slice().sort((a,b)=> (norm(b.date)>norm(a.date)?1:(norm(b.date)<norm(a.date)?-1:0))); chosen=sorted[0]||{}; }
    const cat=(chosen.cat_top||chosen.category||'').toString().trim();
    const sub=(chosen.subcat||chosen.subcategory||'').toString().trim();
    const ssub=(chosen.sub_subcategory||'').toString().trim();
    return { cat, sub, ssub, sss:'', label:(ssub||sub||cat||'Category') };
  }
  function catChip(label, path){
    const txt = esc(label||'Category');
    const level = path.ssub ? 'subsubcategory' : (path.sub ? 'subcategory' : 'category');
    return `<a href="#" class="chip link-manage"
              data-manage data-level="${esc(level)}"
              data-cat="${esc(path.cat||'')}" data-sub="${esc(path.sub||'')}" data-ssub="${esc(path.ssub||'')}"
              onclick="return (window.dashManage ? window.dashManage(event, this) : true);">${txt}</a>`;
  }

  // ---------- RULES STORAGE ----------
  const LS_KEY = 'recurringOverrides';
  function readOverrides(){
    try{
      const ls = localStorage.getItem(LS_KEY);
      if (ls) return JSON.parse(ls);
      const tag = document.getElementById('recurring-overrides');
      const j = JSON.parse(tag.textContent || '{}');
      return Object.assign({include:[], exclude:{}, override:[], pins:[], schedules:[], merges:[]}, j||{});
    }catch(e){ return { include:[], exclude:{}, override:[], pins:[], schedules:[], merges:[] }; }
  }
  function writeOverrides(state){
    localStorage.setItem(LS_KEY, JSON.stringify(state));
    document.getElementById('recurring-overrides').textContent = JSON.stringify(state, null, 2);
    renderRulesTables(state);
  }

  // ---------- MATCHING ----------
  function mkMatcher(keywords){
    const K = (Array.isArray(keywords)?keywords:String(keywords||'').split(',')).map(s=>s.trim().toLowerCase()).filter(Boolean);
    if (!K.length) return ()=>false;
    return (s)=>{ const t=String(s||'').toLowerCase(); return K.some(k=> t.includes(k)); };
  }
  function streamMatchesKeywords(stream, txsForStream, keywords){
    const m = mkMatcher(keywords);
    if (m(stream.merchant||stream.name)) return true;
    if (txsForStream && txsForStream.some(t => m(t.merchant||t.merchant_name||t.description))) return true;
    return false;
  }

  // ---------- APPLY OVERRIDES (incl. TRUE MERGES) ----------
  function nextFromFreq(freq, baseDateStr){
    const base = parseDate(baseDateStr) || new Date();
    const d = new Date(base.getFullYear(), base.getMonth(), base.getDate());
    const f = String(freq||'').toLowerCase();
    if (f==='weekly') d.setDate(d.getDate()+7);
    else if (f==='biweekly') d.setDate(d.getDate()+14);
    else if (f==='semi_monthly') d.setDate(d.getDate()+14);
    else if (f==='monthly') d.setMonth(d.getMonth()+1);
    else if (f==='quarterly') d.setMonth(d.getMonth()+3);
    else if (f==='semiannual') d.setMonth(d.getMonth()+6);
    else if (f==='annual') d.setFullYear(d.getFullYear()+1);
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${dd}`;
  }

  function applyRecurringOverrides(base){
    const ov = readOverrides();

    // Start with clones
    let streams = (base.streams||[]).map(s=>({...s}));
    let txs = (base.transactions||[]).map(t=>({...t}));
    let upcoming = (base.upcoming||[]).map(u=>({...u}));

    // Build map for excludes by text
    const excMatchers = Object.entries(ov.exclude||{}).map(([k,reason])=>({ match: mkMatcher(k.split(',')), reason }));
    const isExcludedText = (desc)=> excMatchers.some(x => x.match(desc));

    // Remove excluded by text (stream + tx + upcoming)
    streams = streams.filter(s=> !isExcludedText(s.merchant || s.name || ''));
    txs = txs.filter(t=> !isExcludedText(t.merchant||t.merchant_name||t.description));
    upcoming = upcoming.filter(u=> !isExcludedText(u.merchant||u.name||''));

    // OVERRIDES
    const txByKey0 = txs.reduce((a,t)=>{const k=t._stream_key||t.merchant_key||'';(a[k] ||= []).push(t);return a;},{});
    (ov.override||[]).forEach(rule=>{
      streams.forEach(s=>{
        const subset = txByKey0[s._key] || [];
        if (streamMatchesKeywords(s, subset, rule.keywords)){
          if (rule.amount!=null && rule.amount!=='') s.amount = Number(rule.amount);
          if (rule.freq) s.freq = rule.freq;
          if (rule.next) s.next = rule.next;
        }
      });
    });

    // ===== MERGES =====
    const merges = Array.isArray(ov.merges) ? ov.merges : [];
    const keyMap = new Map(); // oldKey -> newKey
    const addMerged = [];
    for (const m of merges){
      const label = m.label || 'Merged';
      const newKey = 'merge:' + slug(label);
      (m.keys||[]).forEach(k=> keyMap.set(k, newKey));

      const sample = streams.filter(s=> (m.keys||[]).includes(s._key));
      const freq = m.freq || (sample[0]?.freq || 'monthly');
      const next = m.next || (sample.sort((a,b)=> (a.next||'')<(b.next||'')? -1:1)[0]?.next) || nextFromFreq(freq, new Date().toISOString().slice(0,10));
      const amount = (m.amount!=null) ? Number(m.amount) : (sample.reduce((a,s)=>a+Number(s.amount||0),0));

      addMerged.push({_key:newKey, merchant:label, amount, count:'', freq, next, manual:true});
    }

    if (merges.length){
      const mergedKeys = new Set(merges.flatMap(m=> m.keys||[]));
      streams = streams.filter(s => !mergedKeys.has(s._key));
      streams.push(...addMerged);
      txs.forEach(t=>{
        const k = t._stream_key || t.merchant_key || '';
        if (keyMap.has(k)) t._stream_key = keyMap.get(k);
      });
      upcoming.forEach(u=>{
        const k = u._stream_key || u.stream_key || u.merchant_key || '';
        if (keyMap.has(k)) u._stream_key = keyMap.get(k);
      });
    }

    // INCLUDE (force streams)
    (ov.include||[]).forEach(rule=>{
      const txByKey = txs.reduce((a,t)=>{const k=t._stream_key||t.merchant_key||'';(a[k] ||= []).push(t);return a;},{});
      let found=null;
      for (const s of streams){
        const subset = txByKey[s._key]||[];
        if (streamMatchesKeywords(s, subset, rule.keywords)){ found=s; break; }
      }
      const label = rule.label || (Array.isArray(rule.keywords) ? rule.keywords[0] : String(rule.keywords||'').split(',')[0]||'Manual');
      if (found){
        if (rule.amount!=null && rule.amount!=='') found.amount = Number(rule.amount);
        if (rule.freq) found.freq = rule.freq;
        if (rule.next) found.next = rule.next;
        if (!found.merchant) found.merchant = label;
      }else{
        streams.push({
          _key: 'manual:' + slug(label) + ':' + Date.now(),
          merchant: label,
          amount: Number(rule.amount||0),
          count: '',
          freq: rule.freq || 'monthly',
          next: rule.next || nextFromFreq(rule.freq||'monthly', new Date().toISOString().slice(0,10)),
          manual: true
        });
      }
    });

    return { ...base, streams, transactions: txs, upcoming };
  }

  // ---------- PAGE RENDER + INTERACTIONS ----------
  const winSel = byId('win'), horSel=byId('horizon'), searchEl=byId('search');
  const mergeBtn = byId('mergeBtn');
  const manageBtn = byId('manageRulesBtn');

  // Sort
  let sortState = { key: 'category', dir: 'asc' };
  function sortableVal(key, s, txByKey){
    if (key==='amount') return Number(s.amount||0);
    if (key==='freq') return (freqOrder[(s.freq||'unknown').toLowerCase()]||9);
    if (key==='next') return s.next ? (parseDate(s.next)?.getTime() || Number.MAX_SAFE_INTEGER) : Number.MAX_SAFE_INTEGER;
    if (key==='category'){
      const deep = deepCategoryForStream(txByKey[s._key] || []);
      return deep.toLowerCase();
    }
    return 0;
  }
  function compareStreams(a,b,txByKey){
    const va=sortableVal(sortState.key,a,txByKey), vb=sortableVal(sortState.key,b,txByKey);
    if (va<vb) return sortState.dir==='asc'?-1:1;
    if (va>vb) return sortState.dir==='asc'? 1:-1;
    return 0;
  }
  function setSortIndicators(){
    document.querySelectorAll('#streamsTable thead th.sortable').forEach(th=>{
      const key=th.getAttribute('data-sort'); th.classList.remove('sorted-asc','sorted-desc');
      if (key===sortState.key){ th.classList.add(sortState.dir==='asc'?'sorted-asc':'sorted-desc'); }
    });
  }
  function bindSort(){
    document.querySelectorAll('#streamsTable thead th.sortable').forEach(th=>{
      th.addEventListener('click', ()=>{
        const key=th.getAttribute('data-sort');
        if (sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); }
        else { sortState={ key, dir:(key==='category')?'asc':'desc' }; }
        renderStreamsTable();
        setSortIndicators();
      });
    });
  }

  let cachedData=null;
  let upcomingWeekTotal=0;
  const selectedKeys = new Set();

  function updateMergeBtn(){ mergeBtn.disabled = selectedKeys.size < 2; }

  async function load(){
    const win=winSel.value, horizon=horSel.value;
    const url=`/api/recurrents?win=${encodeURIComponent(win)}&horizon=${encodeURIComponent(horizon)}&top_n=5`;
    const res=await fetch(url); const base=await res.json();
    const data=applyRecurringOverrides(base);
    cachedData=data;

    // KPIs and week total (from filtered upcoming)
    const pm = data.projected_month || {
      income_recurring: Number(data.income_recurring || 0),
      variable_income_monthly: Number(data.variable_income_monthly || 0),
      income_expected: Number(data.income_expected || 0),
      fixed_floor: Number(data.floor || 0),
      leftover: Number(data.leftover != null ? data.leftover : (Number(data.income_expected||0) - Number(data.floor||0)))
    };
    const income=Number(pm.income_expected||data.income_expected||0);
    const floor=Number(pm.fixed_floor||data.floor||0);
    const leftover=Number(pm.leftover!=null?pm.leftover:(income-floor));

    byId('kpi-floor').textContent=money(floor);
    byId('kpi-income').textContent=money(income);
    const lEl=byId('kpi-leftover'); lEl.textContent=money(leftover); lEl.classList.toggle('text-danger',leftover<0);

    const todayTo7 = (data.upcoming||[])
      .map(u=>({...u,days:daysFromToday(u.date)}))
      .filter(u=>u.days!=null && u.days>=0 && u.days<=7);
    upcomingWeekTotal = todayTo7.reduce((a,u)=>a+Number(u.amount||0),0);
    byId('kpi-week').textContent=money(upcomingWeekTotal);
    setFloorMeter(floor, income);

    byId('pmRecurring').textContent=money(pm.income_recurring||0);
    byId('pmVariable').textContent=money(pm.variable_income_monthly||0);
    byId('pmExpected').textContent=money(pm.income_expected||0);
    byId('pmFloor').textContent=money(pm.fixed_floor||0);
    const pmL=byId('pmLeftover'); pmL.textContent=money(pm.leftover||0); pmL.classList.toggle('text-danger', Number(pm.leftover||0)<0);
    byId('pmNote').textContent=`Horizon: ${data.horizon || horSel.value} days • Window: ${data.window || winSel.value}`;

    // Scatter header note
    const mKeys = new Set((data.streams||[]).filter(s=> (s.freq||'').toLowerCase()==='monthly').map(s=> s._key));
    const txCount = (data.transactions||[]).filter(t=> mKeys.has(t._stream_key||t.merchant_key||'')).length;
    byId('scNote').textContent = `Window: ${data.window || winSel.value} days • ${txCount} monthly tx`;

    renderStreamsTable();
    renderScatterMonthly();   // <<<<<< monthly scatter
    bindSort(); setSortIndicators();

    // Due soon table
    const dueTbody=document.querySelector('#dueSoonTable tbody'); dueTbody.innerHTML='';
    const txs=data.transactions||[];
    const txByKey = txs.reduce((acc,t)=>{ const k=t._stream_key||t.merchant_key||''; (acc[k] ||= []).push(t); return acc; },{});
    const upcoming=(data.upcoming||[]).slice().sort((a,b)=> (a.date<b.date?-1:1));
    const dueSoon=upcoming.map(u=>({...u,days:daysFromToday(u.date)})).filter(u=>u.days!=null&&u.days>=0&&u.days<=7).sort((a,b)=> (a.date<b.date?-1:1));
    if(!dueSoon.length){ dueTbody.innerHTML='<tr><td colspan="4" class="text-muted py-3 text-center">Nothing due in the next 7 days.</td></tr>'; }
    else{
      for (const u of dueSoon){
        const key=u._stream_key||u.stream_key||u.merchant_key||'';
        let subset=[]; if (key){ subset=txs.filter(t=>(t._stream_key||t.merchant_key||'')===key); }
        const deep=subset.length?deepCategoryForStream(subset):(u.category||'Other');
        const path=subset.length?categoryPathForLabel(subset,deep):{cat:u.category||'Other',sub:'',ssub:'',sss:''};
        const chip=catChip(deep,path);
        const label = u.days===0 ? '<span class="badge text-bg-danger">Today</span>' : (u.days===1?'1 day':`${u.days} days`);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${u.date}</td><td>${chip}</td><td class="text-end">${money(u.amount)}</td><td class="text-end">${label}</td>`;
        dueTbody.appendChild(tr);
        if (window.canonicalizeChip){ const a=tr.querySelector('.chip.link-manage'); if(a) window.canonicalizeChip(a); }
      }
    }
  }

  function setFloorMeter(floor,income){
    const bar=byId('kpi-floor-meter'), subEl=byId('kpi-floor-sub'), tile=byId('tile-floor');
    if(income>0){ const pct=clamp((floor/income)*100,0,140); bar.style.width=pct.toFixed(0)+'%'; subEl.textContent=`${pct.toFixed(0)}% of income`; tile.classList.toggle('over',pct>100); }
    else { bar.style.width='0%'; subEl.textContent='no income set'; tile.classList.remove('over'); }
  }

  function renderStreamsTable(){
    if(!cachedData) return;
    const tbody=document.querySelector('#streamsTable tbody'); tbody.innerHTML='';
    const streams=(cachedData.streams||[]).slice();
    const txs=cachedData.transactions||[];
    const txByKey = txs.reduce((acc,t)=>{ const k=t._stream_key||t.merchant_key||''; (acc[k] ||= []).push(t); return acc; },{});

    const q=(searchEl.value||'').trim().toLowerCase();
    const filtered = streams.filter(s=>{
      if(!q) return true;
      const deep = deepCategoryForStream(txByKey[s._key]||[]);
      const hay = [ deep||'', s.freq||'' ].join(' ').toLowerCase();
      return hay.includes(q);
    });

    if(!filtered.length){ tbody.innerHTML='<tr><td colspan="6" class="text-muted py-3 text-center">No streams detected.</td></tr>'; return; }

    filtered.sort((a,b)=>compareStreams(a,b,txByKey));
    const months=lastNMonthsLabels(6);

    for (const s of filtered){
      const key=s._key||''; const subset=txByKey[key]||[];
      const series=bucketSeriesByMonth(subset, months);
      const warn=outlierFlag(series);
      const nextDays=s.next?daysFromToday(s.next):null;

      const deepLabel=deepCategoryForStream(subset);
      const path=categoryPathForLabel(subset, deepLabel);
      const chipHtml=catChip(deepLabel, path);

      const actions = `
        <div class="dropdown ms-1">
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown" aria-label="Row actions">⋮</button>
          <div class="dropdown-menu dropdown-menu-end">
            <button class="dropdown-item" data-act="start-merge" data-key="${esc(key)}">Combine with…</button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" data-act="exclude" data-kw="${esc(s.merchant||'')}">Exclude “${esc(s.merchant||'') || 'stream'}”</button>
            <button class="dropdown-item" data-act="override-amount" data-kw="${esc(s.merchant||'')}" data-amt="${esc(s.amount||'')}">Set amount…</button>
            <button class="dropdown-item" data-act="override-next" data-kw="${esc(s.merchant||'')}" data-next="${esc(s.next||'')}">Set next date…</button>
            <button class="dropdown-item" data-act="override-freq" data-kw="${esc(s.merchant||'')}">Set frequency…</button>
          </div>
        </div>`;

      const checked = selectedKeys.has(key) ? 'checked' : '';
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td class="text-center align-middle"><input type="checkbox" class="rowSel" data-key="${esc(key)}" ${checked}></td>
        <td class="streams-category">
          <div class="d-flex align-items-center gap-2">
            ${chipHtml} ${warn?`<span class="variance-tag" title="Last charge >20% above median">variance</span>`:''}
            ${actions}
          </div>
        </td>
        <td class="text-start">${money(s.amount)}</td>
        <td>${(s.freq || '—')}</td>
        <td>${s.next ? `<div>${s.next}</div><div class="small muted">${nextDays===0?'today':(nextDays===1?'in 1 day':(nextDays!=null?`in ${nextDays} days`:'—'))}</div>` : '—'}</td>
        <td class="trend-cell">${svgSparkline(series, months)}</td>
      `;
      tbody.appendChild(tr);
    }

    // row selectors
    tbody.querySelectorAll('.rowSel').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const k = cb.dataset.key;
        if (cb.checked) selectedKeys.add(k); else selectedKeys.delete(k);
        updateMergeBtn();
      });
    });

    // wire actions
    tbody.querySelectorAll('[data-act]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const act=btn.dataset.act; const kw=btn.dataset.kw||'';
        const ov=readOverrides();

        if (act==='start-merge'){
          const k = btn.dataset.key;
          if (k){ selectedKeys.add(k); updateMergeBtn(); }
          document.getElementById('mergeBtn').click();
          return;
        }

        if (act==='exclude'){
          ov.exclude[kw] = 'manual exclude';
          writeOverrides(ov); load();
        } else if (act==='override-amount'){
          const a = prompt('Set amount (blank to cancel):', btn.dataset.amt||'');
          if (a===null || a==='') return;
          ov.override.push({ keywords: kw, amount: Number(a) });
          writeOverrides(ov); load();
        } else if (act==='override-next'){
          const nxt = prompt('Set next date (YYYY-MM-DD):', btn.dataset.next||'');
          if (!nxt) return;
          ov.override.push({ keywords: kw, next: nxt });
          writeOverrides(ov); load();
        } else if (act==='override-freq'){
          const f = prompt('Set frequency (weekly/biweekly/semi_monthly/monthly/quarterly/semiannual/annual):','monthly');
          if (!f) return;
          ov.override.push({ keywords: kw, freq: f });
          writeOverrides(ov); load();
        }
      });
    });

    updateMergeBtn();
  }

  // ----- MONTHLY scatter plot -----
  function renderScatterMonthly(){
    const svg = document.getElementById('txScatter');
    if (!svg || !cachedData) return;

    const monthlyKeys = new Set((cachedData.streams||[])
      .filter(s => (s.freq||'').toLowerCase() === 'monthly')
      .map(s => s._key));

    const txs = (cachedData.transactions||[])
      .filter(t => monthlyKeys.has(t._stream_key || t.merchant_key || ''))
      .map(t=>({ dt: parseTxDate(t.date), amt: Math.abs(Number(t.amount||0)), label: t.merchant||t.merchant_name||t.description||'' }))
      .filter(t=> t.dt && isFinite(t.amt));

    const W = svg.clientWidth || svg.getBoundingClientRect().width || 520;
    const H = svg.getAttribute('height') ? Number(svg.getAttribute('height')) : 240;
    const m = {t:12, r:16, b:28, l:40};
    const iw = Math.max(10, W - m.l - m.r);
    const ih = Math.max(10, H - m.t - m.b);

    if (!txs.length){ svg.innerHTML = `<text x="${W/2}" y="${H/2}" text-anchor="middle" fill="var(--muted)">No monthly recurring transactions</text>`; return; }

    const dmin = new Date(Math.min(...txs.map(t=>t.dt)));
    const dmax = new Date(Math.max(...txs.map(t=>t.dt)));
    const amax = Math.max(...txs.map(t=>t.amt)) || 1;

    const x = d => m.l + ( (d - dmin) / Math.max(1,(dmax - dmin)) ) * iw;
    const y = a => m.t + (1 - (a/amax)) * ih;

    // axes + ticks
    const xticks = 5, yticks = 4;
    const parts = [];
    parts.push(`<rect x="${m.l}" y="${m.t}" width="${iw}" height="${ih}" fill="none" stroke="var(--card-border)"/>`);
    for (let i=0;i<=xticks;i++){
      const t = dmin.getTime() + (i/xticks)*(dmax.getTime()-dmin.getTime());
      const dd = new Date(t);
      const xx = x(dd);
      parts.push(`<line x1="${xx}" y1="${m.t+ih}" x2="${xx}" y2="${m.t+ih+4}" stroke="var(--card-border)"/>`);
      const label = dd.toISOString().slice(5,10);
      parts.push(`<text x="${xx}" y="${m.t+ih+18}" font-size="11" text-anchor="middle" fill="var(--muted)">${label}</text>`);
    }
    for (let i=0;i<=yticks;i++){
      const val = (i/yticks)*amax;
      const yy = y(val);
      parts.push(`<line x1="${m.l-4}" y1="${yy}" x2="${m.l}" y2="${yy}" stroke="var(--card-border)"/>`);
      parts.push(`<text x="${m.l-8}" y="${yy+4}" font-size="11" text-anchor="end" fill="var(--muted)">$${Math.round(val)}</text>`);
    }

    // points
    const pts = txs.map(t=>{
      const xx = x(t.dt), yy = y(t.amt);
      const dstr = t.dt.toISOString().slice(0,10);
      return `<g class="sc-pt"><circle cx="${xx}" cy="${yy}" r="3" fill="currentColor"></circle>
        <circle class="sc-hit" cx="${xx}" cy="${yy}" r="10" fill="transparent"
          data-label="${dstr}" data-value="${money(t.amt)}" data-what="${esc(t.label)}"></circle></g>`;
    }).join('');
    parts.push(`<g transform="translate(0,0)" style="color:var(--muted)">${pts}</g>`);

    svg.innerHTML = parts.join('');

    // tooltip (reuse floating tip)
    const tip = document.getElementById('sparkTip');
    function showTip(xp,yp,txt){
      tip.textContent = txt;
      const pad = 8, vw = window.innerWidth, vh = window.innerHeight;
      const left = Math.min(vw-pad, Math.max(pad, xp));
      let top = yp - 8;
      tip.style.transform = 'translate(-50%,-110%)';
      tip.style.left = left+'px';
      tip.style.top = top+'px';
      tip.style.opacity = '1';
      const r = tip.getBoundingClientRect();
      if (r.top < 0){ top = Math.min(vh-pad, yp+18); tip.style.top = top+'px'; tip.style.transform='translate(-50%,0)'; }
    }
    function hideTip(){ tip.style.opacity='0'; }

    svg.onpointermove = (e)=>{
      const c = e.target.closest('.sc-hit');
      if (c){
        const txt = `${c.dataset.label}: ${c.dataset.value}`;
        showTip(e.clientX, e.clientY, txt);
      } else { hideTip(); }
    };
    svg.onpointerleave = ()=> hideTip();

    window.addEventListener('resize', ()=> renderScatterMonthly(), { once:true });
  }

  // ===== Shared floating tooltip (for sparklines & scatter) =====
  const tableEl = document.getElementById('streamsTable');
  const tip = document.createElement('div');
  tip.id = 'sparkTip';
  tip.style.cssText = [
    'position:fixed','z-index:9999','padding:6px 10px','border-radius:10px','font-size:12px',
    'color:var(--text)','background:var(--card-bg)','border:1px solid var(--card-border)',
    'box-shadow:0 10px 24px rgba(0,0,0,.45)','pointer-events:none','opacity:0',
    'transform:translate(-50%,-110%)','transition:opacity .08s ease'
  ].join(';');
  document.body.appendChild(tip);

  function showSparkTip(x,y,txt){
    tip.textContent = txt;
    const pad = 8, vw = window.innerWidth, vh = window.innerHeight;
    const left = Math.min(vw - pad, Math.max(pad, x));
    let top = y - 8;
    tip.style.transform = 'translate(-50%,-110%)';
    tip.style.left = left + 'px';
    tip.style.top = top + 'px';
    tip.style.opacity = '1';
    const r = tip.getBoundingClientRect();
    if (r.top < 0){
      top = Math.min(vh - pad, y + 18);
      tip.style.top = top + 'px';
      tip.style.transform = 'translate(-50%,0)';
    }
  }
  function hideTip(){ tip.style.opacity = '0'; }

  tableEl.addEventListener('pointermove', (e)=>{
    const c = e.target.closest('.hit');
    if (c){
      const txt = `${c.dataset.label}: ${c.dataset.value}`;
      showSparkTip(e.clientX, e.clientY, txt);
    } else {
      hideTip();
    }
  });
  tableEl.addEventListener('pointerleave', hideTip);
  tableEl.addEventListener('focusin', (e)=>{
    const g = e.target.closest('.spark-pt'); if (!g) return;
    const hit = g.querySelector('.hit');
    const r = g.getBoundingClientRect();
    const txt = `${hit.dataset.label}: ${hit.dataset.value}`;
    showSparkTip(r.left + r.width/2, r.top, txt);
  });
  tableEl.addEventListener('focusout', hideTip);

  // Events
  winSel.addEventListener('change', load);
  horSel.addEventListener('change', load);
  byId('search').addEventListener('input', renderStreamsTable);

  // init
  renderRulesTables(readOverrides());
  load();
})();
</script>

<style>
/* ---- Align with global dark/glass theme from layout.html ---- */
.kpi-grid{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; }
@media (max-width: 992px){ .kpi-grid{ grid-template-columns: repeat(2, minmax(0,1fr)); } }
@media (max-width: 576px){ .kpi-grid{ grid-template-columns: 1fr; } }

.kpi-tile{
  border:1px solid var(--card-border); border-radius:14px; padding:12px 14px;
  background: var(--card-bg);
  box-shadow: 0 12px 28px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
  color: var(--text); backdrop-filter: saturate(120%) blur(4px);
}
.kpi-top{ display:flex; align-items:center; gap:8px; margin-bottom:4px; }
.kpi-icon{ display:grid; place-items:center; width:28px; height:28px; border-radius:999px; color: var(--text); background: rgba(255,255,255,.06); border:1px solid var(--card-border); }
.kpi-label{ font-size:12px; color: var(--muted); font-weight:600; }
.kpi-value{ font-size:22px; font-weight:700; line-height:1.1; margin-top:2px; }
.kpi-sub{ font-size:12px; color: var(--muted); margin-top:2px; }

.accent-red   .kpi-icon{ color:#fda4af; }
.accent-green .kpi-icon{ color:#86efac; }
.accent-blue  .kpi-icon{ color:#93c5fd; }
.accent-amber .kpi-icon{ color:#fde68a; }

.kpi-meter{ width:100%; height:10px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid var(--card-border); overflow:hidden; margin-top:6px; }
.kpi-meter .fill{ height:100%; width:0%; background:#f87171; transition:width .25s ease; }
#tile-floor.over .kpi-meter .fill{ background:#dc2626; }

/* ==== CATEGORY "CHIP" ==== */
.chip{ display:inline-block; background:transparent; border:0; color:var(--text); padding:0; margin:0; border-radius:0; font-size:14px; font-weight:700; line-height:1.1; text-decoration:none; }
.chip:hover{ text-decoration: underline; }
.chip:focus{ outline:2px solid color-mix(in oklab, var(--text) 45%, transparent); outline-offset:2px; }

/* table UX */
#streamsTable thead th.sortable { cursor:pointer; user-select:none; }
#streamsTable thead th .sort { opacity:.5; margin-left:4px; font-size:10px; }
#streamsTable thead th.sorted-asc .sort::after  { content:"▲"; }
#streamsTable thead th.sorted-desc .sort::after { content:"▼"; }
#streamsTable thead th:not(.sorted-asc):not(.sorted-desc) .sort::after { content:"↕"; }

#streamsTable td, #streamsTable th,
#dueSoonTable td, #dueSoonTable th{ vertical-align: middle; }

/* variance label */
.variance-tag{ font-size:.85rem; color: color-mix(in oklab, var(--text) 70%, #fff 0%); opacity:.85; }

/* row selector col fixed */
#streamsTable td:first-child, #streamsTable th:first-child { width:32px; }

/* monospace for money blocks we show in merge list */
.mono{ font-variant-numeric: tabular-nums; }

/* tighten cell paddings a bit for better fit */
.table.table-floating > :not(caption) > * > * { padding-top: .6rem; padding-bottom: .6rem; }

/* Sparkline style + bullet/line color sync; FORCE events just in case */
#streamsTable .trend-cell { white-space:nowrap; min-width:190px; }
#streamsTable .trend-cell svg { display:block; margin:0 auto; color: var(--muted); pointer-events:auto; }
#streamsTable .trend-cell svg path { stroke: currentColor; }
#streamsTable .trend-cell svg .dot { fill: currentColor; stroke: currentColor; }
#streamsTable .trend-cell svg .hit { fill: transparent; pointer-events: all !important; }

/* Scatter */
#txScatter { color: var(--muted); }

#streamsTable .trend-cell svg .spark-pt:hover .dot,
#streamsTable .trend-cell svg .spark-pt:focus .dot { filter: drop-shadow(0 0 2px currentColor); }
</style>
{% endblock %}
